<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é–€å¸‚é¸æ“‡å®Œæˆ</title>
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: #FFD700;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
        }
        .container {
            text-align: center;
            padding: 40px;
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid #FFD700;
            border-radius: 20px;
            max-width: 500px;
        }
        .icon {
            font-size: 60px;
            margin-bottom: 20px;
            animation: bounce 1s ease-in-out infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .store-info {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
        }
        .store-info h3 {
            color: #FFD700;
            margin: 0 0 15px 0;
            font-size: 20px;
        }
        .store-info p {
            margin: 8px 0;
            color: #FFF;
            font-size: 16px;
        }
        .spinner {
            border: 4px solid rgba(255, 215, 0, 0.3);
            border-top: 4px solid #FFD700;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .countdown {
            color: #FFA500;
            font-size: 14px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="icon">âœ…</div>
        <h2>é–€å¸‚é¸æ“‡å®Œæˆ</h2>
        
        <div class="store-info" id="storeInfo">
            <h3>ğŸ“ å·²é¸æ“‡é–€å¸‚</h3>
            <p id="storeName">è¼‰å…¥ä¸­...</p>
            <p id="storeAddress"></p>
        </div>
        
        <div class="spinner"></div>
        <p class="countdown">è¦–çª—å°‡åœ¨ <span id="countdown">2</span> ç§’å¾Œè‡ªå‹•é—œé–‰...</p>
    </div>

    <script>
        console.log('========================================');
        console.log('ğŸ“ ç¶ ç•Œå›å‚³é é¢è¼‰å…¥');
        console.log('ç•¶å‰ç¶²å€:', window.location.href);
        console.log('========================================');
        
        // å–å¾— URL åƒæ•¸
        const urlParams = new URLSearchParams(window.location.search);
        
        console.log('URL åƒæ•¸æ•¸é‡:', Array.from(urlParams.keys()).length);
        console.log('æ‰€æœ‰åƒæ•¸:');
        for (let [key, value] of urlParams) {
            console.log(`  ${key} = ${value}`);
        }
        
        // ç¶ ç•Œå›å‚³çš„é–€å¸‚è³‡è¨Š
        const storeData = {
            CVSStoreID: urlParams.get('CVSStoreID') || '',
            CVSStoreName: urlParams.get('CVSStoreName') || '',
            CVSAddress: urlParams.get('CVSAddress') || '',
            CVSTelephone: urlParams.get('CVSTelephone') || '',
            MerchantTradeNo: urlParams.get('MerchantTradeNo') || ''
        };

        console.log('========================================');
        console.log('é–€å¸‚è³‡æ–™:');
        console.log('é–€å¸‚ä»£ç¢¼:', storeData.CVSStoreID);
        console.log('é–€å¸‚åç¨±:', storeData.CVSStoreName);
        console.log('é–€å¸‚åœ°å€:', storeData.CVSAddress);
        console.log('é–€å¸‚é›»è©±:', storeData.CVSTelephone);
        console.log('========================================');

        // é¡¯ç¤ºé–€å¸‚è³‡è¨Š
        if (storeData.CVSStoreID) {
            document.getElementById('storeName').textContent = `ğŸª ${storeData.CVSStoreName}`;
            document.getElementById('storeAddress').textContent = `ğŸ“ ${storeData.CVSAddress}`;
        } else {
            console.warn('âš ï¸ è­¦å‘Šï¼šæ²’æœ‰æ”¶åˆ°é–€å¸‚è³‡æ–™');
            document.getElementById('storeName').textContent = 'âš ï¸ æœªæ”¶åˆ°é–€å¸‚è³‡æ–™';
            document.getElementById('storeAddress').textContent = 'è«‹æª¢æŸ¥ Console æŸ¥çœ‹è©³ç´°è³‡è¨Š';
        }

        // ğŸ”¥ æ–¹å¼ 1ï¼šé€é window.opener å‚³é€è³‡æ–™å›ä¸»è¦–çª—
        if (window.opener && !window.opener.closed) {
            console.log('âœ… æ‰¾åˆ°ä¸»è¦–çª—');
            
            try {
                // å‘¼å«ä¸»è¦–çª—çš„å‡½æ•¸
                if (typeof window.opener.receiveStoreData === 'function') {
                    console.log('âœ… æº–å‚™å‘¼å« receiveStoreData');
                    window.opener.receiveStoreData(storeData);
                    console.log('âœ… è³‡æ–™å·²é€é window.opener å‚³é€');
                } else {
                    console.error('âŒ ä¸»è¦–çª—æ²’æœ‰ receiveStoreData å‡½æ•¸');
                }
            } catch (e) {
                console.error('âŒ å‚³é€è³‡æ–™å¤±æ•—:', e);
            }
            
            // å€’æ•¸è¨ˆæ™‚è‡ªå‹•é—œé–‰
            let countdown = 2;
            const countdownEl = document.getElementById('countdown');
            const timer = setInterval(() => {
                countdown--;
                countdownEl.textContent = countdown;
                
                if (countdown <= 0) {
                    clearInterval(timer);
                    console.log('æº–å‚™é—œé–‰è¦–çª—...');
                    window.close();
                }
            }, 1000);
            
        } else {
            console.warn('âŒ æ‰¾ä¸åˆ°ä¸»è¦–çª—ï¼Œä½¿ç”¨ localStorage æ–¹å¼');
            
            // ğŸ”¥ æ–¹å¼ 2ï¼šå¦‚æœæ‰¾ä¸åˆ°ä¸»è¦–çª—ï¼Œå„²å­˜åˆ° localStorage ä¸¦è·³è½‰
            if (storeData.CVSStoreID) {
                localStorage.setItem('ecpay_store_data', JSON.stringify(storeData));
                console.log('ğŸ’¾ è³‡æ–™å·²å„²å­˜åˆ° localStorage');
                
                // 3 ç§’å¾Œè·³è½‰å›ä¸»é é¢
                let countdown = 3;
                const countdownEl = document.getElementById('countdown');
                countdownEl.textContent = countdown;
                
                const timer = setInterval(() => {
                    countdown--;
                    countdownEl.textContent = countdown;
                    
                    if (countdown <= 0) {
                        clearInterval(timer);
                        console.log('æº–å‚™è·³è½‰å›ä¸»é é¢...');
                        window.location.href = 'ecommerce-with-approval.html?store=selected';
                    }
                }, 1000);
            } else {
                console.error('âŒ æ²’æœ‰é–€å¸‚è³‡æ–™ï¼Œç„¡æ³•å„²å­˜');
            }
        }
    </script>
</body>
</html>
