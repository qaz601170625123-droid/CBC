<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¶ ç•Œ7-11é¸åº—èˆ‡ç‰©æµç³»çµ± (Google Apps Scriptç‰ˆ)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .content {
            padding: 40px;
        }
        
        .section {
            margin-bottom: 40px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #11998e;
        }
        
        .section h2 {
            color: #11998e;
            margin-bottom: 20px;
            font-size: 22px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }
        
        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #11998e;
            box-shadow: 0 0 0 3px rgba(17, 153, 142, 0.1);
        }
        
        .btn {
            padding: 14px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
            text-decoration: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(17, 153, 142, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: 10px;
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        .info-box {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        
        .warning-box {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        
        .error-box {
            background: #ffebee;
            border-left: 4px solid #f44336;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        
        .store-info {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
            border: 2px solid #11998e;
        }
        
        .store-info p {
            margin: 8px 0;
            line-height: 1.6;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            .content {
                padding: 20px;
            }
        }
        
        .hidden {
            display: none;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        th {
            background: #11998e;
            color: white;
            font-weight: 600;
        }
        
        tr:hover {
            background: #f5f5f5;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            padding: 0 20px;
        }
        
        .step {
            flex: 1;
            text-align: center;
            position: relative;
        }
        
        .step::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 50%;
            width: 100%;
            height: 2px;
            background: #e0e0e0;
            z-index: 0;
        }
        
        .step:first-child::before {
            display: none;
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #999;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            position: relative;
            z-index: 1;
            margin-bottom: 10px;
        }
        
        .step.active .step-number {
            background: #11998e;
            color: white;
        }
        
        .step.completed .step-number {
            background: #4caf50;
            color: white;
        }
        
        .step-label {
            font-size: 14px;
            color: #666;
        }
        
        .step.active .step-label {
            color: #11998e;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸª ç¶ ç•Œ7-11è¶…å•†å–è²¨ç³»çµ±</h1>
            <p>Googleè©¦ç®—è¡¨æ•´åˆç‰ˆ - ç„¡éœ€ä¼ºæœå™¨</p>
        </div>
        
        <div class="content">
            <!-- æ­¥é©ŸæŒ‡ç¤ºå™¨ -->
            <div class="step-indicator">
                <div class="step" id="step1">
                    <div class="step-number">1</div>
                    <div class="step-label">è¨­å®šè…³æœ¬</div>
                </div>
                <div class="step" id="step2">
                    <div class="step-number">2</div>
                    <div class="step-label">è¼‰å…¥è³‡æ–™</div>
                </div>
                <div class="step" id="step3">
                    <div class="step-number">3</div>
                    <div class="step-label">é¸æ“‡é–€å¸‚</div>
                </div>
                <div class="step" id="step4">
                    <div class="step-number">4</div>
                    <div class="step-label">å»ºç«‹è¨‚å–®</div>
                </div>
            </div>
            
            <!-- Apps Script è¨­å®šèªªæ˜ -->
            <div class="section">
                <h2>âš™ï¸ ç¬¬ä¸€æ­¥ï¼šè¨­å®šGoogle Apps Script</h2>
                <div class="warning-box">
                    <strong>âš ï¸ é¦–æ¬¡ä½¿ç”¨å¿…è®€ï¼š</strong><br>
                    è«‹å…ˆåœ¨æ‚¨çš„Googleè©¦ç®—è¡¨ä¸­è¨­å®šApps Scriptï¼Œç„¶å¾Œå°‡ç”¢ç”Ÿçš„ç¶²å€è²¼åœ¨ä¸‹æ–¹ã€‚
                    <a href="#setup-guide" onclick="showSetupGuide()" style="color: #11998e; text-decoration: underline; cursor: pointer;">æŸ¥çœ‹è©³ç´°è¨­å®šæ•™å­¸</a>
                </div>
                
                <div id="setup-guide" class="info-box" style="display: none;">
                    <strong>ğŸ“ è¨­å®šæ­¥é©Ÿï¼š</strong><br>
                    1. é–‹å•Ÿæ‚¨çš„Googleè©¦ç®—è¡¨<br>
                    2. é»é¸ã€Œæ“´å……åŠŸèƒ½ã€â†’ã€ŒApps Scriptã€<br>
                    3. è¤‡è£½æˆ‘æä¾›çš„ã€ŒApps Scriptç¨‹å¼ç¢¼ã€è²¼ä¸Š<br>
                    4. é»é¸ã€Œéƒ¨ç½²ã€â†’ã€Œæ–°å¢éƒ¨ç½²ä½œæ¥­ã€<br>
                    5. é¸æ“‡ã€Œç¶²é æ‡‰ç”¨ç¨‹å¼ã€<br>
                    6. ã€ŒåŸ·è¡Œèº«åˆ†ã€é¸ã€Œæˆ‘ã€<br>
                    7. ã€Œå…·æœ‰å­˜å–æ¬Šçš„ä½¿ç”¨è€…ã€é¸ã€Œæ‰€æœ‰äººã€<br>
                    8. é»é¸ã€Œéƒ¨ç½²ã€ä¸¦è¤‡è£½ç¶²å€<br>
                    9. å°‡ç¶²å€è²¼åˆ°ä¸‹æ–¹æ¬„ä½
                </div>
                
                <div class="form-group">
                    <label>Apps Script ç¶²å€ï¼š*</label>
                    <input type="text" id="script-url" placeholder="è²¼ä¸Šæ‚¨çš„Apps Scriptéƒ¨ç½²ç¶²å€">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        æ ¼å¼ï¼šhttps://script.google.com/macros/s/AKfyc.../exec
                    </small>
                </div>
                
                <button class="btn btn-primary" onclick="saveScriptUrl()">ğŸ’¾ å„²å­˜è¨­å®š</button>
                <span id="script-status" style="margin-left: 15px; color: #666;"></span>
            </div>
            
            <!-- Googleè©¦ç®—è¡¨è¨­å®š -->
            <div class="section">
                <h2>ğŸ“Š ç¬¬äºŒæ­¥ï¼šè¼‰å…¥è©¦ç®—è¡¨è³‡æ–™</h2>
                
                <div class="form-group">
                    <label>è©¦ç®—è¡¨IDæˆ–ç¶²å€ï¼š*</label>
                    <input type="text" id="spreadsheet-id" placeholder="è²¼ä¸Šå®Œæ•´è©¦ç®—è¡¨ç¶²å€æˆ–è©¦ç®—è¡¨ID">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        ç¯„ä¾‹: https://docs.google.com/spreadsheets/d/[è©¦ç®—è¡¨ID]/edit
                    </small>
                </div>
                
                <div class="form-group">
                    <label>å·¥ä½œè¡¨åç¨±ï¼š</label>
                    <input type="text" id="sheet-name" value="è¨‚å–®" placeholder="ä¾‹å¦‚: è¨‚å–®">
                </div>
                
                <button class="btn btn-primary" onclick="loadSheetData()" id="load-btn">
                    ğŸ“¥ è¼‰å…¥è©¦ç®—è¡¨è³‡æ–™
                </button>
                
                <div class="info-box" style="margin-top: 15px;">
                    <strong>ğŸ“‹ è©¦ç®—è¡¨æ¬„ä½æ ¼å¼èªªæ˜ï¼š</strong><br>
                    æ¬„ä½é †åºï¼šè¨‚å–®ç·¨è™Ÿ | æ”¶ä»¶äººå§“å | æ”¶ä»¶äººæ‰‹æ©Ÿ | å•†å“åç¨± | é‡‘é¡ | é–€å¸‚ä»£è™Ÿ | é–€å¸‚åç¨± | ç‹€æ…‹<br>
                    ç¬¬ä¸€åˆ—æ‡‰ç‚ºæ¨™é¡Œåˆ—
                </div>
                
                <div id="sheet-data" class="table-container" style="display: none;">
                    <h3 style="margin: 20px 0 10px 0;">è©¦ç®—è¡¨è³‡æ–™ï¼š</h3>
                    <table id="data-table">
                        <thead>
                            <tr>
                                <th>é¸æ“‡</th>
                                <th>è¨‚å–®ç·¨è™Ÿ</th>
                                <th>æ”¶ä»¶äºº</th>
                                <th>æ‰‹æ©Ÿ</th>
                                <th>å•†å“</th>
                                <th>é‡‘é¡</th>
                                <th>é–€å¸‚</th>
                                <th>ç‹€æ…‹</th>
                            </tr>
                        </thead>
                        <tbody id="data-tbody">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- 7-11é¸åº— -->
            <div class="section">
                <h2>ğŸ—ºï¸ ç¬¬ä¸‰æ­¥ï¼šé¸æ“‡7-11å–è²¨é–€å¸‚</h2>
                
                <div class="form-group">
                    <label>è¨‚å–®ç·¨è™Ÿï¼š*</label>
                    <input type="text" id="order-no" placeholder="è«‹è¼¸å…¥è¨‚å–®ç·¨è™Ÿï¼ˆè‹±æ•¸å­—æ··åˆ,æœ€å¤š20å­—å…ƒï¼‰" readonly>
                </div>
                
                <button class="btn btn-secondary" onclick="open711Map()" id="map-btn">
                    ğŸ“ é–‹å•Ÿ7-11é›»å­åœ°åœ–é¸åº—
                </button>
                
                <div class="warning-box" style="margin-top: 15px;">
                    <strong>âš ï¸ æ³¨æ„ï¼š</strong><br>
                    1. é»æ“ŠæŒ‰éˆ•å¾Œæœƒé–‹å•Ÿæ–°è¦–çª—å‰å¾€ç¶ ç•Œé¸åº—é é¢<br>
                    2. é¸æ“‡å®Œé–€å¸‚å¾Œè«‹è¤‡è£½é–€å¸‚è³‡è¨Šï¼Œç„¶å¾Œé—œé–‰è¦–çª—<br>
                    3. å›åˆ°æœ¬é é¢æ‰‹å‹•å¡«å…¥é–€å¸‚è³‡è¨Š
                </div>
                
                <div id="selected-store" class="store-info" style="display: none;">
                    <h3 style="color: #11998e; margin-bottom: 15px;">âœ… å·²é¸æ“‡é–€å¸‚ï¼š</h3>
                    <div class="grid-2">
                        <div class="form-group">
                            <label>é–€å¸‚ä»£è™Ÿï¼š*</label>
                            <input type="text" id="store-id" placeholder="è«‹æ‰‹å‹•è¼¸å…¥é–€å¸‚ä»£è™Ÿ">
                        </div>
                        <div class="form-group">
                            <label>é–€å¸‚åç¨±ï¼š</label>
                            <input type="text" id="store-name" placeholder="è«‹æ‰‹å‹•è¼¸å…¥é–€å¸‚åç¨±">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- å»ºç«‹ç‰©æµè¨‚å–® -->
            <div class="section">
                <h2>ğŸ“¦ ç¬¬å››æ­¥ï¼šå»ºç«‹ç‰©æµè¨‚å–®</h2>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>æ”¶ä»¶äººå§“åï¼š*</label>
                        <input type="text" id="receiver-name" placeholder="è«‹è¼¸å…¥æ”¶ä»¶äººå§“å" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label>æ”¶ä»¶äººæ‰‹æ©Ÿï¼š*</label>
                        <input type="text" id="receiver-cellphone" placeholder="è«‹è¼¸å…¥æ”¶ä»¶äººæ‰‹æ©Ÿï¼ˆ10ç¢¼ï¼‰" readonly>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>å•†å“åç¨±ï¼š*</label>
                    <input type="text" id="goods-name" placeholder="è«‹è¼¸å…¥å•†å“åç¨±ï¼ˆæœ€å¤š60å­—å…ƒï¼‰" readonly>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>å•†å“é‡‘é¡ï¼š*</label>
                        <input type="number" id="goods-amount" placeholder="è«‹è¼¸å…¥å•†å“é‡‘é¡" min="1" max="20000" readonly>
                        <small style="color: #666;">è¶…å•†å–è²¨é‡‘é¡ä¸Šé™ç‚º20,000å…ƒ</small>
                    </div>
                    
                    <div class="form-group">
                        <label>æº«å±¤ï¼š</label>
                        <select id="temperature">
                            <option value="0001">å¸¸æº«</option>
                            <option value="0002">å†·è—</option>
                            <option value="0003">å†·å‡</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>å‚™è¨»ï¼š</label>
                    <textarea id="remark" rows="3" placeholder="é¸å¡«"></textarea>
                </div>
                
                <button class="btn btn-primary" onclick="createLogisticsOrder()" id="create-btn">
                    ğŸš€ å»ºç«‹ç‰©æµè¨‚å–®
                </button>
                <div id="create-status" style="margin-top: 15px;"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        // ç¶ ç•Œè¨­å®š
        const ECPAY_CONFIG = {
            MerchantID: '3490304',
            HashKey: 'O7MpUtX9Inc7e4Ud',
            HashIV: 'B6BxB56xLdGv4fBd',
            MapURL: 'https://logistics.ecpay.com.tw/Express/map'
        };
        
        // å„²å­˜é¸æ“‡çš„é–€å¸‚è³‡è¨Š
        let selectedStore = null;
        
        // å„²å­˜è©¦ç®—è¡¨è³‡æ–™
        let sheetData = [];
        
        // å„²å­˜Script URL
        let scriptUrl = localStorage.getItem('ecpay_script_url') || '';
        
        // é é¢è¼‰å…¥æ™‚
        window.onload = function() {
            if (scriptUrl) {
                document.getElementById('script-url').value = scriptUrl;
                document.getElementById('script-status').innerHTML = 'âœ… å·²å„²å­˜';
                updateStep(2);
            }
        };
        
        // é¡¯ç¤ºè¨­å®šæ•™å­¸
        function showSetupGuide() {
            const guide = document.getElementById('setup-guide');
            guide.style.display = guide.style.display === 'none' ? 'block' : 'none';
        }
        
        // å„²å­˜Script URL
        function saveScriptUrl() {
            const url = document.getElementById('script-url').value.trim();
            if (!url) {
                alert('è«‹è¼¸å…¥Apps Scriptç¶²å€');
                return;
            }
            
            if (!url.includes('script.google.com')) {
                alert('ç¶²å€æ ¼å¼ä¸æ­£ç¢ºï¼Œæ‡‰è©²åŒ…å« script.google.com');
                return;
            }
            
            localStorage.setItem('ecpay_script_url', url);
            scriptUrl = url;
            document.getElementById('script-status').innerHTML = 'âœ… å„²å­˜æˆåŠŸï¼';
            updateStep(2);
            
            setTimeout(() => {
                alert('âœ… è¨­å®šå®Œæˆï¼ç¾åœ¨å¯ä»¥è¼‰å…¥è©¦ç®—è¡¨è³‡æ–™äº†');
            }, 500);
        }
        
        // æ›´æ–°æ­¥é©ŸæŒ‡ç¤ºå™¨
        function updateStep(stepNumber) {
            for (let i = 1; i <= 4; i++) {
                const step = document.getElementById('step' + i);
                step.classList.remove('active', 'completed');
                
                if (i < stepNumber) {
                    step.classList.add('completed');
                } else if (i === stepNumber) {
                    step.classList.add('active');
                }
            }
        }
        
        // ç”ŸæˆCheckMacValue
        function generateCheckMacValue(params) {
            const sortedKeys = Object.keys(params).sort();
            
            let checkStr = 'HashKey=' + ECPAY_CONFIG.HashKey + '&';
            sortedKeys.forEach(key => {
                if (key !== 'CheckMacValue') {
                    checkStr += key + '=' + params[key] + '&';
                }
            });
            checkStr += 'HashIV=' + ECPAY_CONFIG.HashIV;
            
            checkStr = encodeURIComponent(checkStr);
            checkStr = checkStr.toLowerCase();
            checkStr = checkStr
                .replace(/%2d/g, '-')
                .replace(/%5f/g, '_')
                .replace(/%2e/g, '.')
                .replace(/%21/g, '!')
                .replace(/%2a/g, '*')
                .replace(/%28/g, '(')
                .replace(/%29/g, ')')
                .replace(/%20/g, '+');
            
            return CryptoJS.SHA256(checkStr).toString().toUpperCase();
        }
        
        // è¼‰å…¥Googleè©¦ç®—è¡¨è³‡æ–™
        async function loadSheetData() {
            if (!scriptUrl) {
                alert('è«‹å…ˆè¨­å®šApps Scriptç¶²å€');
                return;
            }
            
            const input = document.getElementById('spreadsheet-id').value.trim();
            const sheetName = document.getElementById('sheet-name').value.trim() || 'è¨‚å–®';
            
            if (!input) {
                alert('è«‹è¼¸å…¥è©¦ç®—è¡¨IDæˆ–ç¶²å€');
                return;
            }
            
            // å¾ç¶²å€ä¸­æå–è©¦ç®—è¡¨ID
            let spreadsheetId = input;
            const urlMatch = input.match(/\/d\/([a-zA-Z0-9-_]+)/);
            if (urlMatch) {
                spreadsheetId = urlMatch[1];
            }
            
            const loadBtn = document.getElementById('load-btn');
            loadBtn.disabled = true;
            loadBtn.innerHTML = '<span class="loading"></span> è¼‰å…¥ä¸­...';
            
            try {
                const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
                
                const response = await fetch(url);
                const text = await response.text();
                
                const jsonData = JSON.parse(text.substring(47).slice(0, -2));
                const rows = jsonData.table.rows;
                
                if (rows.length < 2) {
                    alert('è©¦ç®—è¡¨è³‡æ–™ä¸è¶³ï¼ˆè‡³å°‘éœ€è¦1åˆ—æ¨™é¡Œ + 1åˆ—è³‡æ–™ï¼‰');
                    return;
                }
                
                const tbody = document.getElementById('data-tbody');
                tbody.innerHTML = '';
                sheetData = [];
                
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    const cells = row.c || [];
                    
                    const rowData = {
                        orderNo: cells[0]?.v || '',
                        receiverName: cells[1]?.v || '',
                        receiverPhone: cells[2]?.v || '',
                        goodsName: cells[3]?.v || '',
                        amount: cells[4]?.v || '',
                        storeId: cells[5]?.v || '',
                        storeName: cells[6]?.v || '',
                        status: cells[7]?.v || 'å¾…è™•ç†'
                    };
                    
                    sheetData.push(rowData);
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><input type="radio" name="select-order" value="${i-1}" onchange="selectOrder(${i-1})"></td>
                        <td>${rowData.orderNo}</td>
                        <td>${rowData.receiverName}</td>
                        <td>${rowData.receiverPhone}</td>
                        <td>${rowData.goodsName}</td>
                        <td>${rowData.amount}</td>
                        <td>${rowData.storeName || '-'}</td>
                        <td>${rowData.status}</td>
                    `;
                    tbody.appendChild(tr);
                }
                
                document.getElementById('sheet-data').style.display = 'block';
                updateStep(3);
                alert('âœ… æˆåŠŸè¼‰å…¥ ' + (rows.length - 1) + ' ç­†è³‡æ–™');
                
            } catch (error) {
                console.error('è¼‰å…¥å¤±æ•—:', error);
                alert('âŒ è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªï¼š\n1. è©¦ç®—è¡¨IDæ­£ç¢º\n2. è©¦ç®—è¡¨å·²è¨­ç‚ºå…¬é–‹\n3. å·¥ä½œè¡¨åç¨±æ­£ç¢º');
            } finally {
                loadBtn.disabled = false;
                loadBtn.innerHTML = 'ğŸ“¥ è¼‰å…¥è©¦ç®—è¡¨è³‡æ–™';
            }
        }
        
        // é¸æ“‡è¨‚å–®
        function selectOrder(index) {
            const data = sheetData[index];
            document.getElementById('order-no').value = data.orderNo;
            document.getElementById('receiver-name').value = data.receiverName;
            document.getElementById('receiver-cellphone').value = data.receiverPhone;
            document.getElementById('goods-name').value = data.goodsName;
            document.getElementById('goods-amount').value = data.amount;
            
            if (data.storeId) {
                document.getElementById('store-id').value = data.storeId;
                document.getElementById('store-name').value = data.storeName;
                document.getElementById('selected-store').style.display = 'block';
                updateStep(4);
            } else {
                document.getElementById('selected-store').style.display = 'block';
                document.getElementById('store-id').value = '';
                document.getElementById('store-name').value = '';
            }
        }
        
        // é–‹å•Ÿ7-11é›»å­åœ°åœ–
        function open711Map() {
            const orderNo = document.getElementById('order-no').value.trim();
            
            if (!orderNo) {
                alert('è«‹å…ˆé¸æ“‡è¨‚å–®');
                return;
            }
            
            if (!/^[a-zA-Z0-9]{1,20}$/.test(orderNo)) {
                alert('è¨‚å–®ç·¨è™Ÿæ ¼å¼éŒ¯èª¤ï¼ˆåƒ…èƒ½åŒ…å«è‹±æ•¸å­—ï¼Œæœ€å¤š20å­—å…ƒï¼‰');
                return;
            }
            
            const params = {
                MerchantID: ECPAY_CONFIG.MerchantID,
                MerchantTradeNo: orderNo,
                LogisticsType: 'CVS',
                LogisticsSubType: 'UNIMART',
                IsCollection: 'N',
                ServerReplyURL: window.location.origin + '/callback'
            };
            
            const checkMacValue = generateCheckMacValue(params);
            
            // å»ºç«‹è¡¨å–®
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = ECPAY_CONFIG.MapURL;
            form.target = '_blank';
            
            Object.keys(params).forEach(key => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = params[key];
                form.appendChild(input);
            });
            
            const checkInput = document.createElement('input');
            checkInput.type = 'hidden';
            checkInput.name = 'CheckMacValue';
            checkInput.value = checkMacValue;
            form.appendChild(checkInput);
            
            document.body.appendChild(form);
            form.submit();
            document.body.removeChild(form);
            
            alert('ğŸ“ è«‹åœ¨æ–°è¦–çª—ä¸­é¸æ“‡é–€å¸‚\n\né¸æ“‡å®Œæˆå¾Œï¼š\n1. è¤‡è£½é–€å¸‚ä»£è™Ÿå’Œåç¨±\n2. é—œé–‰é¸åº—è¦–çª—\n3. å›åˆ°æœ¬é é¢æ‰‹å‹•å¡«å…¥é–€å¸‚è³‡è¨Š');
            
            document.getElementById('selected-store').style.display = 'block';
        }
        
        // å»ºç«‹ç‰©æµè¨‚å–®
        async function createLogisticsOrder() {
            if (!scriptUrl) {
                alert('è«‹å…ˆè¨­å®šApps Scriptç¶²å€');
                return;
            }
            
            const orderNo = document.getElementById('order-no').value.trim();
            const receiverName = document.getElementById('receiver-name').value.trim();
            const receiverCellphone = document.getElementById('receiver-cellphone').value.trim();
            const goodsName = document.getElementById('goods-name').value.trim();
            const goodsAmount = document.getElementById('goods-amount').value;
            const storeId = document.getElementById('store-id').value.trim();
            const storeName = document.getElementById('store-name').value.trim();
            
            if (!orderNo || !receiverName || !receiverCellphone || !goodsName || !goodsAmount) {
                alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½');
                return;
            }
            
            if (!storeId) {
                alert('è«‹å¡«å¯«é–€å¸‚ä»£è™Ÿ');
                return;
            }
            
            if (!/^09\d{8}$/.test(receiverCellphone)) {
                alert('æ‰‹æ©Ÿè™Ÿç¢¼æ ¼å¼éŒ¯èª¤ï¼ˆæ‡‰ç‚º09é–‹é ­çš„10ç¢¼æ•¸å­—ï¼‰');
                return;
            }
            
            if (goodsAmount < 1 || goodsAmount > 20000) {
                alert('å•†å“é‡‘é¡å¿…é ˆåœ¨1~20,000å…ƒä¹‹é–“');
                return;
            }
            
            const confirmMsg = 'ç¢ºå®šè¦å»ºç«‹ç‰©æµè¨‚å–®å—ï¼Ÿ\n\n' +
                             'è¨‚å–®ç·¨è™Ÿï¼š' + orderNo + '\n' +
                             'æ”¶ä»¶äººï¼š' + receiverName + '\n' +
                             'æ‰‹æ©Ÿï¼š' + receiverCellphone + '\n' +
                             'å•†å“ï¼š' + goodsName + '\n' +
                             'é‡‘é¡ï¼š' + goodsAmount + ' å…ƒ\n' +
                             'é–€å¸‚ï¼š' + storeName + ' (' + storeId + ')';
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            const createBtn = document.getElementById('create-btn');
            createBtn.disabled = true;
            createBtn.innerHTML = '<span class="loading"></span> å»ºç«‹ä¸­...';
            
            const statusDiv = document.getElementById('create-status');
            statusDiv.innerHTML = '';
            
            try {
                // æº–å‚™è¨‚å–®è³‡æ–™
                const orderData = {
                    action: 'createOrder',
                    orderNo: orderNo,
                    receiverName: receiverName,
                    receiverCellphone: receiverCellphone,
                    goodsName: goodsName,
                    goodsAmount: goodsAmount,
                    storeId: storeId,
                    storeName: storeName,
                    temperature: document.getElementById('temperature').value,
                    remark: document.getElementById('remark').value.trim(),
                    merchantId: ECPAY_CONFIG.MerchantID,
                    hashKey: ECPAY_CONFIG.HashKey,
                    hashIV: ECPAY_CONFIG.HashIV
                };
                
                // å‘¼å«Apps Script
                const response = await fetch(scriptUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(orderData)
                });
                
                // å› ç‚ºno-corsæ¨¡å¼ï¼Œç„¡æ³•è®€å–å›æ‡‰ï¼Œæ‰€ä»¥å‡è¨­æˆåŠŸ
                statusDiv.innerHTML = '<div class="info-box">âœ… è¨‚å–®å·²é€å‡ºï¼<br>è«‹ç¨å¾Œæª¢æŸ¥è©¦ç®—è¡¨ï¼Œç¢ºèªè¨‚å–®ç‹€æ…‹æ˜¯å¦æ›´æ–°ç‚ºã€Œå·²å»ºç«‹ã€</div>';
                
                // æ¸…ç©ºè¡¨å–®
                setTimeout(() => {
                    if (confirm('è¨‚å–®å·²é€å‡ºï¼æ˜¯å¦è¦é‡æ–°è¼‰å…¥è©¦ç®—è¡¨æŸ¥çœ‹æœ€æ–°ç‹€æ…‹ï¼Ÿ')) {
                        loadSheetData();
                    }
                }, 2000);
                
            } catch (error) {
                console.error('å»ºç«‹å¤±æ•—:', error);
                statusDiv.innerHTML = '<div class="error-box">âŒ å»ºç«‹å¤±æ•—ï¼š' + error.message + '<br>è«‹æª¢æŸ¥Apps Scriptè¨­å®šæ˜¯å¦æ­£ç¢º</div>';
            } finally {
                createBtn.disabled = false;
                createBtn.innerHTML = 'ğŸš€ å»ºç«‹ç‰©æµè¨‚å–®';
            }
        }
    </script>
</body>
</html>
