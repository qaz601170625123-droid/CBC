<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CANDY BOSS - è³¼ç‰©å•†åŸ v2.5</title>
    <!-- å¼·åˆ¶åˆ·æ–°å¿«å– - ç‰ˆæœ¬ 2.5 - æ”¯æ´Fæ¬„å¤§åˆ†é¡éæ¿¾åŠŸèƒ½ -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
    <!-- Crypto-JS for SHA256 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        // å¼·åˆ¶æ¸…é™¤å¿«å–
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) {
                    registration.unregister();
                }
            });
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            touch-action: manipulation; /* é˜²æ­¢é›™æ“Šæ”¾å¤§ */
            -webkit-text-size-adjust: 100%; /* é˜²æ­¢ iOS è‡ªå‹•èª¿æ•´å­—é«”å¤§å° */
        }

        :root {
            --primary: #FFD700;
            --secondary: #1a1a1a;
            --bg-dark: #0a0a0a;
            --text-light: #ffffff;
            --text-muted: #999;
            --accent-green: #00FF00;
            --gradient-start: #FF6B9D;
            --gradient-end: #C084FC;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: var(--bg-dark);
            color: var(--text-light);
            min-height: 100vh;
            touch-action: manipulation; /* å…¨åŸŸé˜²æ­¢é›™æ“Šæ”¾å¤§ */
            -webkit-tap-highlight-color: transparent; /* ç§»é™¤é»æ“Šé«˜äº® */
        }

        /* é ‚éƒ¨å°èˆª */
        .navbar {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--primary);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-family: 'Orbitron', sans-serif;
            font-size: 24px;
            font-weight: 900;
            color: var(--primary);
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid var(--primary);
            color: var(--primary);
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: var(--primary);
            color: var(--secondary);
        }

        /* ğŸ†• å…¬å‘Šåˆ—æ¨£å¼ */
        .announcement-bar {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15) 0%, rgba(255, 140, 0, 0.1) 100%);
            border-bottom: 2px solid var(--primary);
            padding: 12px 0;
            overflow: hidden;
            position: relative;
            display: none; /* é è¨­éš±è—ï¼Œæœ‰å…¬å‘Šæ‰é¡¯ç¤º */
        }
        
        .announcement-bar.active {
            display: block;
        }
        
        .announcement-content {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 15px;
            overflow: hidden;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .announcement-icon {
            font-size: 20px;
            animation: pulse 2s ease-in-out infinite;
            flex-shrink: 0;
        }
        
        .announcement-text {
            font-size: 15px;
            font-weight: 700;
            color: var(--primary);
            white-space: nowrap;
            display: inline-block;
            transition: opacity 0.3s ease;
        }
        
        /* è·‘é¦¬ç‡ˆæ•ˆæœï¼ˆå–®å‰‡å…¬å‘Šï¼‰ */
        .announcement-text.marquee {
            animation: marquee 30s linear infinite;
        }
        
        @keyframes marquee {
            0% {
                transform: translateX(100%);
            }
            100% {
                transform: translateX(-100%);
            }
        }
        
        /* æ·¡å…¥æ·¡å‡ºæ•ˆæœï¼ˆå¤šå‰‡å…¬å‘Šè¼ªæ’­ï¼‰ */
        .announcement-text.fade {
            animation: fadeInOut 5s ease-in-out;
            white-space: normal;
            word-break: break-word;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-10px); }
            10%, 90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(10px); }
        }

        /* ä¸»è¦å®¹å™¨ */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* å•†å“ç¶²æ ¼ */
        .products-section {
            margin-top: 30px;
        }
        
        /* ä¸»æ‰“å•†å“å€åŸŸ */
        .featured-section {
            margin-bottom: 50px;
            padding: 40px 20px;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(255, 140, 0, 0.08) 50%, rgba(255, 215, 0, 0.1) 100%);
            border-radius: 20px;
            border: 3px solid rgba(255, 215, 0, 0.4);
            box-shadow: 0 10px 40px rgba(255, 215, 0, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        /* ä¸»æ‰“å•†å“èƒŒæ™¯å‹•ç•« */
        .featured-section::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                transparent 30%,
                rgba(255, 215, 0, 0.05) 50%,
                transparent 70%
            );
            animation: shimmer 3s linear infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }
        
        .featured-title {
            font-size: 36px;
            font-weight: 900;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 50%, #FFD700 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(255, 215, 0, 0.3);
            animation: pulse 2s ease-in-out infinite;
            position: relative;
            z-index: 1;
        }
        
        .featured-subtitle {
            text-align: center;
            color: #999;
            font-size: 14px;
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
        }
        
        .featured-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 30px;
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }
        
        .featured-grid .product-card {
            position: relative;
            overflow: visible;
            transform: translateY(0);
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 215, 0, 0.3);
        }
        
        .featured-grid .product-card:hover {
            transform: translateY(-10px) scale(1.02);
            border-color: rgba(255, 215, 0, 0.6);
            box-shadow: 0 15px 40px rgba(255, 215, 0, 0.3);
        }
        
        /* ğŸ”¥ ä¸»æ‰“æ¨è–¦å¾½ç«  - ä½¿ç”¨å¯¦é«”å…ƒç´ è€Œéå½å…ƒç´  */
        .featured-badge {
            position: absolute;
            top: -12px;
            right: -12px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #000;
            padding: 6px 18px;
            border-radius: 25px;
            font-size: 13px;
            font-weight: 700;
            z-index: 10;
            box-shadow: 0 4px 20px rgba(255, 215, 0, 0.6);
            animation: bounce 2s ease-in-out infinite;
        }

        /* ğŸ†• è‡ªå®šç¾©å€å¡Šå¡ç‰‡å¾½ç«  */
        .custom-block-badge {
            position: absolute;
            top: -12px;
            right: -12px;
            background: linear-gradient(135deg, #C084FC 0%, #8B5CF6 100%);
            color: #fff;
            padding: 6px 18px;
            border-radius: 25px;
            font-size: 13px;
            font-weight: 700;
            z-index: 10;
            box-shadow: 0 4px 20px rgba(192, 132, 252, 0.6);
            animation: bounce 2s ease-in-out infinite;
        }

        /* ğŸ†• è‡ªå®šç¾©å€å¡Šå¡ç‰‡é‚Šæ¡† */
        .featured-grid .custom-block-card {
            border-color: rgba(192, 132, 252, 0.3);
        }
        .featured-grid .custom-block-card:hover {
            border-color: rgba(192, 132, 252, 0.7);
            box-shadow: 0 15px 40px rgba(192, 132, 252, 0.3);
        }

        /* ğŸ†• å®¢æœæŒ‰éˆ• */
        .cs-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #06C755;
            border: none;
            color: #fff;
            padding: 8px 16px;
            border-radius: 25px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
            margin-left: 10px;
        }
        .cs-btn:hover {
            background: #05a847;
            transform: scale(1.05);
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0) rotate(-3deg); }
            50% { transform: translateY(-5px) rotate(3deg); }
        }
        
        /* å•†å“åˆ†é¡æ¨™ç±¤ */
        .category-tabs {
            display: flex;
            gap: 12px;
            margin: 30px 0;
            padding: 20px 0;
            overflow-x: auto;
            scrollbar-width: none; /* éš±è—æ»¾å‹•æ¢ */
            -ms-overflow-style: none;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .category-tabs::-webkit-scrollbar {
            display: none; /* éš±è—æ»¾å‹•æ¢ */
        }
        
        .category-tab {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15) 0%, rgba(255, 140, 0, 0.1) 100%);
            border: 2px solid var(--primary);
            color: var(--primary);
            padding: 14px 28px;
            border-radius: 30px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            white-space: nowrap;
            flex-shrink: 0;
            font-size: 15px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.2);
        }
        
        .category-tab::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 215, 0, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .category-tab:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .category-tab:hover {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.25) 0%, rgba(255, 140, 0, 0.15) 100%);
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
            border-color: #FFA500;
        }
        
        .category-tab.active {
            background: linear-gradient(135deg, var(--primary) 0%, #FFA500 100%);
            color: var(--secondary);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.6);
            transform: scale(1.08);
            border-color: var(--primary);
        }
        
        .category-tab.active::before {
            display: none;
        }

        .section-title {
            font-size: 28px;
            font-weight: 900;
            color: var(--primary);
            margin-bottom: 20px;
            text-align: center;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 50px;
        }

        @supports not (grid-template-columns: repeat(auto-fill, minmax(250px, 1fr))) {
            .products-grid {
                display: flex;
                flex-wrap: wrap;
            }
            
            .product-card {
                flex: 1 1 250px;
                max-width: 100%;
            }
        }

        .product-card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .product-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.3);
        }

        .product-image {
            width: 100%;
            height: 200px;
            background: #f5f5f5;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .product-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .product-price {
            font-size: 24px;
            font-weight: 900;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .product-stock {
            font-size: 14px;
            color: var(--accent-green);
            margin-bottom: 15px;
        }

        .add-to-cart-btn {
            width: 100%;
            background: var(--primary);
            color: var(--secondary);
            border: none;
            padding: 12px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .add-to-cart-btn:hover {
            filter: brightness(1.1);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.5);
        }

        /* è³¼ç‰©è»Šæµ®å‹•æŒ‰éˆ• */
        .cart-float {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, var(--primary) 0%, #FFA500 100%);
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.5);
            transition: all 0.3s ease;
            z-index: 999;
        }

        .cart-float:hover {
            transform: scale(1.1);
        }

        .cart-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4444;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
        }

        /* è³¼ç‰©è»Šå´é‚Šæ¬„ */
        .cart-sidebar {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100%;
            background: var(--bg-dark);
            border-left: 2px solid var(--primary);
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }

        .cart-sidebar.active {
            right: 0;
        }

        .cart-header {
            padding: 20px;
            border-bottom: 2px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cart-title {
            font-size: 24px;
            font-weight: 900;
            color: var(--primary);
        }

        .close-cart {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 30px;
            cursor: pointer;
        }

        .cart-items {
            padding: 20px;
        }

        .cart-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .cart-item-name {
            font-weight: 700;
            margin-bottom: 8px;
            line-height: 1.4;
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
        }

        .cart-item-price {
            color: var(--primary);
            font-weight: 700;
        }

        .cart-item-qty {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .qty-btn {
            background: var(--primary);
            color: var(--secondary);
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 700;
            touch-action: manipulation; /* é˜²æ­¢æ‰‹æ©Ÿé›™æ“Šæ”¾å¤§ */
            user-select: none; /* é˜²æ­¢é¸å–æ–‡å­— */
            -webkit-tap-highlight-color: transparent; /* ç§»é™¤é»æ“Šé«˜äº® */
        }

        .remove-item {
            background: #ff4444;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 700;
            margin-top: 10px;
        }

        .cart-footer {
            padding: 20px;
            border-top: 2px solid var(--primary);
        }

        .cart-total {
            font-size: 24px;
            font-weight: 900;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .checkout-btn {
            width: 100%;
            background: var(--primary);
            color: var(--secondary);
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
        }

        /* å½ˆçª—å…±ç”¨æ¨£å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-dark);
            border: 2px solid var(--primary);
            border-radius: 15px;
            padding: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 900;
            color: var(--primary);
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 24px;
            cursor: pointer;
        }

        /* è¦æ ¼é¸æ“‡æ¨¡æ…‹æ¡† */
        .spec-header-container {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            flex-shrink: 0;
        }
        
        .spec-image {
            display: none;
            width: 35%;
            height: 100px;
            background: #f5f5f5;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .spec-info-display {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 6px;
            padding: 8px;
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid var(--primary);
            border-radius: 8px;
        }
        
        .spec-info-price {
            font-size: 24px;
            font-weight: 900;
            color: var(--primary);
            line-height: 1.2;
            text-align: center;
        }
        .spec-original-price {
            font-size: 16px;
            font-weight: 400;
            color: #888;
            text-decoration: line-through;
            margin-left: 8px;
        }
        .sale-badge {
            display: inline-block;
            background: #ff4444;
            color: #fff;
            font-size: 11px;
            font-weight: 700;
            padding: 2px 7px;
            border-radius: 4px;
            margin-left: 6px;
            vertical-align: middle;
            letter-spacing: 0.5px;
        }
        .card-sale-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background: #ff4444;
            color: #fff;
            font-size: 11px;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 4px;
            z-index: 2;
        }
        
        .spec-info-stock {
            font-size: 13px;
            font-weight: 700;
            color: var(--accent-green);
            text-align: center;
        }

        .spec-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .spec-options {
            margin-bottom: 10px;
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            padding-right: 5px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            align-content: start;
        }

        .spec-options::-webkit-scrollbar {
            width: 6px;
        }

        .spec-options::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .spec-options::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }

        .spec-section-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 1px solid rgba(255, 215, 0, 0.3);
        }

        .spec-option {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 8px;
            padding: 10px 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 42px;
        }

        .spec-option:hover {
            border-color: var(--primary);
            box-shadow: 0 0 0 1px var(--primary), 0 0 20px rgba(255, 215, 0, 0.4);
            background: rgba(255, 215, 0, 0.08);
        }

        .spec-option.selected {
            border-color: var(--primary);
            background: rgba(255, 215, 0, 0.15);
            box-shadow: 0 0 0 1px var(--primary), 0 0 25px rgba(255, 215, 0, 0.5);
        }

        .spec-option.out-of-stock {
            opacity: 0.4;
            cursor: not-allowed;
            background: rgba(255, 255, 255, 0.02);
        }

        .spec-option.out-of-stock:hover {
            transform: none;
            box-shadow: none;
        }

        .spec-name {
            font-weight: 700;
            line-height: 1.3;
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
            font-size: 13px;
            color: var(--text-light);
        }

        .spec-stock.low {
            color: #ff9900;
        }

        .spec-stock.out {
            color: #ff4444;
        }

        .quantity-selector {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .quantity-label {
            font-weight: 700;
            margin-bottom: 10px;
            text-align: center;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .quantity-btn {
            background: var(--primary);
            color: var(--secondary);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            font-size: 24px;
            font-weight: 700;
            cursor: pointer;
            touch-action: manipulation; /* é˜²æ­¢æ‰‹æ©Ÿé›™æ“Šæ”¾å¤§ */
            user-select: none; /* é˜²æ­¢é¸å–æ–‡å­— */
            -webkit-tap-highlight-color: transparent; /* ç§»é™¤é»æ“Šé«˜äº® */
        }

        .quantity-display {
            font-size: 24px;
            font-weight: 700;
            min-width: 50px;
            text-align: center;
        }

        .add-to-cart-modal-btn {
            width: 100%;
            background: var(--primary);
            color: var(--secondary);
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
        }

        .add-to-cart-modal-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* çµå¸³è¡¨å–® */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 10px;
            padding: 12px;
            color: var(--text-light);
            font-size: 16px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .radio-group {
            display: flex;
            gap: 15px;
        }

        .radio-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .store-selector {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 10px;
        }

        .store-selector.active {
            display: block;
        }

        .store-select-btn {
            background: var(--primary);
            color: var(--secondary);
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
        }

        .selected-store {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background: rgba(0, 255, 0, 0.1);
            border-radius: 5px;
        }

        .submit-order-btn {
            width: 100%;
            background: var(--primary);
            color: var(--secondary);
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
        }

        /* è¨‚å–®æŸ¥è©¢ */
        .order-result {
            display: none;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            line-height: 1.8;
        }

        .tracking-link {
            display: inline-block;
            background: var(--primary);
            color: var(--secondary);
            padding: 8px 15px;
            border-radius: 5px;
            text-decoration: none;
            font-weight: 700;
            margin-top: 10px;
        }

        /* Toast æç¤º */
        .toast {
            position: fixed;
            top: 100px;
            right: 20px;
            background: var(--accent-green);
            color: var(--secondary);
            padding: 15px 25px;
            border-radius: 10px;
            font-weight: 700;
            z-index: 3000;
            opacity: 0;
            transform: translateX(400px);
            transition: all 0.3s ease;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.error {
            background: #ff4444;
            color: white;
        }

        /* ç™»å…¥ç‰†æ¨£å¼ */
        .login-wall {
            min-height: 70vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
        }

        .login-wall-content {
            text-align: center;
            max-width: 450px;
            width: 100%;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(255, 140, 0, 0.05) 100%);
            padding: 60px 40px;
            border-radius: 24px;
            border: 2px solid var(--primary);
            box-shadow: 0 8px 32px rgba(255, 215, 0, 0.2);
            backdrop-filter: blur(10px);
        }

        .login-wall-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .login-wall-content h2 {
            font-size: 28px;
            color: var(--primary);
            margin-bottom: 15px;
            font-weight: 900;
            text-shadow: 0 2px 10px rgba(255, 215, 0, 0.3);
        }

        .login-wall-content p {
            font-size: 16px;
            color: #ccc;
            margin-bottom: 40px;
            line-height: 1.6;
        }

        .login-wall-btn {
            background: #06C755;
            border: none;
            color: white;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0 auto;
            box-shadow: 0 4px 15px rgba(6, 199, 85, 0.3);
        }

        .login-wall-btn:hover {
            background: #05B34A;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(6, 199, 85, 0.4);
        }

        .login-wall-btn:active {
            transform: translateY(0);
        }
        
        .line-icon {
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            color: #06C755;
            font-size: 16px;
        }

        /* å¯©æ ¸ç‹€æ…‹æ¨£å¼ */
        .approval-status {
            min-height: 70vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
        }

        .approval-content {
            text-align: center;
            max-width: 500px;
            background: rgba(255, 255, 255, 0.05);
            padding: 60px 40px;
            border-radius: 20px;
            border: 2px solid var(--primary);
        }

        .approval-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .approval-content h2 {
            font-size: 28px;
            color: var(--primary);
            margin-bottom: 15px;
            font-weight: 900;
        }

        .approval-content p {
            font-size: 16px;
            color: var(--text-light);
            margin-bottom: 10px;
        }

        /* å‹•ç•«æ•ˆæœ */
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .animate-pulse {
            animation: pulse 0.5s ease;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        /* æ‰‹æ©Ÿç‰ˆå„ªåŒ– (< 480px) */
        @media (max-width: 480px) {
            .navbar {
                padding: 8px 10px;
                flex-direction: column;
                gap: 8px;
                align-items: stretch;
            }

            .logo {
                font-size: 18px;
                text-align: center;
            }

            .nav-buttons {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 8px;
                flex-wrap: wrap;
            }

            .nav-btn {
                padding: 6px 12px;
                font-size: 12px;
                border-radius: 20px;
                white-space: nowrap;
                min-width: auto;
            }

            /* æœƒå“¡è³‡è¨Šå€ - æ©«å‘ç·Šæ¹Šæ’åˆ— */
            #memberInfo {
                display: flex !important;
                gap: 6px !important;
                align-items: center !important;
                justify-content: center !important;
            }

            #memberAvatar {
                width: 30px !important;
                height: 30px !important;
                flex-shrink: 0;
            }

            /* LINE ç™»å…¥æŒ‰éˆ• - ç¸®å° */
            #lineLoginBtn {
                padding: 0 !important;
                background: none !important;
                border: none !important;
            }

            #lineLoginBtn img {
                height: 32px !important;
                width: auto;
            }

            .section-title {
                font-size: 20px;
            }

            .container {
                padding: 10px;
            }

            .products-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .product-card {
                padding: 12px;
            }

            .product-image {
                height: 180px;
            }

            .cart-float {
                width: 50px;
                height: 50px;
                font-size: 22px;
                bottom: 15px;
                right: 15px;
            }

            /* æ¨¡æ…‹æ¡†å„ªåŒ– */
            .modal-content {
                width: 95%;
                max-height: 90vh;
                padding: 15px;
            }

            .modal-title {
                font-size: 18px;
            }
            
            /* ç™»å…¥ç‰†æ‰‹æ©Ÿç‰ˆå„ªåŒ– */
            .login-wall-content {
                padding: 40px 25px;
                max-width: 90%;
            }
            
            .login-wall-icon {
                font-size: 60px;
            }
            
            .login-wall-content h2 {
                font-size: 22px;
            }
            
            .login-wall-content p {
                font-size: 14px;
                margin-bottom: 30px;
            }
            
            .login-wall-btn {
                padding: 12px 30px;
                font-size: 16px;
                width: 100%;
                max-width: 280px;
            }
            
            /* å•†å“åˆ†é¡æ¨™ç±¤æ‰‹æ©Ÿç‰ˆ */
            .category-tabs {
                gap: 8px;
                margin: 20px 0;
                padding: 15px 0;
                justify-content: flex-start;
                overflow-x: auto;
                flex-wrap: nowrap;
            }
            
            .category-tab {
                padding: 11px 20px;
                font-size: 13px;
            }
            
            /* ä¸»æ‰“å•†å“æ‰‹æ©Ÿç‰ˆ */
            .featured-section {
                padding: 20px 10px;
                margin-bottom: 30px;
            }
            
            .featured-title {
                font-size: 24px;
                margin-bottom: 20px;
            }
            
            .featured-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .featured-grid .product-image {
                height: 140px;
            }
            
            .featured-grid .product-name {
                font-size: 14px;
            }
            
            .featured-grid .product-price {
                font-size: 16px;
            }
        }

        @media (min-width: 361px) and (max-width: 480px) {
            .navbar {
                padding: 10px 15px;
            }

            .logo {
                font-size: 18px;
            }

            .nav-btn {
                padding: 8px 12px;
                font-size: 12px;
            }

            .section-title {
                font-size: 20px;
            }

            .container {
                padding: 10px;
            }

            .cart-sidebar {
                width: 100%;
                right: -100%;
            }

            .modal-content {
                width: 95%;
                padding: 15px;
                max-height: 90vh;
                overflow-y: auto;
            }

            .products-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .product-card {
                padding: 12px;
            }

            .product-image {
                height: 120px;
            }

            .product-name {
                font-size: 14px;
            }

            .product-price {
                font-size: 18px;
            }

            .add-to-cart-btn {
                padding: 10px;
                font-size: 14px;
            }

            .spec-header-container {
                gap: 8px;
            }
            
            .spec-image {
                width: 35%;
                height: 90px;
            }
            
            .spec-info-display {
                padding: 6px;
                gap: 4px;
            }
            
            .spec-info-price {
                font-size: 20px;
            }
            
            .spec-info-stock {
                font-size: 11px;
            }
            
            .spec-options {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
            }

            .spec-option {
                padding: 8px 4px;
                min-height: 38px;
            }

            .spec-name {
                font-size: 11px;
            }

            .spec-stock {
                font-size: 9px;
            }
            
            .spec-section-title {
                font-size: 13px;
                margin-bottom: 8px;
                padding-bottom: 5px;
            }

            .cart-float {
                width: 60px;
                height: 60px;
                font-size: 28px;
                bottom: 20px;
                right: 20px;
            }

            .cart-badge {
                width: 24px;
                height: 24px;
                font-size: 12px;
            }
        }

        @media (min-width: 481px) and (max-width: 768px) {
            .cart-sidebar {
                width: 100%;
                right: -100%;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
            }

            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
            
            .spec-image {
                width: 35%;
                height: 100px;
            }
            
            .spec-info-price {
                font-size: 22px;
            }
            
            .spec-info-stock {
                font-size: 12px;
            }

            .spec-options {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }

            .spec-option {
                padding: 10px 6px;
                min-height: 40px;
            }

            .spec-name {
                font-size: 12px;
            }

            .spec-price {
                font-size: 14px;
            }

            .spec-stock {
                font-size: 10px;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .spec-options {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
        }

        @media (min-width: 1025px) {
            .spec-options {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            }
        }

        /* è¨‚å–®æ‘˜è¦æ¨£å¼ */
        .order-summary {
            margin: 25px 0;
            padding: 20px;
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid var(--primary);
            border-radius: 15px;
        }

        .summary-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .summary-items {
            margin-bottom: 15px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 14px;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .item-name {
            flex: 1;
            color: var(--text-light);
        }

        .item-price {
            color: var(--primary);
            font-weight: 700;
            margin-left: 10px;
        }

        .summary-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-top: 2px solid var(--primary);
            margin-top: 15px;
            font-size: 18px;
            font-weight: 900;
        }

        .total-amount {
            font-size: 28px;
            color: var(--primary);
        }
        
        /* ğŸ†• ç¶ ç•Œé–€å¸‚é¸æ“‡æŒ‰éˆ•æ¨£å¼ */
        .store-select-btn {
            background: linear-gradient(135deg, #00c853 0%, #00e676 100%);
            border: none;
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 200, 83, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            margin: 20px 0;
        }
        
        .store-select-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 200, 83, 0.4);
        }
        
        .store-select-btn:active {
            transform: translateY(0);
        }
        
        /* é¸ä¸­é–€å¸‚é¡¯ç¤ºå€åŸŸ */
        .selected-store-info {
            background: rgba(0, 200, 83, 0.1);
            border: 2px solid #00c853;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }
        
        .selected-store-info.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        .store-info-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .store-info-header h3 {
            color: #00c853;
            font-size: 18px;
            margin: 0;
        }
        
        .store-detail {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: start;
            gap: 10px;
        }
        
        .store-detail-label {
            color: #999;
            min-width: 70px;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .store-detail-value {
            color: white;
            flex: 1;
            font-size: 14px;
            word-break: break-all;
        }
        
        .change-store-btn {
            background: transparent;
            border: 2px solid #00c853;
            color: #00c853;
            padding: 8px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .change-store-btn:hover {
            background: #00c853;
            color: white;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* ğŸ†• è‡ªå–ä»˜æ¬¾æ–¹å¼å€å¡Š */
        .pickup-payment-method {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 215, 0, 0.05);
            border-radius: 15px;
            border: 2px solid rgba(255, 215, 0, 0.2);
            animation: fadeIn 0.3s ease;
        }

        .pickup-payment-method.active {
            display: block;
        }

        /* ğŸ†• åŒ¯æ¬¾è³‡è¨Šå¡ç‰‡ */
        .bank-info {
            display: none;
            margin-top: 15px;
            animation: slideDown 0.3s ease;
        }

        .bank-info.active {
            display: block;
        }

        .bank-info-card {
            background: linear-gradient(135deg, rgba(0, 200, 83, 0.1) 0%, rgba(0, 150, 136, 0.1) 100%);
            border: 2px solid #00c853;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 200, 83, 0.2);
        }

        .bank-info-card h4 {
            color: #00c853;
            margin-bottom: 20px;
            font-size: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .bank-detail {
            display: flex;
            align-items: center;
            margin: 12px 0;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .bank-detail:hover {
            background: rgba(0, 0, 0, 0.3);
            transform: translateX(5px);
        }

        .bank-detail .label {
            color: #999;
            min-width: 80px;
            font-weight: 500;
        }

        .bank-detail .value {
            color: #FFD700;
            font-weight: bold;
            font-size: 16px;
            flex: 1;
            word-break: break-all;
            letter-spacing: 1px;
        }

        .bank-notice {
            margin-top: 15px;
            padding: 12px;
            background: rgba(255, 152, 0, 0.1);
            border-left: 4px solid #ff9800;
            border-radius: 5px;
            color: #ff9800;
            font-size: 14px;
        }

        .required {
            color: #ff4444;
            font-weight: bold;
        }

        /* ğŸ†• å‹•ç•«æ•ˆæœ */
        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
            }
            to {
                opacity: 1;
                max-height: 500px;
            }
        }
    </style>
</head>
<body>
    <!-- ğŸ†• éš±è—çš„ç¶ ç•Œè¡¨å–®ï¼ˆClientReplyURL + ServerReplyURLï¼‰ -->
    <form id="ecpayMapForm" method="POST" action="https://logistics.ecpay.com.tw/Express/map" style="display: none;" target="ecpayWindow">
        <input type="text" name="MerchantID" id="ecpay_MerchantID">
        <input type="text" name="MerchantTradeNo" id="ecpay_MerchantTradeNo">
        <input type="text" name="LogisticsType" value="CVS">
        <input type="text" name="LogisticsSubType" id="ecpay_LogisticsSubType" value="UNIMARTC2C">
        <input type="text" name="IsCollection" value="N">
        <input type="text" name="ServerReplyURL" id="ecpay_ServerReplyURL">
        <input type="text" name="ClientReplyURL" id="ecpay_ClientReplyURL">
        <input type="text" name="ExtraData" id="ecpay_ExtraData">
        <input type="text" name="Device" id="ecpay_Device">
        <input type="text" name="CheckMacValue" id="ecpay_CheckMacValue">
    </form>
    <!-- å°èˆªåˆ— -->
    <nav class="navbar">
        <div style="display:flex; align-items:center; gap:10px;">
            <div class="logo">R E X</div>
            <a class="cs-btn" href="https://line.me/ti/p/~YOUR_LINE_ID" target="_blank">
                ğŸ’¬ å®¢æœ
            </a>
        </div>
        <div class="nav-buttons" id="navButtons" style="display:none;">
            <button class="nav-btn" id="lineLoginBtn" onclick="lineLogin()" style="display:none;">
                <img src="https://developers.line.biz/media/line-login/btn_base.png" alt="LINE Login" style="height:40px;">
            </button>
            <div id="memberInfo" style="display:none; align-items:center; gap:10px;">
                <img id="memberAvatar" src="" style="width:40px; height:40px; border-radius:50%; border:2px solid var(--primary);">
                <button class="nav-btn" onclick="openMemberProfileModal()">ğŸ‘¤ æœƒå“¡è³‡æ–™</button>
                <button class="nav-btn" onclick="logout()">ç™»å‡º</button>
            </div>
            <button class="nav-btn" onclick="openOrderSearch()">ğŸ“¦ æŸ¥è©¢è¨‚å–®</button>
        </div>
    </nav>

    <!-- ğŸ†• å…¬å‘Šåˆ— -->
    <div class="announcement-bar" id="announcementBar">
        <div class="announcement-content">
            <span class="announcement-icon">ğŸ“¢</span>
            <span class="announcement-text" id="announcementText"></span>
        </div>
    </div>

    <!-- ä¸»è¦å…§å®¹ -->
    <div class="container">
        <!-- ç™»å…¥ç‰† -->
        <div id="loginWall" class="login-wall" style="display:none;">
            <div class="login-wall-content">
                <div class="login-wall-icon">ğŸ”</div>
                <h2>æ­¡è¿ä¾†åˆ° CANDY BOSS</h2>
                <p>è«‹å…ˆç™»å…¥ä»¥ç¹¼çºŒè³¼ç‰©</p>
                <button class="login-wall-btn" onclick="lineLogin()">
                    <span class="line-icon">L</span>
                    <span>LINE ç™»å…¥</span>
                </button>
            </div>
        </div>

        <!-- å¯©æ ¸ä¸­ç‹€æ…‹ -->
        <div id="pendingApproval" class="approval-status" style="display:none;">
            <div class="approval-content">
                <div class="approval-icon">â³</div>
                <h2>å¸³è™Ÿå¯©æ ¸ä¸­</h2>
                <p>æ‚¨çš„å¸³è™Ÿæ­£åœ¨å¯©æ ¸ä¸­ï¼Œè«‹ç¨å€™ç‰‡åˆ»</p>
                <p style="color:#999; font-size:14px; margin-top:20px;">å¯©æ ¸é€šéå¾Œå³å¯é–‹å§‹è³¼ç‰©</p>
                <button class="nav-btn" style="margin-top:30px;" onclick="checkApprovalStatus()">é‡æ–°æª¢æŸ¥ç‹€æ…‹</button>
            </div>
        </div>

        <!-- å¯©æ ¸æ‹’çµ•ç‹€æ…‹ -->
        <div id="rejectedApproval" class="approval-status" style="display:none;">
            <div class="approval-content">
                <div class="approval-icon" style="color:#ff4444;">âŒ</div>
                <h2>å¯©æ ¸æœªé€šé</h2>
                <p>å¾ˆæŠ±æ­‰ï¼Œæ‚¨çš„ç”³è«‹æœªé€šéå¯©æ ¸</p>
                <p style="color:#999; font-size:14px; margin-top:20px;">å¦‚æœ‰ç–‘å•ï¼Œè«‹è¯ç¹«å®¢æœ</p>
                <button class="nav-btn" style="margin-top:30px;" onclick="logout()">ç™»å‡º</button>
            </div>
        </div>

        <!-- å•†å“å€åŸŸï¼ˆå¯©æ ¸é€šéå¾Œæ‰é¡¯ç¤ºï¼‰ -->
        <section class="products-section" id="productsSection" style="display:none;">
            <!-- ä¸»æ‰“å•†å“å€åŸŸ -->
            <div class="featured-section" id="featuredSection">
                <h2 class="featured-title">â­ æœ¬æœˆä¸»æ‰“æ¨è–¦ â­</h2>
                <p class="featured-subtitle">ç²¾é¸ç†±é–€å•†å“ï¼Œé™æ™‚å„ªæƒ ä¸­</p>
                <div class="featured-grid" id="featuredGrid"></div>
            </div>
            
            <!-- ç³»åˆ—åˆ†é¡æ¨™ç±¤ - å‹•æ…‹ç”Ÿæˆ -->
            <div class="category-tabs" id="categoryTabs">
                <!-- æ‰€æœ‰åˆ†é¡æŒ‰éˆ•ï¼ˆåŒ…å«ã€Œå…¨éƒ¨ã€ï¼‰éƒ½æœƒå¾ JavaScript å‹•æ…‹è¼‰å…¥ -->
            </div>
            
            <div class="products-grid" id="productsGrid"></div>
        </section>
    </div>

    <!-- è³¼ç‰©è»Šæµ®å‹•æŒ‰éˆ• -->
    <div class="cart-float" onclick="toggleCart()">
        ğŸ›’
        <div class="cart-badge" id="cartBadge">0</div>
    </div>

    <!-- è³¼ç‰©è»Šå´é‚Šæ¬„ -->
    <div class="cart-sidebar" id="cartSidebar">
        <div class="cart-header">
            <div class="cart-title">ğŸ›’ è³¼ç‰©è»Š</div>
            <button class="close-cart" onclick="toggleCart()">Ã—</button>
        </div>
        <div class="cart-items" id="cartItems"></div>
        <!-- ğŸ†• è³¼ç‰©è»Šå„ªæƒ æç¤º -->
        <div id="cartPromotionHints"></div>
        <div class="cart-footer">
            <div class="cart-total">ç¸½è¨ˆ:$<span id="cartTotal">0</span></div>
            <button class="checkout-btn" onclick="openCheckout()">å‰å¾€çµå¸³</button>
        </div>
    </div>

    <!-- è¦æ ¼é¸æ“‡å½ˆçª— -->
    <div class="modal" id="specModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="specModalTitle">é¸æ“‡è¦æ ¼</div>
                <button class="close-modal" onclick="closeSpecModal()">Ã—</button>
            </div>
            <div class="spec-header-container">
                <div class="spec-info-display" style="width:100%">
                    <div class="spec-info-price" id="specInfoPrice">è«‹é¸æ“‡è¦æ ¼</div>
                    <div class="spec-info-stock" id="specInfoStock"></div>
                </div>
            </div>
            <div class="spec-options" id="specOptions"></div>
            <div class="quantity-selector">
                <div class="quantity-label" style="display: none;">é¸æ“‡æ•¸é‡:</div>
                <div class="quantity-controls">
                    <button class="quantity-btn" onclick="changeQuantity(-1)">âˆ’</button>
                    <div class="quantity-display" id="quantityDisplay">1</div>
                    <button class="quantity-btn" onclick="changeQuantity(1)">+</button>
                </div>
            </div>
            <button class="add-to-cart-modal-btn" id="addToCartModalBtn" onclick="confirmAddToCart()">åŠ å…¥è³¼ç‰©è»Š</button>
            <div style="text-align: center; margin-top: 15px; color: #999; font-size: 14px;">
                ğŸ’¡ åŠ å…¥å¾Œå¯ç¹¼çºŒé¸è³¼å…¶ä»–è¦æ ¼
            </div>
        </div>
    </div>

    <!-- çµå¸³å½ˆçª— -->
    <div class="modal" id="checkoutModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ğŸ’³ çµå¸³è³‡è¨Š</div>
                <button class="close-modal" onclick="closeCheckout()">Ã—</button>
            </div>
            
            <div class="form-group">
                <label class="form-label">å§“å</label>
                <input type="text" class="form-input" id="customerName" placeholder="è«‹è¼¸å…¥å§“å">
            </div>

            <div class="form-group">
                <label class="form-label">é›»è©±</label>
                <input type="tel" class="form-input" id="customerPhone" placeholder="è«‹è¼¸å…¥é›»è©±è™Ÿç¢¼">
            </div>

            <div class="form-group">
                <label class="form-label">å–è²¨æ–¹å¼</label>
                <div class="radio-group">
                    <label class="radio-label">
                        <input type="radio" name="shipping" value="711" checked onchange="toggleShippingMethod()">
                        7-11åº—åˆ°åº—
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="shipping" value="pickup" onchange="toggleShippingMethod()">
                        è‡ªå–
                    </label>
                </div>
                
                <!-- ğŸ†• ç¶ ç•Œé–€å¸‚é¸æ“‡å€å¡Š -->
                <div id="storeSelector" class="store-selector active">
                    <button type="button" class="store-select-btn" onclick="openECPayMap()">
                        <span>ğŸ“</span>
                        <span>é¸æ“‡ 7-11 å–è²¨é–€å¸‚</span>
                    </button>
                    
                    <div id="selectedStoreInfo" class="selected-store-info">
                        <div class="store-info-header">
                            <span>âœ…</span>
                            <h3>å·²é¸æ“‡é–€å¸‚</h3>
                        </div>
                        
                        <div class="store-detail">
                            <span class="store-detail-label">é–€å¸‚åç¨±ï¼š</span>
                            <span class="store-detail-value" id="storeName"></span>
                        </div>
                        
                        <div class="store-detail">
                            <span class="store-detail-label">é–€å¸‚åœ°å€ï¼š</span>
                            <span class="store-detail-value" id="storeAddress"></span>
                        </div>
                        
                        <div class="store-detail">
                            <span class="store-detail-label">é–€å¸‚é›»è©±ï¼š</span>
                            <span class="store-detail-value" id="storePhone"></span>
                        </div>
                        
                        <button type="button" class="change-store-btn" onclick="openECPayMap()">
                            é‡æ–°é¸æ“‡é–€å¸‚
                        </button>
                    </div>
                </div>
                
                <!-- 7-11 ä»˜æ¬¾æ–¹å¼é¸æ“‡ -->
                <div id="storePaymentMethod" class="pickup-payment-method" style="display:none;">
                    <label class="form-label">ğŸ’° ä»˜æ¬¾æ–¹å¼</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="storePayment" value="transfer" checked onchange="toggleStorePayment()">
                            ğŸ¦ åŒ¯æ¬¾
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="storePayment" value="linepay" onchange="toggleStorePayment()">
                            ğŸ’š LINE Pay
                        </label>
                    </div>
                    
                    <!-- åŒ¯æ¬¾è³‡è¨Š -->
                    <div id="storeBankInfo" class="bank-info" style="display:block;">
                        <div class="bank-info-card">
                            <h4>ğŸ’³ åŒ¯æ¬¾å¸³æˆ¶è³‡è¨Š</h4>
                            <div class="bank-detail">
                                <span class="label">éŠ€è¡Œï¼š</span>
                                <span class="value" id="storeBankName">è¼‰å…¥ä¸­...</span>
                            </div>
                            <div class="bank-detail">
                                <span class="label">å¸³è™Ÿï¼š</span>
                                <span class="value" id="storeBankAccount">è¼‰å…¥ä¸­...</span>
                            </div>
                            <div class="bank-detail">
                                <span class="label">æˆ¶åï¼š</span>
                                <span class="value" id="storeBankHolder">è¼‰å…¥ä¸­...</span>
                            </div>
                            <div class="bank-notice">
                                âš ï¸ è«‹åœ¨åŒ¯æ¬¾å¾Œå¡«å¯«è¨‚å–®é é¢çš„å¸³è™Ÿæœ«äº”ç¢¼
                            </div>
                        </div>
                    </div>
                    
                    <!-- LINE Pay è³‡è¨Š -->
                    <div id="storeLinePayInfo" style="display:none;">
                        <div class="bank-info-card">
                            <h4>ğŸ’š LINE Pay ä»˜æ¬¾</h4>
                            <div class="bank-detail">
                                <span class="label">LINE Pay å¸³è™Ÿï¼š</span>
                                <span class="value" id="linePayAccount">è¼‰å…¥ä¸­...</span>
                            </div>
                            <div class="bank-notice">
                                âš ï¸ è«‹ä»˜æ¬¾å¾Œå¡«å¯«ä¸‹æ–¹æ‚¨çš„ LINE é¡¯ç¤ºåç¨±
                            </div>
                            <div style="margin-top:10px;">
                                <label class="form-label" style="font-size:13px;">æ‚¨çš„ LINE é¡¯ç¤ºåç¨±</label>
                                <input type="text" id="linePayName" class="form-input" placeholder="è«‹è¼¸å…¥æ‚¨çš„ LINE é¡¯ç¤ºåç¨±" style="margin-top:5px;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ğŸ†• è‡ªå–ä»˜æ¬¾æ–¹å¼é¸æ“‡ -->
                <div id="pickupPaymentMethod" class="pickup-payment-method">
                    <label class="form-label">ğŸ’° ä»˜æ¬¾æ–¹å¼</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="paymentMethod" value="cash" checked onchange="toggleBankInfo()">
                            ğŸ’µ ç¾å ´ä»˜æ¬¾
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="paymentMethod" value="transfer" onchange="toggleBankInfo()">
                            ğŸ¦ åŒ¯æ¬¾
                        </label>
                    </div>
                    
                    <!-- ğŸ†• åŒ¯æ¬¾è³‡è¨Šé¡¯ç¤ºå€ -->
                    <div id="bankInfo" class="bank-info">
                        <div class="bank-info-card">
                            <h4>ğŸ’³ åŒ¯æ¬¾å¸³æˆ¶è³‡è¨Š</h4>
                            <div class="bank-detail">
                                <span class="label">éŠ€è¡Œï¼š</span>
                                <span class="value" id="bankName">è¼‰å…¥ä¸­...</span>
                            </div>
                            <div class="bank-detail">
                                <span class="label">å¸³è™Ÿï¼š</span>
                                <span class="value" id="bankAccount">è¼‰å…¥ä¸­...</span>
                            </div>
                            <div class="bank-detail">
                                <span class="label">æˆ¶åï¼š</span>
                                <span class="value" id="bankHolder">è¼‰å…¥ä¸­...</span>
                            </div>
                            <div class="bank-notice">
                                âš ï¸ è«‹åœ¨åŒ¯æ¬¾å¾Œå¡«å¯«ä¸‹æ–¹çš„å¸³è™Ÿæœ«äº”ç¢¼
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è¨‚å–®æ‘˜è¦ -->
            <div class="order-summary">
                <h3 class="summary-title">ğŸ“‹ è¨‚å–®æ‘˜è¦</h3>
                <div class="summary-items" id="checkoutSummary"></div>
                <div class="summary-total">
                    <span>ç¸½è¨ˆ</span>
                    <span class="total-amount" id="checkoutTotal">$0</span>
                </div>
                <!-- ğŸ†• å„ªæƒ æç¤ºå€åŸŸ -->
                <div id="promotionHints"></div>
            </div>

            <button class="submit-order-btn" onclick="submitOrder()">ç¢ºèªé€å‡ºè¨‚å–®</button>
        </div>
    </div>

    <!-- è¨‚å–®æŸ¥è©¢å½ˆçª— -->
    <div class="modal" id="orderSearchModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ğŸ“¦ æˆ‘çš„è¨‚å–®</div>
                <button class="close-modal" onclick="closeOrderSearch()">Ã—</button>
            </div>
            
            <div id="ordersList" style="max-height: 500px; overflow-y: auto;">
                <!-- è¨‚å–®åˆ—è¡¨æœƒå‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>
    </div>


    <!-- æœƒå“¡è³‡æ–™æŸ¥çœ‹å½ˆçª— -->
    <div class="modal" id="memberProfileModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ğŸ‘¤ æœƒå“¡è³‡æ–™</div>
                <button class="close-modal" onclick="closeMemberProfileModal()">âœ•</button>
            </div>
            
            <div style="padding: 20px 0;">
                <div style="text-align: center; margin-bottom: 20px;">
                    <img id="profileAvatar" src="" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--primary);">
                    <div style="margin-top: 10px; font-size: 18px; font-weight: 700; color: var(--primary);" id="profileDisplayName"></div>
                </div>
                
                <div style="background: rgba(255, 215, 0, 0.1); border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                    <div style="margin-bottom: 12px;">
                        <div style="font-size: 12px; color: #999; margin-bottom: 5px;">ğŸ“± é›»è©±è™Ÿç¢¼</div>
                        <div style="font-size: 16px; font-weight: 700;" id="profilePhone">æœªè¨­å®š</div>
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <div style="font-size: 12px; color: #999; margin-bottom: 5px;">ğŸ“§ Email</div>
                        <div style="font-size: 16px; font-weight: 700;" id="profileEmail">æœªè¨­å®š</div>
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <div style="font-size: 12px; color: #999; margin-bottom: 5px;">ğŸ¯ å¯©æ ¸ç‹€æ…‹</div>
                        <div style="font-size: 16px; font-weight: 700;" id="profileApprovalStatus">å¾…å¯©æ ¸</div>
                    </div>
                    
                    <div>
                        <div style="font-size: 12px; color: #999; margin-bottom: 5px;">ğŸ†” æœƒå“¡ ID</div>
                        <div style="font-size: 12px; color: #666; word-break: break-all;" id="profileLineId"></div>
                    </div>
                </div>
                
                <button class="submit-order-btn" onclick="openEditProfileModal()">âœï¸ ç·¨è¼¯è³‡æ–™</button>
            </div>
        </div>
    </div>

    <!-- æœƒå“¡è³‡æ–™ç·¨è¼¯å½ˆçª— -->
    <div class="modal" id="profileUpdateModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">âœï¸ ç·¨è¼¯æœƒå“¡è³‡æ–™</div>
                <button class="close-modal" onclick="closeProfileUpdateModal()">âœ•</button>
            </div>
            
            <div style="padding: 20px 0;">
                <div class="form-group">
                    <label class="form-label">ğŸ“± é›»è©±è™Ÿç¢¼ *</label>
                    <input type="tel" class="form-input" id="updatePhone" placeholder="ä¾‹: 0912345678" required>
                </div>

                <div class="form-group">
                    <label class="form-label">ğŸ“§ Emailï¼ˆé¸å¡«ï¼‰</label>
                    <input type="email" class="form-input" id="updateEmail" placeholder="ä¾‹: example@gmail.com">
                </div>

                <button class="submit-order-btn" onclick="submitProfileUpdate()">âœ… å„²å­˜è®Šæ›´</button>
            </div>
        </div>
    </div>

    <!-- Toast æç¤º -->
    <div class="toast" id="toast"></div>

    <script>
// ==========================================
// å…¨åŸŸè®Šæ•¸è¨­å®š
// ==========================================
const SHEET_ID = '1v1ecAE2XYAJgCnT3jbUp6Lfz64npIAzdiepzy-PSr_4';
const API_KEY = 'AIzaSyD3zhGgpz3SBgp62_1GhTql2CW5vrzI7NA';
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbywjsDQeIkVbhg9Ah2Z62oWi4fx2WlOeQUhFP-CxtnPYBgOW0_eQ3qdccB4AISV8dIZ/exec';

// LINE Login è¨­å®š
const LINE_CHANNEL_ID = '2009077580';
const LINE_REDIRECT_URI = 'https://cbc-lake.vercel.app/callback.html';
const LINE_STATE = 'random_state_' + Math.random().toString(36).substr(2, 9);

const PRODUCTS_SHEET = 'å•†å“åˆ—è¡¨';
const SPECS_SHEET = 'å•†å“è¦æ ¼è¡¨';
const ANNOUNCEMENT_SHEET = 'å…¬å‘Šè¨­å®š';  // ğŸ†• å…¬å‘Šå·¥ä½œè¡¨
const PROMOTION_SHEET = 'å„ªæƒ è¨­å®š';     // ğŸ†• å„ªæƒ å·¥ä½œè¡¨

let products = [];
let productSpecs = {};
let announcements = [];  // ğŸ†• å„²å­˜å…¬å‘Šè³‡æ–™
let promotions = [];     // ğŸ†• å„²å­˜å„ªæƒ è³‡æ–™
let categories = [];     // ğŸ†• å„²å­˜åˆ†é¡è¨­å®šï¼ˆå«åœ–ç‰‡ï¼‰
let currentCategory = 'all';  // ç•¶å‰é¸æ“‡çš„åˆ†é¡
let cart = [];
let selectedStore = null;

// ğŸ†• ç³»çµ±è¨­å®šï¼ˆåŒ¯æ¬¾è³‡è¨Šï¼‰
let systemSettings = {
    bankName: '',
    bankAccount: '',
    bankHolder: ''
};

// æœƒå“¡ç›¸é—œ
let currentMember = null;
let currentProduct = null;
let selectedSpec = null;
let quantity = 1;

// ==========================================
// ğŸ†• ç¶ ç•Œç‰©æµè¨­å®šï¼ˆæ­£å¼ç’°å¢ƒï¼‰
// ==========================================
const ECPAY_CONFIG = {
    MerchantID: '3490304',
    HashKey: 'O7MpUtX9Inc7e4Ud',  // æ³¨æ„ï¼šç¬¬ä¸€å€‹å­—å…ƒæ˜¯å¤§å¯« O
    HashIV: 'B6BxB56xLdGv4fBd',
    // æ­£å¼ç’°å¢ƒ
    MapURL: 'https://logistics.ecpay.com.tw/Express/map'
};

// ==========================================
// ğŸ†• ç¶ ç•ŒåŠ å¯†å‡½æ•¸
// ==========================================

/**
 * URL Encodeï¼ˆç¶ ç•Œå°ˆç”¨ï¼‰
 * ç¶ ç•Œçš„ URL Encode è¦å‰‡ï¼š
 * 1. å…ˆé€²è¡Œæ¨™æº–çš„ encodeURIComponent
 * 2. å°‡ç‰¹å®šå­—å…ƒé‚„åŸï¼ˆä¸ç·¨ç¢¼ï¼‰ï¼š- _ . ! * ( )
 * 3. å°‡ %20 (ç©ºæ ¼) è½‰æˆ +
 */
function ecpayUrlEncode(str) {
    let encoded = encodeURIComponent(str);
    
    // å°‡ç‰¹å®šå­—å…ƒé‚„åŸï¼ˆç¶ ç•Œè¦æ±‚é€™äº›å­—å…ƒä¸è¦ç·¨ç¢¼ï¼‰
    encoded = encoded.replace(/%2D/g, '-');  // -
    encoded = encoded.replace(/%5F/g, '_');  // _
    encoded = encoded.replace(/%2E/g, '.');  // .
    encoded = encoded.replace(/%21/g, '!');  // !
    encoded = encoded.replace(/%2A/g, '*');  // *
    encoded = encoded.replace(/%28/g, '(');  // (
    encoded = encoded.replace(/%29/g, ')');  // )
    encoded = encoded.replace(/%20/g, '+');  // ç©ºæ ¼è½‰ +
    
    return encoded;
}

/**
 * ç”¢ç”Ÿ CheckMacValue
 */
function generateCheckMacValue(params, hashKey, hashIV) {
    // 1. åƒæ•¸ä¾ç…§ A-Z æ’åº
    const sortedKeys = Object.keys(params).sort((a, b) => {
        return a.toLowerCase().localeCompare(b.toLowerCase());
    });
    
    // 2. çµ„æˆå­—ä¸²ï¼škey1=value1&key2=value2...
    let checkStr = sortedKeys.map(key => {
        return `${key}=${params[key]}`;
    }).join('&');
    
    // 3. å‰å¾ŒåŠ ä¸Š HashKey å’Œ HashIV
    checkStr = `HashKey=${hashKey}&${checkStr}&HashIV=${hashIV}`;
    
    // 4. URL Encode
    checkStr = ecpayUrlEncode(checkStr);
    
    // 5. è½‰å°å¯«
    checkStr = checkStr.toLowerCase();
    
    // 6. SHA256 åŠ å¯†
    let hash = CryptoJS.SHA256(checkStr).toString(CryptoJS.enc.Hex);
    
    // 7. è½‰å¤§å¯«
    return hash.toUpperCase();
}

/**
 * ç”¢ç”Ÿè¨‚å–®ç·¨è™Ÿ
 */
function generateMerchantTradeNo() {
    const timestamp = new Date().getTime();
    const random = Math.floor(Math.random() * 1000);
    return `CB${timestamp}${random}`;
}

/**
 * åµæ¸¬è£ç½®é¡å‹
 */
function getDeviceType() {
    return '0'; // å›ºå®šæ‰‹æ©Ÿç‰ˆåœ°åœ–
}

// ==========================================
// ğŸ†• é–‹å•Ÿç¶ ç•Œåœ°åœ–é¸æ“‡é–€å¸‚
// ==========================================
function openECPayMap() {
    console.log('========================================');
    console.log('ğŸš€ é–‹å§‹åŸ·è¡Œ openECPayMap');
    console.log('========================================');
    
    // ç”¢ç”Ÿå”¯ä¸€è¨‚å–®ç·¨è™Ÿ
    const merchantTradeNo = generateMerchantTradeNo();
    
    // ServerReplyURL å’Œ ClientReplyURL éƒ½æŒ‡å‘ Vercel API
    // Vercel API æ¥æ”¶ POST â†’ å›å‚³ HTML çµ¦å½ˆçª— â†’ å½ˆçª—é—œé–‰
    // GAS å¦å¤–ç”¨ fetch é€šçŸ¥ï¼ˆè¨˜éŒ„è¨‚å–®ç”¨ï¼‰
    const serverReplyURL = 'https://cbc-lake.vercel.app/api/ecpay-callback';
    const clientReplyURL = 'https://cbc-lake.vercel.app/api/ecpay-callback';
    
    console.log('ServerReplyURL:', serverReplyURL);
    console.log('ClientReplyURL:', clientReplyURL);
    
    // æº–å‚™åƒæ•¸
    const params = {
        MerchantID: ECPAY_CONFIG.MerchantID,
        MerchantTradeNo: merchantTradeNo,
        LogisticsType: 'CVS',
        LogisticsSubType: 'UNIMARTC2C', // ğŸ”¥ 7-11 åº—åˆ°åº—ï¼ˆC2Cï¼‰
        IsCollection: 'N',
        ServerReplyURL: serverReplyURL,  // Apps Script æ¥æ”¶ POSTï¼ˆå¾Œç«¯é€šçŸ¥ï¼‰
        ClientReplyURL: clientReplyURL,  // ecpay-callback.html æ¥æ”¶ GETï¼ˆå‰ç«¯å½ˆçª—ï¼‰
        ExtraData: '',
        Device: getDeviceType()
    };
    
    // ğŸ”¥ é™¤éŒ¯ï¼šè¨˜éŒ„åƒæ•¸
    console.log('ğŸ“¦ ç¶ ç•Œåœ°åœ–åƒæ•¸ï¼š');
    console.log('MerchantID:', params.MerchantID);
    console.log('MerchantTradeNo:', params.MerchantTradeNo);
    console.log('LogisticsType:', params.LogisticsType);
    console.log('LogisticsSubType:', params.LogisticsSubType);
    console.log('ServerReplyURL:', params.ServerReplyURL);
    console.log('ClientReplyURL:', params.ClientReplyURL);
    console.log('Device:', params.Device);
    
    // ç”¢ç”Ÿæª¢æŸ¥ç¢¼
    const checkMacValue = generateCheckMacValue(
        params,
        ECPAY_CONFIG.HashKey,
        ECPAY_CONFIG.HashIV
    );
    
    console.log('CheckMacValue:', checkMacValue);
    console.log('========================================');
    
    // å¡«å…¥è¡¨å–®
    document.getElementById('ecpay_MerchantID').value = params.MerchantID;
    document.getElementById('ecpay_MerchantTradeNo').value = params.MerchantTradeNo;
    document.getElementById('ecpay_LogisticsSubType').value = params.LogisticsSubType;
    document.getElementById('ecpay_ServerReplyURL').value = params.ServerReplyURL;
    document.getElementById('ecpay_ClientReplyURL').value = params.ClientReplyURL;
    document.getElementById('ecpay_ExtraData').value = params.ExtraData;
    document.getElementById('ecpay_Device').value = params.Device;
    document.getElementById('ecpay_CheckMacValue').value = checkMacValue;
    
    // å„²å­˜è¨‚å–®ç·¨è™Ÿï¼Œä¾›å›å‚³æ™‚é©—è­‰
    localStorage.setItem('ecpay_merchant_trade_no', merchantTradeNo);
    console.log('âœ… å·²å„²å­˜è¨‚å–®ç·¨è™Ÿåˆ° localStorage:', merchantTradeNo);
    
    // ğŸ”¥ é–‹å•Ÿå½ˆçª—ï¼ˆ800x600ï¼‰
    const ecpayWindow = window.open('', 'ecpayWindow', 'width=800,height=600,scrollbars=yes');
    
    if (ecpayWindow) {
        console.log('âœ… å½ˆçª—å·²é–‹å•Ÿ');
        // æäº¤è¡¨å–®åˆ°å½ˆçª—
        document.getElementById('ecpayMapForm').submit();
        showToast('é–‹å•Ÿé–€å¸‚é¸æ“‡è¦–çª—...', 'success');
    } else {
        console.error('âŒ å½ˆçª—è¢«é˜»æ“‹ï¼');
        showToast('è«‹å…è¨±å½ˆå‡ºè¦–çª—ï¼', 'error');
    }
    
    console.log('========================================');
}

// ==========================================
// ğŸ†• æ¥æ”¶å½ˆçª—å‚³ä¾†çš„é–€å¸‚è³‡æ–™
// ==========================================
// ==========================================
// ğŸ†• è™•ç†ç¶ ç•Œå›å‚³çš„é–€å¸‚è³‡æ–™ï¼ˆä½¿ç”¨ localStorageï¼‰
// ==========================================

// ğŸ”¥ è¼ªè©¢æª¢æŸ¥ localStorage ä¸­çš„é–€å¸‚è³‡æ–™
let storeDataCheckInterval = null;

/**
 * ğŸ†• é–‹å§‹ç›£è½ localStorage ä¸­çš„é–€å¸‚è³‡æ–™
 */
function startListeningForStoreData() {
    console.log('========================================');
    console.log('ğŸ§ é–‹å§‹ç›£è½é–€å¸‚è³‡æ–™...');
    console.log('========================================');
    
    // æ¸…é™¤èˆŠçš„ç›£è½å™¨
    if (storeDataCheckInterval) {
        clearInterval(storeDataCheckInterval);
    }
    
    // æ¯ 500ms æª¢æŸ¥ä¸€æ¬¡ localStorage
    storeDataCheckInterval = setInterval(() => {
        const storeDataJson = localStorage.getItem('ecpay_store_data');
        
        if (storeDataJson) {
            console.log('âœ… åµæ¸¬åˆ°é–€å¸‚è³‡æ–™ï¼');
            
            try {
                const storeData = JSON.parse(storeDataJson);
                console.log('æ”¶åˆ°çš„é–€å¸‚è³‡æ–™ï¼š', storeData);
                
                // åœæ­¢ç›£è½
                clearInterval(storeDataCheckInterval);
                storeDataCheckInterval = null;
                
                // è™•ç†é–€å¸‚è³‡æ–™
                processStoreData(storeData);
                
                // æ¸…é™¤ localStorage ä¸­çš„é–€å¸‚è³‡æ–™
                localStorage.removeItem('ecpay_store_data');
                
            } catch (error) {
                console.error('âŒ è§£æé–€å¸‚è³‡æ–™å¤±æ•—ï¼š', error);
                localStorage.removeItem('ecpay_store_data');
            }
        }
    }, 500);
    
    // 30ç§’å¾Œè‡ªå‹•åœæ­¢ç›£è½
    setTimeout(() => {
        if (storeDataCheckInterval) {
            console.log('â±ï¸ ç›£è½é€¾æ™‚ï¼Œåœæ­¢ç›£è½');
            clearInterval(storeDataCheckInterval);
            storeDataCheckInterval = null;
        }
    }, 30000);
}

/**
 * ğŸ†• è™•ç†é–€å¸‚è³‡æ–™
 */
function processStoreData(storeData) {
    console.log('========================================');
    console.log('ğŸ“¦ é–‹å§‹è™•ç†é–€å¸‚è³‡æ–™');
    console.log('========================================');
    
    if (!storeData) {
        console.error('âŒ é–€å¸‚è³‡æ–™ç‚ºç©º');
        showToast('é–€å¸‚è³‡æ–™ç‚ºç©º', 'error');
        return;
    }
    
    // é©—è­‰è¨‚å–®ç·¨è™Ÿ
    const savedTradeNo = localStorage.getItem('ecpay_merchant_trade_no');
    console.log('å„²å­˜çš„è¨‚å–®ç·¨è™Ÿï¼š', savedTradeNo);
    console.log('å›å‚³çš„è¨‚å–®ç·¨è™Ÿï¼š', storeData.MerchantTradeNo);
    
    if (storeData.MerchantTradeNo !== savedTradeNo) {
        console.error('âŒ è¨‚å–®ç·¨è™Ÿä¸ç¬¦ï¼');
        showToast('é–€å¸‚è³‡æ–™é©—è­‰å¤±æ•—', 'error');
        return;
    }
    
    // å„²å­˜é–€å¸‚è³‡æ–™
    selectedStore = {
        id: storeData.CVSStoreID,
        name: storeData.CVSStoreName,
        address: storeData.CVSAddress,
        phone: storeData.CVSTelephone
    };
    
    console.log('âœ… å·²å„²å­˜é–€å¸‚ï¼š', selectedStore);
    
    // é¡¯ç¤ºé–€å¸‚è³‡è¨Š
    displaySelectedStore();
    
    // æ¸…é™¤è¨‚å–®ç·¨è™Ÿ
    localStorage.removeItem('ecpay_merchant_trade_no');
    
    // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
    showToast('âœ… é–€å¸‚é¸æ“‡æˆåŠŸï¼', 'success');
    
    console.log('========================================');
}

// window.opener ç›´æ¥å‘¼å«ï¼ˆåŒåŸŸæ™‚ï¼‰
window.receiveStoreData = function(storeData) {
    console.log('âœ… receiveStoreData è¢«å‘¼å«ï¼ˆwindow.opener æ–¹å¼ï¼‰');
    processStoreData(storeData);
};

// âœ… postMessage ç›£è½ï¼ˆè·¨åŸŸæ™‚ï¼ŒGAS å›å‚³çš„å½ˆçª—ç”¨é€™å€‹ï¼‰
window.addEventListener('message', function(event) {
    if (!event.data || event.data.type !== 'ecpay_store') return;
    console.log('âœ… æ”¶åˆ° postMessage é–€å¸‚è³‡æ–™:', event.data.data);
    processStoreData(event.data.data);
});

/**
 * ğŸ†• é¡¯ç¤ºå·²é¸æ“‡çš„é–€å¸‚è³‡è¨Š
 */
function displaySelectedStore() {
    console.log('displaySelectedStore è¢«å‘¼å«ï¼ŒselectedStoreï¼š', selectedStore);
    
    if (!selectedStore) {
        // æ²’æœ‰é¸æ“‡é–€å¸‚ï¼Œéš±è—é–€å¸‚è³‡è¨Šå€å¡Š
        const infoElement = document.getElementById('selectedStoreInfo');
        if (infoElement) {
            infoElement.classList.remove('active');
        }
        return;
    }
    
    // æœ‰é¸æ“‡é–€å¸‚ï¼Œé¡¯ç¤ºé–€å¸‚è³‡è¨Š
    const infoElement = document.getElementById('selectedStoreInfo');
    if (infoElement) {
        infoElement.classList.add('active');
        document.getElementById('storeName').textContent = selectedStore.name || '';
        document.getElementById('storeAddress').textContent = selectedStore.address || '';
        document.getElementById('storePhone').textContent = selectedStore.phone || '';
        console.log('âœ… é–€å¸‚è³‡è¨Šå·²é¡¯ç¤ºåœ¨é é¢ä¸Š');
        // é¡¯ç¤ºä»˜æ¬¾æ–¹å¼é¸æ“‡
        showStorePaymentMethod();
    } else {
        console.error('âŒ æ‰¾ä¸åˆ° selectedStoreInfo å…ƒç´ ');
    }
}

/**
 * ğŸ†• æ¸…é™¤é¸æ“‡çš„é–€å¸‚
 */
function clearSelectedStore() {
    selectedStore = null;
    displaySelectedStore();
    showToast('å·²æ¸…é™¤é–€å¸‚é¸æ“‡', 'success');
}

// ==========================================
// è¼‰å…¥å•†å“è³‡æ–™
// ==========================================
async function loadProductsData() {
    try {
        showToast('è¼‰å…¥å•†å“è³‡æ–™ä¸­...', 'success');
        
        // è¼‰å…¥å•†å“åˆ—è¡¨
        const productsUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${PRODUCTS_SHEET}?key=${API_KEY}`;
        const productsResponse = await fetch(productsUrl);
        
        if (!productsResponse.ok) throw new Error('ç„¡æ³•è¼‰å…¥å•†å“è³‡æ–™');
        
        const productsData = await productsResponse.json();
        
        if (!productsData.values || productsData.values.length < 2) {
            throw new Error('å•†å“è³‡æ–™ç‚ºç©º');
        }

        products = productsData.values.slice(1).map(row => ({
            id: row[0] || '',
            name: row[1] || '',
            image: row[2] || '',
            isFeatured: (row[3] || '').trim() === 'æ˜¯',  // Dæ¬„ï¼šä¸»æ‰“ï¼Œå¡«ã€Œæ˜¯ã€è¡¨ç¤ºä¸»æ‰“
            category: row[4] || '',  // Eæ¬„ï¼šå•†å“é¡åˆ¥ï¼ˆå£å‘³åˆ†é¡ï¼Œå¦‚ PLOOMè›‹ã€GLOè›‹ï¼‰
            tags: (row[5] || '').split(',').map(t => t.trim()).filter(t => t),  // Fæ¬„ï¼šå¤§åˆ†é¡æ¨™ç±¤
            customBlock: (row[6] || '').trim(),  // ğŸ†• Gæ¬„ï¼šè‡ªå®šç¾©å€å¡Šåç¨±ï¼ˆå¡«å€å¡Šåç¨±å³åŠ å…¥è©²å€å¡Šï¼‰
            price: 0,
            stock: 0
        })).filter(p => p.id);

        // è¼‰å…¥å•†å“è¦æ ¼è¡¨
        const specsUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SPECS_SHEET}?key=${API_KEY}`;
        const specsResponse = await fetch(specsUrl);
        
        if (!specsResponse.ok) throw new Error('ç„¡æ³•è¼‰å…¥è¦æ ¼è³‡æ–™');
        
        const specsData = await specsResponse.json();
        
        if (specsData.values && specsData.values.length > 1) {
            specsData.values.slice(1).forEach(row => {
                const productId = row[0];
                const _salePrice = parseInt(row[3]) || 0;
                const _normalPrice = parseInt(row[5]) || 0;
                const spec = {
                    productId: row[0] || '',
                    productName: row[1] || '',
                    specName: row[2] || '',
                    price: _salePrice > 0 ? _salePrice : _normalPrice,  // Dæœ‰ç‰¹åƒ¹ç”¨ç‰¹åƒ¹ï¼Œå¦å‰‡ç”¨FåŸåƒ¹
                    originalPrice: _salePrice > 0 ? _normalPrice : 0,   // æœ‰ç‰¹åƒ¹æ‰é¡¯ç¤ºåŠƒç·šåŸåƒ¹
                    stock: parseInt(row[4]) || 0,
                    image: '',                                  // ç„¡åœ–ç‰‡æ¬„
                    quantityMultiplier: parseInt(row[6]) || 1   // Gæ¬„ï¼šå€æ•¸
                };
                
                if (!productSpecs[productId]) {
                    productSpecs[productId] = [];
                }
                productSpecs[productId].push(spec);
            });
            
            // æ›´æ–°å•†å“çš„åƒ¹æ ¼å’Œåº«å­˜
            products.forEach(product => {
                const specs = productSpecs[product.id];
                if (specs && specs.length > 0) {
                    product.price = Math.min(...specs.map(s => s.price));
                    product.stock = specs.reduce((sum, spec) => sum + spec.stock, 0);
                }
            });
        }

        // ğŸ”¥ å…ˆè¼‰å…¥åˆ†é¡ç…§ç‰‡è¨­å®šï¼Œå†é¡¯ç¤ºå•†å“
        await loadCategoryImages();   // ç­‰å¾…è¼‰å…¥å®Œæˆ
        
        displayFeaturedProducts();  // é¡¯ç¤ºä¸»æ‰“å•†å“
        displayProducts();          // é¡¯ç¤ºæ‰€æœ‰å•†å“
        loadCategories();           // ğŸ†• è¼‰å…¥ä¸¦ç”Ÿæˆåˆ†é¡æŒ‰éˆ•
        loadAnnouncements();        // ğŸ†• è¼‰å…¥å…¬å‘Š
        loadPromotions();           // ğŸ†• è¼‰å…¥å„ªæƒ è¨­å®š
        showToast('å•†å“è¼‰å…¥å®Œæˆ!', 'success');
        
    } catch (error) {
        console.error('è¼‰å…¥å•†å“å¤±æ•—:', error);
        showToast('è¼‰å…¥å•†å“å¤±æ•—ï¼š' + error.message, 'error');
    }
}

// ==========================================
// ğŸ†• å…¬å‘Šåˆ—åŠŸèƒ½
// ==========================================

/**
 * è¼‰å…¥å…¬å‘Šè³‡æ–™
 */
async function loadAnnouncements() {
    try {
        const announcementUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${ANNOUNCEMENT_SHEET}?key=${API_KEY}`;
        const response = await fetch(announcementUrl);
        
        if (!response.ok) {
            console.log('æ‰¾ä¸åˆ°å…¬å‘Šè¨­å®šå·¥ä½œè¡¨ï¼Œè·³éå…¬å‘Šè¼‰å…¥');
            return;
        }
        
        const data = await response.json();
        
        if (!data.values || data.values.length < 2) {
            console.log('å…¬å‘Šè³‡æ–™ç‚ºç©º');
            return;
        }
        
        // è§£æå…¬å‘Šè³‡æ–™
        // æ ¼å¼ï¼šAæ¬„=å…¬å‘Šå…§å®¹, Bæ¬„=å•Ÿç”¨ç‹€æ…‹ï¼ˆæ˜¯/å¦ï¼‰, Cæ¬„=é€£çµ(å¯é¸)
        announcements = data.values.slice(1)
            .filter(row => row[0] && (row[1] || '').trim() === 'æ˜¯')  // åªå–å•Ÿç”¨çš„å…¬å‘Š
            .map(row => ({
                text: row[0] || '',
                link: row[2] || ''
            }));
        
        if (announcements.length > 0) {
            displayAnnouncements();
        }
        
    } catch (error) {
        console.error('è¼‰å…¥å…¬å‘Šå¤±æ•—:', error);
    }
}

/**
 * é¡¯ç¤ºå…¬å‘Š
 */
function displayAnnouncements() {
    const announcementBar = document.getElementById('announcementBar');
    const announcementText = document.getElementById('announcementText');
    
    if (announcements.length === 0) {
        announcementBar.classList.remove('active');
        return;
    }
    
    announcementBar.classList.add('active');
    
    if (announcements.length === 1) {
        // å–®å‰‡å…¬å‘Šï¼šä½¿ç”¨è·‘é¦¬ç‡ˆæ•ˆæœ
        const announcement = announcements[0];
        announcementText.textContent = announcement.text;
        announcementText.classList.add('marquee');
        announcementText.classList.remove('fade');
        
        // å¦‚æœæœ‰é€£çµï¼Œè¨­å®šé»æ“Šäº‹ä»¶
        if (announcement.link) {
            announcementBar.style.cursor = 'pointer';
            announcementBar.onclick = () => {
                window.open(announcement.link, '_blank');
            };
        }
    } else {
        // å¤šå‰‡å…¬å‘Šï¼šä½¿ç”¨è¼ªæ’­æ•ˆæœ
        let currentIndex = 0;
        announcementText.classList.remove('marquee');
        announcementText.classList.add('fade');
        
        function rotateAnnouncement() {
            const announcement = announcements[currentIndex];
            
            // å…ˆæ·¡å‡º
            announcementText.style.opacity = '0';
            
            setTimeout(() => {
                announcementText.textContent = announcement.text;
                
                // æ›´æ–°é€£çµ
                if (announcement.link) {
                    announcementBar.style.cursor = 'pointer';
                    announcementBar.onclick = () => {
                        window.open(announcement.link, '_blank');
                    };
                } else {
                    announcementBar.style.cursor = 'default';
                    announcementBar.onclick = null;
                }
                
                // æ·¡å…¥
                announcementText.style.opacity = '1';
                
                currentIndex = (currentIndex + 1) % announcements.length;
            }, 300);
        }
        
        // åˆå§‹é¡¯ç¤ºç¬¬ä¸€å‰‡
        rotateAnnouncement();
        
        // æ¯ 5 ç§’åˆ‡æ›ä¸€æ¬¡
        setInterval(rotateAnnouncement, 5000);
    }
}

// ==========================================
// ğŸ†• å„ªæƒ ç³»çµ±
// ==========================================

/**
 * è¼‰å…¥å„ªæƒ è¨­å®š
 */
async function loadPromotions() {
    try {
        const promotionUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${PROMOTION_SHEET}?key=${API_KEY}`;
        const response = await fetch(promotionUrl);
        
        if (!response.ok) {
            console.log('æ‰¾ä¸åˆ°å„ªæƒ è¨­å®šå·¥ä½œè¡¨ï¼Œè·³éå„ªæƒ è¼‰å…¥');
            return;
        }
        
        const data = await response.json();
        
        if (!data.values || data.values.length < 2) {
            console.log('å„ªæƒ è³‡æ–™ç‚ºç©º');
            return;
        }
        
        // è§£æå„ªæƒ è³‡æ–™
        // ğŸ†• æ–°å¢ Hã€I æ¬„ï¼šé©ç”¨é¡åˆ¥ã€é©ç”¨è¦æ ¼
        // æ ¼å¼ï¼š
        // Aæ¬„=å„ªæƒ åç¨±
        // Bæ¬„=å„ªæƒ é¡å‹ï¼ˆæ»¿ä»¶æŠ˜æ‰£/æ»¿é¡æŠ˜æ‰£/æ»¿é¡å…é‹ï¼‰
        // Cæ¬„=å–®ä½ï¼ˆæ¢/åŒ…/å…ƒï¼‰
        // Dæ¬„=æ¢ä»¶æ•¸é‡/é‡‘é¡
        // Eæ¬„=æŠ˜æ‰£é‡‘é¡
        // Fæ¬„=å•Ÿç”¨ç‹€æ…‹ï¼ˆæ˜¯/å¦ï¼‰
        // Gæ¬„=èªªæ˜æ–‡å­—
        // Hæ¬„=é©ç”¨é¡åˆ¥ï¼ˆç©ºç™½=å…¨éƒ¨ï¼Œæˆ–å¡«å¯«é¡åˆ¥ï¼Œå¤šå€‹ç”¨é€—è™Ÿåˆ†éš”ï¼‰ğŸ†•
        // Iæ¬„=é©ç”¨è¦æ ¼ï¼ˆç©ºç™½=å…¨éƒ¨ï¼Œæˆ–å¡«å¯«ï¼šå–®åŒ…/æ¢ï¼‰ğŸ†•
        promotions = data.values.slice(1)
            .filter(row => row[0] && (row[5] || '').trim() === 'æ˜¯')  // Fæ¬„ï¼šå•Ÿç”¨
            .map(row => ({
                name: row[0] || '',
                type: row[1] || '',
                unit: row[2] || '',
                threshold: parseFloat(row[3]) || 0,
                discount: parseFloat(row[4]) || 0,
                description: row[6] || '',
                allowedCategories: row[7] ? row[7].split(',').map(c => c.trim()).filter(c => c) : [],  // ğŸ†• é©ç”¨é¡åˆ¥
                allowedSpecs: row[8] ? row[8].split(',').map(s => s.trim()).filter(s => s) : []        // ğŸ†• é©ç”¨è¦æ ¼
            }));
        
        console.log('å·²è¼‰å…¥å„ªæƒ :', promotions);
        
    } catch (error) {
        console.error('è¼‰å…¥å„ªæƒ å¤±æ•—:', error);
    }
}

/**
 * è¨ˆç®—å„ªæƒ æŠ˜æ‰£
 * @param {Array} cartItems - è³¼ç‰©è»Šå•†å“
 * @returns {Object} å„ªæƒ è©³æƒ…
 */

// é¡¯ç¤ºåƒ¹æ ¼ï¼ˆå«åŸåƒ¹åŠƒç·šï¼‰
function renderSpecPrice(spec) {
    const el = document.getElementById('specInfoPrice');
    if (!el) return;
    if (spec.originalPrice && spec.originalPrice > spec.price) {
        el.innerHTML = `$${spec.price} <span class="spec-original-price">$${spec.originalPrice}</span><span class="sale-badge">ç‰¹åƒ¹ä¸­</span>`;
    } else {
        el.textContent = `$${spec.price}`;
    }
}

function calculatePromotions(cartItems) {
    const result = {
        appliedPromotions: [],  // å·²å¥—ç”¨çš„å„ªæƒ 
        totalDiscount: 0,       // ç¸½æŠ˜æ‰£é‡‘é¡
        freeShipping: false,    // æ˜¯å¦å…é‹
        messages: []            // å„ªæƒ è¨Šæ¯
    };
    
    if (promotions.length === 0 || cartItems.length === 0) {
        return result;
    }
    
    // é€ä¸€æª¢æŸ¥æ¯å€‹å„ªæƒ 
    promotions.forEach(promo => {
        // ğŸ†• éæ¿¾ç¬¦åˆæ¢ä»¶çš„å•†å“
        const eligibleItems = cartItems.filter(item => {
            // æª¢æŸ¥é¡åˆ¥é™åˆ¶
            if (promo.allowedCategories.length > 0) {
                // æ‰¾å‡ºè©²å•†å“çš„é¡åˆ¥
                const product = products.find(p => p.id === item.productId);
                if (!product || !promo.allowedCategories.includes(product.category)) {
                    return false;  // ä¸ç¬¦åˆé¡åˆ¥é™åˆ¶
                }
            }
            
            // æª¢æŸ¥è¦æ ¼é™åˆ¶
            if (promo.allowedSpecs.length > 0) {
                if (!promo.allowedSpecs.includes(item.specName)) {
                    return false;  // ä¸ç¬¦åˆè¦æ ¼é™åˆ¶
                }
            }
            
            return true;  // ç¬¦åˆæ‰€æœ‰é™åˆ¶
        });
        
        if (eligibleItems.length === 0) {
            return;  // æ²’æœ‰ç¬¦åˆçš„å•†å“ï¼Œè·³éæ­¤å„ªæƒ 
        }
        
        // ğŸ†• è¨ˆç®—ç¬¦åˆæ¢ä»¶çš„å•†å“çµ±è¨ˆ
        const stats = {
            totalAmount: eligibleItems.reduce((sum, item) => sum + (item.price * item.quantity), 0),
            totalBoxes: 0,
            totalPacks: 0
        };
        
        eligibleItems.forEach(item => {
            const multiplier = item.quantityMultiplier || 1;
            if (multiplier === 10) {
                stats.totalBoxes += item.quantity;
                stats.totalPacks += item.quantity * 10;
            } else {
                stats.totalPacks += item.quantity;
            }
        });
        
        let applied = false;
        let discount = 0;
        
        switch (promo.type) {
            case 'æ»¿ä»¶æŠ˜æ‰£':
                if (promo.unit === 'æ¢') {
                    if (stats.totalBoxes >= promo.threshold) {
                        discount = stats.totalBoxes * promo.discount;
                        applied = true;
                    }
                } else if (promo.unit === 'åŒ…') {
                    if (stats.totalPacks >= promo.threshold) {
                        discount = stats.totalPacks * promo.discount;
                        applied = true;
                    }
                }
                break;
                
            case 'æ»¿é¡æŠ˜æ‰£':
                if (stats.totalAmount >= promo.threshold) {
                    discount = promo.discount;
                    applied = true;
                }
                break;
                
            case 'æ»¿é¡å…é‹':
                // ğŸ†• å…é‹å„ªæƒ æ”¹ç”¨å…¨éƒ¨å•†å“é‡‘é¡ï¼ˆä¸é™åˆ¶é¡åˆ¥ï¼‰
                const allAmount = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                if (allAmount >= promo.threshold) {
                    result.freeShipping = true;
                    applied = true;
                }
                break;
        }
        
        if (applied) {
            result.appliedPromotions.push({
                name: promo.name,
                type: promo.type,
                discount: discount,
                description: promo.description
            });
            
            if (discount > 0) {
                result.totalDiscount += discount;
            }
            
            // ç”Ÿæˆå„ªæƒ è¨Šæ¯
            if (promo.type === 'æ»¿é¡å…é‹') {
                result.messages.push(`âœ… ${promo.name}ï¼šå…é‹è²»`);
            } else if (discount > 0) {
                result.messages.push(`âœ… ${promo.name}ï¼šæŠ˜æ‰£ $${discount}`);
            }
        }
    });
    
    return result;
}

/**
 * é¡¯ç¤ºå„ªæƒ æç¤ºï¼ˆåœ¨è³¼ç‰©è»Šæˆ–çµå¸³é é¢ï¼‰
 */
function displayPromotionHints(cartItems) {
    if (promotions.length === 0) return '';
    
    const hints = [];
    
    promotions.forEach(promo => {
        // âœ… å…ˆéæ¿¾ç¬¦åˆæ­¤å„ªæƒ æ¢ä»¶çš„å•†å“ï¼ˆè·Ÿ calculatePromotions é‚è¼¯ä¸€è‡´ï¼‰
        const eligibleItems = cartItems.filter(item => {
            if (promo.allowedCategories.length > 0) {
                const product = products.find(p => p.id === item.productId);
                if (!product || !promo.allowedCategories.includes(product.category)) return false;
            }
            if (promo.allowedSpecs.length > 0) {
                if (!promo.allowedSpecs.includes(item.specName)) return false;
            }
            return true;
        });

        // è¨ˆç®—ç¬¦åˆæ¢ä»¶å•†å“çš„çµ±è¨ˆ
        const stats = {
            totalAmount: eligibleItems.reduce((sum, item) => sum + (item.price * item.quantity), 0),
            totalBoxes: 0,
            totalPacks: 0
        };
        eligibleItems.forEach(item => {
            const multiplier = item.quantityMultiplier || 1;
            if (multiplier === 10) {
                stats.totalBoxes += item.quantity;
                stats.totalPacks += item.quantity * 10;
            } else {
                stats.totalPacks += item.quantity;
            }
        });

        // âœ… çµ„æˆé¡åˆ¥æ‹¬è™Ÿæ–‡å­—
        const categoryLabel = promo.allowedCategories.length > 0
            ? `ï¼ˆ${promo.allowedCategories.join('ã€')}ï¼‰`
            : '';

        let hint = '';
        switch (promo.type) {
            case 'æ»¿ä»¶æŠ˜æ‰£':
                if (promo.unit === 'æ¢') {
                    if (stats.totalBoxes < promo.threshold) {
                        const needed = promo.threshold - stats.totalBoxes;
                        hint = `ğŸ’¡ å†è³¼è²· ${needed} æ¢å³å¯äº«ã€Œ${promo.name}ã€${categoryLabel}`;
                    }
                } else if (promo.unit === 'åŒ…') {
                    if (stats.totalPacks < promo.threshold) {
                        const needed = promo.threshold - stats.totalPacks;
                        hint = `ğŸ’¡ å†è³¼è²· ${needed} åŒ…å³å¯äº«ã€Œ${promo.name}ã€${categoryLabel}`;
                    }
                }
                break;
            case 'æ»¿é¡æŠ˜æ‰£':
            case 'æ»¿é¡å…é‹': {
                // å…é‹ç”¨å…¨éƒ¨é‡‘é¡ï¼Œå…¶ä»–ç”¨ç¬¦åˆæ¢ä»¶é‡‘é¡
                const checkAmount = promo.type === 'æ»¿é¡å…é‹'
                    ? cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0)
                    : stats.totalAmount;
                if (checkAmount < promo.threshold) {
                    const needed = promo.threshold - checkAmount;
                    hint = `ğŸ’¡ å†åŠ è³¼ $${needed} å³å¯äº«ã€Œ${promo.name}ã€${categoryLabel}`;
                }
                break;
            }
        }
        
        if (hint) hints.push(hint);
    });
    
    return hints.join('<br>');
}

// ==========================================
// ğŸ”¥ åªæ›´æ–°å·²è³¼è²·å•†å“çš„åº«å­˜ï¼ˆè¼•é‡ç´šæ›´æ–°ï¼‰
// ==========================================
async function updatePurchasedProductsStock(purchasedItems) {
    try {
        // è¼‰å…¥æœ€æ–°çš„å•†å“è¦æ ¼è¡¨
        const specsUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SPECS_SHEET}?key=${API_KEY}`;
        const specsResponse = await fetch(specsUrl);
        
        if (!specsResponse.ok) return;
        
        const specsData = await specsResponse.json();
        
        if (specsData.values && specsData.values.length > 1) {
            // åªæ›´æ–°å·²è³¼è²·å•†å“çš„è¦æ ¼
            const updatedProductIds = new Set();
            
            specsData.values.slice(1).forEach(row => {
                const productId = row[0];
                const specName = row[2] || '';
                
                // æª¢æŸ¥é€™å€‹è¦æ ¼æ˜¯å¦åœ¨è³¼è²·æ¸…å–®ä¸­
                const isPurchased = purchasedItems.some(item => 
                    item.productId === productId && item.specName === specName
                );
                
                if (isPurchased) {
                    // æ›´æ–°é€™å€‹è¦æ ¼çš„åº«å­˜
                    if (productSpecs[productId]) {
                        const spec = productSpecs[productId].find(s => s.specName === specName);
                        if (spec) {
                            spec.stock = parseInt(row[4]) || 0;
                            updatedProductIds.add(productId);
                        }
                    }
                }
            });
            
            // é‡æ–°è¨ˆç®—å—å½±éŸ¿å•†å“çš„ç¸½åº«å­˜
            updatedProductIds.forEach(productId => {
                const product = products.find(p => p.id === productId);
                if (product && productSpecs[productId]) {
                    product.stock = productSpecs[productId].reduce((sum, spec) => sum + spec.stock, 0);
                }
            });
            
            // åªé‡æ–°æ¸²æŸ“å•†å“é¡¯ç¤ºï¼ˆä¸é‡æ–°è¼‰å…¥åˆ†é¡ï¼‰
            displayFeaturedProducts();
            displayProducts();
            
            console.log('âœ… å·²æ›´æ–°', updatedProductIds.size, 'å€‹å•†å“çš„åº«å­˜');
        }
        
    } catch (error) {
        console.error('æ›´æ–°åº«å­˜å¤±æ•—:', error);
        // å¦‚æœè¼•é‡æ›´æ–°å¤±æ•—ï¼Œéœé»˜å¤±æ•—ï¼ˆç”¨æˆ¶ä¸‹æ¬¡é‡æ•´é é¢æ™‚æœƒçœ‹åˆ°æœ€æ–°åº«å­˜ï¼‰
    }
}

// ==========================================
// ğŸ”¥ å®šæœŸè‡ªå‹•åˆ·æ–°æ‰€æœ‰å•†å“åº«å­˜ï¼ˆè§£æ±ºå¤šäººåŒæ™‚ä¸‹å–®å•é¡Œï¼‰
// ==========================================
let autoRefreshInterval = null;

async function refreshAllStock() {
    try {
        // éœé»˜æ›´æ–°ï¼Œä¸é¡¯ç¤ºæç¤ºè¨Šæ¯
        const specsUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SPECS_SHEET}?key=${API_KEY}`;
        const specsResponse = await fetch(specsUrl);
        
        if (!specsResponse.ok) return;
        
        const specsData = await specsResponse.json();
        
        if (specsData.values && specsData.values.length > 1) {
            // æ¸…ç©ºä¸¦é‡å»ºè¦æ ¼æ•¸æ“š
            productSpecs = {};
            
            specsData.values.slice(1).forEach(row => {
                const productId = row[0];
                const _salePrice2 = parseInt(row[3]) || 0;
                const _normalPrice2 = parseInt(row[5]) || 0;
                const spec = {
                    productId: row[0] || '',
                    productName: row[1] || '',
                    specName: row[2] || '',
                    price: _salePrice2 > 0 ? _salePrice2 : _normalPrice2,
                    originalPrice: _salePrice2 > 0 ? _normalPrice2 : 0,
                    stock: parseInt(row[4]) || 0,
                    image: '',
                    quantityMultiplier: parseInt(row[6]) || 1
                };
                
                if (!productSpecs[productId]) {
                    productSpecs[productId] = [];
                }
                productSpecs[productId].push(spec);
            });
            
            // æ›´æ–°æ‰€æœ‰å•†å“çš„åº«å­˜
            products.forEach(product => {
                const specs = productSpecs[product.id];
                if (specs && specs.length > 0) {
                    product.stock = specs.reduce((sum, spec) => sum + spec.stock, 0);
                }
            });
            
            // é‡æ–°æ¸²æŸ“å•†å“é¡¯ç¤º
            displayFeaturedProducts();
            displayProducts();
            
            console.log('ğŸ”„ è‡ªå‹•åˆ·æ–°åº«å­˜å®Œæˆ -', new Date().toLocaleTimeString());
        }
        
    } catch (error) {
        console.error('è‡ªå‹•åˆ·æ–°åº«å­˜å¤±æ•—:', error);
    }
}

function startAutoRefresh(intervalSeconds = 30) {
    // æ¸…é™¤èˆŠçš„å®šæ™‚å™¨
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
    
    // è¨­ç½®æ–°çš„å®šæ™‚å™¨ï¼ˆé è¨­30ç§’åˆ·æ–°ä¸€æ¬¡ï¼‰
    autoRefreshInterval = setInterval(() => {
        refreshAllStock();
    }, intervalSeconds * 1000);
    
    console.log(`âœ… å·²å•Ÿå‹•è‡ªå‹•åˆ·æ–°ï¼Œæ¯ ${intervalSeconds} ç§’æ›´æ–°ä¸€æ¬¡åº«å­˜`);
}

function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
        console.log('â¹ï¸ å·²åœæ­¢è‡ªå‹•åˆ·æ–°');
    }
}

// ==========================================
// ğŸ†• è¼‰å…¥åˆ†é¡ç…§ç‰‡è¨­å®šï¼ˆå¾ã€Œåˆ†é¡ç…§ç‰‡è¨­å®šã€å·¥ä½œè¡¨ï¼‰
// ==========================================
let categoryImages = {};  // å„²å­˜åˆ†é¡ç…§ç‰‡è¨­å®š

async function loadCategoryImages() {
    try {
        const sheetName = 'åˆ†é¡ç…§ç‰‡è¨­å®š';
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${sheetName}?key=${API_KEY}`;
        
        const response = await fetch(url);
        if (response.ok) {
            const data = await response.json();
            if (data.values && data.values.length > 1) {
                // å¾å·¥ä½œè¡¨è®€å–åˆ†é¡ç…§ç‰‡è¨­å®š
                categoryImages = {};
                data.values.slice(1).forEach(row => {
                    const categoryName = row[0] || '';      // Aæ¬„ï¼šåˆ†é¡åç¨±
                    const imageUrl = row[1] || '';          // Bæ¬„ï¼šåœ–ç‰‡ç¶²å€
                    
                    if (categoryName && imageUrl) {
                        categoryImages[categoryName] = imageUrl;
                    }
                });
                
                console.log('âœ… å·²è¼‰å…¥åˆ†é¡ç…§ç‰‡è¨­å®šï¼š', categoryImages);
            }
        }
    } catch (error) {
        console.log('âš ï¸ æ²’æœ‰æ‰¾åˆ°ã€Œåˆ†é¡ç…§ç‰‡è¨­å®šã€å·¥ä½œè¡¨ï¼Œå°‡ä½¿ç”¨å•†å“åœ–ç‰‡');
    }
}

// ==========================================
// ğŸ†• è¼‰å…¥ä¸¦ç”Ÿæˆåˆ†é¡æŒ‰éˆ•ï¼ˆå¾ã€Œåˆ†é¡è¨­å®šã€å·¥ä½œè¡¨ï¼‰
// ==========================================
async function loadCategories() {
    try {
        // å¾ Google Sheets è®€å–ã€Œåˆ†é¡è¨­å®šã€å·¥ä½œè¡¨
        const categoriesSheetName = 'åˆ†é¡è¨­å®š';
        const categoriesUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${categoriesSheetName}?key=${API_KEY}`;
        
        categories = [];  // ğŸ”¥ ä½¿ç”¨å…¨åŸŸè®Šæ•¸
        
        try {
            const response = await fetch(categoriesUrl);
            if (response.ok) {
                const data = await response.json();
                if (data.values && data.values.length > 1) {
                    // å¾å·¥ä½œè¡¨è®€å–åˆ†é¡
                    categories = data.values.slice(1).map(row => ({
                        name: row[0] || '',                    // Aæ¬„ï¼šåˆ†é¡åç¨±
                        order: parseInt(row[1]) || 999,        // Bæ¬„ï¼šæ’åºé †åº
                        enabled: (row[2] || '').toString().toUpperCase() === 'TRUE'  // Cæ¬„ï¼šæ˜¯å¦å•Ÿç”¨ï¼ˆTRUE/FALSEï¼‰
                    }))
                    .filter(c => c.name && c.enabled)  // ğŸ”¥ åªä¿ç•™å·²å•Ÿç”¨çš„åˆ†é¡
                    .filter(c => c.name !== 'å…¨éƒ¨')    // ğŸ”¥ æ’é™¤ã€Œå…¨éƒ¨ã€åˆ†é¡ï¼ˆå› ç‚ºæœƒè‡ªå‹•ç”Ÿæˆï¼‰
                    .sort((a, b) => a.order - b.order);  // ä¾ç…§é †åºæ’åº
                    
                    console.log('âœ… å¾ã€Œåˆ†é¡è¨­å®šã€å·¥ä½œè¡¨è¼‰å…¥åˆ†é¡ï¼š', categories);
                }
            }
        } catch (err) {
            console.log('âš ï¸ æ²’æœ‰æ‰¾åˆ°ã€Œåˆ†é¡è¨­å®šã€å·¥ä½œè¡¨ï¼Œå°‡å¾å•†å“è³‡æ–™è‡ªå‹•ç”Ÿæˆåˆ†é¡');
        }
        
        // æ–¹æ³•2ï¼šå¦‚æœæ²’æœ‰åˆ†é¡è¡¨ï¼Œå°±å¾å•†å“è³‡æ–™çš„ Fæ¬„ï¼ˆtagsï¼‰æå–å”¯ä¸€åˆ†é¡
        if (categories.length === 0) {
            const allTags = new Set();
            products.forEach(p => {
                if (p.tags && p.tags.length > 0) {
                    p.tags.forEach(tag => allTags.add(tag));
                }
            });
            
            categories = [...allTags].map((name, index) => ({
                name: name,
                order: index + 1,
                enabled: true
            }));
            
            console.log('âœ… å¾å•†å“è³‡æ–™è‡ªå‹•ç”Ÿæˆåˆ†é¡ï¼š', categories);
        }
        
        // ç”Ÿæˆåˆ†é¡æŒ‰éˆ•
        const categoryTabs = document.getElementById('categoryTabs');
        
        // ä¿ç•™ã€Œå…¨éƒ¨ã€æŒ‰éˆ•ï¼Œæ¸…é™¤å…¶ä»–æŒ‰éˆ•
        categoryTabs.innerHTML = '<button class="category-tab active" onclick="filterCategory(\'all\')">å…¨éƒ¨</button>';
        
        // ç”Ÿæˆå…¶ä»–åˆ†é¡æŒ‰éˆ•
        categories.forEach(category => {
            const button = document.createElement('button');
            button.className = 'category-tab';
            button.onclick = () => filterCategory(category.name);
            button.textContent = category.name;
            categoryTabs.appendChild(button);
        });
        
        console.log(`âœ… å·²è¼‰å…¥ ${categories.length} å€‹å•Ÿç”¨çš„åˆ†é¡æŒ‰éˆ•`);
        
    } catch (error) {
        console.error('âŒ è¼‰å…¥åˆ†é¡æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š', error);
    }
}

/**
 * æ ¹æ“šåˆ†é¡åç¨±è‡ªå‹•é…å°åœ–æ¨™
 */
function getCategoryIcon(categoryName) {
    const iconMap = {
        'PLOOMç³»åˆ—': 'ğŸ”¥',
        'PLOOM': 'ğŸ”¥',
        'GLOç³»åˆ—': 'âœ¨',
        'GLO': 'âœ¨',
        'å¢ƒå…§ç³»åˆ—': 'ğŸ¯',
        'å¢ƒå…§': 'ğŸ¯',
        'æ©Ÿå­': 'ğŸ”§',
        'å…¶ä»–é…ä»¶': 'âš™ï¸',
        'é…ä»¶': 'âš™ï¸'
    };
    
    return iconMap[categoryName] || '';
}

// ==========================================
// ä¸»æ‰“å•†å“é¡¯ç¤º + è‡ªå®šç¾©å€å¡Šå¡ç‰‡
// ==========================================
function displayFeaturedProducts() {
    const featuredGrid = document.getElementById('featuredGrid');
    const featuredSection = document.getElementById('featuredSection');
    
    const featuredProducts = products.filter(p => p.isFeatured);
    
    // å–å¾—æ‰€æœ‰è‡ªå®šç¾©å€å¡Šåç¨±ï¼ˆå»é‡ï¼‰
    const customBlockNames = [...new Set(
        products.filter(p => p.customBlock).map(p => p.customBlock)
    )];
    
    // ä¸»æ‰“å’Œè‡ªå®šç¾©éƒ½æ²’æœ‰ â†’ éš±è—æ•´å€‹å€å¡Š
    if (featuredProducts.length === 0 && customBlockNames.length === 0) {
        featuredSection.style.display = 'none';
        return;
    }
    
    featuredSection.style.display = 'block';
    featuredGrid.innerHTML = '';
    
    // â”€â”€ ä¸»æ‰“å•†å“å¡ç‰‡ â”€â”€
    if (featuredProducts.length > 0) {
        let totalStock = 0, minPrice = Infinity, maxPrice = 0;
        featuredProducts.forEach(product => {
            const specs = productSpecs[product.id];
            if (specs) specs.forEach(spec => {
                totalStock += spec.stock;
                if (spec.price < minPrice) minPrice = spec.price;
                if (spec.price > maxPrice) maxPrice = spec.price;
            });
        });
        
        let imageUrl = categoryImages['ä¸»æ‰“å•†å“'] || featuredProducts[0]?.image || '';
        if (imageUrl && !imageUrl.startsWith('http')) imageUrl = 'https://' + imageUrl;
        if (!imageUrl) imageUrl = 'https://via.placeholder.com/300x300/8B4513/FFFFFF?text=ä¸»æ‰“å•†å“';
        
        const card = document.createElement('div');
        card.className = 'product-card';
        card.onclick = () => openFeaturedCategoryModal();
        const featuredHasSale = featuredProducts.some(p => productSpecs[p.id]?.some(s => s.originalPrice > 0));
        card.innerHTML = `
            <div class="featured-badge">â­ ä¸»æ‰“æ¨è–¦</div>
            ${featuredHasSale ? '<div class="card-sale-badge">ğŸ”¥ ç‰¹åƒ¹ä¸­</div>' : ''}
            <div class="product-image">
                <img src="${imageUrl}" alt="ä¸»æ‰“å•†å“" onerror="this.src='https://via.placeholder.com/300x300/8B4513/FFFFFF?text=ä¸»æ‰“å•†å“'">
            </div>
            <div class="product-name">ä¸»æ‰“å•†å“</div>
            <div class="product-price">$${minPrice}${minPrice !== maxPrice ? ` - $${maxPrice}` : ''}</div>
            <div class="product-stock">åº«å­˜:${totalStock} ä»¶</div>
            <button class="add-to-cart-btn" onclick="event.stopPropagation(); openFeaturedCategoryModal()">é¸æ“‡è¦æ ¼</button>
        `;
        featuredGrid.appendChild(card);
    }
    
    // â”€â”€ è‡ªå®šç¾©å€å¡Šå¡ç‰‡ï¼ˆæ¯å€‹å€å¡Šåç¨±ä¸€å¼µå¡ï¼‰â”€â”€
    customBlockNames.forEach(blockName => {
        const blockProducts = products.filter(p => p.customBlock === blockName);
        
        let totalStock = 0, minPrice = Infinity, maxPrice = 0;
        blockProducts.forEach(product => {
            const specs = productSpecs[product.id];
            if (specs) specs.forEach(spec => {
                totalStock += spec.stock;
                if (spec.price < minPrice) minPrice = spec.price;
                if (spec.price > maxPrice) maxPrice = spec.price;
            });
        });
        if (minPrice === Infinity) minPrice = 0;
        
        // åœ–ç‰‡å„ªå…ˆç”¨ã€Œåˆ†é¡ç…§ç‰‡è¨­å®šã€ï¼Œå¦å‰‡ç”¨ç¬¬ä¸€å€‹å•†å“çš„åœ–ç‰‡
        let imageUrl = categoryImages[blockName] || blockProducts[0]?.image || '';
        if (imageUrl && !imageUrl.startsWith('http')) imageUrl = 'https://' + imageUrl;
        if (!imageUrl) imageUrl = `https://via.placeholder.com/300x300/1a1a2e/FFD700?text=${encodeURIComponent(blockName)}`;
        
        const priceText = minPrice === maxPrice ? `$${minPrice}` : `$${minPrice} - $${maxPrice}`;
        
        const blockHasSale = blockProducts.some(p => productSpecs[p.id]?.some(s => s.originalPrice > 0));
        const card = document.createElement('div');
        card.className = 'product-card custom-block-card';
        card.onclick = () => openCustomBlockModal(blockName);
        card.innerHTML = `
            <div class="custom-block-badge">ğŸ¯ ç²¾é¸</div>
            ${blockHasSale ? '<div class="card-sale-badge">ğŸ”¥ ç‰¹åƒ¹ä¸­</div>' : ''}
            <div class="product-image">
                <img src="${imageUrl}" alt="${blockName}" onerror="this.src='https://via.placeholder.com/300x300/1a1a2e/FFD700?text=${encodeURIComponent(blockName)}'">
            </div>
            <div class="product-name">${blockName}</div>
            <div class="product-price">${priceText}</div>
            <div class="product-stock">åº«å­˜:${totalStock} ä»¶</div>
            <button class="add-to-cart-btn" onclick="event.stopPropagation(); openCustomBlockModal('${blockName}')">é¸æ“‡è¦æ ¼</button>
        `;
        featuredGrid.appendChild(card);
    });
}

// ==========================================
// ğŸ†• è‡ªå®šç¾©å€å¡Šï¼šé–‹å•Ÿå½ˆçª—ï¼ˆç¬¬ä¸€å±¤ - é¸å£å‘³ï¼‰
// é‚è¼¯èˆ‡ä¸»æ‰“å•†å“å®Œå…¨ä¸€è‡´
// ==========================================
function openCustomBlockModal(blockName) {
    currentCategoryProducts = products.filter(p => p.customBlock === blockName);
    
    if (currentCategoryProducts.length === 0) {
        showToast('æ­¤å€å¡Šç›®å‰ç„¡å•†å“', 'error');
        return;
    }
    
    document.getElementById('specModalTitle').textContent = blockName;
    document.getElementById('specModal').classList.add('active');
    history.pushState({ modal: 'spec' }, '');
    isModalOpen = true;
    
    // è¨ˆç®—çµ±è¨ˆ
    let totalStock = 0, minPrice = Infinity, maxPrice = 0;
    currentCategoryProducts.forEach(product => {
        const specs = productSpecs[product.id];
        if (specs) specs.forEach(spec => {
            totalStock += spec.stock;
            if (spec.price < minPrice) minPrice = spec.price;
            if (spec.price > maxPrice) maxPrice = spec.price;
        });
    });
    if (minPrice === Infinity) minPrice = 0;
    
    // å°åœ–å·²ç§»é™¤
    document.getElementById('specInfoPrice').textContent = minPrice === maxPrice ? `$${minPrice}` : `$${minPrice} - $${maxPrice}`;
    document.getElementById('specInfoStock').textContent = `åº«å­˜ï¼š${totalStock} ä»¶`;
    document.getElementById('specInfoStock').style.color = 'var(--accent-green)';
    
    // æ¸²æŸ“å•†å“å£å‘³é¸é …ï¼ˆèˆ‡ä¸»æ‰“å•†å“å®Œå…¨ç›¸åŒæ ¼å¼ï¼‰
    const optionsContainer = document.getElementById('specOptions');
    const flavorTitle = `<div class="spec-section-title" style="grid-column:1/-1;">ğŸ¯ é¸æ“‡å•†å“ (${currentCategoryProducts.length} ç¨®é¸é …)</div>`;
    const flavorOptions = currentCategoryProducts.map((product, index) => {
        const specs = productSpecs[product.id];
        const hasStock = specs && specs.some(s => s.stock > 0);
        return `
            <div class="spec-option ${!hasStock ? 'out-of-stock' : ''}"
                 onclick="selectFlavor(${index})" id="flavor-${index}"
                 title="${product.name}${!hasStock ? ' - å·²å”®å®Œ' : ''}">
                <div class="spec-name">${product.name}${!hasStock ? ' âŒ' : ''}</div>
            </div>`;
    }).join('');
    optionsContainer.innerHTML = flavorTitle + flavorOptions;
    
    selectedFlavor = null; selectedSpec = null; quantity = 1;
    updateQuantityDisplay(); updateAddToCartButton();
}

// ==========================================
// ä¸»æ‰“å•†å“ï¼šç¬¬ä¸€å±¤ - é¸æ“‡å•†å“ï¼ˆå£å‘³ï¼‰
// ==========================================
function openFeaturedCategoryModal() {
    // å–å¾—æ‰€æœ‰ä¸»æ‰“å•†å“
    currentCategoryProducts = products.filter(p => p.isFeatured);
    
    if (currentCategoryProducts.length === 0) {
        showToast('ç›®å‰æ²’æœ‰ä¸»æ‰“å•†å“', 'error');
        return;
    }
    
    // è¨­ç½®å½ˆçª—æ¨™é¡Œç‚ºã€Œä¸»æ‰“å•†å“ã€
    document.getElementById('specModalTitle').textContent = 'ä¸»æ‰“å•†å“';
    document.getElementById('specModal').classList.add('active');
    
    // ğŸ”¥ æ·»åŠ æ­·å²è¨˜éŒ„ï¼Œè®“è¿”å›éµå¯ä»¥é—œé–‰å½ˆçª—
    history.pushState({ modal: 'spec' }, '');
    isModalOpen = true;
    
    // æ¸²æŸ“ä¸»æ‰“å•†å“é¸é …
    renderFeaturedFlavorOptions();
    
    // é‡ç½®é¸æ“‡ç‹€æ…‹
    selectedFlavor = null;
    selectedSpec = null;
    quantity = 1;
    updateQuantityDisplay();
    updateAddToCartButton();
}

function renderFeaturedFlavorOptions() {
    const optionsContainer = document.getElementById('specOptions');
    const imageContainer = null; // å°åœ–å·²ç§»é™¤
    const priceDisplay = document.getElementById('specInfoPrice');
    const stockDisplay = document.getElementById('specInfoStock');
    
    // è¨ˆç®—ç¸½é«”ä¿¡æ¯
    let totalStock = 0;
    let minPrice = Infinity;
    let maxPrice = 0;
    
    currentCategoryProducts.forEach(product => {
        const specs = productSpecs[product.id];
        if (specs && specs.length > 0) {
            specs.forEach(spec => {
                totalStock += spec.stock;
                if (spec.price < minPrice) minPrice = spec.price;
                if (spec.price > maxPrice) maxPrice = spec.price;
            });
        }
    });
    
    // æ›´æ–°åœ–ç‰‡ï¼ˆä½¿ç”¨ç¬¬ä¸€å€‹å•†å“çš„åœ–ç‰‡ï¼‰
    let imageUrl = currentCategoryProducts[0].image || '';
    if (imageUrl && !imageUrl.startsWith('http://') && !imageUrl.startsWith('https://')) {
        imageUrl = 'https://' + imageUrl;
    }
    if (!imageUrl) {
        imageUrl = `https://via.placeholder.com/300x300/8B4513/FFFFFF?text=ä¸»æ‰“å•†å“`;
    }
    // å°åœ–å·²ç§»é™¤
    
    // æ›´æ–°åƒ¹æ ¼å’Œåº«å­˜
    priceDisplay.textContent = minPrice === maxPrice ? `$${minPrice}` : `$${minPrice} - $${maxPrice}`;
    stockDisplay.textContent = `åº«å­˜ï¼š${totalStock} ä»¶`;
    stockDisplay.style.color = 'var(--accent-green)';
    
    // ç”Ÿæˆå•†å“é¸é …ï¼ˆ2åˆ—ç¶²æ ¼å¸ƒå±€ï¼‰
    const flavorTitle = `<div class="spec-section-title" style="grid-column: 1 / -1;">ğŸ¯ é¸æ“‡å•†å“ (${currentCategoryProducts.length} ç¨®é¸é …)</div>`;
    
    const flavorOptions = currentCategoryProducts.map((product, index) => {
        const specs = productSpecs[product.id];
        const hasStock = specs && specs.some(s => s.stock > 0);
        const isOutOfStock = !hasStock;
        
        return `
            <div class="spec-option ${isOutOfStock ? 'out-of-stock' : ''}" 
                 onclick="selectFlavor(${index})"
                 id="flavor-${index}"
                 title="${product.name}${isOutOfStock ? ' - å·²å”®å®Œ' : ''}">
                <div class="spec-name">${product.name}${isOutOfStock ? ' âŒ' : ''}</div>
            </div>
        `;
    }).join('');
    
    optionsContainer.innerHTML = flavorTitle + flavorOptions;
}

// ==========================================
// å•†å“é¡¯ç¤º - é¡¯ç¤ºé¡åˆ¥å¡ç‰‡
// ==========================================
function displayProducts() {
    const grid = document.getElementById('productsGrid');
    
    if (products.length === 0) {
        grid.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">æš«ç„¡å•†å“</p>';
        return;
    }
    
    // ğŸ”¥ æ ¹æ“šç•¶å‰åˆ†é¡éæ¿¾å•†å“ï¼ˆä½¿ç”¨ Fæ¬„çš„ tagsï¼‰
    const filteredProducts = currentCategory === 'all' 
        ? products 
        : products.filter(p => p.tags && p.tags.includes(currentCategory));
    
    if (filteredProducts.length === 0) {
        grid.innerHTML = '<p style="text-align:center;color:#999;padding:40px;">æ­¤åˆ†é¡æš«ç„¡å•†å“</p>';
        return;
    }
    
    // æŒ‰é¡åˆ¥åˆ†çµ„çµ±è¨ˆï¼ˆä½¿ç”¨ Eæ¬„çš„ category ä½œç‚ºå£å‘³åˆ†é¡ï¼‰
    const categoriesMap = {};
    filteredProducts.forEach(product => {
        const category = product.category || 'å…¶ä»–';
        if (!categoriesMap[category]) {
            categoriesMap[category] = {
                name: category,
                products: [],
                totalStock: 0,
                minPrice: Infinity,
                maxPrice: 0,
                image: ''
            };
        }
        
        const specs = productSpecs[product.id];
        if (specs && specs.length > 0) {
            categoriesMap[category].products.push(product);
            
            // è¨ˆç®—ç¸½åº«å­˜å’Œåƒ¹æ ¼ç¯„åœ
            const totalStock = specs.reduce((sum, s) => sum + s.stock, 0);
            categoriesMap[category].totalStock += totalStock;
            
            const minPrice = Math.min(...specs.map(s => s.price));
            const maxPrice = Math.max(...specs.map(s => s.price));
            
            if (minPrice < categoriesMap[category].minPrice) {
                categoriesMap[category].minPrice = minPrice;
            }
            if (maxPrice > categoriesMap[category].maxPrice) {
                categoriesMap[category].maxPrice = maxPrice;
            }
            
            // ğŸ”¥ å„ªå…ˆä½¿ç”¨ã€Œåˆ†é¡ç…§ç‰‡è¨­å®šã€çš„åœ–ç‰‡ï¼Œå…¶æ¬¡ä½¿ç”¨ç¬¬ä¸€å€‹å•†å“çš„åœ–ç‰‡
            if (!categoriesMap[category].image) {
                // å¾ categoryImages ç‰©ä»¶ä¸­æ‰¾åˆ°å°æ‡‰çš„åˆ†é¡ç…§ç‰‡
                if (categoryImages[category]) {
                    categoriesMap[category].image = categoryImages[category];
                } else if (product.image) {
                    categoriesMap[category].image = product.image;
                }
            }
        }
    });
    
    // ç”Ÿæˆé¡åˆ¥å¡ç‰‡
    const categories = Object.values(categoriesMap);
    
    grid.innerHTML = categories.map(category => {
        // ä¿®æ­£åœ–ç‰‡ç¶²å€
        let imageUrl = category.image || '';
        if (imageUrl && !imageUrl.startsWith('http://') && !imageUrl.startsWith('https://')) {
            imageUrl = 'https://' + imageUrl;
        }
        if (!imageUrl) {
            imageUrl = `https://via.placeholder.com/300x300/8B4513/FFFFFF?text=${encodeURIComponent(category.name)}`;
        }
        
        return `
            <div class="product-card" onclick="openCategoryModal('${category.name}')">
                <div class="product-image">
                    <img src="${imageUrl}" alt="${category.name}" onerror="this.src='https://via.placeholder.com/300x300/8B4513/FFFFFF?text=${encodeURIComponent(category.name)}'">
                </div>
                <div class="product-name">${category.name}</div>
                <div class="product-price">$${category.minPrice}${category.minPrice !== category.maxPrice ? ` - $${category.maxPrice}` : ''}</div>
                <div class="product-stock">åº«å­˜:${category.totalStock} ä»¶</div>
                <button class="add-to-cart-btn" onclick="event.stopPropagation(); openCategoryModal('${category.name}')">
                    é¸æ“‡è¦æ ¼
                </button>
            </div>
        `;
    }).join('');
}

// ==========================================
// å•†å“åˆ†é¡éæ¿¾
// ==========================================
function filterCategory(category) {
    currentCategory = category;
    
    // æ›´æ–°æ¨™ç±¤ç‹€æ…‹
    document.querySelectorAll('.category-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // é‡æ–°æ¸²æŸ“å•†å“
    displayProducts();
    
    // æ»¾å‹•åˆ°å•†å“å€åŸŸ
    document.getElementById('productsGrid').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// ==========================================
// ç¬¬ä¸€å±¤ï¼šé¡åˆ¥é¸æ“‡å½ˆçª—
// ==========================================
let currentCategoryProducts = []; // ç•¶å‰é¡åˆ¥çš„æ‰€æœ‰å•†å“
let selectedFlavor = null; // é¸ä¸­çš„å£å‘³ï¼ˆå•†å“ï¼‰

function openCategoryModal(categoryName) {
    // ç²å–è©²é¡åˆ¥ä¸‹çš„æ‰€æœ‰å•†å“ï¼ˆå£å‘³ï¼‰
    currentCategoryProducts = products.filter(p => p.category === categoryName);
    
    if (currentCategoryProducts.length === 0) {
        showToast('æ­¤é¡åˆ¥æš«ç„¡å•†å“', 'error');
        return;
    }
    
    // è¨­ç½®å½ˆçª—æ¨™é¡Œ
    document.getElementById('specModalTitle').textContent = categoryName;
    document.getElementById('specModal').classList.add('active');
    
    // ğŸ”¥ æ·»åŠ æ­·å²è¨˜éŒ„ï¼Œè®“è¿”å›éµå¯ä»¥é—œé–‰å½ˆçª—
    history.pushState({ modal: 'spec' }, '');
    isModalOpen = true;
    
    // æ¸²æŸ“è©²é¡åˆ¥ä¸‹çš„æ‰€æœ‰å£å‘³é¸é …
    renderFlavorOptions(categoryName);
    
    // é‡ç½®é¸æ“‡ç‹€æ…‹
    selectedFlavor = null;
    selectedSpec = null;
    quantity = 1;
    updateQuantityDisplay();
    updateAddToCartButton();
}

function renderFlavorOptions(categoryName) {
    const optionsContainer = document.getElementById('specOptions');
    const imageContainer = null; // å°åœ–å·²ç§»é™¤
    const priceDisplay = document.getElementById('specInfoPrice');
    const stockDisplay = document.getElementById('specInfoStock');
    
    // è¨ˆç®—è©²é¡åˆ¥çš„ç¸½é«”ä¿¡æ¯
    let totalStock = 0;
    let minPrice = Infinity;
    let maxPrice = 0;
    
    currentCategoryProducts.forEach(product => {
        const specs = productSpecs[product.id];
        if (specs && specs.length > 0) {
            specs.forEach(spec => {
                totalStock += spec.stock;
                if (spec.price < minPrice) minPrice = spec.price;
                if (spec.price > maxPrice) maxPrice = spec.price;
            });
        }
    });
    
    // æ›´æ–°åœ–ç‰‡ï¼ˆä½¿ç”¨ç¬¬ä¸€å€‹å•†å“çš„åœ–ç‰‡ï¼‰
    let imageUrl = currentCategoryProducts[0].image || '';
    if (imageUrl && !imageUrl.startsWith('http://') && !imageUrl.startsWith('https://')) {
        imageUrl = 'https://' + imageUrl;
    }
    if (!imageUrl) {
        imageUrl = `https://via.placeholder.com/300x300/8B4513/FFFFFF?text=${encodeURIComponent(categoryName)}`;
    }
    // å°åœ–å·²ç§»é™¤
    
    // æ›´æ–°åƒ¹æ ¼å’Œåº«å­˜
    priceDisplay.textContent = minPrice === maxPrice ? `$${minPrice}` : `$${minPrice} - $${maxPrice}`;
    stockDisplay.textContent = `åº«å­˜ï¼š${totalStock} ä»¶`;
    stockDisplay.style.color = 'var(--accent-green)';
    
    // ç”Ÿæˆå£å‘³é¸é …ï¼ˆ2åˆ—ç¶²æ ¼å¸ƒå±€ï¼‰
    const flavorTitle = `<div class="spec-section-title" style="grid-column: 1 / -1;">ğŸ¯ é¸æ“‡å£å‘³ (${currentCategoryProducts.length} ç¨®é¸é …)</div>`;
    
    const flavorOptions = currentCategoryProducts.map((product, index) => {
        const specs = productSpecs[product.id];
        const hasStock = specs && specs.some(s => s.stock > 0);
        const isOutOfStock = !hasStock;
        
        return `
            <div class="spec-option ${isOutOfStock ? 'out-of-stock' : ''}" 
                 onclick="selectFlavor(${index})"
                 id="flavor-${index}"
                 title="${product.name}${isOutOfStock ? ' - å·²å”®å®Œ' : ''}">
                <div class="spec-name">${product.name}${isOutOfStock ? ' âŒ' : ''}</div>
            </div>
        `;
    }).join('');
    
    optionsContainer.innerHTML = flavorTitle + flavorOptions;
}

// ==========================================
// ç¬¬äºŒå±¤ï¼šé¸æ“‡å£å‘³å¾Œé¡¯ç¤ºæ•¸é‡è¦æ ¼é¸é …
// ==========================================
function selectFlavor(index) {
    const product = currentCategoryProducts[index];
    const specs = productSpecs[product.id];
    
    if (!specs || specs.length === 0) {
        showToast('æ­¤å£å‘³æš«ç„¡è¦æ ¼', 'error');
        return;
    }
    
    // æª¢æŸ¥æ˜¯å¦æœ‰åº«å­˜
    const hasStock = specs.some(s => s.stock > 0);
    if (!hasStock) {
        showToast('æ­¤å£å‘³å·²å”®å®Œ', 'error');
        return;
    }
    
    selectedFlavor = product;
    
    // æ›´æ–°å£å‘³é¸é …çš„é¸ä¸­ç‹€æ…‹
    document.querySelectorAll('[id^="flavor-"]').forEach((el, i) => {
        el.classList.toggle('selected', i === index);
    });
    
    // æ›´æ–°åœ–ç‰‡
    const imageContainer = null; // å°åœ–å·²ç§»é™¤
    let imageUrl = product.image || '';
    if (imageUrl && !imageUrl.startsWith('http://') && !imageUrl.startsWith('https://')) {
        imageUrl = 'https://' + imageUrl;
    }
    if (!imageUrl) {
        imageUrl = `https://via.placeholder.com/300x300/8B4513/FFFFFF?text=${encodeURIComponent(product.name)}`;
    }
    // å°åœ–å·²ç§»é™¤
    
    // é¡¯ç¤ºè©²å£å‘³çš„æ•¸é‡è¦æ ¼é¸é …ï¼ˆå–®åŒ…ã€10åŒ…çµ„åˆç­‰ï¼‰
    renderQuantitySpecOptions(specs);
    
    // ğŸ”¥ è‡ªå‹•é é¸ã€Œå–®åŒ…ã€è¦æ ¼
    // å°‹æ‰¾è¦æ ¼åç¨±åŒ…å«ã€Œå–®åŒ…ã€çš„é¸é …ï¼Œæˆ–è€…ç¬¬ä¸€å€‹æœ‰åº«å­˜çš„è¦æ ¼
    let autoSelectIndex = -1;
    
    // å„ªå…ˆå°‹æ‰¾åç¨±åŒ…å«ã€Œå–®åŒ…ã€çš„è¦æ ¼
    autoSelectIndex = specs.findIndex(s => 
        s.specName.includes('å–®åŒ…') && s.stock > 0
    );
    
    // å¦‚æœæ²’æœ‰æ‰¾åˆ°ï¼Œå‰‡é¸æ“‡ç¬¬ä¸€å€‹æœ‰åº«å­˜çš„è¦æ ¼
    if (autoSelectIndex === -1) {
        autoSelectIndex = specs.findIndex(s => s.stock > 0);
    }
    
    // è‡ªå‹•é¸æ“‡è¦æ ¼
    if (autoSelectIndex !== -1) {
        setTimeout(() => {
            selectQuantitySpec(autoSelectIndex);
        }, 100); // å»¶é²ä¸€é»é»ï¼Œç¢ºä¿ DOM å·²æ¸²æŸ“
    }
}

function renderQuantitySpecOptions(specs) {
    const optionsContainer = document.getElementById('specOptions');
    
    // ä¿ç•™å£å‘³é¸é …ï¼Œåœ¨ä¸‹æ–¹æ·»åŠ æ•¸é‡è¦æ ¼é¸é …
    const currentFlavorOptions = Array.from(document.querySelectorAll('[id^="flavor-"]')).map(el => el.outerHTML).join('');
    const flavorTitle = `<div class="spec-section-title" style="grid-column: 1 / -1;">ğŸ¯ é¸æ“‡å£å‘³ (${currentCategoryProducts.length} ç¨®é¸é …)</div>`;
    
    // æ·»åŠ æ•¸é‡è¦æ ¼é¸é …æ¨™é¡Œ
    const quantityTitle = `<div class="spec-section-title" style="grid-column: 1 / -1; margin-top: 20px;">ğŸ“¦ é¸æ“‡é …ç›®</div>`;
    
    const quantityOptions = specs.map((spec, index) => {
        const isOutOfStock = spec.stock === 0;
        
        return `
            <div class="spec-option ${isOutOfStock ? 'out-of-stock' : ''}" 
                 onclick="selectQuantitySpec(${index})"
                 id="qty-spec-${index}"
                 title="${spec.specName}${isOutOfStock ? ' - å·²å”®å®Œ' : ''}">
                <div class="spec-name">${spec.specName}${isOutOfStock ? ' âŒ' : ''}</div>
            </div>
        `;
    }).join('');
    
    optionsContainer.innerHTML = flavorTitle + currentFlavorOptions + quantityTitle + quantityOptions;
    
    // é‡æ–°ç¶å®šå£å‘³é¸é …çš„é»æ“Šäº‹ä»¶
    currentCategoryProducts.forEach((_, index) => {
        const flavorOption = document.getElementById(`flavor-${index}`);
        if (flavorOption) {
            flavorOption.onclick = () => selectFlavor(index);
            // ä¿æŒç•¶å‰é¸ä¸­ç‹€æ…‹
            if (selectedFlavor && currentCategoryProducts[index].id === selectedFlavor.id) {
                flavorOption.classList.add('selected');
            }
        }
    });
    
    // å„²å­˜ç•¶å‰è¦æ ¼åˆ°å…¨åŸŸè®Šæ•¸
    window.currentQuantitySpecs = specs;
}

// ==========================================
// ç¬¬ä¸‰å±¤ï¼šé¸æ“‡æ•¸é‡è¦æ ¼ï¼ˆå–®åŒ…æˆ–10åŒ…çµ„åˆï¼‰
// ==========================================
function selectQuantitySpec(index) {
    const specs = window.currentQuantitySpecs;
    const spec = specs[index];
    
    if (spec.stock === 0) {
        showToast('æ­¤è¦æ ¼å·²å”®å®Œ', 'error');
        return;
    }
    
    selectedSpec = {
        ...spec,
        productId: selectedFlavor.id,
        productName: selectedFlavor.name,
        productImage: selectedFlavor.image
    };
    
    // æ›´æ–°é¸ä¸­ç‹€æ…‹
    document.querySelectorAll('[id^="qty-spec-"]').forEach((el, i) => {
        el.classList.toggle('selected', i === index);
    });
    
    // æ›´æ–°åƒ¹æ ¼å’Œåº«å­˜é¡¯ç¤º
    renderSpecPrice(spec);
    
    const stockDisplay = document.getElementById('specInfoStock');
    const multiplier = spec.quantityMultiplier || 1;
    const actualStock = spec.stock;
    
    let stockText = '';
    if (multiplier > 1) {
        const availableUnits = Math.floor(actualStock / multiplier);
        stockText = `åº«å­˜ï¼š${actualStock} å€‹ (å¯å”® ${availableUnits} çµ„)`;
    } else {
        stockText = `åº«å­˜ï¼š${actualStock} ä»¶`;
    }
    
    const isLowStock = actualStock > 0 && actualStock <= 10;
    stockDisplay.textContent = stockText + (isLowStock ? ' âš ï¸ å³å°‡å”®å®Œ' : '');
    stockDisplay.style.color = isLowStock ? '#ff9900' : 'var(--accent-green)';
    
    // é‡ç½®æ•¸é‡
    quantity = 1;
    updateQuantityDisplay();
    updateAddToCartButton();
}

// ==========================================
// ğŸ”¥ ç€è¦½å™¨è¿”å›éµè™•ç† - é—œé–‰å½ˆçª—å›åˆ°ä¸»é 
// ==========================================
let isModalOpen = false;

// ç›£è½ç€è¦½å™¨è¿”å›éµ
window.addEventListener('popstate', function(event) {
    // æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½•å½ˆçª—é–‹å•Ÿ
    const specModal = document.getElementById('specModal');
    const cartSidebar = document.getElementById('cartSidebar');
    const checkoutModal = document.getElementById('checkoutModal');
    const orderSearchModal = document.getElementById('orderSearchModal');
    const profileUpdateModal = document.getElementById('profileUpdateModal');
    
    // ä¾åºæª¢æŸ¥ä¸¦é—œé–‰é–‹å•Ÿçš„å½ˆçª—
    const orderDetailView = document.getElementById('orderDetailView');
    if (orderDetailView) {
        // å„ªå…ˆé—œé–‰è¨‚å–®è©³æƒ…å…¨è¢å¹•é 
        closeOrderDetail();
        isModalOpen = false;
    } else if (specModal && specModal.classList.contains('active')) {
        closeSpecModal();
        isModalOpen = false;
    } else if (cartSidebar && cartSidebar.classList.contains('active')) {
        toggleCart();
        isModalOpen = false;
    } else if (checkoutModal && checkoutModal.classList.contains('active')) {
        closeCheckout();
        isModalOpen = false;
    } else if (orderSearchModal && orderSearchModal.classList.contains('active')) {
        closeOrderSearch();
        isModalOpen = false;
    } else if (profileUpdateModal && profileUpdateModal.classList.contains('active')) {
        closeProfileUpdateModal();
        isModalOpen = false;
    } else {
        // å¦‚æœæ²’æœ‰å½ˆçª—é–‹å•Ÿï¼Œé˜»æ­¢è¿”å›ï¼ˆåœç•™åœ¨ä¸»é ï¼‰
        history.pushState(null, '', location.href);
    }
});

// é é¢è¼‰å…¥æ™‚ï¼Œè¨­ç½®åˆå§‹ç‹€æ…‹ï¼Œé˜²æ­¢è¿”å›è·³å‡ºç¶²ç«™
window.addEventListener('load', function() {
    history.pushState(null, '', location.href);
});

// ==========================================
// è¦æ ¼é¸æ“‡å½ˆçª—ï¼ˆä¿ç•™åŸæœ‰åŠŸèƒ½ï¼‰
// ==========================================
function openSpecModal(productId) {
    currentProduct = products.find(p => p.id === productId);
    if (!currentProduct) return;

    const specs = productSpecs[productId];
    if (!specs || specs.length === 0) {
        showToast('æ­¤å•†å“æš«ç„¡è¦æ ¼', 'error');
        return;
    }

    document.getElementById('specModalTitle').textContent = currentProduct.name;
    document.getElementById('specModal').classList.add('active');
    
    // ğŸ”¥ æ·»åŠ æ­·å²è¨˜éŒ„ï¼Œè®“è¿”å›éµå¯ä»¥é—œé–‰å½ˆçª—
    history.pushState({ modal: 'spec' }, '');
    isModalOpen = true;
    
    renderSpecOptions();
    quantity = 1;
    selectedSpec = null;
    updateQuantityDisplay();
    updateAddToCartButton();
}

function closeSpecModal() {
    document.getElementById('specModal').classList.remove('active');
    currentProduct = null;
    selectedSpec = null;
    selectedFlavor = null;
    currentCategoryProducts = [];
    quantity = 1;
}

function renderSpecOptions() {
    const specs = productSpecs[currentProduct.id];
    const optionsContainer = document.getElementById('specOptions');
    
    const specTitle = `<div class="spec-section-title" style="grid-column: 1 / -1;">ğŸ“¦ é¸æ“‡è¦æ ¼ (${specs.length} ç¨®é¸é …)</div>`;
    
    const specOptions = specs.map((spec, index) => {
        const isOutOfStock = spec.stock === 0;
        
        return `
            <div class="spec-option ${isOutOfStock ? 'out-of-stock' : ''}" 
                 onclick="selectSpec(${index})"
                 id="spec-${index}"
                 title="${spec.specName}${isOutOfStock ? ' - å·²å”®å®Œ' : ''}">
                <div class="spec-name">${spec.specName}${isOutOfStock ? ' âŒ' : ''}</div>
            </div>
        `;
    }).join('');
    
    optionsContainer.innerHTML = specTitle + specOptions;
}

function selectSpec(index) {
    const specs = productSpecs[currentProduct.id];
    const spec = specs[index];
    
    if (spec.stock === 0) {
        showToast('æ­¤è¦æ ¼å·²å”®å®Œ', 'error');
        return;
    }

    selectedSpec = spec;
    
    // æ›´æ–°é¸ä¸­ç‹€æ…‹
    document.querySelectorAll('.spec-option').forEach((el, i) => {
        el.classList.toggle('selected', i === index);
    });
    
    // æ›´æ–°åœ–ç‰‡
    const imageContainer = null; // å°åœ–å·²ç§»é™¤
    let imageUrl = spec.image || currentProduct.image || '';
    
    // è‡ªå‹•è£œä¸Š https://
    if (imageUrl && !imageUrl.startsWith('http://') && !imageUrl.startsWith('https://')) {
        imageUrl = 'https://' + imageUrl;
    }
    if (!imageUrl) {
        imageUrl = `https://via.placeholder.com/300x300/8B4513/FFFFFF?text=${encodeURIComponent(currentProduct.name)}`;
    }
    
    // å°åœ–å·²ç§»é™¤
    
    // æ›´æ–°åƒ¹æ ¼å’Œåº«å­˜é¡¯ç¤º
    renderSpecPrice(spec);
    
    const stockDisplay = document.getElementById('specInfoStock');
    const multiplier = spec.quantityMultiplier || 1;
    const actualStock = spec.stock;
    
    // å¦‚æœæœ‰å€æ•¸ï¼Œé¡¯ç¤ºå¯¦éš›æ•¸é‡
    let stockText = '';
    if (multiplier > 1) {
        const availableUnits = Math.floor(actualStock / multiplier);  // å¯å”®çµ„æ•¸
        stockText = `åº«å­˜ï¼š${actualStock} å€‹ (å¯å”® ${availableUnits} çµ„)`;
    } else {
        stockText = `åº«å­˜ï¼š${actualStock} ä»¶`;
    }
    
    const isLowStock = actualStock > 0 && actualStock <= 10;
    stockDisplay.textContent = stockText + (isLowStock ? ' âš ï¸ å³å°‡å”®å®Œ' : '');
    stockDisplay.style.color = isLowStock ? '#ff9900' : 'var(--accent-green)';
    
    // é‡ç½®æ•¸é‡
    quantity = 1;
    updateQuantityDisplay();
    updateAddToCartButton();
}

function changeQuantity(change) {
    if (!selectedSpec) {
        showToast('è«‹å…ˆé¸æ“‡è¦æ ¼', 'error');
        return;
    }

    const newQty = quantity + change;
    
    if (newQty < 1) {
        showToast('æ•¸é‡ä¸å¯å°æ–¼ 1', 'error');
        return;
    }
    
    if (newQty > selectedSpec.stock) {
        showToast('å·²é”åº«å­˜ä¸Šé™', 'error');
        return;
    }

    quantity = newQty;
    updateQuantityDisplay();
}

function updateQuantityDisplay() {
    document.getElementById('quantityDisplay').textContent = quantity;
}

function updateAddToCartButton() {
    const btn = document.getElementById('addToCartModalBtn');
    btn.disabled = !selectedSpec;
}

function confirmAddToCart() {
    if (!selectedSpec) {
        showToast('è«‹é¸æ“‡è¦æ ¼', 'error');
        return;
    }

    // å–å¾—æ•¸é‡å€æ•¸
    const multiplier = selectedSpec.quantityMultiplier || 1;
    const actualStock = selectedSpec.stock;
    
    // ä½¿ç”¨ selectedSpec ä¸­çš„ productId å’Œ productNameï¼ˆå¾ä¸‰å±¤é¸æ“‡ä¸­è¨­ç½®ï¼‰
    const actualProductId = selectedSpec.productId || (currentProduct ? currentProduct.id : null);
    const actualProductName = selectedSpec.productName || (currentProduct ? currentProduct.name : '');
    
    if (!actualProductId) {
        showToast('å•†å“è³‡è¨ŠéŒ¯èª¤', 'error');
        return;
    }
    
    // æª¢æŸ¥è³¼ç‰©è»Šä¸­æ˜¯å¦å·²æœ‰ç›¸åŒå•†å“+è¦æ ¼
    const existingIndex = cart.findIndex(item => 
        item.productId === actualProductId && item.specName === selectedSpec.specName
    );

    if (existingIndex !== -1) {
        // æ›´æ–°æ•¸é‡
        const newQty = cart[existingIndex].quantity + quantity;
        const totalUnits = newQty * multiplier;  // å¯¦éš›ä½”ç”¨åº«å­˜
        
        if (totalUnits > actualStock) {
            showToast('å·²é”åº«å­˜ä¸Šé™', 'error');
            return;
        }
        cart[existingIndex].quantity = newQty;
    } else {
        // æª¢æŸ¥åº«å­˜
        const totalUnits = quantity * multiplier;
        if (totalUnits > actualStock) {
            showToast('åº«å­˜ä¸è¶³', 'error');
            return;
        }
        
        // æ–°å¢é …ç›®
        cart.push({
            productId: actualProductId,
            productName: actualProductName,
            specName: selectedSpec.specName,
            price: selectedSpec.price,
            quantity: quantity,
            quantityMultiplier: multiplier,  // å„²å­˜å€æ•¸
            image: selectedSpec.productImage || selectedSpec.image || (currentProduct ? currentProduct.image : '')
        });
    }
    
    updateCart();
    
    // é¡¯ç¤ºæç¤ºè¨Šæ¯ï¼ˆå¦‚æœæœ‰å€æ•¸ï¼Œé¡¯ç¤ºå¯¦éš›æ•¸é‡ï¼‰
    const displayMsg = multiplier > 1 
        ? `âœ… å·²åŠ å…¥ ${quantity} çµ„ã€Œ${actualProductName} - ${selectedSpec.specName}ã€(å…± ${quantity * multiplier} å€‹)åˆ°è³¼ç‰©è»Š!`
        : `âœ… å·²åŠ å…¥ ${quantity} ä»¶ã€Œ${actualProductName} - ${selectedSpec.specName}ã€åˆ°è³¼ç‰©è»Š!`;
    showToast(displayMsg);
    
    // é‡ç½®é¸æ“‡ç‹€æ…‹,è®“ä½¿ç”¨è€…å¯ä»¥ç¹¼çºŒé¸è³¼å…¶ä»–è¦æ ¼
    quantity = 1;
    selectedSpec = null;
    selectedFlavor = null;
    updateQuantityDisplay();
    updateAddToCartButton();
    
    // ç§»é™¤æ‰€æœ‰è¦æ ¼çš„é¸ä¸­ç‹€æ…‹
    document.querySelectorAll('.spec-option.selected').forEach(el => {
        el.classList.remove('selected');
    });
    
    const cartIcon = document.querySelector('.cart-float');
    if (cartIcon) {
        cartIcon.classList.add('animate-pulse');
        setTimeout(() => cartIcon.classList.remove('animate-pulse'), 500);
    }
}

// ==========================================
// è³¼ç‰©è»ŠåŠŸèƒ½
// ==========================================
function updateCart() {
    const cartItems = document.getElementById('cartItems');
    const cartBadge = document.getElementById('cartBadge');
    const cartTotal = document.getElementById('cartTotal');

    const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
    cartBadge.textContent = totalItems;

    if (cart.length === 0) {
        cartItems.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">è³¼ç‰©è»Šæ˜¯ç©ºçš„</p>';
        cartTotal.textContent = '0';
        return;
    }

    cartItems.innerHTML = cart.map((item, index) => `
        <div class="cart-item">
            <div class="cart-item-name" title="${item.productName} - ${item.specName}">
                ${item.productName}<br>
                <span style="color: var(--primary); font-size: 14px;">ğŸ“¦ ${item.specName}</span>
            </div>
            <div class="cart-item-price">$${item.price} Ã— ${item.quantity} = <span style="font-size: 20px;">$${item.price * item.quantity}</span></div>
            <div class="cart-item-qty">
                <button class="qty-btn" onclick="updateCartQuantity(${index}, -1)">âˆ’</button>
                <span>${item.quantity}</span>
                <button class="qty-btn" onclick="updateCartQuantity(${index}, 1)">+</button>
            </div>
            <button class="remove-item" onclick="removeCartItem(${index})">ğŸ—‘ï¸ ç§»é™¤</button>
        </div>
    `).join('');

    const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    cartTotal.textContent = total;

    // ğŸ†• è³¼ç‰©è»Šå„ªæƒ æç¤º
    const cartHintContainer = document.getElementById('cartPromotionHints');
    if (cartHintContainer) {
        const hints = displayPromotionHints(cart);
        if (hints) {
            cartHintContainer.innerHTML = `<div style="padding:10px 16px 4px; font-size:13px; line-height:1.8; color:#FFD700;">${hints}</div>`;
        } else {
            cartHintContainer.innerHTML = '';
        }
    }
}

function updateCartQuantity(index, change) {
    const item = cart[index];
    const newQty = item.quantity + change;

    if (newQty <= 0) {
        removeCartItem(index);
        return;
    }

    // æŸ¥æ‰¾è¦æ ¼ï¼ˆæ”¯æŒä¸‰å±¤é¸æ“‡çµæ§‹ï¼‰
    let spec = null;
    const specs = productSpecs[item.productId];
    
    if (specs) {
        spec = specs.find(s => s.specName === item.specName);
    }
    
    // å¦‚æœæ‰¾ä¸åˆ°è¦æ ¼ï¼Œå˜—è©¦å¾æ‰€æœ‰è¦æ ¼ä¸­æŸ¥æ‰¾
    if (!spec) {
        for (let productId in productSpecs) {
            const foundSpec = productSpecs[productId].find(s => s.specName === item.specName);
            if (foundSpec) {
                spec = foundSpec;
                break;
            }
        }
    }
    
    if (!spec) {
        showToast('æ‰¾ä¸åˆ°å•†å“è¦æ ¼', 'error');
        return;
    }
    
    if (newQty > spec.stock) {
        showToast('å·²é”åº«å­˜ä¸Šé™', 'error');
        return;
    }

    item.quantity = newQty;
    updateCart();
}

function removeCartItem(index) {
    cart.splice(index, 1);
    updateCart();
}

function toggleCart() {
    const cartSidebar = document.getElementById('cartSidebar');
    const isOpening = !cartSidebar.classList.contains('active');
    
    cartSidebar.classList.toggle('active');
    
    // ğŸ”¥ é–‹å•Ÿè³¼ç‰©è»Šæ™‚æ·»åŠ æ­·å²è¨˜éŒ„
    if (isOpening) {
        history.pushState({ modal: 'cart' }, '');
        isModalOpen = true;
    }
}

// ==========================================
// çµå¸³æµç¨‹
// ==========================================
function openCheckout() {
    if (cart.length === 0) {
        showToast('è³¼ç‰©è»Šæ˜¯ç©ºçš„', 'error');
        return;
    }
    // å¦‚æœè¨‚å–®è©³æƒ…é é‚„é–‹è‘—ï¼Œå…ˆé—œæ‰
    const existingDetail = document.getElementById('orderDetailView');
    if (existingDetail) existingDetail.remove();
    
    // æ›´æ–°çµå¸³é é¢çš„è¨‚å–®æ‘˜è¦
    updateCheckoutSummary();
    
    // ğŸ†• å¦‚æœå·²é¸æ“‡é–€å¸‚ï¼Œé¡¯ç¤ºé–€å¸‚è³‡è¨Š
    displaySelectedStore();
    
    document.getElementById('checkoutModal').classList.add('active');
    
    // ğŸ”¥ æ·»åŠ æ­·å²è¨˜éŒ„
    history.pushState({ modal: 'checkout' }, '');
    isModalOpen = true;
}

function updateCheckoutSummary() {
    const summaryItems = document.getElementById('checkoutSummary');
    const checkoutTotal = document.getElementById('checkoutTotal');
    
    // è¨ˆç®—å•†å“å°è¨ˆ
    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    
    // ğŸ†• è¨ˆç®—å„ªæƒ 
    const promotionResult = calculatePromotions(cart);
    
    // æª¢æŸ¥æ˜¯å¦é¸æ“‡ 7-11 é…é€
    const shipping = document.querySelector('input[name="shipping"]:checked');
    let shippingFee = (shipping && shipping.value === '711') ? 60 : 0;
    
    // ğŸ†• å¦‚æœç¬¦åˆå…é‹å„ªæƒ ï¼Œé‹è²»è¨­ç‚º 0
    if (promotionResult.freeShipping) {
        shippingFee = 0;
    }
    
    // ç”Ÿæˆå•†å“åˆ—è¡¨
    let itemsHtml = cart.map(item => `
        <div class="summary-item">
            <span class="item-name">${item.productName} - ${item.specName} Ã— ${item.quantity}</span>
            <span class="item-price">$${item.price * item.quantity}</span>
        </div>
    `).join('');
    
    // é¡¯ç¤ºå•†å“å°è¨ˆ
    itemsHtml += `
        <div class="summary-item" style="border-top: 1px solid rgba(255,215,0,0.2); margin-top: 10px; padding-top: 10px;">
            <span class="item-name">å•†å“å°è¨ˆ</span>
            <span class="item-price">$${subtotal}</span>
        </div>
    `;
    
    // ğŸ†• é¡¯ç¤ºå„ªæƒ æŠ˜æ‰£
    if (promotionResult.appliedPromotions.length > 0) {
        promotionResult.appliedPromotions.forEach(promo => {
            if (promo.type === 'æ»¿é¡å…é‹') {
                itemsHtml += `
                    <div class="summary-item" style="color: #00FF00;">
                        <span class="item-name">ğŸ ${promo.name}</span>
                        <span class="item-price">å…é‹è²»</span>
                    </div>
                `;
            } else if (promo.discount > 0) {
                itemsHtml += `
                    <div class="summary-item" style="color: #00FF00;">
                        <span class="item-name">ğŸ ${promo.name}</span>
                        <span class="item-price">-$${promo.discount}</span>
                    </div>
                `;
            }
        });
    }
    
    // é¡¯ç¤ºé‹è²»
    if (shipping && shipping.value === '711') {
        const shippingText = promotionResult.freeShipping ? 
            `<span style="text-decoration: line-through; color: #666;">$60</span> <span style="color: #00FF00;">å…é‹</span>` : 
            `$${shippingFee}`;
        
        itemsHtml += `
            <div class="summary-item">
                <span class="item-name">7-11 é‹è²»</span>
                <span class="item-price" style="color: var(--primary);">${shippingText}</span>
            </div>
        `;
    }
    
    summaryItems.innerHTML = itemsHtml;
    
    // ğŸ†• è¨ˆç®—ç¸½é‡‘é¡ï¼ˆå•†å“ - å„ªæƒ  + é‹è²»ï¼‰
    const total = subtotal - promotionResult.totalDiscount + shippingFee;
    checkoutTotal.textContent = `$${total}`;
    
    // ğŸ†• é¡¯ç¤ºå„ªæƒ æç¤º
    const hints = displayPromotionHints(cart);
    const hintContainer = document.getElementById('promotionHints');
    if (hintContainer) {
        if (hints) {
            hintContainer.innerHTML = `<div style="background: rgba(255,215,0,0.1); padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 13px; line-height: 1.6;">${hints}</div>`;
        } else {
            hintContainer.innerHTML = '';
        }
    }
}

function closeCheckout() {
    document.getElementById('checkoutModal').classList.remove('active');
}

// ğŸ†• åˆ‡æ›å–è²¨æ–¹å¼ï¼ˆ7-11 / è‡ªå–ï¼‰
function toggleShippingMethod() {
    const shipping = document.querySelector('input[name="shipping"]:checked').value;
    const storeSelector = document.getElementById('storeSelector');
    const pickupPayment = document.getElementById('pickupPaymentMethod');
    const storePayment = document.getElementById('storePaymentMethod');
    
    if (shipping === '711') {
        storeSelector.classList.add('active');
        pickupPayment.classList.remove('active');
        storePayment.style.display = 'none';
        selectedStore = null;
    } else {
        storeSelector.classList.remove('active');
        pickupPayment.classList.add('active');
        storePayment.style.display = 'none';
        selectedStore = null;
        
        const infoElement = document.getElementById('selectedStoreInfo');
        if (infoElement) infoElement.classList.remove('active');
        
        toggleBankInfo();
    }
    
    updateCheckoutSummary();
}

// é–€å¸‚é¸å®Œå¾Œé¡¯ç¤ºä»˜æ¬¾æ–¹å¼
function showStorePaymentMethod() {
    const storePayment = document.getElementById('storePaymentMethod');
    if (storePayment) {
        storePayment.style.display = 'block';
        updateStoreBankInfo();
        toggleStorePayment();
    }
}

// åˆ‡æ› 7-11 ä»˜æ¬¾æ–¹å¼
function toggleStorePayment() {
    const method = document.querySelector('input[name="storePayment"]:checked')?.value;
    const bankInfo = document.getElementById('storeBankInfo');
    const linePayInfo = document.getElementById('storeLinePayInfo');
    if (method === 'linepay') {
        bankInfo.style.display = 'none';
        linePayInfo.style.display = 'block';
    } else {
        bankInfo.style.display = 'block';
        linePayInfo.style.display = 'none';
    }
}

// æ›´æ–° 7-11 åŒ¯æ¬¾è³‡è¨Š
function updateStoreBankInfo() {
    const el1 = document.getElementById('storeBankName');
    const el2 = document.getElementById('storeBankAccount');
    const el3 = document.getElementById('storeBankHolder');
    const el4 = document.getElementById('linePayAccount');
    if (el1) el1.textContent = systemSettings.bankName || 'è«‹è¯ç¹«å®¢æœ';
    if (el2) el2.textContent = systemSettings.bankAccount || 'è«‹è¯ç¹«å®¢æœ';
    if (el3) el3.textContent = systemSettings.bankHolder || 'CANDY BOSS';
    if (el4) el4.textContent = systemSettings.linePayAccount || 'è«‹è¯ç¹«å®¢æœ';
}

// ğŸ†• åˆ‡æ›åŒ¯æ¬¾è³‡è¨Šé¡¯ç¤º
function toggleBankInfo() {
    const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;
    const bankInfo = document.getElementById('bankInfo');
    
    if (paymentMethod === 'transfer') {
        bankInfo.classList.add('active');
    } else {
        bankInfo.classList.remove('active');
    }
}

// ğŸ†• è¼‰å…¥ç³»çµ±è¨­å®š
async function loadSystemSettings() {
    try {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/ç³»çµ±è¨­å®š?key=${API_KEY}`;
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.values && data.values.length > 1) {
            // è§£æè¨­å®šè³‡æ–™ï¼ˆå‡è¨­æ ¼å¼ï¼šè¨­å®šé …ç›® | è¨­å®šå€¼ï¼‰
            data.values.slice(1).forEach(row => {
                if (row[0] === 'åŒ¯æ¬¾éŠ€è¡Œ') systemSettings.bankName = row[1] || '';
                if (row[0] === 'åŒ¯æ¬¾å¸³è™Ÿ') systemSettings.bankAccount = row[1] || '';
                if (row[0] === 'åŒ¯æ¬¾æˆ¶å') systemSettings.bankHolder = row[1] || '';
                if (row[0] === 'LINE Payå¸³è™Ÿ') systemSettings.linePayAccount = row[1] || '';
            });
            
            console.log('âœ… ç³»çµ±è¨­å®šè¼‰å…¥æˆåŠŸ:', systemSettings);
            updateBankInfo();
        }
    } catch (error) {
        console.error('âŒ è¼‰å…¥ç³»çµ±è¨­å®šå¤±æ•—:', error);
        // ä½¿ç”¨é è¨­å€¼
        systemSettings = {
            bankName: 'è«‹è¯ç¹«å®¢æœ',
            bankAccount: 'è«‹è¯ç¹«å®¢æœ',
            bankHolder: 'CANDY BOSS'
        };
        updateBankInfo();
    }
}

// ğŸ†• æ›´æ–°åŒ¯æ¬¾è³‡è¨Šé¡¯ç¤º
function updateBankInfo() {
    const bankNameEl = document.getElementById('bankName');
    const bankAccountEl = document.getElementById('bankAccount');
    const bankHolderEl = document.getElementById('bankHolder');
    
    if (bankNameEl) bankNameEl.textContent = systemSettings.bankName;
    if (bankAccountEl) bankAccountEl.textContent = systemSettings.bankAccount;
    if (bankHolderEl) bankHolderEl.textContent = systemSettings.bankHolder;
}

async function submitOrder() {
    // ğŸ”¥ é˜²é‡è¤‡é»æ“Šï¼šæª¢æŸ¥æ˜¯å¦æ­£åœ¨æäº¤
    if (window.isSubmittingOrder) {
        showToast('è¨‚å–®è™•ç†ä¸­ï¼Œè«‹ç¨å€™...', 'error');
        return;
    }
    
    const shipping = document.querySelector('input[name="shipping"]:checked').value;
    const name = document.getElementById('customerName').value.trim();
    const phone = document.getElementById('customerPhone').value.trim();
    let paymentMethod = '';

    // åŸºæœ¬è³‡æ–™é©—è­‰
    if (!name || !phone) {
        showToast('è«‹å¡«å¯«å§“åå’Œé›»è©±', 'error');
        return;
    }

    // è‡ªå–ä»˜æ¬¾æ–¹å¼
    if (shipping === 'pickup') {
        paymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value || '';
    } else if (shipping === '711') {
        if (!selectedStore) {
            showToast('è«‹é¸æ“‡ 7-11 é–€å¸‚', 'error');
            return;
        }
        const storePaymentVal = document.querySelector('input[name="storePayment"]:checked')?.value || 'transfer';
        if (storePaymentVal === 'linepay') {
            const linePayName = document.getElementById('linePayName')?.value.trim();
            if (!linePayName) {
                showToast('è«‹å¡«å¯«æ‚¨çš„ LINE é¡¯ç¤ºåç¨±', 'error');
                document.getElementById('linePayName')?.focus();
                return;
            }
            paymentMethod = 'linepay';
            window._linePayName = linePayName;
        } else {
            paymentMethod = 'transfer';
            window._linePayName = '';
        }
    }

    // ğŸ”¥ è¨­å®šæäº¤ä¸­æ¨™è¨˜ï¼Œé˜²æ­¢é‡è¤‡é»æ“Š
    window.isSubmittingOrder = true;
    
    // ğŸ”¥ ç¦ç”¨æäº¤æŒ‰éˆ•ä¸¦é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
    const submitBtn = document.querySelector('.submit-order-btn');
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.style.opacity = '0.6';
    submitBtn.style.cursor = 'not-allowed';
    submitBtn.innerHTML = 'â³ è¨‚å–®è™•ç†ä¸­ï¼Œè«‹ç¨å€™...';

    // ğŸ†• è¨ˆç®—å„ªæƒ 
    const promotionResult = calculatePromotions(cart);
    
    // ğŸ”¥ è¨ˆç®—é‹è²»å’Œç¸½é‡‘é¡
    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    let shippingFee = shipping === '711' ? 60 : 0;
    
    // ğŸ†• å¦‚æœç¬¦åˆå…é‹å„ªæƒ ï¼Œé‹è²»è¨­ç‚º 0
    if (promotionResult.freeShipping) {
        shippingFee = 0;
    }
    
    // ğŸ†• è¨ˆç®—å„ªæƒ å¾Œçš„ç¸½é‡‘é¡
    const totalAmount = subtotal - promotionResult.totalDiscount + shippingFee;
    
    // ğŸ†• çµ„åˆå„ªæƒ æ˜ç´°æ–‡å­—
    const promotionText = promotionResult.appliedPromotions.length > 0 
        ? promotionResult.appliedPromotions.map(p => {
            if (p.type === 'æ»¿é¡å…é‹') {
                return `${p.name}(å…é‹)`;
            } else {
                return `${p.name}(-$${p.discount})`;
            }
        }).join(', ')
        : '-';

    const orderData = {
        action: 'createOrder',
        è¨‚å–®ç·¨è™Ÿ: 'ORD' + Date.now(),
        è¨‚è³¼æ™‚é–“: new Date().toISOString(),
        å§“å: name,
        é›»è©±: phone,
        å–è²¨æ–¹å¼: shipping === '711' ? '7-11åº—åˆ°åº—' : 'è‡ªå–',
        ä»˜æ¬¾æ–¹å¼: shipping === '711' ? (paymentMethod === 'linepay' ? 'LINE Pay' : 'åŒ¯æ¬¾') : (paymentMethod === 'cash' ? 'ç¾å ´ä»˜æ¬¾' : 'åŒ¯æ¬¾'),
        ä»˜æ¬¾ç‹€æ…‹: 'å¾…ä»˜æ¬¾', // ğŸ†• ä»˜æ¬¾ç‹€æ…‹
        é–€å¸‚åç¨±: shipping === '711' ? selectedStore.name : '-',
        é–€å¸‚åœ°å€: shipping === '711' ? selectedStore.address : '-',
        åŒ¯æ¬¾æœ«äº”ç¢¼: paymentMethod === 'linepay' ? ('LINE:' + (window._linePayName || '')) : '',
        å•†å“æ˜ç´°: cart.map(item => {
            const multiplier = item.quantityMultiplier || 1;
            const displayQty = multiplier > 1 ? `${item.quantity}çµ„(å…±${item.quantity * multiplier}å€‹)` : `${item.quantity}`;
            return `${item.productName}-${item.specName} x${displayQty}`;
        }).join(', '),
        å•†å“é‡‘é¡: subtotal,
        å„ªæƒ æŠ˜æ‰£: promotionResult.totalDiscount,  // ğŸ†• å„ªæƒ æŠ˜æ‰£
        å„ªæƒ æ˜ç´°: promotionText,                  // ğŸ†• å„ªæƒ æ˜ç´°
        é‹è²»: shippingFee,
        ç¸½é‡‘é¡: totalAmount,
        è¨‚å–®ç‹€æ…‹: 'å¾…è™•ç†',
        ç‰©æµç·¨è™Ÿ: '-',
        æœƒå“¡ID: currentMember ? currentMember.lineId : '',
        å•†å“è³‡æ–™: cart.map(item => ({
            productId: item.productId,
            specName: item.specName,
            quantity: (item.quantity * (item.quantityMultiplier || 1))  // å‚³é€å¯¦éš›æ‰£åº«å­˜æ•¸é‡
        }))
    };

    // ğŸ”¥ ä¿å­˜è³¼è²·æ¸…å–®ï¼Œç”¨æ–¼å¾ŒçºŒæ›´æ–°åº«å­˜
    const purchasedItems = cart.map(item => ({
        productId: item.productId,
        specName: item.specName
    }));

    try {
        await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(orderData)
        });
        
        showToast('âœ… è¨‚å–®å·²é€å‡ºï¼', 'success');
        
        // æ¸…ç©ºè³¼ç‰©è»Š
        cart = [];
        updateCart();
        
        // é—œé–‰çµå¸³æ¨¡æ…‹æ¡†
        closeCheckout();
        
        // ğŸ†• ç›´æ¥åœ¨ç•¶å‰é é¢é¡¯ç¤ºè¨‚å–®è©³æƒ…ï¼ˆä½¿ç”¨æ–°è¨‚å–®è³‡æ–™ï¼‰
        setTimeout(() => {
            showNewOrderDetail(orderData);
        }, 500);
        
    } catch (error) {
        console.log('è¨‚å–®å·²é€å‡º(no-cors æ¨¡å¼)');
        showToast('âœ… è¨‚å–®å·²é€å‡ºï¼', 'success');
        
        // æ¸…ç©ºè³¼ç‰©è»Š
        cart = [];
        updateCart();
        
        // é—œé–‰çµå¸³æ¨¡æ…‹æ¡†
        closeCheckout();
        
        // ğŸ†• ç›´æ¥åœ¨ç•¶å‰é é¢é¡¯ç¤ºè¨‚å–®è©³æƒ…
        setTimeout(() => {
            showNewOrderDetail(orderData);
        }, 500);
        
        submitBtn.innerHTML = originalBtnText;
        
        // ğŸ”¥ è¼•é‡ç´šæ›´æ–°ï¼šåªæ›´æ–°å·²è³¼è²·å•†å“çš„åº«å­˜
        setTimeout(() => {
            updatePurchasedProductsStock(purchasedItems);
        }, 1000);
    }
}

// ==========================================
// è¨‚å–®æŸ¥è©¢
// ==========================================
async function openOrderSearch() {
    // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
    if (!currentMember || !currentMember.lineId) {
        showToast('è«‹å…ˆç™»å…¥ LINE å¸³è™Ÿ', 'error');
        return;
    }
    
    // é¡¯ç¤ºæ¨¡æ…‹æ¡†
    document.getElementById('orderSearchModal').classList.add('active');
    
    // ğŸ”¥ æ·»åŠ æ­·å²è¨˜éŒ„
    history.pushState({ modal: 'orderSearch' }, '');
    isModalOpen = true;
    
    // é¡¯ç¤ºè¼‰å…¥ä¸­
    document.getElementById('ordersList').innerHTML = `
        <div style="text-align:center; padding:40px; color:#999;">
            <div style="font-size:40px; margin-bottom:20px;">â³</div>
            <div>è¼‰å…¥ä¸­...</div>
        </div>
    `;
    
    // æŸ¥è©¢è¨‚å–®
    await loadMemberOrders();
}


function closeOrderSearch() {
    document.getElementById('orderSearchModal').classList.remove('active');
}

// ==========================================
// ğŸ†• é¡¯ç¤ºæ–°è¨‚å–®è©³æƒ…ï¼ˆè¨‚å–®é€å‡ºå¾Œï¼‰â†’ çµ±ä¸€èµ°æŸ¥è©¢è¨‚å–® modal
// ==========================================
function showNewOrderDetail(orderData) {
    // å…ˆæ¸…é™¤èˆŠçš„è©³æƒ…é ï¼ˆé¿å…ç–ŠåŠ ï¼‰
    const existingDetail = document.getElementById('orderDetailView');
    if (existingDetail) existingDetail.remove();
    // åŠ å…¥ historyï¼Œè®“æ‰‹æ©Ÿè¿”å›éµå¯ä»¥é—œæ‰
    history.pushState({ modal: 'orderDetail' }, '');
    isModalOpen = true;
    // ç›´æ¥é¡¯ç¤ºå…¨è¢å¹•è¨‚å–®è©³æƒ…
    const order = {
        è¨‚å–®ç·¨è™Ÿ: orderData.è¨‚å–®ç·¨è™Ÿ,
        è¨‚è³¼æ™‚é–“: orderData.è¨‚è³¼æ™‚é–“,
        å§“å: orderData.å§“å,
        é›»è©±: orderData.é›»è©±,
        å–è²¨æ–¹å¼: orderData.å–è²¨æ–¹å¼,
        é–€å¸‚åç¨±: orderData.é–€å¸‚åç¨± || '-',
        å•†å“æ˜ç´°: orderData.å•†å“æ˜ç´°,
        å•†å“é‡‘é¡: orderData.å•†å“é‡‘é¡,
        é‹è²»: orderData.é‹è²»,
        ç¸½é‡‘é¡: orderData.ç¸½é‡‘é¡,
        è¨‚å–®ç‹€æ…‹: orderData.è¨‚å–®ç‹€æ…‹ || 'å¾…è™•ç†',
        ç‰©æµç·¨è™Ÿ: '-',
        åŒ¯æ¬¾æœ«äº”ç¢¼: orderData.åŒ¯æ¬¾æœ«äº”ç¢¼ || '-'
    };
    showOrderDetailByData(order);
}

// ==========================================
// ğŸ†• é¡¯ç¤ºè¨‚å–®è©³æƒ…
// ==========================================
function showOrderDetail(orderIndex) {
    if (!window.memberOrders || !window.memberOrders[orderIndex]) {
        showToast('è¨‚å–®è³‡æ–™è¼‰å…¥å¤±æ•—', 'error');
        return;
    }
    
    const order = window.memberOrders[orderIndex];
    showOrderDetailByData(order);
}

// çµ±ä¸€çš„è¨‚å–®è©³æƒ…é¡¯ç¤ºå‡½æ•¸
function showOrderDetailByData(order) {
    
    // ğŸ”¥ æª¢æŸ¥æ˜¯å¦é€¾æ™‚ä¸¦è‡ªå‹•å–æ¶ˆè¨‚å–®
    let isExpired = false;
    let shouldShowPaymentButton = true;
    
    // å·²å¡«æœ«äº”ç¢¼ æˆ– å·²ä»˜æ¬¾å¾…å‡ºè²¨ = å·²ä»˜æ¬¾ï¼Œä¸åšä»»ä½•é€¾æ™‚åˆ¤æ–·
    const hasPaid = (order.åŒ¯æ¬¾æœ«äº”ç¢¼ && order.åŒ¯æ¬¾æœ«äº”ç¢¼ !== '-' && order.åŒ¯æ¬¾æœ«äº”ç¢¼ !== '') || order.è¨‚å–®ç‹€æ…‹ === 'å·²ä»˜æ¬¾å¾…å‡ºè²¨';
    
    if (order.å–è²¨æ–¹å¼ === '7-11åº—åˆ°åº—' && !hasPaid) {
        try {
            const orderTime = new Date(order.è¨‚è³¼æ™‚é–“);
            const now = new Date();
            const deadline = new Date(orderTime.getTime() + 1 * 60 * 1000); // ä¸‹å–®å¾Œ1åˆ†é˜
            const remaining = deadline - now;
            
            if (remaining <= 0) {
                isExpired = true;
                shouldShowPaymentButton = false;
                
                // è‡ªå‹•å–æ¶ˆè¨‚å–®ï¼ˆå‘¼å« GASï¼‰
                if (order.è¨‚å–®ç‹€æ…‹ !== 'å–æ¶ˆè¨‚å–®' && order.è¨‚å–®ç‹€æ…‹ !== 'è¨‚å–®å–æ¶ˆ' && order.è¨‚å–®ç‹€æ…‹ !== 'å·²å–æ¶ˆ' && order.è¨‚å–®ç‹€æ…‹ !== 'å·²ä»˜æ¬¾å¾…å‡ºè²¨') {
                    cancelExpiredOrder(order.è¨‚å–®ç·¨è™Ÿ);
                }
            }
        } catch (e) {
            console.error('æª¢æŸ¥é€¾æ™‚éŒ¯èª¤:', e);
        }
    }
    
    // è¨ˆç®—å‰©é¤˜æ™‚é–“ï¼ˆå¦‚æœæ˜¯7-11åº—åˆ°åº—ï¼‰
    let countdownHTML = '';
    const orderIdHash = order.è¨‚å–®ç·¨è™Ÿ.replace(/[^a-zA-Z0-9]/g, ''); // ç§»é™¤ç‰¹æ®Šå­—å…ƒ
    
    // å·²ä»˜æ¬¾çš„è¨‚å–®ä¸é¡¯ç¤ºå€’æ•¸æˆ–é€¾æœŸ
    if (order.å–è²¨æ–¹å¼ === '7-11åº—åˆ°åº—' && !hasPaid) {
        try {
            const orderTime = new Date(order.è¨‚è³¼æ™‚é–“);
            const now = new Date();
            const deadline = new Date(orderTime.getTime() + 1 * 60 * 1000); // ä¸‹å–®å¾Œ1åˆ†é˜
            const remaining = deadline - now;
            
            if (remaining > 0) {
                const hours = Math.floor(remaining / (1000 * 60 * 60));
                const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
                
                countdownHTML = `
                    <div style="
                        background: linear-gradient(135deg, rgba(255, 69, 0, 0.2), rgba(255, 140, 0, 0.2));
                        border: 2px solid #ff4500;
                        border-radius: 15px;
                        padding: 20px;
                        margin-bottom: 20px;
                        text-align: center;
                    ">
                        <h2 style="color: #ff4500; font-size: 20px; margin-bottom: 15px;">â° ä»˜æ¬¾å€’æ•¸</h2>
                        <div id="countdown-${orderIdHash}" style="
                            font-size: 32px;
                            font-weight: 900;
                            color: #FFD700;
                            font-family: 'Orbitron', monospace;
                        ">
                            ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}
                        </div>
                        <div style="color: #ff8c00; margin-top: 10px; font-size: 14px;">
                            è«‹æ–¼æ™‚é–“å…§å®Œæˆä»˜æ¬¾
                        </div>
                    </div>
                `;
            } else {
                countdownHTML = `
                    <div style="
                        background: linear-gradient(135deg, rgba(255, 0, 0, 0.3), rgba(150, 0, 0, 0.3));
                        border: 2px solid #ff0000;
                        border-radius: 15px;
                        padding: 30px;
                        margin-bottom: 20px;
                        text-align: center;
                    ">
                        <div style="font-size: 60px; margin-bottom: 15px;">âš ï¸</div>
                        <h2 style="color: #ff4444; font-size: 24px; margin-bottom: 10px; font-weight: 900;">ä»˜æ¬¾æ™‚é–“å·²é€¾æœŸ</h2>
                        <div style="color: #ff8c00; font-size: 16px; line-height: 1.6; margin-top: 15px;">
                            æ­¤è¨‚å–®å·²è¶…éä»˜æ¬¾æ™‚é™<br>
                            è¨‚å–®å·²è‡ªå‹•å–æ¶ˆ<br>
                            <strong style="color: #FFD700;">è«‹é‡æ–°ä¸‹å–®</strong>
                        </div>
                    </div>
                `;
            }
        } catch (e) {
            console.error('å€’æ•¸è¨ˆæ™‚éŒ¯èª¤:', e);
        }
    }
    
    // å»ºç«‹è¨‚å–®è©³æƒ… HTMLï¼ˆå„ªåŒ–ç‚ºä¸€é å¯è¦–ï¼‰
    const detailHTML = `
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%); z-index: 10000; overflow-y: auto; padding: 20px;">
            <div style="max-width: 800px; margin: 0 auto;">
                <!-- è¿”å›æŒ‰éˆ• -->
                <button onclick="closeOrderDetail()" style="
                    display: inline-flex;
                    align-items: center;
                    gap: 10px;
                    background: rgba(255, 215, 0, 0.1);
                    border: 2px solid #FFD700;
                    color: #FFD700;
                    padding: 10px 20px;
                    border-radius: 25px;
                    font-weight: 700;
                    margin-bottom: 15px;
                    cursor: pointer;
                    font-size: 14px;
                ">
                    â† è¿”å›è¨‚å–®åˆ—è¡¨
                </button>
                
                ${countdownHTML}
                
                <!-- ğŸ†• åŒ¯æ¬¾å¸³è™Ÿè³‡è¨Šï¼ˆåªæœ‰7-11åº—åˆ°åº—é¡¯ç¤ºï¼‰ -->
                ${order.å–è²¨æ–¹å¼ === '7-11åº—åˆ°åº—' ? `
                    <div style="
                        background: linear-gradient(135deg, rgba(0, 200, 0, 0.2), rgba(0, 255, 0, 0.2));
                        border: 2px solid #00c800;
                        border-radius: 15px;
                        padding: 25px;
                        margin-bottom: 20px;
                    ">
                        <h2 style="color: #00c800; font-size: 20px; margin-bottom: 20px; text-align: center;">
                            ğŸ’³ åŒ¯æ¬¾è³‡è¨Š
                        </h2>
                        
                        <div style="background: rgba(0, 0, 0, 0.4); padding: 20px; border-radius: 10px; margin-bottom: 15px;">
                            <div style="display: grid; gap: 12px;">
                                <div style="display: flex; justify-content: space-between; padding: 10px; background: rgba(255, 215, 0, 0.1); border-radius: 8px;">
                                    <span style="color: #999; font-size: 14px;">éŠ€è¡Œåç¨±</span>
                                    <span style="color: #FFD700; font-weight: 700; font-size: 14px;">å°æ–°éŠ€è¡Œï¼ˆ812ï¼‰</span>
                                </div>
                                
                                <div style="display: flex; justify-content: space-between; padding: 10px; background: rgba(255, 215, 0, 0.1); border-radius: 8px;">
                                    <span style="color: #999; font-size: 14px;">å¸³è™Ÿ</span>
                                    <span style="color: #FFD700; font-weight: 700; font-size: 16px; letter-spacing: 2px;">2028-01-0002558-8</span>
                                </div>
                                
                                <div style="display: flex; justify-content: space-between; padding: 10px; background: rgba(255, 215, 0, 0.1); border-radius: 8px;">
                                    <span style="color: #999; font-size: 14px;">æˆ¶å</span>
                                    <span style="color: #FFD700; font-weight: 700; font-size: 14px;">å‘¨å† å»·</span>
                                </div>
                                
                                <div style="display: flex; justify-content: space-between; padding: 10px; background: rgba(255, 215, 0, 0.1); border-radius: 8px;">
                                    <span style="color: #999; font-size: 14px;">åŒ¯æ¬¾é‡‘é¡</span>
                                    <span style="color: #00FF00; font-weight: 900; font-size: 20px;">$${order.ç¸½é‡‘é¡}</span>
                                </div>
                                
                                ${order.åŒ¯æ¬¾æœ«äº”ç¢¼ && order.åŒ¯æ¬¾æœ«äº”ç¢¼ !== '-' ? `
                                    <div style="display: flex; justify-content: space-between; padding: 10px; background: rgba(0, 255, 0, 0.2); border-radius: 8px; border: 1px solid #00c800;">
                                        <span style="color: #999; font-size: 14px;">æ‚¨çš„åŒ¯æ¬¾æœ«äº”ç¢¼</span>
                                        <span style="color: #00FF00; font-weight: 900; font-size: 18px;">${order.åŒ¯æ¬¾æœ«äº”ç¢¼}</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div style="background: rgba(255, 140, 0, 0.2); padding: 15px; border-radius: 8px; border-left: 4px solid #ff8c00;">
                            <div style="color: #ff8c00; font-size: 14px; line-height: 1.6;">
                                <strong>âš ï¸ é‡è¦æé†’ï¼š</strong><br>
                                â€¢ è«‹æ–¼æ™‚é–“å…§å®ŒæˆåŒ¯æ¬¾<br>
                                â€¢ åŒ¯æ¬¾å®Œæˆå¾Œè«‹è¨˜ä¸‹å¸³è™Ÿæœ«äº”ç¢¼<br>
                                â€¢ è¶…éæ™‚é–“æœªåŒ¯æ¬¾è¨‚å–®å°‡è‡ªå‹•å–æ¶ˆ
                            </div>
                        </div>
                    </div>
                ` : ''}
                
                <!-- ä¸»è¦è¨‚å–®å¡ç‰‡ - åˆä½µæ‰€æœ‰è³‡è¨Š -->
                <div style="
                    background: rgba(255, 255, 255, 0.05);
                    backdrop-filter: blur(10px);
                    border: 2px solid #FFD700;
                    border-radius: 20px;
                    padding: 25px;
                ">
                    <h1 style="
                        color: #FFD700;
                        font-size: 24px;
                        margin-bottom: 20px;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                    ">
                        ğŸ“¦ è¨‚å–®è©³æƒ…
                    </h1>
                    
                    <!-- è¨‚å–®è³‡è¨Š - ç·Šæ¹Šç‰ˆ -->
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px;">
                        <div style="background: rgba(0, 0, 0, 0.3); padding: 10px; border-radius: 8px;">
                            <div style="color: #999; font-size: 12px; margin-bottom: 5px;">è¨‚å–®ç·¨è™Ÿ</div>
                            <div style="color: #FFD700; font-weight: 700; font-size: 14px;">${order.è¨‚å–®ç·¨è™Ÿ}</div>
                        </div>
                        
                        <div style="background: rgba(0, 0, 0, 0.3); padding: 10px; border-radius: 8px;">
                            <div style="color: #999; font-size: 12px; margin-bottom: 5px;">è¨‚è³¼æ™‚é–“</div>
                            <div style="color: #FFD700; font-weight: 700; font-size: 14px;">${order.è¨‚è³¼æ™‚é–“}</div>
                        </div>
                        
                        <div style="background: rgba(0, 0, 0, 0.3); padding: 10px; border-radius: 8px;">
                            <div style="color: #999; font-size: 12px; margin-bottom: 5px;">å§“å</div>
                            <div style="color: #FFD700; font-weight: 700; font-size: 14px;">${order.å§“å}</div>
                        </div>
                        
                        <div style="background: rgba(0, 0, 0, 0.3); padding: 10px; border-radius: 8px;">
                            <div style="color: #999; font-size: 12px; margin-bottom: 5px;">é›»è©±</div>
                            <div style="color: #FFD700; font-weight: 700; font-size: 14px;">${order.é›»è©±}</div>
                        </div>
                        
                        <div style="background: rgba(0, 0, 0, 0.3); padding: 10px; border-radius: 8px;">
                            <div style="color: #999; font-size: 12px; margin-bottom: 5px;">å–è²¨æ–¹å¼</div>
                            <div style="color: #FFD700; font-weight: 700; font-size: 14px;">${order.å–è²¨æ–¹å¼}</div>
                        </div>
                        
                        <div style="background: rgba(0, 0, 0, 0.3); padding: 10px; border-radius: 8px;" id="payment-code-section">
                            <div style="color: #999; font-size: 12px; margin-bottom: 5px;">åŒ¯æ¬¾æœ«äº”ç¢¼</div>
                            ${order.åŒ¯æ¬¾æœ«äº”ç¢¼ && order.åŒ¯æ¬¾æœ«äº”ç¢¼ !== '-' ? `
                                <div style="color: #00FF00; font-weight: 700; font-size: 14px;">âœ… ${order.åŒ¯æ¬¾æœ«äº”ç¢¼}</div>
                            ` : order.å–è²¨æ–¹å¼ === '7-11åº—åˆ°åº—' ? `
                                <input 
                                    type="text" 
                                    id="payment-code-input" 
                                    placeholder="è«‹è¼¸å…¥5ç¢¼"
                                    maxlength="5"
                                    style="
                                        width: 100%;
                                        padding: 8px;
                                        border: 2px solid #FFD700;
                                        border-radius: 5px;
                                        background: rgba(0, 0, 0, 0.5);
                                        color: #FFD700;
                                        font-size: 16px;
                                        font-weight: 700;
                                        text-align: center;
                                        letter-spacing: 3px;
                                    "
                                >
                            ` : `
                                <div style="color: #FFD700; font-weight: 700; font-size: 14px;">-</div>
                            `}
                        </div>
                    </div>
                    
                    ${order.é–€å¸‚åç¨± && order.é–€å¸‚åç¨± !== '-' ? `
                        <div style="background: rgba(0, 0, 0, 0.3); padding: 12px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="color: #999; font-size: 12px; margin-bottom: 5px;">é–€å¸‚è³‡è¨Š</div>
                            <div style="color: #FFD700; font-weight: 700; font-size: 14px;">${order.é–€å¸‚åç¨±}</div>
                        </div>
                    ` : ''}
                    
                    <!-- å•†å“æ˜ç´° - ç·Šæ¹Šç‰ˆ -->
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #FFD700; font-size: 16px; margin-bottom: 10px;">ğŸ›’ å•†å“æ˜ç´°</h3>
                        <div style="
                            background: rgba(0, 0, 0, 0.3);
                            padding: 12px;
                            border-radius: 8px;
                            line-height: 1.6;
                            color: #fff;
                            font-size: 14px;
                            max-height: 150px;
                            overflow-y: auto;
                        ">
                            ${order.å•†å“æ˜ç´°.split(',').map(item => `<div style="padding: 5px 0;">â€¢ ${item.trim()}</div>`).join('')}
                        </div>
                    </div>
                    
                    <!-- é‡‘é¡æ‘˜è¦ - ç·Šæ¹Šç‰ˆ -->
                    <div style="
                        background: rgba(255, 215, 0, 0.1);
                        border: 1px solid #FFD700;
                        border-radius: 10px;
                        padding: 15px;
                        margin-bottom: 15px;
                    ">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #999; font-size: 14px;">å•†å“é‡‘é¡</span>
                            <span style="color: #fff; font-weight: 700; font-size: 14px;">$${order.å•†å“é‡‘é¡ || (order.ç¸½é‡‘é¡ - (order.é‹è²» || 0))}</span>
                        </div>
                        ${order.é‹è²» && order.é‹è²» > 0 ? `
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: #999; font-size: 14px;">é‹è²»</span>
                                <span style="color: #fff; font-weight: 700; font-size: 14px;">$${order.é‹è²»}</span>
                            </div>
                        ` : ''}
                        <div style="
                            display: flex;
                            justify-content: space-between;
                            padding-top: 10px;
                            border-top: 1px solid #FFD700;
                            font-size: 20px;
                            font-weight: 900;
                        ">
                            <span style="color: #FFD700;">ç¸½é‡‘é¡</span>
                            <span style="color: #FFD700;">$${order.ç¸½é‡‘é¡}</span>
                        </div>
                    </div>
                    
                    <!-- è¨‚å–®ç‹€æ…‹ -->
                    <div style="text-align: center;">
                        <div style="
                            background: ${order.è¨‚å–®ç‹€æ…‹ === 'å·²å®Œæˆ' ? '#00FF00' : order.è¨‚å–®ç‹€æ…‹ === 'å¾…è™•ç†' ? '#ffa500' : order.è¨‚å–®ç‹€æ…‹ === 'å–æ¶ˆè¨‚å–®' || order.è¨‚å–®ç‹€æ…‹ === 'è¨‚å–®å–æ¶ˆ' || order.è¨‚å–®ç‹€æ…‹ === 'å·²å–æ¶ˆ' ? '#ff4444' : order.è¨‚å–®ç‹€æ…‹ === 'å·²ä»˜æ¬¾å¾…å‡ºè²¨' ? '#00bfff' : '#FFD700'};
                            color: #000;
                            padding: 10px 30px;
                            border-radius: 20px;
                            font-size: 16px;
                            font-weight: 900;
                            display: inline-block;
                            margin-bottom: 15px;
                        ">
                            ${order.è¨‚å–®ç‹€æ…‹}
                        </div>
                        
                        ${order.å–è²¨æ–¹å¼ === '7-11åº—åˆ°åº—' && (!order.åŒ¯æ¬¾æœ«äº”ç¢¼ || order.åŒ¯æ¬¾æœ«äº”ç¢¼ === '-') && shouldShowPaymentButton && !isExpired ? `
                            <div>
                                <button 
                                    onclick="submitPaymentCode('${order.è¨‚å–®ç·¨è™Ÿ}')"
                                    style="
                                        background: linear-gradient(135deg, #00c800, #00ff00);
                                        color: #000;
                                        border: none;
                                        padding: 15px 40px;
                                        border-radius: 25px;
                                        font-size: 18px;
                                        font-weight: 900;
                                        cursor: pointer;
                                        box-shadow: 0 5px 15px rgba(0, 200, 0, 0.3);
                                        transition: all 0.3s ease;
                                    "
                                    onmouseover="this.style.transform='scale(1.05)'"
                                    onmouseout="this.style.transform='scale(1)'"
                                >
                                    ğŸ’³ ç¢ºèªä»˜æ¬¾
                                </button>
                                <div style="color: #999; font-size: 12px; margin-top: 10px;">
                                    è«‹å…ˆå¡«å¯«åŒ¯æ¬¾æœ«äº”ç¢¼å¾Œå†é»æ“Šç¢ºèª
                                </div>
                            </div>
                        ` : isExpired ? `
                            <div style="
                                background: rgba(255, 0, 0, 0.2);
                                border: 2px solid #ff4444;
                                padding: 20px;
                                border-radius: 15px;
                                margin-top: 15px;
                            ">
                                <div style="color: #ff4444; font-size: 18px; font-weight: 700; margin-bottom: 10px;">
                                    âŒ ä»˜æ¬¾æ™‚é™å·²é
                                </div>
                                <div style="color: #ff8c00; font-size: 14px; line-height: 1.6;">
                                    æ­¤è¨‚å–®å·²è¶…é1å°æ™‚ä»˜æ¬¾æ™‚é™<br>
                                    ç³»çµ±å·²è‡ªå‹•å–æ¶ˆè¨‚å–®<br>
                                    <strong style="color: #FFD700;">è«‹è¿”å›é¦–é é‡æ–°ä¸‹å–®</strong>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // å»ºç«‹ä¸¦é¡¯ç¤ºè©³æƒ…é é¢
    const detailDiv = document.createElement('div');
    detailDiv.id = 'orderDetailView';
    detailDiv.innerHTML = detailHTML;
    document.body.appendChild(detailDiv);
    
    // å•Ÿå‹•å€’æ•¸è¨ˆæ™‚
    if (order.å–è²¨æ–¹å¼ === '7-11åº—åˆ°åº—') {
        if (!hasPaid) startCountdown(order.è¨‚å–®ç·¨è™Ÿ, order.è¨‚è³¼æ™‚é–“);
    }
}

// å€’æ•¸è¨ˆæ™‚å‡½æ•¸
function startCountdown(orderId, orderTime) {
    const orderIdHash = orderId.replace(/[^a-zA-Z0-9]/g, ''); // ç§»é™¤ç‰¹æ®Šå­—å…ƒ
    const countdownEl = document.getElementById(`countdown-${orderIdHash}`);
    if (!countdownEl) return;
    
    const timer = setInterval(() => {
        try {
            const orderDate = new Date(orderTime);
            const now = new Date();
            const deadline = new Date(orderDate.getTime() + 1 * 60 * 1000); // ä¸‹å–®å¾Œ1åˆ†é˜
            const remaining = deadline - now;
            
            if (remaining <= 0) {
                clearInterval(timer);
                
                // å·²ä»˜æ¬¾ï¼ˆpayment-code-section é¡¯ç¤º âœ…ï¼‰å°±ä¸å–æ¶ˆä¹Ÿä¸é¡¯ç¤ºé€¾æœŸ
                const paidSection = document.getElementById('payment-code-section');
                const alreadyPaid = paidSection && paidSection.textContent.includes('âœ…');
                if (alreadyPaid) return;
                
                // è‡ªå‹•å–æ¶ˆè¨‚å–®
                cancelExpiredOrder(orderId);
                
                // æ›´æ–°é¡¯ç¤º
                countdownEl.parentElement.parentElement.innerHTML = `
                    <div style="
                        background: linear-gradient(135deg, rgba(255, 0, 0, 0.3), rgba(150, 0, 0, 0.3));
                        border: 2px solid #ff0000;
                        border-radius: 15px;
                        padding: 30px;
                        margin-bottom: 20px;
                        text-align: center;
                    ">
                        <div style="font-size: 60px; margin-bottom: 15px;">âš ï¸</div>
                        <h2 style="color: #ff4444; font-size: 24px; margin-bottom: 10px; font-weight: 900;">ä»˜æ¬¾æ™‚é–“å·²é€¾æœŸ</h2>
                        <div style="color: #ff8c00; font-size: 16px; line-height: 1.6; margin-top: 15px;">
                            æ­¤è¨‚å–®å·²è¶…éä»˜æ¬¾æ™‚é™<br>
                            è¨‚å–®å·²è‡ªå‹•å–æ¶ˆ<br>
                            <strong style="color: #FFD700;">è«‹é‡æ–°ä¸‹å–®</strong>
                        </div>
                    </div>
                `;
                
                // éš±è—ä»˜æ¬¾æŒ‰éˆ•ï¼ˆå¦‚æœæœ‰ï¼‰
                const paymentSection = document.querySelector('[onclick*="submitPaymentCode"]');
                if (paymentSection && paymentSection.parentElement) {
                    paymentSection.parentElement.innerHTML = `
                        <div style="
                            background: rgba(255, 0, 0, 0.2);
                            border: 2px solid #ff4444;
                            padding: 20px;
                            border-radius: 15px;
                            margin-top: 15px;
                        ">
                            <div style="color: #ff4444; font-size: 18px; font-weight: 700; margin-bottom: 10px;">
                                âŒ ä»˜æ¬¾æ™‚é™å·²é
                            </div>
                            <div style="color: #ff8c00; font-size: 14px; line-height: 1.6;">
                                æ­¤è¨‚å–®å·²è¶…é1å°æ™‚ä»˜æ¬¾æ™‚é™<br>
                                ç³»çµ±å·²è‡ªå‹•å–æ¶ˆè¨‚å–®<br>
                                <strong style="color: #FFD700;">è«‹è¿”å›é¦–é é‡æ–°ä¸‹å–®</strong>
                            </div>
                        </div>
                    `;
                }
                
                return;
            }
            
            const hours = Math.floor(remaining / (1000 * 60 * 60));
            const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
            
            countdownEl.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        } catch (e) {
            clearInterval(timer);
        }
    }, 1000);
    
    // å„²å­˜timerä»¥ä¾¿æ¸…ç†
    if (!window.orderTimers) window.orderTimers = {};
    window.orderTimers[orderIdHash] = timer;
}

// ==========================================
// ğŸ”¥ è‡ªå‹•å–æ¶ˆé€¾æ™‚è¨‚å–®
// ==========================================
async function cancelExpiredOrder(orderId) {
    try {
        console.log('ğŸ”¥ è‡ªå‹•å–æ¶ˆé€¾æ™‚è¨‚å–®:', orderId);
        await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({
                action: 'cancelExpiredOrder',
                orderId: orderId
            })
        });
        console.log('âœ… å–æ¶ˆè«‹æ±‚å·²é€å‡º');
    } catch (error) {
        console.error('âŒ å–æ¶ˆè¨‚å–®å¤±æ•—:', error);
    }
}

// ==========================================
// ğŸ†• æäº¤åŒ¯æ¬¾æœ«äº”ç¢¼
// ==========================================
async function submitPaymentCode(orderId) {
    const input = document.getElementById('payment-code-input');
    if (!input) { showToast('æ‰¾ä¸åˆ°è¼¸å…¥æ¬„ä½', 'error'); return; }
    
    const paymentCode = input.value.trim();
    if (!paymentCode) { showToast('è«‹è¼¸å…¥åŒ¯æ¬¾æœ«äº”ç¢¼', 'error'); input.focus(); return; }
    if (paymentCode.length !== 5) { showToast('è«‹è¼¸å…¥å®Œæ•´çš„5ç¢¼', 'error'); input.focus(); return; }
    if (!/^\d{5}$/.test(paymentCode)) { showToast('è«‹è¼¸å…¥5ä½æ•¸å­—', 'error'); input.focus(); return; }
    if (!confirm(`ç¢ºèªåŒ¯æ¬¾æœ«äº”ç¢¼ç‚ºï¼š${paymentCode}ï¼Ÿ\n\né€å‡ºå¾Œå°‡æ›´æ–°è¨‚å–®ç‹€æ…‹ç‚ºã€Œå·²ä»˜æ¬¾ã€`)) return;
    
    // btn åœ¨ try å¤–ï¼Œcatch æ‰èƒ½ç”¨
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = 'â³ è™•ç†ä¸­...';
    btn.disabled = true;
    
    try {
        // no-cors æ¨¡å¼é€å‡ºï¼Œä¸ç­‰å›å‚³
        await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({
                action: 'updatePaymentCode',
                orderId: orderId,
                paymentCode: paymentCode
            })
        });
        
        // åœæ­¢å€’æ•¸è¨ˆæ™‚å™¨
        const orderIdHash = orderId.replace(/[^a-zA-Z0-9]/g, '');
        if (window.orderTimers && window.orderTimers[orderIdHash]) {
            clearInterval(window.orderTimers[orderIdHash]);
            delete window.orderTimers[orderIdHash];
        }
        
        // éš±è—å€’æ•¸å€å¡Š
        const countdownEl = document.getElementById('countdown-' + orderIdHash);
        if (countdownEl) {
            let box = countdownEl.parentElement;
            while (box && box !== document.body) {
                if (box.style && box.style.border) { box.style.display = 'none'; break; }
                box = box.parentElement;
            }
        }
        
        // æ›´æ–°æœ«äº”ç¢¼é¡¯ç¤º
        const section = document.getElementById('payment-code-section');
        if (section) {
            section.innerHTML = `
                <div style="color:#999;font-size:12px;margin-bottom:5px;">åŒ¯æ¬¾æœ«äº”ç¢¼</div>
                <div style="color:#00FF00;font-weight:700;font-size:14px;">âœ… ${paymentCode}</div>
            `;
        }
        
        // æŠŠé€å‡ºæŒ‰éˆ•æ›æˆæˆåŠŸè¨Šæ¯ï¼Œä¿æŒåœ¨åŸé é¢
        btn.parentElement.innerHTML = `
            <div style="background:rgba(0,255,0,0.2);border:2px solid #00c800;padding:20px;
                border-radius:15px;color:#00FF00;font-weight:700;text-align:center;font-size:16px;">
                âœ… ä»˜æ¬¾å·²ç¢ºèªï¼Œç­‰å¾…å•†å®¶è™•ç†
            </div>
        `;
        
        showToast('âœ… ä»˜æ¬¾ç¢ºèªæˆåŠŸï¼', 'success');
        
    } catch (error) {
        console.error('æäº¤ä»˜æ¬¾ç¢¼å¤±æ•—:', error);
        showToast('âŒ æäº¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

function closeOrderDetail() {
    if (window.orderTimers) {
        Object.values(window.orderTimers).forEach(timer => clearInterval(timer));
        window.orderTimers = {};
    }
    const detailView = document.getElementById('orderDetailView');
    if (detailView) detailView.remove();
}

async function loadMemberOrders() {
    if (!currentMember || !currentMember.lineId) {
        document.getElementById('ordersList').innerHTML = `
            <div style="text-align:center; padding:40px; color:#999;">
                <div style="font-size:40px; margin-bottom:20px;">ğŸ”</div>
                <div>è«‹å…ˆç™»å…¥</div>
            </div>
        `;
        return;
    }
    
    try {
        const response = await fetch(`${APPS_SCRIPT_URL}?action=getOrdersByLine&lineId=${encodeURIComponent(currentMember.lineId)}`);
        const result = await response.json();
        
        const ordersList = document.getElementById('ordersList');
        
        if (result.success && result.orders && result.orders.length > 0) {
            // é¡¯ç¤ºè¨‚å–®åˆ—è¡¨
            ordersList.innerHTML = result.orders.map((order, index) => `
                <div class="order-card" style="
                    background: rgba(255, 255, 255, 0.05);
                    border: 1px solid rgba(255, 215, 0, 0.3);
                    border-radius: 10px;
                    padding: 20px;
                    margin-bottom: 15px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                " onclick="showOrderDetail(${index})">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid rgba(255,215,0,0.2); padding-bottom:10px;">
                        <div>
                            <div style="font-size:16px; font-weight:700; color:var(--primary);">
                                è¨‚å–® #${index + 1}
                            </div>
                            <div style="font-size:12px; color:#999; margin-top:5px;">
                                ${order.è¨‚è³¼æ™‚é–“}
                            </div>
                        </div>
                        <div style="
                            background: ${order.è¨‚å–®ç‹€æ…‹ === 'å·²å®Œæˆ' ? 'var(--accent-green)' : order.è¨‚å–®ç‹€æ…‹ === 'å¾…è™•ç†' ? '#ffa500' : order.è¨‚å–®ç‹€æ…‹ === 'å–æ¶ˆè¨‚å–®' || order.è¨‚å–®ç‹€æ…‹ === 'è¨‚å–®å–æ¶ˆ' ? '#ff4444' : order.è¨‚å–®ç‹€æ…‹ === 'å·²ä»˜æ¬¾å¾…å‡ºè²¨' ? '#00bfff' : 'var(--primary)'};
                            color: var(--secondary);
                            padding: 5px 15px;
                            border-radius: 15px;
                            font-size: 12px;
                            font-weight: 700;
                        ">
                            ${order.è¨‚å–®ç‹€æ…‹}
                        </div>
                    </div>
                    
                    <div style="line-height:1.8; font-size:14px;">
                        <div><strong>è¨‚å–®ç·¨è™Ÿï¼š</strong>${order.è¨‚å–®ç·¨è™Ÿ}</div>
                        <div><strong>ç¸½é‡‘é¡ï¼š</strong><span style="color:var(--primary); font-size:18px; font-weight:900;">$${order.ç¸½é‡‘é¡}</span></div>
                        <div style="margin-top:10px; color:#999; font-size:12px;">
                            ${order.å•†å“æ˜ç´°.length > 50 ? order.å•†å“æ˜ç´°.substring(0, 50) + '...' : order.å•†å“æ˜ç´°}
                        </div>
                    </div>
                    
                    <div style="margin-top:15px; padding-top:15px; border-top:1px solid rgba(255,215,0,0.2); text-align:center;">
                        <span style="color:var(--primary); font-size:14px; font-weight:700;">
                            ğŸ‘‰ é»æ“ŠæŸ¥çœ‹è©³æƒ…
                        </span>
                    </div>
                </div>
            `).join('');
            
            // å„²å­˜è¨‚å–®è³‡æ–™åˆ°å…¨åŸŸè®Šæ•¸
            window.memberOrders = result.orders;
            
            // åŠ ä¸Šç¸½è¨‚å–®æ•¸
            ordersList.innerHTML += `
                <div style="text-align:center; padding:20px; color:#999; font-size:14px;">
                    å…± ${result.orders.length} ç­†è¨‚å–®
                </div>
            `;
        } else {
            // æ²’æœ‰è¨‚å–®
            ordersList.innerHTML = `
                <div style="text-align:center; padding:60px 20px; color:#999;">
                    <div style="font-size:60px; margin-bottom:20px;">ğŸ“¦</div>
                    <div style="font-size:18px; font-weight:700; margin-bottom:10px;">å°šç„¡è¨‚å–®è¨˜éŒ„</div>
                    <div style="font-size:14px;">é–‹å§‹è³¼ç‰©ï¼Œå»ºç«‹æ‚¨çš„ç¬¬ä¸€ç­†è¨‚å–®å§ï¼</div>
                </div>
            `;
        }
    } catch (error) {
        console.error('æŸ¥è©¢è¨‚å–®å¤±æ•—:', error);
        document.getElementById('ordersList').innerHTML = `
            <div style="text-align:center; padding:40px; color:#ff4444;">
                <div style="font-size:40px; margin-bottom:20px;">âŒ</div>
                <div>æŸ¥è©¢å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</div>
            </div>
        `;
    }
}

// ==========================================
// æç¤ºè¨Šæ¯
// ==========================================
function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = 'toast show ' + (type === 'error' ? 'error' : '');
    setTimeout(() => toast.classList.remove('show'), 3000);
}

// ==========================================
// LINE ç™»å…¥åŠŸèƒ½
// ==========================================

function lineLogin() {
    const url = `https://access.line.me/oauth2/v2.1/authorize?` +
        `response_type=code` +
        `&client_id=${LINE_CHANNEL_ID}` +
        `&redirect_uri=${encodeURIComponent(LINE_REDIRECT_URI)}` +
        `&state=${LINE_STATE}` +
        `&scope=profile%20openid`;
    
    window.location.href = url;
}

async function checkMemberStatus() {
    const memberData = localStorage.getItem('candyboss_member');
    if (memberData) {
        try {
            currentMember = JSON.parse(memberData);
        } catch (e) {
            console.error('æœƒå“¡è³‡æ–™è§£æéŒ¯èª¤:', e);
            localStorage.removeItem('candyboss_member');
            currentMember = null;
            showLoginWall();
            return;
        }
        
        // å…ˆç«‹åˆ»é¡¯ç¤º UIï¼ˆé¿å…ç•«é¢å¡ç™½ï¼‰ï¼Œå†èƒŒæ™¯åŒæ­¥å¯©æ ¸ç‹€æ…‹
        updateMemberUI();
        
        // èƒŒæ™¯æ›´æ–°å¯©æ ¸ç‹€æ…‹ï¼ˆä¸é˜»å¡ UIï¼‰
        fetchMemberApprovalStatus().then(() => {
            updateMemberUI();
        }).catch(e => {
            console.warn('å¯©æ ¸ç‹€æ…‹åŒæ­¥å¤±æ•—ï¼ˆä¸å½±éŸ¿ç™»å…¥ï¼‰:', e);
        });
    } else {
        showLoginWall();
    }
}

async function fetchMemberApprovalStatus() {
    if (!currentMember || !currentMember.lineId) return;
    
    try {
        // åŠ ä¸Š 5 ç§’ timeoutï¼Œé¿å… Apps Script æ…¢å›æ‡‰è®“é é¢å¡ä½
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        
        const response = await fetch(
            `${APPS_SCRIPT_URL}?action=getMember&lineId=${encodeURIComponent(currentMember.lineId)}`,
            { signal: controller.signal }
        );
        clearTimeout(timeoutId);
        
        const result = await response.json();
        
        if (result.success && result.member) {
            // æ›´æ–°å¯©æ ¸ç‹€æ…‹åˆ° localStorage
            currentMember.approvalStatus = result.member.approvalStatus || 'å¾…å¯©æ ¸';
            if (result.member.phone) currentMember.phone = result.member.phone;
            if (result.member.email) currentMember.email = result.member.email;
            localStorage.setItem('candyboss_member', JSON.stringify(currentMember));
        }
    } catch (error) {
        console.warn('å–å¾—å¯©æ ¸ç‹€æ…‹å¤±æ•—ï¼ˆå°‡ä½¿ç”¨æœ¬åœ°å¿«å–ï¼‰:', error.name === 'AbortError' ? 'Timeout' : error.message);
        // å¦‚æœå–å¾—å¤±æ•—ï¼Œç¶­æŒ localStorage è£¡å·²æœ‰çš„ç‹€æ…‹ï¼ˆä¸æ¸…ç©ºï¼‰
        currentMember.approvalStatus = currentMember.approvalStatus || 'å¾…å¯©æ ¸';
    }
}

function showLoginWall() {
    document.getElementById('loginWall').style.display = 'flex';
    document.getElementById('pendingApproval').style.display = 'none';
    document.getElementById('rejectedApproval').style.display = 'none';
    document.getElementById('productsSection').style.display = 'none';
    
    // ğŸ”¥ ä¿®æ­£ï¼šé¡¯ç¤ºå°èˆªæŒ‰éˆ•å€åŸŸï¼Œä¸¦é¡¯ç¤º LINE ç™»å…¥æŒ‰éˆ•
    document.getElementById('navButtons').style.display = 'flex';
    document.getElementById('lineLoginBtn').style.display = 'block';
    document.getElementById('memberInfo').style.display = 'none';
}

function updateMemberUI() {
    if (currentMember) {
        // é¡¯ç¤ºå°èˆªæŒ‰éˆ•å€
        document.getElementById('navButtons').style.display = 'flex';
        document.getElementById('lineLoginBtn').style.display = 'none';
        document.getElementById('memberInfo').style.display = 'flex';
        document.getElementById('memberAvatar').src = currentMember.pictureUrl || '';
        // ä¸é¡¯ç¤ºåç¨±
        
        // æ ¹æ“šå¯©æ ¸ç‹€æ…‹é¡¯ç¤ºä¸åŒå…§å®¹
        const approvalStatus = currentMember.approvalStatus || 'å¾…å¯©æ ¸';
        
        if (approvalStatus === 'å·²é€šé') {
            // å¯©æ ¸é€šéï¼šé¡¯ç¤ºå•†å“
            document.getElementById('loginWall').style.display = 'none';
            document.getElementById('pendingApproval').style.display = 'none';
            document.getElementById('rejectedApproval').style.display = 'none';
            document.getElementById('productsSection').style.display = 'block';
            
            // è‡ªå‹•å¡«å…¥æœƒå“¡è³‡æ–™åˆ°çµå¸³è¡¨å–®
            if (currentMember.phone) {
                const phoneInput = document.getElementById('customerPhone');
                if (phoneInput && phoneInput.value === '') {
                    phoneInput.value = currentMember.phone;
                }
            }
            if (currentMember.displayName) {
                const nameInput = document.getElementById('customerName');
                if (nameInput && nameInput.value === '') {
                    nameInput.value = currentMember.displayName;
                }
            }
        } else if (approvalStatus === 'å·²æ‹’çµ•') {
            // å¯©æ ¸æ‹’çµ•
            document.getElementById('loginWall').style.display = 'none';
            document.getElementById('pendingApproval').style.display = 'none';
            document.getElementById('rejectedApproval').style.display = 'flex';
            document.getElementById('productsSection').style.display = 'none';
        } else {
            // å¾…å¯©æ ¸
            document.getElementById('loginWall').style.display = 'none';
            document.getElementById('pendingApproval').style.display = 'flex';
            document.getElementById('rejectedApproval').style.display = 'none';
            document.getElementById('productsSection').style.display = 'none';
        }
    } else {
        document.getElementById('lineLoginBtn').style.display = 'block';
        document.getElementById('memberInfo').style.display = 'none';
        showLoginWall();
    }
}

async function checkApprovalStatus() {
    showToast('æª¢æŸ¥ä¸­...', 'success');
    await fetchMemberApprovalStatus();
    updateMemberUI();
    
    if (currentMember.approvalStatus === 'å·²é€šé') {
        showToast('å¯©æ ¸å·²é€šéï¼æ­¡è¿è³¼ç‰©ï¼');
    } else if (currentMember.approvalStatus === 'å·²æ‹’çµ•') {
        showToast('å¯©æ ¸æœªé€šé', 'error');
    } else {
        showToast('ä»åœ¨å¯©æ ¸ä¸­ï¼Œè«‹è€å¿ƒç­‰å€™', 'error');
    }
}

function logout() {
    if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
        // æ¸…é™¤æœƒå“¡è³‡æ–™
        currentMember = null;
        localStorage.removeItem('candyboss_member');
        
        // é‡ç½® UI
        document.getElementById('lineLoginBtn').style.display = 'block';
        document.getElementById('memberInfo').style.display = 'none';
        
        // é¡¯ç¤ºç™»å…¥ç‰†ï¼Œéš±è—å…¶ä»–æ‰€æœ‰å…§å®¹
        document.getElementById('loginWall').style.display = 'flex';
        document.getElementById('pendingApproval').style.display = 'none';
        document.getElementById('rejectedApproval').style.display = 'none';
        document.getElementById('productsSection').style.display = 'none';
        
        showToast('å·²ç™»å‡º');
        
        // ç‚ºäº†ç¢ºä¿ï¼Œ3ç§’å¾Œé‡æ–°æ•´ç†é é¢
        setTimeout(() => {
            window.location.reload();
        }, 1500);
    }
}

// ==========================================
// æœƒå“¡è³‡æ–™æŸ¥çœ‹èˆ‡ç·¨è¼¯
// ==========================================

function openMemberProfileModal() {
    if (!currentMember) {
        showToast('è«‹å…ˆç™»å…¥', 'error');
        return;
    }
    
    // å¡«å…¥æœƒå“¡è³‡æ–™
    document.getElementById('profileAvatar').src = currentMember.pictureUrl || '';
    document.getElementById('profileDisplayName').textContent = currentMember.displayName || 'æœªè¨­å®š';
    document.getElementById('profilePhone').textContent = currentMember.phone || 'æœªè¨­å®š';
    document.getElementById('profileEmail').textContent = currentMember.email || 'æœªè¨­å®š';
    document.getElementById('profileLineId').textContent = currentMember.lineId || '';
    
    // é¡¯ç¤ºå¯©æ ¸ç‹€æ…‹
    const approvalStatus = currentMember.approvalStatus || 'å¾…å¯©æ ¸';
    const statusElement = document.getElementById('profileApprovalStatus');
    statusElement.textContent = approvalStatus;
    
    // æ ¹æ“šç‹€æ…‹æ”¹è®Šé¡è‰²
    if (approvalStatus === 'å·²é€šé') {
        statusElement.style.color = 'var(--accent-green)';
    } else if (approvalStatus === 'å·²æ‹’çµ•') {
        statusElement.style.color = '#ff4444';
    } else {
        statusElement.style.color = '#ffa500';
    }
    
    // é¡¯ç¤ºå½ˆçª—
    document.getElementById('memberProfileModal').classList.add('active');
}

function closeMemberProfileModal() {
    document.getElementById('memberProfileModal').classList.remove('active');
}

function openEditProfileModal() {
    // é—œé–‰æŸ¥çœ‹å½ˆçª—
    closeMemberProfileModal();
    
    // å¡«å…¥ç¾æœ‰è³‡æ–™
    document.getElementById('updatePhone').value = currentMember.phone || '';
    document.getElementById('updateEmail').value = currentMember.email || '';
    
    // é¡¯ç¤ºç·¨è¼¯å½ˆçª—
    document.getElementById('profileUpdateModal').classList.add('active');
}

function closeProfileUpdateModal() {
    document.getElementById('profileUpdateModal').classList.remove('active');
}

async function submitProfileUpdate() {
    const phone = document.getElementById('updatePhone').value.trim();
    const email = document.getElementById('updateEmail').value.trim();
    
    // é©—è­‰é›»è©±
    if (!phone) {
        showToast('è«‹è¼¸å…¥é›»è©±è™Ÿç¢¼', 'error');
        return;
    }
    
    // é©—è­‰é›»è©±æ ¼å¼ï¼ˆå°ç£æ‰‹æ©Ÿè™Ÿç¢¼ï¼‰
    const phonePattern = /^09\d{8}$/;
    if (!phonePattern.test(phone)) {
        showToast('è«‹è¼¸å…¥æ­£ç¢ºçš„æ‰‹æ©Ÿè™Ÿç¢¼æ ¼å¼ï¼ˆä¾‹ï¼š0912345678ï¼‰', 'error');
        return;
    }
    
    if (!currentMember) {
        showToast('æœƒå“¡è³‡æ–™ç•°å¸¸ï¼Œè«‹é‡æ–°ç™»å…¥', 'error');
        return;
    }
    
    try {
        showToast('æ›´æ–°ä¸­...', 'success');
        
        // æ›´æ–°åˆ° Google Sheets
        await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                action: 'saveMember',
                lineId: currentMember.lineId,
                displayName: currentMember.displayName,
                pictureUrl: currentMember.pictureUrl,
                phone: phone,
                email: email
            })
        });
        
        // æ›´æ–°æœ¬åœ°è³‡æ–™
        currentMember.phone = phone;
        currentMember.email = email;
        localStorage.setItem('candyboss_member', JSON.stringify(currentMember));
        
        // é—œé–‰å½ˆçª—
        closeProfileUpdateModal();
        showToast('è³‡æ–™æ›´æ–°æˆåŠŸï¼');
        
    } catch (error) {
        console.error('æ›´æ–°å¤±æ•—:', error);
        showToast('æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
    }
}

// ==========================================
// åˆå§‹åŒ–
// ==========================================
window.addEventListener('load', () => {
    console.log('ğŸš€ é é¢è¼‰å…¥å®Œæˆ');
    
    // ğŸ”¥ é˜²æ­¢é›™æ“Šæ”¾å¤§ï¼ˆå¾¹åº•è§£æ±ºæ–¹æ¡ˆï¼‰
    let lastTouchEnd = 0;
    document.addEventListener('touchend', (event) => {
        const now = Date.now();
        if (now - lastTouchEnd <= 300) {
            event.preventDefault(); // é˜»æ­¢é›™æ“Šäº‹ä»¶
        }
        lastTouchEnd = now;
    }, false);
    
    // æ­£å¸¸åˆå§‹åŒ–
    loadProductsData();
    loadSystemSettings(); // ğŸ†• è¼‰å…¥ç³»çµ±è¨­å®šï¼ˆåŒ¯æ¬¾è³‡è¨Šï¼‰
    updateCart();
    checkMemberStatus();
    
    // ğŸ”¥ å•Ÿå‹•è‡ªå‹•åˆ·æ–°åº«å­˜åŠŸèƒ½ï¼ˆæ¯30ç§’åˆ·æ–°ä¸€æ¬¡ï¼‰
    // å¯ä»¥èª¿æ•´ç§’æ•¸ï¼š15ç§’æ›´å¿«ä½†è€—æµé‡ã€60ç§’æ›´æ…¢ä½†çœæµé‡
    startAutoRefresh(30);
});

// ç•¶ç”¨æˆ¶é›¢é–‹é é¢æ™‚ï¼Œåœæ­¢è‡ªå‹•åˆ·æ–°ä»¥ç¯€çœè³‡æº
window.addEventListener('beforeunload', () => {
    stopAutoRefresh();
});
    </script>
</body>
</html>
