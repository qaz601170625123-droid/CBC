<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CANDY BOSS - Ë≥ºÁâ©ÂïÜÂüé v2.5</title>
    <!-- Âº∑Âà∂Âà∑Êñ∞Âø´Âèñ - ÁâàÊú¨ 2.5 - ÊîØÊè¥FÊ¨ÑÂ§ßÂàÜÈ°ûÈÅéÊøæÂäüËÉΩ -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
    <!-- Crypto-JS for SHA256 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        // Âº∑Âà∂Ê∏ÖÈô§Âø´Âèñ
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) {
                    registration.unregister();
                }
            });
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            touch-action: manipulation; /* Èò≤Ê≠¢ÈõôÊìäÊîæÂ§ß */
            -webkit-text-size-adjust: 100%; /* Èò≤Ê≠¢ iOS Ëá™ÂãïË™øÊï¥Â≠óÈ´îÂ§ßÂ∞è */
        }

        :root {
            --primary: #FFD700;
            --secondary: #1a1a1a;
            --bg-dark: #0a0a0a;
            --text-light: #ffffff;
            --text-muted: #999;
            --accent-green: #00FF00;
            --gradient-start: #FF6B9D;
            --gradient-end: #C084FC;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: var(--bg-dark);
            color: var(--text-light);
            min-height: 100vh;
            touch-action: manipulation; /* ÂÖ®ÂüüÈò≤Ê≠¢ÈõôÊìäÊîæÂ§ß */
            -webkit-tap-highlight-color: transparent; /* ÁßªÈô§ÈªûÊìäÈ´ò‰∫Æ */
        }

        /* È†ÇÈÉ®Â∞éËà™ */
        .navbar {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--primary);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-family: 'Orbitron', sans-serif;
            font-size: 24px;
            font-weight: 900;
            color: var(--primary);
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid var(--primary);
            color: var(--primary);
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background: var(--primary);
            color: var(--secondary);
        }

        /* üÜï ÂÖ¨ÂëäÂàóÊ®£Âºè */
        .announcement-bar {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15) 0%, rgba(255, 140, 0, 0.1) 100%);
            border-bottom: 2px solid var(--primary);
            padding: 12px 0;
            overflow: hidden;
            position: relative;
            display: none; /* È†êË®≠Èö±ËóèÔºåÊúâÂÖ¨ÂëäÊâçÈ°ØÁ§∫ */
        }
        
        .announcement-bar.active {
            display: block;
        }
        
        .announcement-content {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 15px;
            overflow: hidden;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .announcement-icon {
            font-size: 20px;
            animation: pulse 2s ease-in-out infinite;
            flex-shrink: 0;
        }
        
        .announcement-text {
            font-size: 15px;
            font-weight: 700;
            color: var(--primary);
            white-space: nowrap;
            display: inline-block;
            transition: opacity 0.3s ease;
        }
        
        /* Ë∑ëÈ¶¨ÁáàÊïàÊûúÔºàÂñÆÂâáÂÖ¨ÂëäÔºâ */
        .announcement-text.marquee {
            animation: marquee 30s linear infinite;
        }
        
        @keyframes marquee {
            0% {
                transform: translateX(100%);
            }
            100% {
                transform: translateX(-100%);
            }
        }
        
        /* Ê∑°ÂÖ•Ê∑°Âá∫ÊïàÊûúÔºàÂ§öÂâáÂÖ¨ÂëäËº™Êí≠Ôºâ */
        .announcement-text.fade {
            animation: fadeInOut 5s ease-in-out;
            white-space: normal;
            word-break: break-word;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-10px); }
            10%, 90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(10px); }
        }

        /* ‰∏ªË¶ÅÂÆπÂô® */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ÂïÜÂìÅÁ∂≤Ê†º */
        .products-section {
            margin-top: 30px;
        }
        
        /* ‰∏ªÊâìÂïÜÂìÅÂçÄÂüü */
        .featured-section {
            margin-bottom: 50px;
            padding: 40px 20px;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(255, 140, 0, 0.08) 50%, rgba(255, 215, 0, 0.1) 100%);
            border-radius: 20px;
            border: 3px solid rgba(255, 215, 0, 0.4);
            box-shadow: 0 10px 40px rgba(255, 215, 0, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        /* ‰∏ªÊâìÂïÜÂìÅËÉåÊôØÂãïÁï´ */
        .featured-section::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                transparent 30%,
                rgba(255, 215, 0, 0.05) 50%,
                transparent 70%
            );
            animation: shimmer 3s linear infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }
        
        .featured-title {
            font-size: 36px;
            font-weight: 900;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 50%, #FFD700 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(255, 215, 0, 0.3);
            animation: pulse 2s ease-in-out infinite;
            position: relative;
            z-index: 1;
        }
        
        .featured-subtitle {
            text-align: center;
            color: #999;
            font-size: 14px;
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
        }
        
        .featured-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 30px;
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }
        
        .featured-grid .product-card {
            position: relative;
            overflow: visible;
            transform: translateY(0);
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 215, 0, 0.3);
        }
        
        .featured-grid .product-card:hover {
            transform: translateY(-10px) scale(1.02);
            border-color: rgba(255, 215, 0, 0.6);
            box-shadow: 0 15px 40px rgba(255, 215, 0, 0.3);
        }
        
        /* üî• ‰∏ªÊâìÊé®Ëñ¶ÂæΩÁ´† - ‰ΩøÁî®ÂØ¶È´îÂÖÉÁ¥†ËÄåÈùûÂÅΩÂÖÉÁ¥† */
        .featured-badge {
            position: absolute;
            top: -12px;
            right: -12px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #000;
            padding: 6px 18px;
            border-radius: 25px;
            font-size: 13px;
            font-weight: 700;
            z-index: 10;
            box-shadow: 0 4px 20px rgba(255, 215, 0, 0.6);
            animation: bounce 2s ease-in-out infinite;
        }

        /* üÜï Ëá™ÂÆöÁæ©ÂçÄÂ°äÂç°ÁâáÂæΩÁ´† */
        .custom-block-badge {
            position: absolute;
            top: -12px;
            right: -12px;
            background: linear-gradient(135deg, #C084FC 0%, #8B5CF6 100%);
            color: #fff;
            padding: 6px 18px;
            border-radius: 25px;
            font-size: 13px;
            font-weight: 700;
            z-index: 10;
            box-shadow: 0 4px 20px rgba(192, 132, 252, 0.6);
            animation: bounce 2s ease-in-out infinite;
        }

        /* üÜï Ëá™ÂÆöÁæ©ÂçÄÂ°äÂç°ÁâáÈÇäÊ°Ü */
        .featured-grid .custom-block-card {
            border-color: rgba(192, 132, 252, 0.3);
        }
        .featured-grid .custom-block-card:hover {
            border-color: rgba(192, 132, 252, 0.7);
            box-shadow: 0 15px 40px rgba(192, 132, 252, 0.3);
        }

        /* üÜï ÂÆ¢ÊúçÊåâÈàï */
        .cs-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #06C755;
            border: none;
            color: #fff;
            padding: 8px 16px;
            border-radius: 25px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
            margin-left: 10px;
        }
        .cs-btn:hover {
            background: #05a847;
            transform: scale(1.05);
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0) rotate(-3deg); }
            50% { transform: translateY(-5px) rotate(3deg); }
        }
        
        /* ÂïÜÂìÅÂàÜÈ°ûÊ®ôÁ±§ */
        .category-tabs {
            display: flex;
            gap: 12px;
            margin: 30px 0;
            padding: 20px 0;
            overflow-x: auto;
            scrollbar-width: none; /* Èö±ËóèÊªæÂãïÊ¢ù */
            -ms-overflow-style: none;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .category-tabs::-webkit-scrollbar {
            display: none; /* Èö±ËóèÊªæÂãïÊ¢ù */
        }
        
        .category-tab {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.15) 0%, rgba(255, 140, 0, 0.1) 100%);
            border: 2px solid var(--primary);
            color: var(--primary);
            padding: 14px 28px;
            border-radius: 30px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            white-space: nowrap;
            flex-shrink: 0;
            font-size: 15px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.2);
        }
        
        .category-tab::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 215, 0, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .category-tab:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .category-tab:hover {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.25) 0%, rgba(255, 140, 0, 0.15) 100%);
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
            border-color: #FFA500;
        }
        
        .category-tab.active {
            background: linear-gradient(135deg, var(--primary) 0%, #FFA500 100%);
            color: var(--secondary);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.6);
            transform: scale(1.08);
            border-color: var(--primary);
        }
        
        .category-tab.active::before {
            display: none;
        }

        .section-title {
            font-size: 28px;
            font-weight: 900;
            color: var(--primary);
            margin-bottom: 20px;
            text-align: center;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 50px;
        }

        @supports not (grid-template-columns: repeat(auto-fill, minmax(250px, 1fr))) {
            .products-grid {
                display: flex;
                flex-wrap: wrap;
            }
            
            .product-card {
                flex: 1 1 250px;
                max-width: 100%;
            }
        }

        .product-card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .product-card:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.3);
        }

        .product-image {
            width: 100%;
            aspect-ratio: 1 / 1;
            background: #000;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .product-name {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .product-price {
            font-size: 24px;
            font-weight: 900;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .product-stock {
            font-size: 14px;
            color: var(--accent-green);
            margin-bottom: 15px;
        }

        .add-to-cart-btn {
            width: 100%;
            background: var(--primary);
            color: var(--secondary);
            border: none;
            padding: 12px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .add-to-cart-btn:hover {
            filter: brightness(1.1);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.5);
        }

        /* Ë≥ºÁâ©ËªäÊµÆÂãïÊåâÈàï */
        .cart-float {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, var(--primary) 0%, #FFA500 100%);
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.5);
            transition: all 0.3s ease;
            z-index: 999;
        }

        .cart-float:hover {
            transform: scale(1.1);
        }

        .cart-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4444;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
        }

        /* Ë≥ºÁâ©ËªäÂÅ¥ÈÇäÊ¨Ñ */
        .cart-sidebar {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100%;
            background: var(--bg-dark);
            border-left: 2px solid var(--primary);
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }

        .cart-sidebar.active {
            right: 0;
        }

        .cart-header {
            padding: 20px;
            border-bottom: 2px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cart-title {
            font-size: 24px;
            font-weight: 900;
            color: var(--primary);
        }

        .close-cart {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 30px;
            cursor: pointer;
        }

        .cart-items {
            padding: 20px;
        }

        .cart-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .cart-item-name {
            font-weight: 700;
            margin-bottom: 8px;
            line-height: 1.4;
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
        }

        .cart-item-price {
            color: var(--primary);
            font-weight: 700;
        }

        .cart-item-qty {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .qty-btn {
            background: var(--primary);
            color: var(--secondary);
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 700;
            touch-action: manipulation; /* Èò≤Ê≠¢ÊâãÊ©üÈõôÊìäÊîæÂ§ß */
            user-select: none; /* Èò≤Ê≠¢ÈÅ∏ÂèñÊñáÂ≠ó */
            -webkit-tap-highlight-color: transparent; /* ÁßªÈô§ÈªûÊìäÈ´ò‰∫Æ */
        }

        .remove-item {
            background: #ff4444;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 700;
            margin-top: 10px;
        }

        .cart-footer {
            padding: 20px;
            border-top: 2px solid var(--primary);
        }

        .cart-total {
            font-size: 24px;
            font-weight: 900;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .checkout-btn {
            width: 100%;
            background: var(--primary);
            color: var(--secondary);
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
        }

        /* ÂΩàÁ™óÂÖ±Áî®Ê®£Âºè */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-dark);
            border: 2px solid var(--primary);
            border-radius: 15px;
            padding: 0 10px 10px 10px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-top: 10px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 900;
            color: var(--primary);
        }

        .close-modal {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 24px;
            cursor: pointer;
        }
        
        /* specModal ÁöÑ header Âú®ÁÖßÁâá‰∏ãÊñπÔºå‰∏çÈúÄË¶ÅÈ°çÂ§ñ padding-top */
        #specModal .modal-header {
            padding-top: 8px;
        }

        /* Ë¶èÊ†ºÈÅ∏ÊìáÊ®°ÊÖãÊ°Ü */
        .spec-header-container {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            flex-shrink: 0;
        }
        
        .spec-image {
            display: none;
            width: 35%;
            height: 100px;
            background: #f5f5f5;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .spec-info-display {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 3px;
            padding: 6px 8px;
            background: rgba(255, 215, 0, 0.08);
            border: 1.5px solid var(--primary);
            border-radius: 8px;
        }
        
        .spec-info-price {
            font-size: 18px;
            font-weight: 900;
            color: var(--primary);
            line-height: 1.2;
            text-align: center;
        }
        .spec-original-price {
            font-size: 16px;
            font-weight: 400;
            color: #888;
            text-decoration: line-through;
            margin-left: 8px;
        }
        .sale-badge {
            display: inline-block;
            background: #ff4444;
            color: #fff;
            font-size: 11px;
            font-weight: 700;
            padding: 2px 7px;
            border-radius: 4px;
            margin-left: 6px;
            vertical-align: middle;
            letter-spacing: 0.5px;
        }
        .card-sale-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background: #ff4444;
            color: #fff;
            font-size: 11px;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 4px;
            z-index: 2;
        }
        
        .spec-info-stock {
            font-size: 12px;
            font-weight: 700;
            color: var(--accent-green);
            text-align: center;
        }

        .spec-image img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .spec-options {
            margin-bottom: 10px;
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            padding-right: 5px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            align-content: start;
        }

        .spec-options::-webkit-scrollbar {
            width: 6px;
        }

        .spec-options::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .spec-options::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }

        .spec-section-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 1px solid rgba(255, 215, 0, 0.3);
        }

        .spec-option {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 8px;
            padding: 10px 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 42px;
        }

        .spec-option:hover {
            border-color: var(--primary);
            box-shadow: 0 0 0 1px var(--primary), 0 0 20px rgba(255, 215, 0, 0.4);
            background: rgba(255, 215, 0, 0.08);
        }

        .spec-option.selected {
            border-color: var(--primary);
            background: rgba(255, 215, 0, 0.15);
            box-shadow: 0 0 0 1px var(--primary), 0 0 25px rgba(255, 215, 0, 0.5);
        }

        .spec-option.out-of-stock {
            opacity: 0.4;
            cursor: not-allowed;
            background: rgba(255, 255, 255, 0.02);
        }

        .spec-option.out-of-stock:hover {
            transform: none;
            box-shadow: none;
        }

        .spec-name {
            font-weight: 700;
            line-height: 1.3;
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
            font-size: 13px;
            color: var(--text-light);
        }

        .spec-stock.low {
            color: #ff9900;
        }

        .spec-stock.out {
            color: #ff4444;
        }

        .quantity-selector {
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .quantity-label {
            font-weight: 700;
            margin-bottom: 10px;
            text-align: center;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .quantity-btn {
            background: var(--primary);
            color: var(--secondary);
            border: none;
            width: 34px;
            height: 34px;
            border-radius: 8px;
            font-size: 20px;
            font-weight: 700;
            cursor: pointer;
            touch-action: manipulation;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .quantity-display {
            font-size: 20px;
            font-weight: 700;
            min-width: 36px;
            text-align: center;
        }

        .add-to-cart-modal-btn {
            width: 100%;
            background: var(--primary);
            color: var(--secondary);
            border: none;
            padding: 11px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            flex-shrink: 0;
        }

        .add-to-cart-modal-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ÁµêÂ∏≥Ë°®ÂñÆ */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 10px;
            padding: 12px;
            color: var(--text-light);
            font-size: 16px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .radio-group {
            display: flex;
            gap: 15px;
        }

        .radio-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .store-selector {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 10px;
        }

        .store-selector.active {
            display: block;
        }

        .store-select-btn {
            background: var(--primary);
            color: var(--secondary);
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
        }

        .selected-store {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background: rgba(0, 255, 0, 0.1);
            border-radius: 5px;
        }

        .submit-order-btn {
            width: 100%;
            background: var(--primary);
            color: var(--secondary);
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
        }

        /* Ë®ÇÂñÆÊü•Ë©¢ */
        .order-result {
            display: none;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            line-height: 1.8;
        }

        .tracking-link {
            display: inline-block;
            background: var(--primary);
            color: var(--secondary);
            padding: 8px 15px;
            border-radius: 5px;
            text-decoration: none;
            font-weight: 700;
            margin-top: 10px;
        }

        /* Toast ÊèêÁ§∫ */
        .toast {
            position: fixed;
            bottom: -80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent-green);
            color: var(--secondary);
            padding: 12px 20px;
            border-radius: 25px;
            font-weight: 700;
            z-index: 99999;
            opacity: 0;
            transition: bottom 0.3s ease, opacity 0.3s ease;
            white-space: nowrap;
            max-width: 90vw;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        .toast.show {
            opacity: 1;
            bottom: 30px;
        }

        .toast.error {
            background: #ff4444;
            color: white;
        }

        /* ÁôªÂÖ•ÁâÜÊ®£Âºè */
        .login-wall {
            min-height: 70vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
        }

        .login-wall-content {
            text-align: center;
            max-width: 450px;
            width: 100%;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1) 0%, rgba(255, 140, 0, 0.05) 100%);
            padding: 60px 40px;
            border-radius: 24px;
            border: 2px solid var(--primary);
            box-shadow: 0 8px 32px rgba(255, 215, 0, 0.2);
            backdrop-filter: blur(10px);
        }

        .login-wall-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .login-wall-content h2 {
            font-size: 28px;
            color: var(--primary);
            margin-bottom: 15px;
            font-weight: 900;
            text-shadow: 0 2px 10px rgba(255, 215, 0, 0.3);
        }

        .login-wall-content p {
            font-size: 16px;
            color: #ccc;
            margin-bottom: 40px;
            line-height: 1.6;
        }

        .login-wall-btn {
            background: #06C755;
            border: none;
            color: white;
            padding: 15px 40px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0 auto;
            box-shadow: 0 4px 15px rgba(6, 199, 85, 0.3);
        }

        .login-wall-btn:hover {
            background: #05B34A;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(6, 199, 85, 0.4);
        }

        .login-wall-btn:active {
            transform: translateY(0);
        }
        
        .line-icon {
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            color: #06C755;
            font-size: 16px;
        }

        /* ÂØ©Ê†∏ÁãÄÊÖãÊ®£Âºè */
        .approval-status {
            min-height: 70vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
        }

        .approval-content {
            text-align: center;
            max-width: 500px;
            background: rgba(255, 255, 255, 0.05);
            padding: 60px 40px;
            border-radius: 20px;
            border: 2px solid var(--primary);
        }

        .approval-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .approval-content h2 {
            font-size: 28px;
            color: var(--primary);
            margin-bottom: 15px;
            font-weight: 900;
        }

        .approval-content p {
            font-size: 16px;
            color: var(--text-light);
            margin-bottom: 10px;
        }

        /* ÂãïÁï´ÊïàÊûú */
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .animate-pulse {
            animation: pulse 0.5s ease;
        }

        /* ÈüøÊáâÂºèË®≠Ë®à */
        /* ÊâãÊ©üÁâàÂÑ™Âåñ (< 480px) */
        @media (max-width: 480px) {
            .navbar {
                padding: 8px 10px;
                flex-direction: column;
                gap: 8px;
                align-items: stretch;
            }

            .logo {
                font-size: 18px;
                text-align: center;
            }

            .nav-buttons {
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 8px;
                flex-wrap: wrap;
            }

            .nav-btn {
                padding: 6px 12px;
                font-size: 12px;
                border-radius: 20px;
                white-space: nowrap;
                min-width: auto;
            }

            /* ÊúÉÂì°Ë≥áË®äÂçÄ - Ê©´ÂêëÁ∑äÊπäÊéíÂàó */
            #memberInfo {
                display: flex !important;
                gap: 6px !important;
                align-items: center !important;
                justify-content: center !important;
            }

            #memberAvatar {
                width: 30px !important;
                height: 30px !important;
                flex-shrink: 0;
            }

            /* LINE ÁôªÂÖ•ÊåâÈàï - Á∏ÆÂ∞è */
            #lineLoginBtn {
                padding: 0 !important;
                background: none !important;
                border: none !important;
            }

            #lineLoginBtn img {
                height: 32px !important;
                width: auto;
            }

            .section-title {
                font-size: 20px;
            }

            .container {
                padding: 10px;
            }

            .products-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .product-card {
                padding: 12px;
            }

            .product-image {
                aspect-ratio: 1 / 1;
            }

            .cart-float {
                width: 50px;
                height: 50px;
                font-size: 22px;
                bottom: 15px;
                right: 15px;
            }

            /* Ê®°ÊÖãÊ°ÜÂÑ™Âåñ */
            .modal-content {
                width: 95%;
                max-height: 90vh;
                padding: 15px;
            }

            .modal-title {
                font-size: 18px;
            }
            
            /* ÁôªÂÖ•ÁâÜÊâãÊ©üÁâàÂÑ™Âåñ */
            .login-wall-content {
                padding: 40px 25px;
                max-width: 90%;
            }
            
            .login-wall-icon {
                font-size: 60px;
            }
            
            .login-wall-content h2 {
                font-size: 22px;
            }
            
            .login-wall-content p {
                font-size: 14px;
                margin-bottom: 30px;
            }
            
            .login-wall-btn {
                padding: 12px 30px;
                font-size: 16px;
                width: 100%;
                max-width: 280px;
            }
            
            /* ÂïÜÂìÅÂàÜÈ°ûÊ®ôÁ±§ÊâãÊ©üÁâà */
            .category-tabs {
                gap: 8px;
                margin: 20px 0;
                padding: 15px 0;
                justify-content: flex-start;
                overflow-x: auto;
                flex-wrap: nowrap;
            }
            
            .category-tab {
                padding: 11px 20px;
                font-size: 13px;
            }
            
            /* ‰∏ªÊâìÂïÜÂìÅÊâãÊ©üÁâà */
            .featured-section {
                padding: 20px 10px;
                margin-bottom: 30px;
            }
            
            .featured-title {
                font-size: 24px;
                margin-bottom: 20px;
            }
            
            .featured-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .featured-grid .product-image {
                aspect-ratio: 1 / 1;
            }
            
            .featured-grid .product-name {
                font-size: 14px;
            }
            
            .featured-grid .product-price {
                font-size: 16px;
            }
        }

        @media (min-width: 361px) and (max-width: 480px) {
            .navbar {
                padding: 10px 15px;
            }

            .logo {
                font-size: 18px;
            }

            .nav-btn {
                padding: 8px 12px;
                font-size: 12px;
            }

            .section-title {
                font-size: 20px;
            }

            .container {
                padding: 10px;
            }

            .cart-sidebar {
                width: 100%;
                right: -100%;
            }

            .modal-content {
                width: 95%;
                padding: 15px;
                max-height: 90vh;
                overflow-y: auto;
            }

            .products-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .product-card {
                padding: 12px;
            }

            .product-image {
                aspect-ratio: 1 / 1;
            }

            .product-name {
                font-size: 14px;
            }

            .product-price {
                font-size: 18px;
            }

            .add-to-cart-btn {
                padding: 10px;
                font-size: 14px;
            }

            .spec-header-container {
                gap: 8px;
            }
            
            .spec-image {
                width: 35%;
                height: 90px;
            }
            
            .spec-info-display {
                padding: 6px;
                gap: 4px;
            }
            
            .spec-info-price {
                font-size: 20px;
            }
            
            .spec-info-stock {
                font-size: 11px;
            }
            
            .spec-options {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
            }

            .spec-option {
                padding: 8px 4px;
                min-height: 38px;
            }

            .spec-name {
                font-size: 11px;
            }

            .spec-stock {
                font-size: 9px;
            }
            
            .spec-section-title {
                font-size: 13px;
                margin-bottom: 8px;
                padding-bottom: 5px;
            }

            .cart-float {
                width: 60px;
                height: 60px;
                font-size: 28px;
                bottom: 20px;
                right: 20px;
            }

            .cart-badge {
                width: 24px;
                height: 24px;
                font-size: 12px;
            }
        }

        @media (min-width: 481px) and (max-width: 768px) {
            .cart-sidebar {
                width: 100%;
                right: -100%;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
            }

            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
            
            .spec-image {
                width: 35%;
                height: 100px;
            }
            
            .spec-info-price {
                font-size: 22px;
            }
            
            .spec-info-stock {
                font-size: 12px;
            }

            .spec-options {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }

            .spec-option {
                padding: 10px 6px;
                min-height: 40px;
            }

            .spec-name {
                font-size: 12px;
            }

            .spec-price {
                font-size: 14px;
            }

            .spec-stock {
                font-size: 10px;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .spec-options {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
        }

        @media (min-width: 1025px) {
            .spec-options {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            }
        }

        /* Ë®ÇÂñÆÊëòË¶ÅÊ®£Âºè */
        .order-summary {
            margin: 25px 0;
            padding: 20px;
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid var(--primary);
            border-radius: 15px;
        }

        .summary-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .summary-items {
            margin-bottom: 15px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 14px;
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .item-name {
            flex: 1;
            color: var(--text-light);
        }

        .item-price {
            color: var(--primary);
            font-weight: 700;
            margin-left: 10px;
        }

        .summary-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-top: 2px solid var(--primary);
            margin-top: 15px;
            font-size: 18px;
            font-weight: 900;
        }

        .total-amount {
            font-size: 28px;
            color: var(--primary);
        }
        
        /* üÜï Á∂†ÁïåÈñÄÂ∏ÇÈÅ∏ÊìáÊåâÈàïÊ®£Âºè */
        .store-select-btn {
            background: linear-gradient(135deg, #00c853 0%, #00e676 100%);
            border: none;
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 200, 83, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            margin: 20px 0;
        }
        
        .store-select-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 200, 83, 0.4);
        }
        
        .store-select-btn:active {
            transform: translateY(0);
        }
        
        /* ÈÅ∏‰∏≠ÈñÄÂ∏ÇÈ°ØÁ§∫ÂçÄÂüü */
        .selected-store-info {
            background: rgba(0, 200, 83, 0.1);
            border: 2px solid #00c853;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }
        
        .selected-store-info.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        .store-info-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .store-info-header h3 {
            color: #00c853;
            font-size: 18px;
            margin: 0;
        }
        
        .store-detail {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: start;
            gap: 10px;
        }
        
        .store-detail-label {
            color: #999;
            min-width: 70px;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .store-detail-value {
            color: white;
            flex: 1;
            font-size: 14px;
            word-break: break-all;
        }
        
        .change-store-btn {
            background: transparent;
            border: 2px solid #00c853;
            color: #00c853;
            padding: 8px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .change-store-btn:hover {
            background: #00c853;
            color: white;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* üÜï Ëá™Âèñ‰ªòÊ¨æÊñπÂºèÂçÄÂ°ä */
        .pickup-payment-method {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: rgba(255, 215, 0, 0.05);
            border-radius: 15px;
            border: 2px solid rgba(255, 215, 0, 0.2);
            animation: fadeIn 0.3s ease;
        }

        .pickup-payment-method.active {
            display: block;
        }

        /* üÜï ÂåØÊ¨æË≥áË®äÂç°Áâá */
        .bank-info {
            display: none;
            margin-top: 15px;
            animation: slideDown 0.3s ease;
        }

        .bank-info.active {
            display: block;
        }

        .bank-info-card {
            background: linear-gradient(135deg, rgba(0, 200, 83, 0.1) 0%, rgba(0, 150, 136, 0.1) 100%);
            border: 2px solid #00c853;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 200, 83, 0.2);
        }

        .bank-info-card h4 {
            color: #00c853;
            margin-bottom: 20px;
            font-size: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .bank-detail {
            display: flex;
            align-items: center;
            margin: 12px 0;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .bank-detail:hover {
            background: rgba(0, 0, 0, 0.3);
            transform: translateX(5px);
        }

        .bank-detail .label {
            color: #999;
            min-width: 80px;
            font-weight: 500;
        }

        .bank-detail .value {
            color: #FFD700;
            font-weight: bold;
            font-size: 16px;
            flex: 1;
            word-break: break-all;
            letter-spacing: 1px;
        }

        .bank-notice {
            margin-top: 15px;
            padding: 12px;
            background: rgba(255, 152, 0, 0.1);
            border-left: 4px solid #ff9800;
            border-radius: 5px;
            color: #ff9800;
            font-size: 14px;
        }

        .required {
            color: #ff4444;
            font-weight: bold;
        }


        /* ==========================================
           üÜï ÂïÜÂìÅÂúñÁâáËº™Êí≠Ê®£Âºè
        ========================================== */
        .product-carousel {
            width: calc(100% + 20px);
            margin-left: -10px;
            margin-right: -10px;
            margin-top: -10px;
            margin-bottom: 10px;
            border-radius: 13px 13px 0 0;
            overflow: hidden;
            background: #000;
            user-select: none;
        }

        /* ÂúñÁâáÊªëÂãïÂçÄÂüüÔºöÁî® grid ÁñäÂ±§Ôºå‰∏çÁî®ÁµïÂ∞çÂÆö‰Ωç */
        .carousel-track-wrap {
            position: relative;
            width: 100%;
            overflow: hidden;
            border-radius: 13px 13px 0 0;
        }

        .carousel-track {
            display: flex;
            width: 100%;
            transition: transform 0.38s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform;
        }

        .carousel-slide {
            flex: 0 0 100%;
            width: 100%;
            min-width: 0;
        }

        .carousel-slide img {
            width: 100%;
            height: auto;
            max-height: 60vw;
            display: block;
            object-fit: contain;
            background: #111;
        }

        /* Â∑¶Âè≥ÁÆ≠È†≠ÔºöÁñäÂú® track-wrap ‰∏ä */
        .carousel-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.55);
            border: 1.5px solid rgba(255, 215, 0, 0.5);
            color: var(--primary);
            font-size: 26px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: all 0.2s ease;
            padding: 0;
            touch-action: manipulation;
        }
        .carousel-btn:hover, .carousel-btn:active {
            background: rgba(255, 215, 0, 0.3);
            border-color: var(--primary);
        }
        .carousel-prev { left: 8px; }
        .carousel-next { right: 8px; }

        /* ËßíÊ®ôÔºöÁñäÂú®ÂúñÁâáÂè≥‰∏ä */
        .carousel-counter {
            position: absolute;
            top: 8px;
            right: 10px;
            background: rgba(0,0,0,0.65);
            color: #fff;
            font-size: 12px;
            font-weight: 700;
            padding: 3px 8px;
            border-radius: 12px;
            z-index: 10;
            pointer-events: none;
        }

        /* ÂúìÈªûÔºöÊîæÂú® track-wrap Â§ñÈù¢Ôºå‰∏çÁñäÂú®ÂúñÁâá‰∏ä */
        .carousel-dots {
            display: flex;
            justify-content: center;
            gap: 7px;
            padding: 7px 0 5px;
            background: rgba(0,0,0,0.5);
        }

        .carousel-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.35);
            cursor: pointer;
            transition: background 0.2s, transform 0.2s;
        }

        .carousel-dot.active {
            background: var(--primary);
            transform: scale(1.35);
        }

        /* üÜï ÂãïÁï´ÊïàÊûú */
        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
            }
            to {
                opacity: 1;
                max-height: 500px;
            }
        }
    </style>
</head>
<body>
    <!-- üÜï Èö±ËóèÁöÑÁ∂†ÁïåË°®ÂñÆÔºàClientReplyURL + ServerReplyURLÔºâ -->
    <form id="ecpayMapForm" method="POST" action="https://logistics.ecpay.com.tw/Express/map" style="display: none;" target="ecpayWindow">
        <input type="text" name="MerchantID" id="ecpay_MerchantID">
        <input type="text" name="MerchantTradeNo" id="ecpay_MerchantTradeNo">
        <input type="text" name="LogisticsType" value="CVS">
        <input type="text" name="LogisticsSubType" id="ecpay_LogisticsSubType" value="UNIMARTC2C">
        <input type="text" name="IsCollection" value="N">
        <input type="text" name="ServerReplyURL" id="ecpay_ServerReplyURL">
        <input type="text" name="ClientReplyURL" id="ecpay_ClientReplyURL">
        <input type="text" name="ExtraData" id="ecpay_ExtraData">
        <input type="text" name="Device" id="ecpay_Device">
        <input type="text" name="CheckMacValue" id="ecpay_CheckMacValue">
    </form>
    <!-- Â∞éËà™Âàó -->
    <nav class="navbar">
        <div style="display:flex; align-items:center; gap:10px;">
            <div class="logo">R E X</div>
            <a class="cs-btn" href="https://line.me/ti/p/~rex52077" target="_blank">
                üí¨ ÂÆ¢Êúç
            </a>
        </div>
        <div class="nav-buttons" id="navButtons" style="display:none;">
            <button class="nav-btn" id="lineLoginBtn" onclick="lineLogin()" style="display:none;">
                <img src="https://developers.line.biz/media/line-login/btn_base.png" alt="LINE Login" style="height:40px;">
            </button>
            <div id="memberInfo" style="display:none; align-items:center; gap:10px;">
                <img id="memberAvatar" src="" style="width:40px; height:40px; border-radius:50%; border:2px solid var(--primary);">
                <button class="nav-btn" onclick="openMemberProfileModal()">üë§ ÊúÉÂì°Ë≥áÊñô</button>
                <button class="nav-btn" onclick="logout()">ÁôªÂá∫</button>
            </div>
            <button class="nav-btn" onclick="openOrderSearch()">üì¶ Êü•Ë©¢Ë®ÇÂñÆ</button>
        </div>
    </nav>

    <!-- üÜï ÂÖ¨ÂëäÂàó -->
    <div class="announcement-bar" id="announcementBar">
        <div class="announcement-content">
            <span class="announcement-icon">üì¢</span>
            <span class="announcement-text" id="announcementText"></span>
        </div>
    </div>

    <!-- ‰∏ªË¶ÅÂÖßÂÆπ -->
    <div class="container">
        <!-- ÁôªÂÖ•ÁâÜ -->
        <div id="loginWall" class="login-wall" style="display:none;">
            <div class="login-wall-content">
                <div class="login-wall-icon">üîê</div>
                <h2>Ê≠°Ëøé‰æÜÂà∞ CANDY BOSS</h2>
                <p>Ë´ãÂÖàÁôªÂÖ•‰ª•ÁπºÁ∫åË≥ºÁâ©</p>
                <button class="login-wall-btn" onclick="lineLogin()">
                    <span class="line-icon">L</span>
                    <span>LINE ÁôªÂÖ•</span>
                </button>
            </div>
        </div>

        <!-- ÂØ©Ê†∏‰∏≠ÁãÄÊÖã -->
        <div id="pendingApproval" class="approval-status" style="display:none;">
            <div class="approval-content">
                <div class="approval-icon">‚è≥</div>
                <h2>Â∏≥ËôüÂØ©Ê†∏‰∏≠</h2>
                <p>ÊÇ®ÁöÑÂ∏≥ËôüÊ≠£Âú®ÂØ©Ê†∏‰∏≠ÔºåË´ãÁ®çÂÄôÁâáÂàª</p>
                <p style="color:#999; font-size:14px; margin-top:20px;">ÂØ©Ê†∏ÈÄöÈÅéÂæåÂç≥ÂèØÈñãÂßãË≥ºÁâ©</p>
                <button class="nav-btn" style="margin-top:30px;" onclick="checkApprovalStatus()">ÈáçÊñ∞Ê™¢Êü•ÁãÄÊÖã</button>
            </div>
        </div>

        <!-- ÂØ©Ê†∏ÊãíÁµïÁãÄÊÖã -->
        <div id="rejectedApproval" class="approval-status" style="display:none;">
            <div class="approval-content">
                <div class="approval-icon" style="color:#ff4444;">‚ùå</div>
                <h2>ÂØ©Ê†∏Êú™ÈÄöÈÅé</h2>
                <p>ÂæàÊä±Ê≠âÔºåÊÇ®ÁöÑÁî≥Ë´ãÊú™ÈÄöÈÅéÂØ©Ê†∏</p>
                <p style="color:#999; font-size:14px; margin-top:20px;">Â¶ÇÊúâÁñëÂïèÔºåË´ãËÅØÁπ´ÂÆ¢Êúç</p>
                <button class="nav-btn" style="margin-top:30px;" onclick="logout()">ÁôªÂá∫</button>
            </div>
        </div>

        <!-- ÂïÜÂìÅÂçÄÂüüÔºàÂØ©Ê†∏ÈÄöÈÅéÂæåÊâçÈ°ØÁ§∫Ôºâ -->
        <section class="products-section" id="productsSection" style="display:none;">
            <!-- ‰∏ªÊâìÂïÜÂìÅÂçÄÂüü -->
            <div class="featured-section" id="featuredSection">
                <h2 class="featured-title">‚≠ê Êú¨Êúà‰∏ªÊâìÊé®Ëñ¶ ‚≠ê</h2>
                <p class="featured-subtitle">Á≤æÈÅ∏ÁÜ±ÈñÄÂïÜÂìÅÔºåÈôêÊôÇÂÑ™ÊÉ†‰∏≠</p>
                <div class="featured-grid" id="featuredGrid"></div>
            </div>
            
            <!-- Á≥ªÂàóÂàÜÈ°ûÊ®ôÁ±§ - ÂãïÊÖãÁîüÊàê -->
            <div class="category-tabs" id="categoryTabs">
                <!-- ÊâÄÊúâÂàÜÈ°ûÊåâÈàïÔºàÂåÖÂê´„ÄåÂÖ®ÈÉ®„ÄçÔºâÈÉΩÊúÉÂæû JavaScript ÂãïÊÖãËºâÂÖ• -->
            </div>
            
            <div class="products-grid" id="productsGrid"></div>
        </section>
    </div>

    <!-- Ë≥ºÁâ©ËªäÊµÆÂãïÊåâÈàï -->
    <div class="cart-float" onclick="toggleCart()">
        üõí
        <div class="cart-badge" id="cartBadge">0</div>
    </div>

    <!-- Ë≥ºÁâ©ËªäÂÅ¥ÈÇäÊ¨Ñ -->
    <div class="cart-sidebar" id="cartSidebar">
        <div class="cart-header">
            <div class="cart-title">üõí Ë≥ºÁâ©Ëªä</div>
            <button class="close-cart" onclick="toggleCart()">√ó</button>
        </div>
        <div class="cart-items" id="cartItems"></div>
        <!-- üÜï Ë≥ºÁâ©ËªäÂÑ™ÊÉ†ÊèêÁ§∫ -->
        <div id="cartPromotionHints"></div>
        <div class="cart-footer">
            <div class="cart-total">Á∏ΩË®à:$<span id="cartTotal">0</span></div>
            <button class="checkout-btn" onclick="openCheckout()">ÂâçÂæÄÁµêÂ∏≥</button>
        </div>
    </div>

    <!-- Ë¶èÊ†ºÈÅ∏ÊìáÂΩàÁ™ó -->
    <div class="modal" id="specModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="specModalTitle">ÈÅ∏ÊìáË¶èÊ†º</div>
                <button class="close-modal" onclick="closeSpecModal()">√ó</button>
            </div>
            <!-- üÜï Â§öÂúñËº™Êí≠ -->
            <div class="product-carousel" id="productCarousel" style="display:none;">
                <div class="carousel-track-wrap" id="carouselWrap">
                    <div class="carousel-track" id="carouselTrack"></div>
                    <button class="carousel-btn carousel-prev" id="carouselPrev" onclick="carouselMove(-1)">&#8249;</button>
                    <button class="carousel-btn carousel-next" id="carouselNext" onclick="carouselMove(1)">&#8250;</button>
                </div>
                <div class="carousel-dots" id="carouselDots"></div>
            </div>
            <div class="spec-header-container">
                <div class="spec-info-display" style="width:100%">
                    <div class="spec-info-price" id="specInfoPrice">Ë´ãÈÅ∏ÊìáË¶èÊ†º</div>
                    <div class="spec-info-stock" id="specInfoStock"></div>
                </div>
            </div>
            <div class="spec-options" id="specOptions"></div>
            <div class="quantity-selector">
                <div class="quantity-label" style="display: none;">ÈÅ∏ÊìáÊï∏Èáè:</div>
                <div class="quantity-controls">
                    <button class="quantity-btn" onclick="changeQuantity(-1)">‚àí</button>
                    <div class="quantity-display" id="quantityDisplay">1</div>
                    <button class="quantity-btn" onclick="changeQuantity(1)">+</button>
                </div>
            </div>
            <button class="add-to-cart-modal-btn" id="addToCartModalBtn" onclick="confirmAddToCart()">Âä†ÂÖ•Ë≥ºÁâ©Ëªä</button>
            <div style="text-align: center; margin-top: 15px; color: #999; font-size: 14px;">
                üí° Âä†ÂÖ•ÂæåÂèØÁπºÁ∫åÈÅ∏Ë≥ºÂÖ∂‰ªñË¶èÊ†º
            </div>
        </div>
    </div>

    <!-- ÁµêÂ∏≥ÂΩàÁ™ó -->
    <div class="modal" id="checkoutModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üí≥ ÁµêÂ∏≥Ë≥áË®ä</div>
                <button class="close-modal" onclick="closeCheckout()">√ó</button>
            </div>
            
            <div class="form-group">
                <label class="form-label">ÂßìÂêç</label>
                <input type="text" class="form-input" id="customerName" placeholder="Ë´ãËº∏ÂÖ•ÂßìÂêç">
            </div>

            <div class="form-group">
                <label class="form-label">ÈõªË©±</label>
                <input type="tel" class="form-input" id="customerPhone" placeholder="Ë´ãËº∏ÂÖ•ÈõªË©±ËôüÁ¢º">
            </div>

            <div class="form-group">
                <label class="form-label">ÂèñË≤®ÊñπÂºè</label>
                <div class="radio-group">
                    <label class="radio-label">
                        <input type="radio" name="shipping" value="711" checked onchange="toggleShippingMethod()">
                        7-11Â∫óÂà∞Â∫ó
                    </label>
                    <label class="radio-label">
                        <input type="radio" name="shipping" value="pickup" onchange="toggleShippingMethod()">
                        Ëá™Âèñ
                    </label>
                </div>
                
                <!-- üÜï Á∂†ÁïåÈñÄÂ∏ÇÈÅ∏ÊìáÂçÄÂ°ä -->
                <div id="storeSelector" class="store-selector active">
                    <button type="button" class="store-select-btn" onclick="openECPayMap()">
                        <span>üìç</span>
                        <span>ÈÅ∏Êìá 7-11 ÂèñË≤®ÈñÄÂ∏Ç</span>
                    </button>
                    
                    <div id="selectedStoreInfo" class="selected-store-info">
                        <div class="store-info-header">
                            <span>‚úÖ</span>
                            <h3>Â∑≤ÈÅ∏ÊìáÈñÄÂ∏Ç</h3>
                        </div>
                        
                        <div class="store-detail">
                            <span class="store-detail-label">ÈñÄÂ∏ÇÂêçÁ®±Ôºö</span>
                            <span class="store-detail-value" id="storeName"></span>
                        </div>
                        
                        <div class="store-detail">
                            <span class="store-detail-label">ÈñÄÂ∏ÇÂú∞ÂùÄÔºö</span>
                            <span class="store-detail-value" id="storeAddress"></span>
                        </div>
                        
                        
                        <button type="button" class="change-store-btn" onclick="openECPayMap()">
                            ÈáçÊñ∞ÈÅ∏ÊìáÈñÄÂ∏Ç
                        </button>
                    </div>
                </div>
                
                <!-- 7-11 ‰ªòÊ¨æÊñπÂºèÈÅ∏Êìá -->
                <div id="storePaymentMethod" class="pickup-payment-method" style="display:none;">
                    <label class="form-label">üí∞ ‰ªòÊ¨æÊñπÂºè</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="storePayment" value="transfer" checked onchange="toggleStorePayment()">
                            üè¶ ÂåØÊ¨æ
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="storePayment" value="linepay" onchange="toggleStorePayment()">
                            üíö LINE Pay
                        </label>
                    </div>
                    

                </div>

                <!-- üÜï Ëá™Âèñ‰ªòÊ¨æÊñπÂºèÈÅ∏Êìá -->
                <div id="pickupPaymentMethod" class="pickup-payment-method">
                    <label class="form-label">üí∞ ‰ªòÊ¨æÊñπÂºè</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="paymentMethod" value="cash" checked onchange="toggleBankInfo()">
                            üíµ ÁèæÂ†¥‰ªòÊ¨æ
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="paymentMethod" value="transfer" onchange="toggleBankInfo()">
                            üè¶ ÂåØÊ¨æ
                        </label>
                    </div>
                    

                </div>
            </div>

            <!-- Ë®ÇÂñÆÊëòË¶Å -->
            <div class="order-summary">
                <h3 class="summary-title">üìã Ë®ÇÂñÆÊëòË¶Å</h3>
                <div class="summary-items" id="checkoutSummary"></div>
                <div class="summary-total">
                    <span>Á∏ΩË®à</span>
                    <span class="total-amount" id="checkoutTotal">$0</span>
                </div>
                <!-- üÜï ÂÑ™ÊÉ†ÊèêÁ§∫ÂçÄÂüü -->
                <div id="promotionHints"></div>
            </div>

            <button class="submit-order-btn" onclick="submitOrder()">Á¢∫Ë™çÈÄÅÂá∫Ë®ÇÂñÆ</button>
        </div>
    </div>

    <!-- Ë®ÇÂñÆÊü•Ë©¢ÂΩàÁ™ó -->
    <div class="modal" id="orderSearchModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üì¶ ÊàëÁöÑË®ÇÂñÆ</div>
                <button class="close-modal" onclick="closeOrderSearch()">√ó</button>
            </div>
            
            <div id="ordersList" style="max-height: 500px; overflow-y: auto;">
                <!-- Ë®ÇÂñÆÂàóË°®ÊúÉÂãïÊÖãÁîüÊàê -->
            </div>
        </div>
    </div>


    <!-- ÊúÉÂì°Ë≥áÊñôÊü•ÁúãÂΩàÁ™ó -->
    <div class="modal" id="memberProfileModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üë§ ÊúÉÂì°Ë≥áÊñô</div>
                <button class="close-modal" onclick="closeMemberProfileModal()">‚úï</button>
            </div>
            
            <div style="padding: 20px 0;">
                <div style="text-align: center; margin-bottom: 20px;">
                    <img id="profileAvatar" src="" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--primary);">
                    <div style="margin-top: 10px; font-size: 18px; font-weight: 700; color: var(--primary);" id="profileDisplayName"></div>
                </div>
                
                <div style="background: rgba(255, 215, 0, 0.1); border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                    <div style="margin-bottom: 12px;">
                        <div style="font-size: 12px; color: #999; margin-bottom: 5px;">üì± ÈõªË©±ËôüÁ¢º</div>
                        <div style="font-size: 16px; font-weight: 700;" id="profilePhone">Êú™Ë®≠ÂÆö</div>
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <div style="font-size: 12px; color: #999; margin-bottom: 5px;">üìß Email</div>
                        <div style="font-size: 16px; font-weight: 700;" id="profileEmail">Êú™Ë®≠ÂÆö</div>
                    </div>
                    
                    <div style="margin-bottom: 12px;">
                        <div style="font-size: 12px; color: #999; margin-bottom: 5px;">üéØ ÂØ©Ê†∏ÁãÄÊÖã</div>
                        <div style="font-size: 16px; font-weight: 700;" id="profileApprovalStatus">ÂæÖÂØ©Ê†∏</div>
                    </div>
                    
                    <div>
                        <div style="font-size: 12px; color: #999; margin-bottom: 5px;">üÜî ÊúÉÂì° ID</div>
                        <div style="font-size: 12px; color: #666; word-break: break-all;" id="profileLineId"></div>
                    </div>
                </div>
                
                <button class="submit-order-btn" onclick="openEditProfileModal()">‚úèÔ∏è Á∑®ËºØË≥áÊñô</button>
            </div>
        </div>
    </div>

    <!-- ÊúÉÂì°Ë≥áÊñôÁ∑®ËºØÂΩàÁ™ó -->
    <div class="modal" id="profileUpdateModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">‚úèÔ∏è Á∑®ËºØÊúÉÂì°Ë≥áÊñô</div>
                <button class="close-modal" onclick="closeProfileUpdateModal()">‚úï</button>
            </div>
            
            <div style="padding: 20px 0;">
                <div class="form-group">
                    <label class="form-label">üì± ÈõªË©±ËôüÁ¢º *</label>
                    <input type="tel" class="form-input" id="updatePhone" placeholder="‰æã: 0912345678" required>
                </div>

                <div class="form-group">
                    <label class="form-label">üìß EmailÔºàÈÅ∏Â°´Ôºâ</label>
                    <input type="email" class="form-input" id="updateEmail" placeholder="‰æã: example@gmail.com">
                </div>

                <button class="submit-order-btn" onclick="submitProfileUpdate()">‚úÖ ÂÑ≤Â≠òËÆäÊõ¥</button>
            </div>
        </div>
    </div>

    <!-- Toast ÊèêÁ§∫ -->
    <div class="toast" id="toast"></div>

    <script>
// ==========================================
// ÂÖ®ÂüüËÆäÊï∏Ë®≠ÂÆö
// ==========================================
const SHEET_ID = '1v1ecAE2XYAJgCnT3jbUp6Lfz64npIAzdiepzy-PSr_4';
const API_KEY = 'AIzaSyD3zhGgpz3SBgp62_1GhTql2CW5vrzI7NA';
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbywjsDQeIkVbhg9Ah2Z62oWi4fx2WlOeQUhFP-CxtnPYBgOW0_eQ3qdccB4AISV8dIZ/exec';

// LINE Login Ë®≠ÂÆö
const LINE_CHANNEL_ID = '2009077580';
const LINE_REDIRECT_URI = 'https://cbc-lake.vercel.app/callback.html';
const LINE_STATE = 'random_state_' + Math.random().toString(36).substr(2, 9);

const PRODUCTS_SHEET = 'ÂïÜÂìÅÂàóË°®';
const SPECS_SHEET = 'ÂïÜÂìÅË¶èÊ†ºË°®';
const ANNOUNCEMENT_SHEET = 'ÂÖ¨ÂëäË®≠ÂÆö';  // üÜï ÂÖ¨ÂëäÂ∑•‰ΩúË°®
const PROMOTION_SHEET = 'ÂÑ™ÊÉ†Ë®≠ÂÆö';     // üÜï ÂÑ™ÊÉ†Â∑•‰ΩúË°®

let products = [];
let productSpecs = {};
let announcements = [];  // üÜï ÂÑ≤Â≠òÂÖ¨ÂëäË≥áÊñô
let promotions = [];     // üÜï ÂÑ≤Â≠òÂÑ™ÊÉ†Ë≥áÊñô
let categories = [];     // üÜï ÂÑ≤Â≠òÂàÜÈ°ûË®≠ÂÆöÔºàÂê´ÂúñÁâáÔºâ
let currentCategory = 'all';  // Áï∂ÂâçÈÅ∏ÊìáÁöÑÂàÜÈ°û
let cart = [];
let selectedStore = null;

// üÜï Á≥ªÁµ±Ë®≠ÂÆöÔºàÂåØÊ¨æË≥áË®äÔºâ
let systemSettings = {
    bankName: '',
    bankAccount: '',
    bankHolder: ''
};

// ÊúÉÂì°Áõ∏Èóú
let currentMember = null;
let currentProduct = null;
let selectedSpec = null;
let quantity = 1;

// ==========================================
// üÜï Á∂†ÁïåÁâ©ÊµÅË®≠ÂÆöÔºàÊ≠£ÂºèÁí∞Â¢ÉÔºâ
// ==========================================
const ECPAY_CONFIG = {
    MerchantID: '3490304',
    HashKey: 'O7MpUtX9Inc7e4Ud',  // Ê≥®ÊÑèÔºöÁ¨¨‰∏ÄÂÄãÂ≠óÂÖÉÊòØÂ§ßÂØ´ O
    HashIV: 'B6BxB56xLdGv4fBd',
    // Ê≠£ÂºèÁí∞Â¢É
    MapURL: 'https://logistics.ecpay.com.tw/Express/map'
};

// ==========================================
// üÜï Á∂†ÁïåÂä†ÂØÜÂáΩÊï∏
// ==========================================

/**
 * URL EncodeÔºàÁ∂†ÁïåÂ∞àÁî®Ôºâ
 * Á∂†ÁïåÁöÑ URL Encode Ë¶èÂâáÔºö
 * 1. ÂÖàÈÄ≤Ë°åÊ®ôÊ∫ñÁöÑ encodeURIComponent
 * 2. Â∞áÁâπÂÆöÂ≠óÂÖÉÈÇÑÂéüÔºà‰∏çÁ∑®Á¢ºÔºâÔºö- _ . ! * ( )
 * 3. Â∞á %20 (Á©∫Ê†º) ËΩâÊàê +
 */
function ecpayUrlEncode(str) {
    let encoded = encodeURIComponent(str);
    
    // Â∞áÁâπÂÆöÂ≠óÂÖÉÈÇÑÂéüÔºàÁ∂†ÁïåË¶ÅÊ±ÇÈÄô‰∫õÂ≠óÂÖÉ‰∏çË¶ÅÁ∑®Á¢ºÔºâ
    encoded = encoded.replace(/%2D/g, '-');  // -
    encoded = encoded.replace(/%5F/g, '_');  // _
    encoded = encoded.replace(/%2E/g, '.');  // .
    encoded = encoded.replace(/%21/g, '!');  // !
    encoded = encoded.replace(/%2A/g, '*');  // *
    encoded = encoded.replace(/%28/g, '(');  // (
    encoded = encoded.replace(/%29/g, ')');  // )
    encoded = encoded.replace(/%20/g, '+');  // Á©∫Ê†ºËΩâ +
    
    return encoded;
}

/**
 * Áî¢Áîü CheckMacValue
 */
function generateCheckMacValue(params, hashKey, hashIV) {
    // 1. ÂèÉÊï∏‰æùÁÖß A-Z ÊéíÂ∫è
    const sortedKeys = Object.keys(params).sort((a, b) => {
        return a.toLowerCase().localeCompare(b.toLowerCase());
    });
    
    // 2. ÁµÑÊàêÂ≠ó‰∏≤Ôºökey1=value1&key2=value2...
    let checkStr = sortedKeys.map(key => {
        return `${key}=${params[key]}`;
    }).join('&');
    
    // 3. ÂâçÂæåÂä†‰∏ä HashKey Âíå HashIV
    checkStr = `HashKey=${hashKey}&${checkStr}&HashIV=${hashIV}`;
    
    // 4. URL Encode
    checkStr = ecpayUrlEncode(checkStr);
    
    // 5. ËΩâÂ∞èÂØ´
    checkStr = checkStr.toLowerCase();
    
    // 6. SHA256 Âä†ÂØÜ
    let hash = CryptoJS.SHA256(checkStr).toString(CryptoJS.enc.Hex);
    
    // 7. ËΩâÂ§ßÂØ´
    return hash.toUpperCase();
}

/**
 * Áî¢ÁîüË®ÇÂñÆÁ∑®Ëôü
 */
function generateMerchantTradeNo() {
    const timestamp = new Date().getTime();
    const random = Math.floor(Math.random() * 1000);
    return `CB${timestamp}${random}`;
}

/**
 * ÂÅµÊ∏¨Ë£ùÁΩÆÈ°ûÂûã
 */
function getDeviceType() {
    return '0'; // Ê∞∏ÈÅ†‰ΩøÁî®ÊâãÊ©üÁâà
}

// ==========================================
// üÜï ÈñãÂïüÁ∂†ÁïåÂú∞ÂúñÈÅ∏ÊìáÈñÄÂ∏Ç
// ==========================================
function openECPayMap() {
    console.log('========================================');
    console.log('üöÄ ÈñãÂßãÂü∑Ë°å openECPayMap');
    console.log('========================================');
    
    // Áî¢ÁîüÂîØ‰∏ÄË®ÇÂñÆÁ∑®Ëôü
    const merchantTradeNo = generateMerchantTradeNo();
    
    // ServerReplyURL Âíå ClientReplyURL ÈÉΩÊåáÂêë Vercel API
    // Vercel API Êé•Êî∂ POST ‚Üí ÂõûÂÇ≥ HTML Áµ¶ÂΩàÁ™ó ‚Üí ÂΩàÁ™óÈóúÈñâ
    // GAS Âè¶Â§ñÁî® fetch ÈÄöÁü•ÔºàË®òÈåÑË®ÇÂñÆÁî®Ôºâ
    const serverReplyURL = 'https://cbc-lake.vercel.app/api/ecpay-callback';
    const clientReplyURL = 'https://cbc-lake.vercel.app/api/ecpay-callback';
    
    console.log('ServerReplyURL:', serverReplyURL);
    console.log('ClientReplyURL:', clientReplyURL);
    
    // Ê∫ñÂÇôÂèÉÊï∏
    const params = {
        MerchantID: ECPAY_CONFIG.MerchantID,
        MerchantTradeNo: merchantTradeNo,
        LogisticsType: 'CVS',
        LogisticsSubType: 'UNIMARTC2C', // üî• 7-11 Â∫óÂà∞Â∫óÔºàC2CÔºâ
        IsCollection: 'N',
        ServerReplyURL: serverReplyURL,  // Apps Script Êé•Êî∂ POSTÔºàÂæåÁ´ØÈÄöÁü•Ôºâ
        ClientReplyURL: clientReplyURL,  // ecpay-callback.html Êé•Êî∂ GETÔºàÂâçÁ´ØÂΩàÁ™óÔºâ
        ExtraData: '',
        Device: getDeviceType()
    };
    
    // üî• Èô§ÈåØÔºöË®òÈåÑÂèÉÊï∏
    console.log('üì¶ Á∂†ÁïåÂú∞ÂúñÂèÉÊï∏Ôºö');
    console.log('MerchantID:', params.MerchantID);
    console.log('MerchantTradeNo:', params.MerchantTradeNo);
    console.log('LogisticsType:', params.LogisticsType);
    console.log('LogisticsSubType:', params.LogisticsSubType);
    console.log('ServerReplyURL:', params.ServerReplyURL);
    console.log('ClientReplyURL:', params.ClientReplyURL);
    console.log('Device:', params.Device);
    
    // Áî¢ÁîüÊ™¢Êü•Á¢º
    const checkMacValue = generateCheckMacValue(
        params,
        ECPAY_CONFIG.HashKey,
        ECPAY_CONFIG.HashIV
    );
    
    console.log('CheckMacValue:', checkMacValue);
    console.log('========================================');
    
    // Â°´ÂÖ•Ë°®ÂñÆ
    document.getElementById('ecpay_MerchantID').value = params.MerchantID;
    document.getElementById('ecpay_MerchantTradeNo').value = params.MerchantTradeNo;
    document.getElementById('ecpay_LogisticsSubType').value = params.LogisticsSubType;
    document.getElementById('ecpay_ServerReplyURL').value = params.ServerReplyURL;
    document.getElementById('ecpay_ClientReplyURL').value = params.ClientReplyURL;
    document.getElementById('ecpay_ExtraData').value = params.ExtraData;
    document.getElementById('ecpay_Device').value = params.Device;
    document.getElementById('ecpay_CheckMacValue').value = checkMacValue;
    
    // ÂÑ≤Â≠òË®ÇÂñÆÁ∑®ËôüÔºå‰æõÂõûÂÇ≥ÊôÇÈ©óË≠â
    localStorage.setItem('ecpay_merchant_trade_no', merchantTradeNo);
    console.log('‚úÖ Â∑≤ÂÑ≤Â≠òË®ÇÂñÆÁ∑®ËôüÂà∞ localStorage:', merchantTradeNo);
    
    // üî• ÈñãÂïüÂΩàÁ™óÔºà800x600Ôºâ
    const ecpayWindow = window.open('', 'ecpayWindow', 'width=800,height=600,scrollbars=yes');
    
    if (ecpayWindow) {
        console.log('‚úÖ ÂΩàÁ™óÂ∑≤ÈñãÂïü');
        // Êèê‰∫§Ë°®ÂñÆÂà∞ÂΩàÁ™ó
        document.getElementById('ecpayMapForm').submit();
        showToast('ÈñãÂïüÈñÄÂ∏ÇÈÅ∏ÊìáË¶ñÁ™ó...', 'success');
    } else {
        console.error('‚ùå ÂΩàÁ™óË¢´ÈòªÊìãÔºÅ');
        showToast('Ë´ãÂÖÅË®±ÂΩàÂá∫Ë¶ñÁ™óÔºÅ', 'error');
    }
    
    console.log('========================================');
}

// ==========================================
// üÜï Êé•Êî∂ÂΩàÁ™óÂÇ≥‰æÜÁöÑÈñÄÂ∏ÇË≥áÊñô
// ==========================================
// ==========================================
// üÜï ËôïÁêÜÁ∂†ÁïåÂõûÂÇ≥ÁöÑÈñÄÂ∏ÇË≥áÊñôÔºà‰ΩøÁî® localStorageÔºâ
// ==========================================

// üî• Ëº™Ë©¢Ê™¢Êü• localStorage ‰∏≠ÁöÑÈñÄÂ∏ÇË≥áÊñô
let storeDataCheckInterval = null;

/**
 * üÜï ÈñãÂßãÁõ£ËÅΩ localStorage ‰∏≠ÁöÑÈñÄÂ∏ÇË≥áÊñô
 */
function startListeningForStoreData() {
    console.log('========================================');
    console.log('üéß ÈñãÂßãÁõ£ËÅΩÈñÄÂ∏ÇË≥áÊñô...');
    console.log('========================================');
    
    // Ê∏ÖÈô§ËàäÁöÑÁõ£ËÅΩÂô®
    if (storeDataCheckInterval) {
        clearInterval(storeDataCheckInterval);
    }
    
    // ÊØè 500ms Ê™¢Êü•‰∏ÄÊ¨° localStorage
    storeDataCheckInterval = setInterval(() => {
        const storeDataJson = localStorage.getItem('ecpay_store_data');
        
        if (storeDataJson) {
            console.log('‚úÖ ÂÅµÊ∏¨Âà∞ÈñÄÂ∏ÇË≥áÊñôÔºÅ');
            
            try {
                const storeData = JSON.parse(storeDataJson);
                console.log('Êî∂Âà∞ÁöÑÈñÄÂ∏ÇË≥áÊñôÔºö', storeData);
                
                // ÂÅúÊ≠¢Áõ£ËÅΩ
                clearInterval(storeDataCheckInterval);
                storeDataCheckInterval = null;
                
                // ËôïÁêÜÈñÄÂ∏ÇË≥áÊñô
                processStoreData(storeData);
                
                // Ê∏ÖÈô§ localStorage ‰∏≠ÁöÑÈñÄÂ∏ÇË≥áÊñô
                localStorage.removeItem('ecpay_store_data');
                
            } catch (error) {
                console.error('‚ùå Ëß£ÊûêÈñÄÂ∏ÇË≥áÊñôÂ§±ÊïóÔºö', error);
                localStorage.removeItem('ecpay_store_data');
            }
        }
    }, 500);
    
    // 30ÁßíÂæåËá™ÂãïÂÅúÊ≠¢Áõ£ËÅΩ
    setTimeout(() => {
        if (storeDataCheckInterval) {
            console.log('‚è±Ô∏è Áõ£ËÅΩÈÄæÊôÇÔºåÂÅúÊ≠¢Áõ£ËÅΩ');
            clearInterval(storeDataCheckInterval);
            storeDataCheckInterval = null;
        }
    }, 30000);
}

/**
 * üÜï ËôïÁêÜÈñÄÂ∏ÇË≥áÊñô
 */
function processStoreData(storeData) {
    console.log('========================================');
    console.log('üì¶ ÈñãÂßãËôïÁêÜÈñÄÂ∏ÇË≥áÊñô');
    console.log('========================================');
    
    if (!storeData) {
        console.error('‚ùå ÈñÄÂ∏ÇË≥áÊñôÁÇ∫Á©∫');
        showToast('ÈñÄÂ∏ÇË≥áÊñôÁÇ∫Á©∫', 'error');
        return;
    }
    
    // È©óË≠âË®ÇÂñÆÁ∑®Ëôü
    const savedTradeNo = localStorage.getItem('ecpay_merchant_trade_no');
    console.log('ÂÑ≤Â≠òÁöÑË®ÇÂñÆÁ∑®ËôüÔºö', savedTradeNo);
    console.log('ÂõûÂÇ≥ÁöÑË®ÇÂñÆÁ∑®ËôüÔºö', storeData.MerchantTradeNo);
    
    if (storeData.MerchantTradeNo !== savedTradeNo) {
        console.error('‚ùå Ë®ÇÂñÆÁ∑®Ëôü‰∏çÁ¨¶ÔºÅ');
        showToast('ÈñÄÂ∏ÇË≥áÊñôÈ©óË≠âÂ§±Êïó', 'error');
        return;
    }
    
    // ÂÑ≤Â≠òÈñÄÂ∏ÇË≥áÊñô
    selectedStore = {
        id: storeData.CVSStoreID,
        name: storeData.CVSStoreName,
        address: storeData.CVSAddress,
        phone: storeData.CVSTelephone
    };
    
    console.log('‚úÖ Â∑≤ÂÑ≤Â≠òÈñÄÂ∏ÇÔºö', selectedStore);
    
    // È°ØÁ§∫ÈñÄÂ∏ÇË≥áË®ä
    displaySelectedStore();
    
    // Ê∏ÖÈô§Ë®ÇÂñÆÁ∑®Ëôü
    localStorage.removeItem('ecpay_merchant_trade_no');
    
    // È°ØÁ§∫ÊàêÂäüË®äÊÅØ
    showToast('‚úÖ ÈñÄÂ∏ÇÈÅ∏ÊìáÊàêÂäüÔºÅ', 'success');
    
    console.log('========================================');
}

// window.opener Áõ¥Êé•ÂëºÂè´ÔºàÂêåÂüüÊôÇÔºâ
window.receiveStoreData = function(storeData) {
    console.log('‚úÖ receiveStoreData Ë¢´ÂëºÂè´Ôºàwindow.opener ÊñπÂºèÔºâ');
    processStoreData(storeData);
};

// ‚úÖ postMessage Áõ£ËÅΩÔºàË∑®ÂüüÊôÇÔºåGAS ÂõûÂÇ≥ÁöÑÂΩàÁ™óÁî®ÈÄôÂÄãÔºâ
window.addEventListener('message', function(event) {
    if (!event.data || event.data.type !== 'ecpay_store') return;
    console.log('‚úÖ Êî∂Âà∞ postMessage ÈñÄÂ∏ÇË≥áÊñô:', event.data.data);
    processStoreData(event.data.data);
});

/**
 * üÜï È°ØÁ§∫Â∑≤ÈÅ∏ÊìáÁöÑÈñÄÂ∏ÇË≥áË®ä
 */
function displaySelectedStore() {
    console.log('displaySelectedStore Ë¢´ÂëºÂè´ÔºåselectedStoreÔºö', selectedStore);
    
    if (!selectedStore) {
        // Ê≤íÊúâÈÅ∏ÊìáÈñÄÂ∏ÇÔºåÈö±ËóèÈñÄÂ∏ÇË≥áË®äÂçÄÂ°ä
        const infoElement = document.getElementById('selectedStoreInfo');
        if (infoElement) {
            infoElement.classList.remove('active');
        }
        return;
    }
    
    // ÊúâÈÅ∏ÊìáÈñÄÂ∏ÇÔºåÈ°ØÁ§∫ÈñÄÂ∏ÇË≥áË®ä
    const infoElement = document.getElementById('selectedStoreInfo');
    if (infoElement) {
        infoElement.classList.add('active');
        document.getElementById('storeName').textContent = selectedStore.name || '';
        document.getElementById('storeAddress').textContent = selectedStore.address || '';
        console.log('‚úÖ ÈñÄÂ∏ÇË≥áË®äÂ∑≤È°ØÁ§∫Âú®È†ÅÈù¢‰∏ä');
        // È°ØÁ§∫‰ªòÊ¨æÊñπÂºèÈÅ∏Êìá
        showStorePaymentMethod();
    } else {
        console.error('‚ùå Êâæ‰∏çÂà∞ selectedStoreInfo ÂÖÉÁ¥†');
    }
}

/**
 * üÜï Ê∏ÖÈô§ÈÅ∏ÊìáÁöÑÈñÄÂ∏Ç
 */
function clearSelectedStore() {
    selectedStore = null;
    displaySelectedStore();
    showToast('Â∑≤Ê∏ÖÈô§ÈñÄÂ∏ÇÈÅ∏Êìá', 'success');
}

// ==========================================
// ËºâÂÖ•ÂïÜÂìÅË≥áÊñô
// ==========================================
async function loadProductsData() {
    try {
        showToast('ËºâÂÖ•ÂïÜÂìÅË≥áÊñô‰∏≠...', 'success');
        
        // ËºâÂÖ•ÂïÜÂìÅÂàóË°®
        const productsUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${PRODUCTS_SHEET}?key=${API_KEY}`;
        const productsResponse = await fetch(productsUrl);
        
        if (!productsResponse.ok) throw new Error('ÁÑ°Ê≥ïËºâÂÖ•ÂïÜÂìÅË≥áÊñô');
        
        const productsData = await productsResponse.json();
        
        if (!productsData.values || productsData.values.length < 2) {
            throw new Error('ÂïÜÂìÅË≥áÊñôÁÇ∫Á©∫');
        }

        products = productsData.values.slice(1).map(row => ({
            id: row[0] || '',
            name: row[1] || '',
            image: row[2] || '',
            isFeatured: (row[3] || '').trim() === 'ÊòØ',  // DÊ¨ÑÔºö‰∏ªÊâìÔºåÂ°´„ÄåÊòØ„ÄçË°®Á§∫‰∏ªÊâì
            category: row[4] || '',  // EÊ¨ÑÔºöÂïÜÂìÅÈ°ûÂà•ÔºàÂè£Âë≥ÂàÜÈ°ûÔºåÂ¶Ç PLOOMËõã„ÄÅGLOËõãÔºâ
            tags: (row[5] || '').split(',').map(t => t.trim()).filter(t => t),  // FÊ¨ÑÔºöÂ§ßÂàÜÈ°ûÊ®ôÁ±§
            customBlock: (row[6] || '').trim(),  // üÜï GÊ¨ÑÔºöËá™ÂÆöÁæ©ÂçÄÂ°äÂêçÁ®±ÔºàÂ°´ÂçÄÂ°äÂêçÁ®±Âç≥Âä†ÂÖ•Ë©≤ÂçÄÂ°äÔºâ
            price: 0,
            stock: 0
        })).filter(p => p.id);

        // ËºâÂÖ•ÂïÜÂìÅË¶èÊ†ºË°®
        const specsUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SPECS_SHEET}?key=${API_KEY}`;
        const specsResponse = await fetch(specsUrl);
        
        if (!specsResponse.ok) throw new Error('ÁÑ°Ê≥ïËºâÂÖ•Ë¶èÊ†ºË≥áÊñô');
        
        const specsData = await specsResponse.json();
        
        if (specsData.values && specsData.values.length > 1) {
            specsData.values.slice(1).forEach(row => {
                const productId = row[0];
                const _salePrice = parseInt(row[3]) || 0;
                const _normalPrice = parseInt(row[5]) || 0;
                const spec = {
                    productId: row[0] || '',
                    productName: row[1] || '',
                    specName: row[2] || '',
                    price: _salePrice > 0 ? _salePrice : _normalPrice,  // DÊúâÁâπÂÉπÁî®ÁâπÂÉπÔºåÂê¶ÂâáÁî®FÂéüÂÉπ
                    originalPrice: _salePrice > 0 ? _normalPrice : 0,   // ÊúâÁâπÂÉπÊâçÈ°ØÁ§∫ÂäÉÁ∑öÂéüÂÉπ
                    stock: parseInt(row[4]) || 0,
                    image: '',                                  // ÁÑ°ÂúñÁâáÊ¨Ñ
                    quantityMultiplier: parseInt(row[6]) || 1   // GÊ¨ÑÔºöÂÄçÊï∏
                };
                
                if (!productSpecs[productId]) {
                    productSpecs[productId] = [];
                }
                productSpecs[productId].push(spec);
            });
            
            // Êõ¥Êñ∞ÂïÜÂìÅÁöÑÂÉπÊ†ºÂíåÂ∫´Â≠ò
            products.forEach(product => {
                const specs = productSpecs[product.id];
                if (specs && specs.length > 0) {
                    product.price = Math.min(...specs.map(s => s.price));
                    product.stock = specs.reduce((sum, spec) => sum + spec.stock, 0);
                }
            });
        }

        // üî• ÂÖàËºâÂÖ•ÂàÜÈ°ûÁÖßÁâáË®≠ÂÆöÔºåÂÜçÈ°ØÁ§∫ÂïÜÂìÅ
        await loadCategoryImages();   // Á≠âÂæÖËºâÂÖ•ÂÆåÊàê
        
        displayFeaturedProducts();  // È°ØÁ§∫‰∏ªÊâìÂïÜÂìÅ
        displayProducts();          // È°ØÁ§∫ÊâÄÊúâÂïÜÂìÅ
        loadCategories();           // üÜï ËºâÂÖ•‰∏¶ÁîüÊàêÂàÜÈ°ûÊåâÈàï
        loadAnnouncements();        // üÜï ËºâÂÖ•ÂÖ¨Âëä
        loadPromotions();           // üÜï ËºâÂÖ•ÂÑ™ÊÉ†Ë®≠ÂÆö
        showToast('ÂïÜÂìÅËºâÂÖ•ÂÆåÊàê!', 'success');
        
    } catch (error) {
        console.error('ËºâÂÖ•ÂïÜÂìÅÂ§±Êïó:', error);
        showToast('ËºâÂÖ•ÂïÜÂìÅÂ§±ÊïóÔºö' + error.message, 'error');
    }
}

// ==========================================
// üÜï ÂÖ¨ÂëäÂàóÂäüËÉΩ
// ==========================================

/**
 * ËºâÂÖ•ÂÖ¨ÂëäË≥áÊñô
 */
async function loadAnnouncements() {
    try {
        const announcementUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${ANNOUNCEMENT_SHEET}?key=${API_KEY}`;
        const response = await fetch(announcementUrl);
        
        if (!response.ok) {
            console.log('Êâæ‰∏çÂà∞ÂÖ¨ÂëäË®≠ÂÆöÂ∑•‰ΩúË°®ÔºåË∑≥ÈÅéÂÖ¨ÂëäËºâÂÖ•');
            return;
        }
        
        const data = await response.json();
        
        if (!data.values || data.values.length < 2) {
            console.log('ÂÖ¨ÂëäË≥áÊñôÁÇ∫Á©∫');
            return;
        }
        
        // Ëß£ÊûêÂÖ¨ÂëäË≥áÊñô
        // Ê†ºÂºèÔºöAÊ¨Ñ=ÂÖ¨ÂëäÂÖßÂÆπ, BÊ¨Ñ=ÂïüÁî®ÁãÄÊÖãÔºàÊòØ/Âê¶Ôºâ, CÊ¨Ñ=ÈÄ£Áµê(ÂèØÈÅ∏)
        announcements = data.values.slice(1)
            .filter(row => row[0] && (row[1] || '').trim() === 'ÊòØ')  // Âè™ÂèñÂïüÁî®ÁöÑÂÖ¨Âëä
            .map(row => ({
                text: row[0] || '',
                link: row[2] || ''
            }));
        
        if (announcements.length > 0) {
            displayAnnouncements();
        }
        
    } catch (error) {
        console.error('ËºâÂÖ•ÂÖ¨ÂëäÂ§±Êïó:', error);
    }
}

/**
 * È°ØÁ§∫ÂÖ¨Âëä
 */
function displayAnnouncements() {
    const announcementBar = document.getElementById('announcementBar');
    const announcementText = document.getElementById('announcementText');
    
    if (announcements.length === 0) {
        announcementBar.classList.remove('active');
        return;
    }
    
    announcementBar.classList.add('active');
    
    if (announcements.length === 1) {
        // ÂñÆÂâáÂÖ¨ÂëäÔºö‰ΩøÁî®Ë∑ëÈ¶¨ÁáàÊïàÊûú
        const announcement = announcements[0];
        announcementText.textContent = announcement.text;
        announcementText.classList.add('marquee');
        announcementText.classList.remove('fade');
        
        // Â¶ÇÊûúÊúâÈÄ£ÁµêÔºåË®≠ÂÆöÈªûÊìä‰∫ã‰ª∂
        if (announcement.link) {
            announcementBar.style.cursor = 'pointer';
            announcementBar.onclick = () => {
                window.open(announcement.link, '_blank');
            };
        }
    } else {
        // Â§öÂâáÂÖ¨ÂëäÔºö‰ΩøÁî®Ëº™Êí≠ÊïàÊûú
        let currentIndex = 0;
        announcementText.classList.remove('marquee');
        announcementText.classList.add('fade');
        
        function rotateAnnouncement() {
            const announcement = announcements[currentIndex];
            
            // ÂÖàÊ∑°Âá∫
            announcementText.style.opacity = '0';
            
            setTimeout(() => {
                announcementText.textContent = announcement.text;
                
                // Êõ¥Êñ∞ÈÄ£Áµê
                if (announcement.link) {
                    announcementBar.style.cursor = 'pointer';
                    announcementBar.onclick = () => {
                        window.open(announcement.link, '_blank');
                    };
                } else {
                    announcementBar.style.cursor = 'default';
                    announcementBar.onclick = null;
                }
                
                // Ê∑°ÂÖ•
                announcementText.style.opacity = '1';
                
                currentIndex = (currentIndex + 1) % announcements.length;
            }, 300);
        }
        
        // ÂàùÂßãÈ°ØÁ§∫Á¨¨‰∏ÄÂâá
        rotateAnnouncement();
        
        // ÊØè 5 ÁßíÂàáÊèõ‰∏ÄÊ¨°
        setInterval(rotateAnnouncement, 5000);
    }
}

// ==========================================
// üÜï ÂÑ™ÊÉ†Á≥ªÁµ±
// ==========================================

/**
 * ËºâÂÖ•ÂÑ™ÊÉ†Ë®≠ÂÆö
 */
async function loadPromotions() {
    try {
        const promotionUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${PROMOTION_SHEET}?key=${API_KEY}`;
        const response = await fetch(promotionUrl);
        
        if (!response.ok) {
            console.log('Êâæ‰∏çÂà∞ÂÑ™ÊÉ†Ë®≠ÂÆöÂ∑•‰ΩúË°®ÔºåË∑≥ÈÅéÂÑ™ÊÉ†ËºâÂÖ•');
            return;
        }
        
        const data = await response.json();
        
        if (!data.values || data.values.length < 2) {
            console.log('ÂÑ™ÊÉ†Ë≥áÊñôÁÇ∫Á©∫');
            return;
        }
        
        // Ëß£ÊûêÂÑ™ÊÉ†Ë≥áÊñô
        // üÜï Êñ∞Â¢û H„ÄÅI Ê¨ÑÔºöÈÅ©Áî®È°ûÂà•„ÄÅÈÅ©Áî®Ë¶èÊ†º
        // Ê†ºÂºèÔºö
        // AÊ¨Ñ=ÂÑ™ÊÉ†ÂêçÁ®±
        // BÊ¨Ñ=ÂÑ™ÊÉ†È°ûÂûãÔºàÊªø‰ª∂ÊäòÊâ£/ÊªøÈ°çÊäòÊâ£/ÊªøÈ°çÂÖçÈÅãÔºâ
        // CÊ¨Ñ=ÂñÆ‰ΩçÔºàÊ¢ù/ÂåÖ/ÂÖÉÔºâ
        // DÊ¨Ñ=Ê¢ù‰ª∂Êï∏Èáè/ÈáëÈ°ç
        // EÊ¨Ñ=ÊäòÊâ£ÈáëÈ°ç
        // FÊ¨Ñ=ÂïüÁî®ÁãÄÊÖãÔºàÊòØ/Âê¶Ôºâ
        // GÊ¨Ñ=Ë™™ÊòéÊñáÂ≠ó
        // HÊ¨Ñ=ÈÅ©Áî®È°ûÂà•ÔºàÁ©∫ÁôΩ=ÂÖ®ÈÉ®ÔºåÊàñÂ°´ÂØ´È°ûÂà•ÔºåÂ§öÂÄãÁî®ÈÄóËôüÂàÜÈöîÔºâüÜï
        // IÊ¨Ñ=ÈÅ©Áî®Ë¶èÊ†ºÔºàÁ©∫ÁôΩ=ÂÖ®ÈÉ®ÔºåÊàñÂ°´ÂØ´ÔºöÂñÆÂåÖ/Ê¢ùÔºâüÜï
        promotions = data.values.slice(1)
            .filter(row => row[0] && (row[5] || '').trim() === 'ÊòØ')  // FÊ¨ÑÔºöÂïüÁî®
            .map(row => ({
                name: row[0] || '',
                type: row[1] || '',
                unit: row[2] || '',
                threshold: parseFloat(row[3]) || 0,
                discount: parseFloat(row[4]) || 0,
                description: row[6] || '',
                allowedCategories: row[7] ? row[7].split(',').map(c => c.trim()).filter(c => c) : [],  // üÜï ÈÅ©Áî®È°ûÂà•
                allowedSpecs: row[8] ? row[8].split(',').map(s => s.trim()).filter(s => s) : []        // üÜï ÈÅ©Áî®Ë¶èÊ†º
            }));
        
        console.log('Â∑≤ËºâÂÖ•ÂÑ™ÊÉ†:', promotions);
        
    } catch (error) {
        console.error('ËºâÂÖ•ÂÑ™ÊÉ†Â§±Êïó:', error);
    }
}

/**
 * Ë®àÁÆóÂÑ™ÊÉ†ÊäòÊâ£
 * @param {Array} cartItems - Ë≥ºÁâ©ËªäÂïÜÂìÅ
 * @returns {Object} ÂÑ™ÊÉ†Ë©≥ÊÉÖ
 */

// È°ØÁ§∫ÂÉπÊ†ºÔºàÂê´ÂéüÂÉπÂäÉÁ∑öÔºâ
function renderSpecPrice(spec) {
    const el = document.getElementById('specInfoPrice');
    if (!el) return;
    if (spec.originalPrice && spec.originalPrice > spec.price) {
        el.innerHTML = `$${spec.price} <span class="spec-original-price">$${spec.originalPrice}</span><span class="sale-badge">ÁâπÂÉπ‰∏≠</span>`;
    } else {
        el.textContent = `$${spec.price}`;
    }
}

function calculatePromotions(cartItems) {
    const result = {
        appliedPromotions: [],  // Â∑≤Â•óÁî®ÁöÑÂÑ™ÊÉ†
        totalDiscount: 0,       // Á∏ΩÊäòÊâ£ÈáëÈ°ç
        freeShipping: false,    // ÊòØÂê¶ÂÖçÈÅã
        messages: []            // ÂÑ™ÊÉ†Ë®äÊÅØ
    };
    
    if (promotions.length === 0 || cartItems.length === 0) {
        return result;
    }
    
    // ÈÄê‰∏ÄÊ™¢Êü•ÊØèÂÄãÂÑ™ÊÉ†
    promotions.forEach(promo => {
        // üÜï ÈÅéÊøæÁ¨¶ÂêàÊ¢ù‰ª∂ÁöÑÂïÜÂìÅ
        const eligibleItems = cartItems.filter(item => {
            // Ê™¢Êü•È°ûÂà•ÈôêÂà∂
            if (promo.allowedCategories.length > 0) {
                // ÊâæÂá∫Ë©≤ÂïÜÂìÅÁöÑÈ°ûÂà•
                const product = products.find(p => p.id === item.productId);
                if (!product || !promo.allowedCategories.includes(product.category)) {
                    return false;  // ‰∏çÁ¨¶ÂêàÈ°ûÂà•ÈôêÂà∂
                }
            }
            
            // Ê™¢Êü•Ë¶èÊ†ºÈôêÂà∂
            if (promo.allowedSpecs.length > 0) {
                if (!promo.allowedSpecs.includes(item.specName)) {
                    return false;  // ‰∏çÁ¨¶ÂêàË¶èÊ†ºÈôêÂà∂
                }
            }
            
            return true;  // Á¨¶ÂêàÊâÄÊúâÈôêÂà∂
        });
        
        if (eligibleItems.length === 0) {
            return;  // Ê≤íÊúâÁ¨¶ÂêàÁöÑÂïÜÂìÅÔºåË∑≥ÈÅéÊ≠§ÂÑ™ÊÉ†
        }
        
        // üÜï Ë®àÁÆóÁ¨¶ÂêàÊ¢ù‰ª∂ÁöÑÂïÜÂìÅÁµ±Ë®à
        const stats = {
            totalAmount: eligibleItems.reduce((sum, item) => sum + (item.price * item.quantity), 0),
            totalBoxes: 0,
            totalPacks: 0
        };
        
        eligibleItems.forEach(item => {
            const multiplier = item.quantityMultiplier || 1;
            if (multiplier === 10) {
                stats.totalBoxes += item.quantity;
                stats.totalPacks += item.quantity * 10;
            } else {
                stats.totalPacks += item.quantity;
            }
        });
        
        let applied = false;
        let discount = 0;
        
        switch (promo.type) {
            case 'Êªø‰ª∂ÊäòÊâ£':
                if (promo.unit === 'Ê¢ù') {
                    if (stats.totalBoxes >= promo.threshold) {
                        discount = stats.totalBoxes * promo.discount;
                        applied = true;
                    }
                } else if (promo.unit === 'ÂåÖ') {
                    if (stats.totalPacks >= promo.threshold) {
                        discount = stats.totalPacks * promo.discount;
                        applied = true;
                    }
                }
                break;
                
            case 'ÊªøÈ°çÊäòÊâ£':
                if (stats.totalAmount >= promo.threshold) {
                    discount = promo.discount;
                    applied = true;
                }
                break;
                
            case 'ÊªøÈ°çÂÖçÈÅã':
                // üÜï ÂÖçÈÅãÂÑ™ÊÉ†ÊîπÁî®ÂÖ®ÈÉ®ÂïÜÂìÅÈáëÈ°çÔºà‰∏çÈôêÂà∂È°ûÂà•Ôºâ
                const allAmount = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                if (allAmount >= promo.threshold) {
                    result.freeShipping = true;
                    applied = true;
                }
                break;
        }
        
        if (applied) {
            result.appliedPromotions.push({
                name: promo.name,
                type: promo.type,
                discount: discount,
                description: promo.description
            });
            
            if (discount > 0) {
                result.totalDiscount += discount;
            }
            
            // ÁîüÊàêÂÑ™ÊÉ†Ë®äÊÅØ
            if (promo.type === 'ÊªøÈ°çÂÖçÈÅã') {
                result.messages.push(`‚úÖ ${promo.name}ÔºöÂÖçÈÅãË≤ª`);
            } else if (discount > 0) {
                result.messages.push(`‚úÖ ${promo.name}ÔºöÊäòÊâ£ $${discount}`);
            }
        }
    });
    
    return result;
}

/**
 * È°ØÁ§∫ÂÑ™ÊÉ†ÊèêÁ§∫ÔºàÂú®Ë≥ºÁâ©ËªäÊàñÁµêÂ∏≥È†ÅÈù¢Ôºâ
 */
function displayPromotionHints(cartItems) {
    if (promotions.length === 0) return '';
    
    const hints = [];
    
    promotions.forEach(promo => {
        // ‚úÖ ÂÖàÈÅéÊøæÁ¨¶ÂêàÊ≠§ÂÑ™ÊÉ†Ê¢ù‰ª∂ÁöÑÂïÜÂìÅÔºàË∑ü calculatePromotions ÈÇèËºØ‰∏ÄËá¥Ôºâ
        const eligibleItems = cartItems.filter(item => {
            if (promo.allowedCategories.length > 0) {
                const product = products.find(p => p.id === item.productId);
                if (!product || !promo.allowedCategories.includes(product.category)) return false;
            }
            if (promo.allowedSpecs.length > 0) {
                if (!promo.allowedSpecs.includes(item.specName)) return false;
            }
            return true;
        });

        // Ë®àÁÆóÁ¨¶ÂêàÊ¢ù‰ª∂ÂïÜÂìÅÁöÑÁµ±Ë®à
        const stats = {
            totalAmount: eligibleItems.reduce((sum, item) => sum + (item.price * item.quantity), 0),
            totalBoxes: 0,
            totalPacks: 0
        };
        eligibleItems.forEach(item => {
            const multiplier = item.quantityMultiplier || 1;
            if (multiplier === 10) {
                stats.totalBoxes += item.quantity;
                stats.totalPacks += item.quantity * 10;
            } else {
                stats.totalPacks += item.quantity;
            }
        });

        // ‚úÖ ÁµÑÊàêÈ°ûÂà•Êã¨ËôüÊñáÂ≠ó
        const categoryLabel = promo.allowedCategories.length > 0
            ? `Ôºà${promo.allowedCategories.join('„ÄÅ')}Ôºâ`
            : '';

        let hint = '';
        switch (promo.type) {
            case 'Êªø‰ª∂ÊäòÊâ£':
                if (promo.unit === 'Ê¢ù') {
                    if (stats.totalBoxes < promo.threshold) {
                        const needed = promo.threshold - stats.totalBoxes;
                        hint = `üí° ÂÜçË≥ºË≤∑ ${needed} Ê¢ùÂç≥ÂèØ‰∫´„Äå${promo.name}„Äç${categoryLabel}`;
                    }
                } else if (promo.unit === 'ÂåÖ') {
                    if (stats.totalPacks < promo.threshold) {
                        const needed = promo.threshold - stats.totalPacks;
                        hint = `üí° ÂÜçË≥ºË≤∑ ${needed} ÂåÖÂç≥ÂèØ‰∫´„Äå${promo.name}„Äç${categoryLabel}`;
                    }
                }
                break;
            case 'ÊªøÈ°çÊäòÊâ£':
            case 'ÊªøÈ°çÂÖçÈÅã': {
                // ÂÖçÈÅãÁî®ÂÖ®ÈÉ®ÈáëÈ°çÔºåÂÖ∂‰ªñÁî®Á¨¶ÂêàÊ¢ù‰ª∂ÈáëÈ°ç
                const checkAmount = promo.type === 'ÊªøÈ°çÂÖçÈÅã'
                    ? cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0)
                    : stats.totalAmount;
                if (checkAmount < promo.threshold) {
                    const needed = promo.threshold - checkAmount;
                    hint = `üí° ÂÜçÂä†Ë≥º $${needed} Âç≥ÂèØ‰∫´„Äå${promo.name}„Äç${categoryLabel}`;
                }
                break;
            }
        }
        
        if (hint) hints.push(hint);
    });
    
    return hints.join('<br>');
}

// ==========================================
// üî• Âè™Êõ¥Êñ∞Â∑≤Ë≥ºË≤∑ÂïÜÂìÅÁöÑÂ∫´Â≠òÔºàËºïÈáèÁ¥öÊõ¥Êñ∞Ôºâ
// ==========================================
async function updatePurchasedProductsStock(purchasedItems) {
    try {
        // ËºâÂÖ•ÊúÄÊñ∞ÁöÑÂïÜÂìÅË¶èÊ†ºË°®
        const specsUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SPECS_SHEET}?key=${API_KEY}`;
        const specsResponse = await fetch(specsUrl);
        
        if (!specsResponse.ok) return;
        
        const specsData = await specsResponse.json();
        
        if (specsData.values && specsData.values.length > 1) {
            // Âè™Êõ¥Êñ∞Â∑≤Ë≥ºË≤∑ÂïÜÂìÅÁöÑË¶èÊ†º
            const updatedProductIds = new Set();
            
            specsData.values.slice(1).forEach(row => {
                const productId = row[0];
                const specName = row[2] || '';
                
                // Ê™¢Êü•ÈÄôÂÄãË¶èÊ†ºÊòØÂê¶Âú®Ë≥ºË≤∑Ê∏ÖÂñÆ‰∏≠
                const isPurchased = purchasedItems.some(item => 
                    item.productId === productId && item.specName === specName
                );
                
                if (isPurchased) {
                    // Êõ¥Êñ∞ÈÄôÂÄãË¶èÊ†ºÁöÑÂ∫´Â≠ò
                    if (productSpecs[productId]) {
                        const spec = productSpecs[productId].find(s => s.specName === specName);
                        if (spec) {
                            spec.stock = parseInt(row[4]) || 0;
                            updatedProductIds.add(productId);
                        }
                    }
                }
            });
            
            // ÈáçÊñ∞Ë®àÁÆóÂèóÂΩ±ÈüøÂïÜÂìÅÁöÑÁ∏ΩÂ∫´Â≠ò
            updatedProductIds.forEach(productId => {
                const product = products.find(p => p.id === productId);
                if (product && productSpecs[productId]) {
                    product.stock = productSpecs[productId].reduce((sum, spec) => sum + spec.stock, 0);
                }
            });
            
            // Âè™ÈáçÊñ∞Ê∏≤ÊüìÂïÜÂìÅÈ°ØÁ§∫Ôºà‰∏çÈáçÊñ∞ËºâÂÖ•ÂàÜÈ°ûÔºâ
            displayFeaturedProducts();
            displayProducts();
            
            console.log('‚úÖ Â∑≤Êõ¥Êñ∞', updatedProductIds.size, 'ÂÄãÂïÜÂìÅÁöÑÂ∫´Â≠ò');
        }
        
    } catch (error) {
        console.error('Êõ¥Êñ∞Â∫´Â≠òÂ§±Êïó:', error);
        // Â¶ÇÊûúËºïÈáèÊõ¥Êñ∞Â§±ÊïóÔºåÈùúÈªòÂ§±ÊïóÔºàÁî®Êà∂‰∏ãÊ¨°ÈáçÊï¥È†ÅÈù¢ÊôÇÊúÉÁúãÂà∞ÊúÄÊñ∞Â∫´Â≠òÔºâ
    }
}

// ==========================================
// üî• ÂÆöÊúüËá™ÂãïÂà∑Êñ∞ÊâÄÊúâÂïÜÂìÅÂ∫´Â≠òÔºàËß£Ê±∫Â§ö‰∫∫ÂêåÊôÇ‰∏ãÂñÆÂïèÈ°åÔºâ
// ==========================================
let autoRefreshInterval = null;

async function refreshAllStock() {
    try {
        // ÈùúÈªòÊõ¥Êñ∞Ôºå‰∏çÈ°ØÁ§∫ÊèêÁ§∫Ë®äÊÅØ
        const specsUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SPECS_SHEET}?key=${API_KEY}`;
        const specsResponse = await fetch(specsUrl);
        
        if (!specsResponse.ok) return;
        
        const specsData = await specsResponse.json();
        
        if (specsData.values && specsData.values.length > 1) {
            // Ê∏ÖÁ©∫‰∏¶ÈáçÂª∫Ë¶èÊ†ºÊï∏Êìö
            productSpecs = {};
            
            specsData.values.slice(1).forEach(row => {
                const productId = row[0];
                const _salePrice2 = parseInt(row[3]) || 0;
                const _normalPrice2 = parseInt(row[5]) || 0;
                const spec = {
                    productId: row[0] || '',
                    productName: row[1] || '',
                    specName: row[2] || '',
                    price: _salePrice2 > 0 ? _salePrice2 : _normalPrice2,
                    originalPrice: _salePrice2 > 0 ? _normalPrice2 : 0,
                    stock: parseInt(row[4]) || 0,
                    image: '',
                    quantityMultiplier: parseInt(row[6]) || 1
                };
                
                if (!productSpecs[productId]) {
                    productSpecs[productId] = [];
                }
                productSpecs[productId].push(spec);
            });
            
            // Êõ¥Êñ∞ÊâÄÊúâÂïÜÂìÅÁöÑÂ∫´Â≠ò
            products.forEach(product => {
                const specs = productSpecs[product.id];
                if (specs && specs.length > 0) {
                    product.stock = specs.reduce((sum, spec) => sum + spec.stock, 0);
                }
            });
            
            // ÈáçÊñ∞Ê∏≤ÊüìÂïÜÂìÅÈ°ØÁ§∫
            displayFeaturedProducts();
            displayProducts();
            
            console.log('üîÑ Ëá™ÂãïÂà∑Êñ∞Â∫´Â≠òÂÆåÊàê -', new Date().toLocaleTimeString());
        }
        
    } catch (error) {
        console.error('Ëá™ÂãïÂà∑Êñ∞Â∫´Â≠òÂ§±Êïó:', error);
    }
}

function startAutoRefresh(intervalSeconds = 30) {
    // Ê∏ÖÈô§ËàäÁöÑÂÆöÊôÇÂô®
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
    
    // Ë®≠ÁΩÆÊñ∞ÁöÑÂÆöÊôÇÂô®ÔºàÈ†êË®≠30ÁßíÂà∑Êñ∞‰∏ÄÊ¨°Ôºâ
    autoRefreshInterval = setInterval(() => {
        refreshAllStock();
    }, intervalSeconds * 1000);
    
    console.log(`‚úÖ Â∑≤ÂïüÂãïËá™ÂãïÂà∑Êñ∞ÔºåÊØè ${intervalSeconds} ÁßíÊõ¥Êñ∞‰∏ÄÊ¨°Â∫´Â≠ò`);
}

function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
        console.log('‚èπÔ∏è Â∑≤ÂÅúÊ≠¢Ëá™ÂãïÂà∑Êñ∞');
    }
}

// ==========================================
// üÜï ËºâÂÖ•ÂàÜÈ°ûÁÖßÁâáË®≠ÂÆöÔºàÂæû„ÄåÂàÜÈ°ûÁÖßÁâáË®≠ÂÆö„ÄçÂ∑•‰ΩúË°®Ôºâ
// ==========================================
let categoryImages = {};        // ÂÑ≤Â≠òÂàÜÈ°ûÁÖßÁâáË®≠ÂÆöÔºàBÊ¨ÑÔºåÊúÄÂ§ñÂ±§Âç°ÁâáÂúñÔºâ
let categoryCarouselImages = {}; // üÜï ÂÑ≤Â≠òÂàÜÈ°ûËº™Êí≠ÂúñÔºàCÊ¨ÑËµ∑ÔºåÈªûÈÄ≤ÂéªÁöÑÂ§öÂºµÂúñÔºâ

async function loadCategoryImages() {
    try {
        const sheetName = 'ÂàÜÈ°ûÁÖßÁâáË®≠ÂÆö';
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${sheetName}?key=${API_KEY}`;
        
        const response = await fetch(url);
        if (response.ok) {
            const data = await response.json();
            if (data.values && data.values.length > 1) {
                categoryImages = {};
                categoryCarouselImages = {};
                data.values.slice(1).forEach(row => {
                    const categoryName = row[0] || '';   // AÊ¨ÑÔºöÂàÜÈ°ûÂêçÁ®±
                    const cardImage = row[1] || '';      // BÊ¨ÑÔºöÊúÄÂ§ñÂ±§Âç°ÁâáÂúñ
                    
                    if (!categoryName) return;
                    
                    if (cardImage) {
                        categoryImages[categoryName] = cardImage;
                    }
                    
                    // üÜï CÊ¨ÑËµ∑Ôºàindex 2ÔºâÔºöËº™Êí≠ÂúñÁâáÔºåÂèØÊúâÂ§öÊ¨Ñ
                    const carouselImgs = [];
                    for (let i = 2; i < row.length; i++) {
                        if (row[i] && row[i].trim()) {
                            carouselImgs.push(row[i].trim());
                        }
                    }
                    if (carouselImgs.length > 0) {
                        categoryCarouselImages[categoryName] = carouselImgs;
                    }
                });
                
                console.log('‚úÖ Â∑≤ËºâÂÖ•ÂàÜÈ°ûÁÖßÁâáË®≠ÂÆöÔºö', categoryImages);
                console.log('‚úÖ Â∑≤ËºâÂÖ•Ëº™Êí≠ÂúñË®≠ÂÆöÔºö', categoryCarouselImages);
            }
        }
    } catch (error) {
        console.log('‚ö†Ô∏è Ê≤íÊúâÊâæÂà∞„ÄåÂàÜÈ°ûÁÖßÁâáË®≠ÂÆö„ÄçÂ∑•‰ΩúË°®ÔºåÂ∞á‰ΩøÁî®ÂïÜÂìÅÂúñÁâá');
    }
}

// ==========================================
// üÜï ËºâÂÖ•‰∏¶ÁîüÊàêÂàÜÈ°ûÊåâÈàïÔºàÂæû„ÄåÂàÜÈ°ûË®≠ÂÆö„ÄçÂ∑•‰ΩúË°®Ôºâ
// ==========================================
async function loadCategories() {
    try {
        // Âæû Google Sheets ËÆÄÂèñ„ÄåÂàÜÈ°ûË®≠ÂÆö„ÄçÂ∑•‰ΩúË°®
        const categoriesSheetName = 'ÂàÜÈ°ûË®≠ÂÆö';
        const categoriesUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${categoriesSheetName}?key=${API_KEY}`;
        
        categories = [];  // üî• ‰ΩøÁî®ÂÖ®ÂüüËÆäÊï∏
        
        try {
            const response = await fetch(categoriesUrl);
            if (response.ok) {
                const data = await response.json();
                if (data.values && data.values.length > 1) {
                    // ÂæûÂ∑•‰ΩúË°®ËÆÄÂèñÂàÜÈ°û
                    categories = data.values.slice(1).map(row => ({
                        name: row[0] || '',                    // AÊ¨ÑÔºöÂàÜÈ°ûÂêçÁ®±
                        order: parseInt(row[1]) || 999,        // BÊ¨ÑÔºöÊéíÂ∫èÈ†ÜÂ∫è
                        enabled: (row[2] || '').toString().toUpperCase() === 'TRUE'  // CÊ¨ÑÔºöÊòØÂê¶ÂïüÁî®ÔºàTRUE/FALSEÔºâ
                    }))
                    .filter(c => c.name && c.enabled)  // üî• Âè™‰øùÁïôÂ∑≤ÂïüÁî®ÁöÑÂàÜÈ°û
                    .filter(c => c.name !== 'ÂÖ®ÈÉ®')    // üî• ÊéíÈô§„ÄåÂÖ®ÈÉ®„ÄçÂàÜÈ°ûÔºàÂõ†ÁÇ∫ÊúÉËá™ÂãïÁîüÊàêÔºâ
                    .sort((a, b) => a.order - b.order);  // ‰æùÁÖßÈ†ÜÂ∫èÊéíÂ∫è
                    
                    console.log('‚úÖ Âæû„ÄåÂàÜÈ°ûË®≠ÂÆö„ÄçÂ∑•‰ΩúË°®ËºâÂÖ•ÂàÜÈ°ûÔºö', categories);
                }
            }
        } catch (err) {
            console.log('‚ö†Ô∏è Ê≤íÊúâÊâæÂà∞„ÄåÂàÜÈ°ûË®≠ÂÆö„ÄçÂ∑•‰ΩúË°®ÔºåÂ∞áÂæûÂïÜÂìÅË≥áÊñôËá™ÂãïÁîüÊàêÂàÜÈ°û');
        }
        
        // ÊñπÊ≥ï2ÔºöÂ¶ÇÊûúÊ≤íÊúâÂàÜÈ°ûË°®ÔºåÂ∞±ÂæûÂïÜÂìÅË≥áÊñôÁöÑ FÊ¨ÑÔºàtagsÔºâÊèêÂèñÂîØ‰∏ÄÂàÜÈ°û
        if (categories.length === 0) {
            const allTags = new Set();
            products.forEach(p => {
                if (p.tags && p.tags.length > 0) {
                    p.tags.forEach(tag => allTags.add(tag));
                }
            });
            
            categories = [...allTags].map((name, index) => ({
                name: name,
                order: index + 1,
                enabled: true
            }));
            
            console.log('‚úÖ ÂæûÂïÜÂìÅË≥áÊñôËá™ÂãïÁîüÊàêÂàÜÈ°ûÔºö', categories);
        }
        
        // ÁîüÊàêÂàÜÈ°ûÊåâÈàï
        const categoryTabs = document.getElementById('categoryTabs');
        
        // ‰øùÁïô„ÄåÂÖ®ÈÉ®„ÄçÊåâÈàïÔºåÊ∏ÖÈô§ÂÖ∂‰ªñÊåâÈàï
        categoryTabs.innerHTML = '<button class="category-tab active" onclick="filterCategory(\'all\')">ÂÖ®ÈÉ®</button>';
        
        // ÁîüÊàêÂÖ∂‰ªñÂàÜÈ°ûÊåâÈàï
        categories.forEach(category => {
            const button = document.createElement('button');
            button.className = 'category-tab';
            button.onclick = () => filterCategory(category.name);
            button.textContent = category.name;
            categoryTabs.appendChild(button);
        });
        
        console.log(`‚úÖ Â∑≤ËºâÂÖ• ${categories.length} ÂÄãÂïüÁî®ÁöÑÂàÜÈ°ûÊåâÈàï`);
        
    } catch (error) {
        console.error('‚ùå ËºâÂÖ•ÂàÜÈ°ûÊôÇÁôºÁîüÈåØË™§Ôºö', error);
    }
}

/**
 * Ê†πÊìöÂàÜÈ°ûÂêçÁ®±Ëá™ÂãïÈÖçÂ∞çÂúñÊ®ô
 */
function getCategoryIcon(categoryName) {
    const iconMap = {
        'PLOOMÁ≥ªÂàó': 'üî•',
        'PLOOM': 'üî•',
        'GLOÁ≥ªÂàó': '‚ú®',
        'GLO': '‚ú®',
        'Â¢ÉÂÖßÁ≥ªÂàó': 'üéØ',
        'Â¢ÉÂÖß': 'üéØ',
        'Ê©üÂ≠ê': 'üîß',
        'ÂÖ∂‰ªñÈÖç‰ª∂': '‚öôÔ∏è',
        'ÈÖç‰ª∂': '‚öôÔ∏è'
    };
    
    return iconMap[categoryName] || '';
}

// ==========================================
// ‰∏ªÊâìÂïÜÂìÅÈ°ØÁ§∫ + Ëá™ÂÆöÁæ©ÂçÄÂ°äÂç°Áâá
// ==========================================
function displayFeaturedProducts() {
    const featuredGrid = document.getElementById('featuredGrid');
    const featuredSection = document.getElementById('featuredSection');
    
    const featuredProducts = products.filter(p => p.isFeatured);
    
    // ÂèñÂæóÊâÄÊúâËá™ÂÆöÁæ©ÂçÄÂ°äÂêçÁ®±ÔºàÂéªÈáçÔºâ
    const customBlockNames = [...new Set(
        products.filter(p => p.customBlock).map(p => p.customBlock)
    )];
    
    // ‰∏ªÊâìÂíåËá™ÂÆöÁæ©ÈÉΩÊ≤íÊúâ ‚Üí Èö±ËóèÊï¥ÂÄãÂçÄÂ°ä
    if (featuredProducts.length === 0 && customBlockNames.length === 0) {
        featuredSection.style.display = 'none';
        return;
    }
    
    featuredSection.style.display = 'block';
    featuredGrid.innerHTML = '';
    
    // ‚îÄ‚îÄ ‰∏ªÊâìÂïÜÂìÅÂç°Áâá ‚îÄ‚îÄ
    if (featuredProducts.length > 0) {
        let totalStock = 0, minPrice = Infinity, maxPrice = 0;
        featuredProducts.forEach(product => {
            const specs = productSpecs[product.id];
            if (specs) specs.forEach(spec => {
                totalStock += spec.stock;
                if (spec.price < minPrice) minPrice = spec.price;
                if (spec.price > maxPrice) maxPrice = spec.price;
            });
        });
        
        let imageUrl = categoryImages['‰∏ªÊâìÂïÜÂìÅ'] || featuredProducts[0]?.image || '';
        if (imageUrl && !imageUrl.startsWith('http')) imageUrl = 'https://' + imageUrl;
        if (!imageUrl) imageUrl = '';
        
        const card = document.createElement('div');
        card.className = 'product-card';
        card.onclick = () => openFeaturedCategoryModal();
        const featuredHasSale = featuredProducts.some(p => productSpecs[p.id]?.some(s => s.originalPrice > 0));
        card.innerHTML = `
            <div class="featured-badge">‚≠ê ‰∏ªÊâìÊé®Ëñ¶</div>

            <div class="product-image">
                <img src="${imageUrl}" alt="‰∏ªÊâìÂïÜÂìÅ" onerror="this.style.display='none'">
            </div>
            <div class="product-name">‰∏ªÊâìÂïÜÂìÅ</div>
            <div class="product-price">$${minPrice}${minPrice !== maxPrice ? ` - $${maxPrice}` : ''}</div>
            <div class="product-stock">Â∫´Â≠ò:${totalStock} ‰ª∂</div>
            <button class="add-to-cart-btn" onclick="event.stopPropagation(); openFeaturedCategoryModal()">ÈÅ∏ÊìáË¶èÊ†º</button>
        `;
        featuredGrid.appendChild(card);
    }
    
    // ‚îÄ‚îÄ Ëá™ÂÆöÁæ©ÂçÄÂ°äÂç°ÁâáÔºàÊØèÂÄãÂçÄÂ°äÂêçÁ®±‰∏ÄÂºµÂç°Ôºâ‚îÄ‚îÄ
    customBlockNames.forEach(blockName => {
        const blockProducts = products.filter(p => p.customBlock === blockName);
        
        let totalStock = 0, minPrice = Infinity, maxPrice = 0;
        blockProducts.forEach(product => {
            const specs = productSpecs[product.id];
            if (specs) specs.forEach(spec => {
                totalStock += spec.stock;
                if (spec.price < minPrice) minPrice = spec.price;
                if (spec.price > maxPrice) maxPrice = spec.price;
            });
        });
        if (minPrice === Infinity) minPrice = 0;
        
        // ÂúñÁâáÂÑ™ÂÖàÁî®„ÄåÂàÜÈ°ûÁÖßÁâáË®≠ÂÆö„ÄçÔºåÂê¶ÂâáÁî®Á¨¨‰∏ÄÂÄãÂïÜÂìÅÁöÑÂúñÁâá
        let imageUrl = categoryImages[blockName] || blockProducts[0]?.image || '';
        if (imageUrl && !imageUrl.startsWith('http')) imageUrl = 'https://' + imageUrl;
        if (!imageUrl) imageUrl = '';
        
        const priceText = minPrice === maxPrice ? `$${minPrice}` : `$${minPrice} - $${maxPrice}`;
        
        const blockHasSale = blockProducts.some(p => productSpecs[p.id]?.some(s => s.originalPrice > 0));
        const card = document.createElement('div');
        card.className = 'product-card custom-block-card';
        card.onclick = () => openCustomBlockModal(blockName);
        card.innerHTML = `
            <div class="custom-block-badge">üéØ Á≤æÈÅ∏</div>

            <div class="product-image">
                <img src="${imageUrl}" alt="${blockName}" onerror="this.style.display='none'">
            </div>
            <div class="product-name">${blockName}</div>
            <div class="product-price">${priceText}</div>
            <div class="product-stock">Â∫´Â≠ò:${totalStock} ‰ª∂</div>
            <button class="add-to-cart-btn" onclick="event.stopPropagation(); openCustomBlockModal('${blockName}')">ÈÅ∏ÊìáË¶èÊ†º</button>
        `;
        featuredGrid.appendChild(card);
    });
}

// ==========================================
// üÜï Ëá™ÂÆöÁæ©ÂçÄÂ°äÔºöÈñãÂïüÂΩàÁ™óÔºàÁ¨¨‰∏ÄÂ±§ - ÈÅ∏Âè£Âë≥Ôºâ
// ÈÇèËºØËàá‰∏ªÊâìÂïÜÂìÅÂÆåÂÖ®‰∏ÄËá¥
// ==========================================
function openCustomBlockModal(blockName) {
    currentCategoryProducts = products.filter(p => p.customBlock === blockName);
    
    if (currentCategoryProducts.length === 0) {
        showToast('Ê≠§ÂçÄÂ°äÁõÆÂâçÁÑ°ÂïÜÂìÅ', 'error');
        return;
    }
    
    document.getElementById('specModalTitle').textContent = blockName;
    document.getElementById('specModal').classList.add('active');
    history.pushState({ modal: 'spec' }, '');
    isModalOpen = true;
    
    // üÜï ÂàùÂßãÂåñËº™Êí≠Âúñ
    window._currentModalCategoryName = blockName;
    initCarousel(blockName);
    
    // Ë®àÁÆóÁµ±Ë®à
    let totalStock = 0, minPrice = Infinity, maxPrice = 0;
    currentCategoryProducts.forEach(product => {
        const specs = productSpecs[product.id];
        if (specs) specs.forEach(spec => {
            totalStock += spec.stock;
            if (spec.price < minPrice) minPrice = spec.price;
            if (spec.price > maxPrice) maxPrice = spec.price;
        });
    });
    if (minPrice === Infinity) minPrice = 0;
    
    // Â∞èÂúñÂ∑≤ÁßªÈô§
    document.getElementById('specInfoPrice').textContent = minPrice === maxPrice ? `$${minPrice}` : `$${minPrice} - $${maxPrice}`;
    document.getElementById('specInfoStock').textContent = `Â∫´Â≠òÔºö${totalStock} ‰ª∂`;
    document.getElementById('specInfoStock').style.color = 'var(--accent-green)';
    
    // Ê∏≤ÊüìÂïÜÂìÅÂè£Âë≥ÈÅ∏È†ÖÔºàËàá‰∏ªÊâìÂïÜÂìÅÂÆåÂÖ®Áõ∏ÂêåÊ†ºÂºèÔºâ
    const optionsContainer = document.getElementById('specOptions');
    const flavorTitle = `<div class="spec-section-title" style="grid-column:1/-1;">üéØ ÈÅ∏ÊìáÂïÜÂìÅ (${currentCategoryProducts.length} Á®ÆÈÅ∏È†Ö)</div>`;
    const flavorOptions = currentCategoryProducts.map((product, index) => {
        const specs = productSpecs[product.id];
        const hasStock = specs && specs.some(s => s.stock > 0);
        const hasSale = specs && specs.some(s => s.originalPrice > 0);
        return `
            <div class="spec-option ${!hasStock ? 'out-of-stock' : ''}"
                 onclick="selectFlavor(${index})" id="flavor-${index}"
                 title="${product.name}${!hasStock ? ' - Â∑≤ÂîÆÂÆå' : ''}">
                <div class="spec-name">${product.name}${!hasStock ? ' ‚ùå' : ''}${hasSale ? '<span class="sale-badge">ÁâπÂÉπ‰∏≠</span>' : ''}</div>
            </div>`;
    }).join('');
    optionsContainer.innerHTML = flavorTitle + flavorOptions;
    
    selectedFlavor = null; selectedSpec = null; quantity = 1;
    updateQuantityDisplay(); updateAddToCartButton();
}

// ==========================================
// ‰∏ªÊâìÂïÜÂìÅÔºöÁ¨¨‰∏ÄÂ±§ - ÈÅ∏ÊìáÂïÜÂìÅÔºàÂè£Âë≥Ôºâ
// ==========================================
function openFeaturedCategoryModal() {
    // ÂèñÂæóÊâÄÊúâ‰∏ªÊâìÂïÜÂìÅ
    currentCategoryProducts = products.filter(p => p.isFeatured);
    
    if (currentCategoryProducts.length === 0) {
        showToast('ÁõÆÂâçÊ≤íÊúâ‰∏ªÊâìÂïÜÂìÅ', 'error');
        return;
    }
    
    // Ë®≠ÁΩÆÂΩàÁ™óÊ®ôÈ°åÁÇ∫„Äå‰∏ªÊâìÂïÜÂìÅ„Äç
    document.getElementById('specModalTitle').textContent = '‰∏ªÊâìÂïÜÂìÅ';
    document.getElementById('specModal').classList.add('active');
    
    // üî• Ê∑ªÂä†Ê≠∑Âè≤Ë®òÈåÑÔºåËÆìËøîÂõûÈçµÂèØ‰ª•ÈóúÈñâÂΩàÁ™ó
    history.pushState({ modal: 'spec' }, '');
    isModalOpen = true;
    
    // üÜï ÂàùÂßãÂåñËº™Êí≠ÂúñÔºà‰∏ªÊâìÂïÜÂìÅ‰ΩøÁî®„Äå‰∏ªÊâìÂïÜÂìÅ„ÄçÈÄôÂÄãÂàÜÈ°ûÂêçÁ®±Ôºâ
    window._currentModalCategoryName = '‰∏ªÊâìÂïÜÂìÅ';
    initCarousel('‰∏ªÊâìÂïÜÂìÅ');
    
    // Ê∏≤Êüì‰∏ªÊâìÂïÜÂìÅÈÅ∏È†Ö
    renderFeaturedFlavorOptions();
    
    // ÈáçÁΩÆÈÅ∏ÊìáÁãÄÊÖã
    selectedFlavor = null;
    selectedSpec = null;
    quantity = 1;
    updateQuantityDisplay();
    updateAddToCartButton();
}

function renderFeaturedFlavorOptions() {
    const optionsContainer = document.getElementById('specOptions');
    const imageContainer = null; // Â∞èÂúñÂ∑≤ÁßªÈô§
    const priceDisplay = document.getElementById('specInfoPrice');
    const stockDisplay = document.getElementById('specInfoStock');
    
    // Ë®àÁÆóÁ∏ΩÈ´î‰ø°ÊÅØ
    let totalStock = 0;
    let minPrice = Infinity;
    let maxPrice = 0;
    
    currentCategoryProducts.forEach(product => {
        const specs = productSpecs[product.id];
        if (specs && specs.length > 0) {
            specs.forEach(spec => {
                totalStock += spec.stock;
                if (spec.price < minPrice) minPrice = spec.price;
                if (spec.price > maxPrice) maxPrice = spec.price;
            });
        }
    });
    
    // Êõ¥Êñ∞ÂúñÁâáÔºà‰ΩøÁî®Á¨¨‰∏ÄÂÄãÂïÜÂìÅÁöÑÂúñÁâáÔºâ
    let imageUrl = currentCategoryProducts[0].image || '';
    if (imageUrl && !imageUrl.startsWith('http://') && !imageUrl.startsWith('https://')) {
        imageUrl = 'https://' + imageUrl;
    }
    if (!imageUrl) {
        imageUrl = '';
    }
    // Â∞èÂúñÂ∑≤ÁßªÈô§
    
    // Êõ¥Êñ∞ÂÉπÊ†ºÂíåÂ∫´Â≠ò
    priceDisplay.textContent = minPrice === maxPrice ? `$${minPrice}` : `$${minPrice} - $${maxPrice}`;
    stockDisplay.textContent = `Â∫´Â≠òÔºö${totalStock} ‰ª∂`;
    stockDisplay.style.color = 'var(--accent-green)';
    
    // ÁîüÊàêÂïÜÂìÅÈÅ∏È†ÖÔºà2ÂàóÁ∂≤Ê†ºÂ∏ÉÂ±ÄÔºâ
    const flavorTitle = `<div class="spec-section-title" style="grid-column: 1 / -1;">üéØ ÈÅ∏ÊìáÂïÜÂìÅ (${currentCategoryProducts.length} Á®ÆÈÅ∏È†Ö)</div>`;
    
    const flavorOptions = currentCategoryProducts.map((product, index) => {
        const specs = productSpecs[product.id];
        const hasStock = specs && specs.some(s => s.stock > 0);
        const isOutOfStock = !hasStock;
        const hasSale = specs && specs.some(s => s.originalPrice > 0);
        
        return `
            <div class="spec-option ${isOutOfStock ? 'out-of-stock' : ''}" 
                 onclick="selectFlavor(${index})"
                 id="flavor-${index}"
                 title="${product.name}${isOutOfStock ? ' - Â∑≤ÂîÆÂÆå' : ''}">
                <div class="spec-name">${product.name}${isOutOfStock ? ' ‚ùå' : ''}${hasSale ? '<span class="sale-badge">ÁâπÂÉπ‰∏≠</span>' : ''}</div>
            </div>
        `;
    }).join('');
    
    optionsContainer.innerHTML = flavorTitle + flavorOptions;
}

// ==========================================
// ÂïÜÂìÅÈ°ØÁ§∫ - È°ØÁ§∫È°ûÂà•Âç°Áâá
// ==========================================
function displayProducts() {
    const grid = document.getElementById('productsGrid');
    
    if (products.length === 0) {
        grid.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">Êö´ÁÑ°ÂïÜÂìÅ</p>';
        return;
    }
    
    // üî• Ê†πÊìöÁï∂ÂâçÂàÜÈ°ûÈÅéÊøæÂïÜÂìÅÔºà‰ΩøÁî® FÊ¨ÑÁöÑ tagsÔºâ
    const filteredProducts = currentCategory === 'all' 
        ? products 
        : products.filter(p => p.tags && p.tags.includes(currentCategory));
    
    if (filteredProducts.length === 0) {
        grid.innerHTML = '<p style="text-align:center;color:#999;padding:40px;">Ê≠§ÂàÜÈ°ûÊö´ÁÑ°ÂïÜÂìÅ</p>';
        return;
    }
    
    // ÊåâÈ°ûÂà•ÂàÜÁµÑÁµ±Ë®àÔºà‰ΩøÁî® EÊ¨ÑÁöÑ category ‰ΩúÁÇ∫Âè£Âë≥ÂàÜÈ°ûÔºâ
    const categoriesMap = {};
    filteredProducts.forEach(product => {
        const category = product.category || 'ÂÖ∂‰ªñ';
        if (!categoriesMap[category]) {
            categoriesMap[category] = {
                name: category,
                products: [],
                totalStock: 0,
                minPrice: Infinity,
                maxPrice: 0,
                image: ''
            };
        }
        
        const specs = productSpecs[product.id];
        if (specs && specs.length > 0) {
            categoriesMap[category].products.push(product);
            
            // Ë®àÁÆóÁ∏ΩÂ∫´Â≠òÂíåÂÉπÊ†ºÁØÑÂúç
            const totalStock = specs.reduce((sum, s) => sum + s.stock, 0);
            categoriesMap[category].totalStock += totalStock;
            
            const minPrice = Math.min(...specs.map(s => s.price));
            const maxPrice = Math.max(...specs.map(s => s.price));
            
            if (minPrice < categoriesMap[category].minPrice) {
                categoriesMap[category].minPrice = minPrice;
            }
            if (maxPrice > categoriesMap[category].maxPrice) {
                categoriesMap[category].maxPrice = maxPrice;
            }
            
            // üî• ÂÑ™ÂÖà‰ΩøÁî®„ÄåÂàÜÈ°ûÁÖßÁâáË®≠ÂÆö„ÄçÁöÑÂúñÁâáÔºåÂÖ∂Ê¨°‰ΩøÁî®Á¨¨‰∏ÄÂÄãÂïÜÂìÅÁöÑÂúñÁâá
            if (!categoriesMap[category].image) {
                // Âæû categoryImages Áâ©‰ª∂‰∏≠ÊâæÂà∞Â∞çÊáâÁöÑÂàÜÈ°ûÁÖßÁâá
                if (categoryImages[category]) {
                    categoriesMap[category].image = categoryImages[category];
                } else if (product.image) {
                    categoriesMap[category].image = product.image;
                }
            }
        }
    });
    
    // ÁîüÊàêÈ°ûÂà•Âç°Áâá
    const categories = Object.values(categoriesMap);
    
    grid.innerHTML = categories.map(category => {
        // ‰øÆÊ≠£ÂúñÁâáÁ∂≤ÂùÄ
        let imageUrl = category.image || '';
        if (imageUrl && !imageUrl.startsWith('http://') && !imageUrl.startsWith('https://')) {
            imageUrl = 'https://' + imageUrl;
        }
        if (!imageUrl) {
            imageUrl = '';
        }
        
        return `
            <div class="product-card" onclick="openCategoryModal('${category.name}')">
                <div class="product-image">
                    <img src="${imageUrl}" alt="${category.name}" onerror="this.style.display='none'">
                </div>
                <div class="product-name">${category.name}</div>
                <div class="product-price">$${category.minPrice}${category.minPrice !== category.maxPrice ? ` - $${category.maxPrice}` : ''}</div>
                <div class="product-stock">Â∫´Â≠ò:${category.totalStock} ‰ª∂</div>
                <button class="add-to-cart-btn" onclick="event.stopPropagation(); openCategoryModal('${category.name}')">
                    ÈÅ∏ÊìáË¶èÊ†º
                </button>
            </div>
        `;
    }).join('');
}

// ==========================================
// ÂïÜÂìÅÂàÜÈ°ûÈÅéÊøæ
// ==========================================
function filterCategory(category) {
    currentCategory = category;
    
    // Êõ¥Êñ∞Ê®ôÁ±§ÁãÄÊÖã
    document.querySelectorAll('.category-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // ÈáçÊñ∞Ê∏≤ÊüìÂïÜÂìÅ
    displayProducts();
    
    // ÊªæÂãïÂà∞ÂïÜÂìÅÂçÄÂüü
    document.getElementById('productsGrid').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// ==========================================
// Á¨¨‰∏ÄÂ±§ÔºöÈ°ûÂà•ÈÅ∏ÊìáÂΩàÁ™ó
// ==========================================
let currentCategoryProducts = []; // Áï∂ÂâçÈ°ûÂà•ÁöÑÊâÄÊúâÂïÜÂìÅ
let selectedFlavor = null; // ÈÅ∏‰∏≠ÁöÑÂè£Âë≥ÔºàÂïÜÂìÅÔºâ

function openCategoryModal(categoryName) {
    // Áç≤ÂèñË©≤È°ûÂà•‰∏ãÁöÑÊâÄÊúâÂïÜÂìÅÔºàÂè£Âë≥Ôºâ
    currentCategoryProducts = products.filter(p => p.category === categoryName);
    
    if (currentCategoryProducts.length === 0) {
        showToast('Ê≠§È°ûÂà•Êö´ÁÑ°ÂïÜÂìÅ', 'error');
        return;
    }
    
    // Ë®≠ÁΩÆÂΩàÁ™óÊ®ôÈ°å
    document.getElementById('specModalTitle').textContent = categoryName;
    document.getElementById('specModal').classList.add('active');
    
    // üî• Ê∑ªÂä†Ê≠∑Âè≤Ë®òÈåÑÔºåËÆìËøîÂõûÈçµÂèØ‰ª•ÈóúÈñâÂΩàÁ™ó
    history.pushState({ modal: 'spec' }, '');
    isModalOpen = true;
    
    // üÜï ÂàùÂßãÂåñËº™Êí≠ÂúñÔºàÂæûÂàÜÈ°ûÁÖßÁâáË®≠ÂÆöÁöÑ C Ê¨ÑËµ∑Ôºâ
    window._currentModalCategoryName = categoryName;
    initCarousel(categoryName);
    
    // Ê∏≤ÊüìË©≤È°ûÂà•‰∏ãÁöÑÊâÄÊúâÂè£Âë≥ÈÅ∏È†Ö
    renderFlavorOptions(categoryName);
    
    // ÈáçÁΩÆÈÅ∏ÊìáÁãÄÊÖã
    selectedFlavor = null;
    selectedSpec = null;
    quantity = 1;
    updateQuantityDisplay();
    updateAddToCartButton();
}

function renderFlavorOptions(categoryName) {
    const optionsContainer = document.getElementById('specOptions');
    const imageContainer = null; // Â∞èÂúñÂ∑≤ÁßªÈô§
    const priceDisplay = document.getElementById('specInfoPrice');
    const stockDisplay = document.getElementById('specInfoStock');
    
    // Ë®àÁÆóË©≤È°ûÂà•ÁöÑÁ∏ΩÈ´î‰ø°ÊÅØ
    let totalStock = 0;
    let minPrice = Infinity;
    let maxPrice = 0;
    
    currentCategoryProducts.forEach(product => {
        const specs = productSpecs[product.id];
        if (specs && specs.length > 0) {
            specs.forEach(spec => {
                totalStock += spec.stock;
                if (spec.price < minPrice) minPrice = spec.price;
                if (spec.price > maxPrice) maxPrice = spec.price;
            });
        }
    });
    
    // Êõ¥Êñ∞ÂúñÁâáÔºà‰ΩøÁî®Á¨¨‰∏ÄÂÄãÂïÜÂìÅÁöÑÂúñÁâáÔºâ
    let imageUrl = currentCategoryProducts[0].image || '';
    if (imageUrl && !imageUrl.startsWith('http://') && !imageUrl.startsWith('https://')) {
        imageUrl = 'https://' + imageUrl;
    }
    if (!imageUrl) {
        imageUrl = '';
    }
    // Â∞èÂúñÂ∑≤ÁßªÈô§
    
    // Êõ¥Êñ∞ÂÉπÊ†ºÂíåÂ∫´Â≠ò
    priceDisplay.textContent = minPrice === maxPrice ? `$${minPrice}` : `$${minPrice} - $${maxPrice}`;
    stockDisplay.textContent = `Â∫´Â≠òÔºö${totalStock} ‰ª∂`;
    stockDisplay.style.color = 'var(--accent-green)';
    
    // ÁîüÊàêÂè£Âë≥ÈÅ∏È†ÖÔºà2ÂàóÁ∂≤Ê†ºÂ∏ÉÂ±ÄÔºâ
    const flavorTitle = `<div class="spec-section-title" style="grid-column: 1 / -1;">üéØ ÈÅ∏ÊìáÂè£Âë≥ (${currentCategoryProducts.length} Á®ÆÈÅ∏È†Ö)</div>`;
    
    const flavorOptions = currentCategoryProducts.map((product, index) => {
        const specs = productSpecs[product.id];
        const hasStock = specs && specs.some(s => s.stock > 0);
        const isOutOfStock = !hasStock;
        const hasSale = specs && specs.some(s => s.originalPrice > 0);
        
        return `
            <div class="spec-option ${isOutOfStock ? 'out-of-stock' : ''}" 
                 onclick="selectFlavor(${index})"
                 id="flavor-${index}"
                 title="${product.name}${isOutOfStock ? ' - Â∑≤ÂîÆÂÆå' : ''}">
                <div class="spec-name">${product.name}${isOutOfStock ? ' ‚ùå' : ''}${hasSale ? '<span class="sale-badge">ÁâπÂÉπ‰∏≠</span>' : ''}</div>
            </div>
        `;
    }).join('');
    
    optionsContainer.innerHTML = flavorTitle + flavorOptions;
}

// ==========================================
// Á¨¨‰∫åÂ±§ÔºöÈÅ∏ÊìáÂè£Âë≥ÂæåÈ°ØÁ§∫Êï∏ÈáèË¶èÊ†ºÈÅ∏È†Ö
// ==========================================
function selectFlavor(index) {
    const product = currentCategoryProducts[index];
    const specs = productSpecs[product.id];
    
    if (!specs || specs.length === 0) {
        showToast('Ê≠§Âè£Âë≥Êö´ÁÑ°Ë¶èÊ†º', 'error');
        return;
    }
    
    // Ê™¢Êü•ÊòØÂê¶ÊúâÂ∫´Â≠ò
    const hasStock = specs.some(s => s.stock > 0);
    if (!hasStock) {
        showToast('Ê≠§Âè£Âë≥Â∑≤ÂîÆÂÆå', 'error');
        return;
    }
    
    selectedFlavor = product;
    
    // Êõ¥Êñ∞Âè£Âë≥ÈÅ∏È†ÖÁöÑÈÅ∏‰∏≠ÁãÄÊÖã
    document.querySelectorAll('[id^="flavor-"]').forEach((el, i) => {
        el.classList.toggle('selected', i === index);
    });
    
    // üÜï ÈªûÈÅ∏Âè£Âë≥ÊôÇÔºöÈáçÊñ∞ÁµÑÂêàËº™Êí≠ÔºàÂïÜÂìÅÂúñÂÑ™ÂÖà + ÂàÜÈ°ûËº™Êí≠ÂúñÊé•ÂæåÔºâ
    {
        const categoryName = window._currentModalCategoryName || '';
        const carouselBase = categoryCarouselImages[categoryName] || [];
        const seen = new Set();
        const merged = [];

        // 1. ÂÖàÂä†ÈÄôÂÄãÂè£Âë≥ÁöÑÂïÜÂìÅÂúñ
        let productImg = product.image || '';
        if (productImg && !productImg.startsWith('http')) productImg = 'https://' + productImg;
        if (productImg && !seen.has(productImg)) { seen.add(productImg); merged.push(productImg); }

        // 2. ÂÜçÂä† C Ê¨ÑËµ∑ÁöÑÂàÜÈ°ûËº™Êí≠Âúñ
        carouselBase.forEach(u => { if (!seen.has(u)) { seen.add(u); merged.push(u); } });

        // 3. Ëã•ÂÆåÂÖ®Ê≤íÂúñÔºåfallback Âà∞ B Ê¨ÑÂç°ÁâáÂúñ
        if (merged.length === 0) {
            const coverImg = categoryImages[categoryName] || '';
            if (coverImg) merged.push(coverImg);
        }

        if (merged.length > 0) initCarouselFromUrls(merged);
    }
    
    // È°ØÁ§∫Ë©≤Âè£Âë≥ÁöÑÊï∏ÈáèË¶èÊ†ºÈÅ∏È†ÖÔºàÂñÆÂåÖ„ÄÅ10ÂåÖÁµÑÂêàÁ≠âÔºâ
    renderQuantitySpecOptions(specs);
    
    // üî• Ëá™ÂãïÈ†êÈÅ∏„ÄåÂñÆÂåÖ„ÄçË¶èÊ†º
    // Â∞ãÊâæË¶èÊ†ºÂêçÁ®±ÂåÖÂê´„ÄåÂñÆÂåÖ„ÄçÁöÑÈÅ∏È†ÖÔºåÊàñËÄÖÁ¨¨‰∏ÄÂÄãÊúâÂ∫´Â≠òÁöÑË¶èÊ†º
    let autoSelectIndex = -1;
    
    // ÂÑ™ÂÖàÂ∞ãÊâæÂêçÁ®±ÂåÖÂê´„ÄåÂñÆÂåÖ„ÄçÁöÑË¶èÊ†º
    autoSelectIndex = specs.findIndex(s => 
        s.specName.includes('ÂñÆÂåÖ') && s.stock > 0
    );
    
    // Â¶ÇÊûúÊ≤íÊúâÊâæÂà∞ÔºåÂâáÈÅ∏ÊìáÁ¨¨‰∏ÄÂÄãÊúâÂ∫´Â≠òÁöÑË¶èÊ†º
    if (autoSelectIndex === -1) {
        autoSelectIndex = specs.findIndex(s => s.stock > 0);
    }
    
    // Ëá™ÂãïÈÅ∏ÊìáË¶èÊ†º
    if (autoSelectIndex !== -1) {
        setTimeout(() => {
            selectQuantitySpec(autoSelectIndex);
        }, 100); // Âª∂ÈÅ≤‰∏ÄÈªûÈªûÔºåÁ¢∫‰øù DOM Â∑≤Ê∏≤Êüì
    }
}

function renderQuantitySpecOptions(specs) {
    const optionsContainer = document.getElementById('specOptions');
    
    // ‰øùÁïôÂè£Âë≥ÈÅ∏È†ÖÔºåÂú®‰∏ãÊñπÊ∑ªÂä†Êï∏ÈáèË¶èÊ†ºÈÅ∏È†Ö
    const currentFlavorOptions = Array.from(document.querySelectorAll('[id^="flavor-"]')).map(el => el.outerHTML).join('');
    const flavorTitle = `<div class="spec-section-title" style="grid-column: 1 / -1;">üéØ ÈÅ∏ÊìáÂè£Âë≥ (${currentCategoryProducts.length} Á®ÆÈÅ∏È†Ö)</div>`;
    
    // Ê∑ªÂä†Êï∏ÈáèË¶èÊ†ºÈÅ∏È†ÖÊ®ôÈ°å
    const quantityTitle = `<div class="spec-section-title" style="grid-column: 1 / -1; margin-top: 20px;">üì¶ ÈÅ∏ÊìáÈ†ÖÁõÆ</div>`;
    
    const quantityOptions = specs.map((spec, index) => {
        const isOutOfStock = spec.stock === 0;
        
        return `
            <div class="spec-option ${isOutOfStock ? 'out-of-stock' : ''}" 
                 onclick="selectQuantitySpec(${index})"
                 id="qty-spec-${index}"
                 title="${spec.specName}${isOutOfStock ? ' - Â∑≤ÂîÆÂÆå' : ''}">
                <div class="spec-name">${spec.specName}${isOutOfStock ? ' ‚ùå' : ''}</div>
            </div>
        `;
    }).join('');
    
    optionsContainer.innerHTML = flavorTitle + currentFlavorOptions + quantityTitle + quantityOptions;
    
    // ÈáçÊñ∞Á∂ÅÂÆöÂè£Âë≥ÈÅ∏È†ÖÁöÑÈªûÊìä‰∫ã‰ª∂
    currentCategoryProducts.forEach((_, index) => {
        const flavorOption = document.getElementById(`flavor-${index}`);
        if (flavorOption) {
            flavorOption.onclick = () => selectFlavor(index);
            // ‰øùÊåÅÁï∂ÂâçÈÅ∏‰∏≠ÁãÄÊÖã
            if (selectedFlavor && currentCategoryProducts[index].id === selectedFlavor.id) {
                flavorOption.classList.add('selected');
            }
        }
    });
    
    // ÂÑ≤Â≠òÁï∂ÂâçË¶èÊ†ºÂà∞ÂÖ®ÂüüËÆäÊï∏
    window.currentQuantitySpecs = specs;
}

// ==========================================
// Á¨¨‰∏âÂ±§ÔºöÈÅ∏ÊìáÊï∏ÈáèË¶èÊ†ºÔºàÂñÆÂåÖÊàñ10ÂåÖÁµÑÂêàÔºâ
// ==========================================
function selectQuantitySpec(index) {
    const specs = window.currentQuantitySpecs;
    const spec = specs[index];
    
    if (spec.stock === 0) {
        showToast('Ê≠§Ë¶èÊ†ºÂ∑≤ÂîÆÂÆå', 'error');
        return;
    }
    
    selectedSpec = {
        ...spec,
        productId: selectedFlavor.id,
        productName: selectedFlavor.name,
        productImage: selectedFlavor.image
    };
    
    // Êõ¥Êñ∞ÈÅ∏‰∏≠ÁãÄÊÖã
    document.querySelectorAll('[id^="qty-spec-"]').forEach((el, i) => {
        el.classList.toggle('selected', i === index);
    });
    
    // Êõ¥Êñ∞ÂÉπÊ†ºÂíåÂ∫´Â≠òÈ°ØÁ§∫
    renderSpecPrice(spec);
    
    const stockDisplay = document.getElementById('specInfoStock');
    const multiplier = spec.quantityMultiplier || 1;
    const actualStock = spec.stock;
    
    let stockText = '';
    if (multiplier > 1) {
        const availableUnits = Math.floor(actualStock / multiplier);
        stockText = `Â∫´Â≠òÔºö${actualStock} ÂÄã (ÂèØÂîÆ ${availableUnits} ÁµÑ)`;
    } else {
        stockText = `Â∫´Â≠òÔºö${actualStock} ‰ª∂`;
    }
    
    const isLowStock = actualStock > 0 && actualStock <= 10;
    stockDisplay.textContent = stockText + (isLowStock ? ' ‚ö†Ô∏è Âç≥Â∞áÂîÆÂÆå' : '');
    stockDisplay.style.color = isLowStock ? '#ff9900' : 'var(--accent-green)';
    
    // ÈáçÁΩÆÊï∏Èáè
    quantity = 1;
    updateQuantityDisplay();
    updateAddToCartButton();
}

// ==========================================
// üî• ÁÄèË¶ΩÂô®ËøîÂõûÈçµËôïÁêÜ - ÈóúÈñâÂΩàÁ™óÂõûÂà∞‰∏ªÈ†Å
// ==========================================
let isModalOpen = false;

// Áõ£ËÅΩÁÄèË¶ΩÂô®ËøîÂõûÈçµ
window.addEventListener('popstate', function(event) {
    // Ê™¢Êü•ÊòØÂê¶Êúâ‰ªª‰ΩïÂΩàÁ™óÈñãÂïü
    const specModal = document.getElementById('specModal');
    const cartSidebar = document.getElementById('cartSidebar');
    const checkoutModal = document.getElementById('checkoutModal');
    const orderSearchModal = document.getElementById('orderSearchModal');
    const profileUpdateModal = document.getElementById('profileUpdateModal');
    
    // ‰æùÂ∫èÊ™¢Êü•‰∏¶ÈóúÈñâÈñãÂïüÁöÑÂΩàÁ™ó
    const orderDetailView = document.getElementById('orderDetailView');
    if (orderDetailView) {
        // ÂÑ™ÂÖàÈóúÈñâË®ÇÂñÆË©≥ÊÉÖÂÖ®Ëû¢ÂπïÈ†Å
        closeOrderDetail();
        isModalOpen = false;
    } else if (specModal && specModal.classList.contains('active')) {
        closeSpecModal();
        isModalOpen = false;
    } else if (cartSidebar && cartSidebar.classList.contains('active')) {
        toggleCart();
        isModalOpen = false;
    } else if (checkoutModal && checkoutModal.classList.contains('active')) {
        closeCheckout();
        isModalOpen = false;
    } else if (orderSearchModal && orderSearchModal.classList.contains('active')) {
        closeOrderSearch();
        isModalOpen = false;
    } else if (profileUpdateModal && profileUpdateModal.classList.contains('active')) {
        closeProfileUpdateModal();
        isModalOpen = false;
    } else {
        // Â¶ÇÊûúÊ≤íÊúâÂΩàÁ™óÈñãÂïüÔºåÈòªÊ≠¢ËøîÂõûÔºàÂÅúÁïôÂú®‰∏ªÈ†ÅÔºâ
        history.pushState(null, '', location.href);
    }
});

// È†ÅÈù¢ËºâÂÖ•ÊôÇÔºåË®≠ÁΩÆÂàùÂßãÁãÄÊÖãÔºåÈò≤Ê≠¢ËøîÂõûË∑≥Âá∫Á∂≤Á´ô
window.addEventListener('load', function() {
    history.pushState(null, '', location.href);
});

// ==========================================
// Ë¶èÊ†ºÈÅ∏ÊìáÂΩàÁ™óÔºà‰øùÁïôÂéüÊúâÂäüËÉΩÔºâ
// ==========================================
function openSpecModal(productId) {
    currentProduct = products.find(p => p.id === productId);
    if (!currentProduct) return;

    const specs = productSpecs[productId];
    if (!specs || specs.length === 0) {
        showToast('Ê≠§ÂïÜÂìÅÊö´ÁÑ°Ë¶èÊ†º', 'error');
        return;
    }

    document.getElementById('specModalTitle').textContent = currentProduct.name;
    document.getElementById('specModal').classList.add('active');
    
    // üî• Ê∑ªÂä†Ê≠∑Âè≤Ë®òÈåÑÔºåËÆìËøîÂõûÈçµÂèØ‰ª•ÈóúÈñâÂΩàÁ™ó
    history.pushState({ modal: 'spec' }, '');
    isModalOpen = true;
    
    renderSpecOptions();
    quantity = 1;
    selectedSpec = null;
    updateQuantityDisplay();
    updateAddToCartButton();
}


// ==========================================
// üÜï ÂïÜÂìÅÂúñÁâáËº™Êí≠ÂäüËÉΩ
// ==========================================
let _carouselImgs = [];
let _carouselIdx = 0;
let _carouselTouchX = 0;

/**
 * ‰ª•ÂàÜÈ°ûÂêçÁ®±ÂàùÂßãÂåñËº™Êí≠ÔºàÂæû categoryCarouselImages Âèñ C Ê¨ÑËµ∑ÁöÑÂúñÔºâ
 */
function initCarousel(categoryName) {
    // ÂÑ™ÂÖàÁî® C Ê¨ÑËµ∑ÁöÑËº™Êí≠ÂúñÔºà‰ΩøÁî®ËÄÖÊâãÂãïË®≠ÂÆöÔºâ
    let imgs = categoryCarouselImages[categoryName] || [];

    // ‚îÄ‚îÄ FallbackÔºöËã• C Ê¨ÑÊ≤íÂ°´ÔºåÂ∞±Êî∂ÈõÜË©≤ÂàÜÈ°ûÊâÄÊúâÂïÜÂìÅÁöÑÂúñÁâá ‚îÄ‚îÄ
    if (imgs.length === 0) {
        const seen = new Set();
        const fallbackImgs = [];

        // ÂÖàÂä† B Ê¨ÑÔºàÂç°ÁâáÂ∞ÅÈù¢ÂúñÔºâ
        const coverImg = categoryImages[categoryName] || '';
        if (coverImg && !seen.has(coverImg)) {
            seen.add(coverImg);
            fallbackImgs.push(coverImg);
        }

        // ÂÜçÂä†ÊØèÂÄãÂïÜÂìÅËá™Â∑±ÁöÑÂúñÁâá
        currentCategoryProducts.forEach(p => {
            if (p.image && !seen.has(p.image)) {
                seen.add(p.image);
                fallbackImgs.push(p.image);
            }
        });

        imgs = fallbackImgs;
    }

    initCarouselFromUrls(imgs);
}

/**
 * ‰ª•ÂúñÁâáÁ∂≤ÂùÄÈô£ÂàóÂàùÂßãÂåñËº™Êí≠
 */
function initCarouselFromUrls(rawUrls) {
    const carousel  = document.getElementById('productCarousel');
    const track     = document.getElementById('carouselTrack');
    const dots      = document.getElementById('carouselDots');
    const prev      = document.getElementById('carouselPrev');
    const next      = document.getElementById('carouselNext');

    // ‰øÆÊ≠£ URLÔºàÁ¢∫‰øùÊúâ https://Ôºâ
    _carouselImgs = rawUrls.map(u => {
        u = (u || '').trim();
        if (!u) return '';
        if (!u.startsWith('http://') && !u.startsWith('https://')) return 'https://' + u;
        return u;
    }).filter(u => u);

    if (_carouselImgs.length === 0) {
        carousel.style.display = 'none';
        return;
    }

    carousel.style.display = 'block';
    _carouselIdx = 0;

    // Ê∏≤ÊüìÂπªÁáàÁâá
    track.innerHTML = _carouselImgs.map((url, i) => `
        <div class="carousel-slide">
            <img src="${url}" alt="ÂïÜÂìÅÂúñ ${i + 1}" onerror="this.style.opacity='0.15'">
        </div>
    `).join('');

    // Ê∏≤ÊüìÂúìÈªû
    dots.innerHTML = _carouselImgs.map((_, i) => `
        <div class="carousel-dot${i === 0 ? ' active' : ''}" onclick="carouselGoTo(${i})"></div>
    `).join('');

    // È°ØÁ§∫ / Èö±ËóèÁÆ≠È†≠ËàáÂúìÈªû
    const multi = _carouselImgs.length > 1;
    prev.style.display  = multi ? 'flex' : 'none';
    next.style.display  = multi ? 'flex' : 'none';
    dots.style.display  = multi ? 'flex' : 'none';

    // Êõ¥Êñ∞ËßíÊ®ôÔºàÂä†Âú® wrap Ë£°ÔºåÈÄôÊ®£ absolute ÂÆö‰ΩçÁõ∏Â∞çÊñº wrapÔºâ
    const wrap2 = carousel.querySelector('.carousel-track-wrap');
    let counter = carousel.querySelector('.carousel-counter');
    if (!counter) {
        counter = document.createElement('div');
        counter.className = 'carousel-counter';
        (wrap2 || carousel).appendChild(counter);
    }
    counter.style.display = multi ? 'block' : 'none';
    counter.textContent = `1 / ${_carouselImgs.length}`;

    // Ëß∏ÊéßÊªëÂãï
    const wrap = carousel.querySelector('.carousel-track-wrap');
    wrap.ontouchstart = e => { _carouselTouchX = e.touches[0].clientX; };
    wrap.ontouchend   = e => {
        const diff = _carouselTouchX - e.changedTouches[0].clientX;
        if (Math.abs(diff) > 35) carouselMove(diff > 0 ? 1 : -1);
    };

    _carouselRender();
}

function carouselMove(dir) {
    if (!_carouselImgs.length) return;
    _carouselIdx = (_carouselIdx + dir + _carouselImgs.length) % _carouselImgs.length;
    _carouselRender();
}

function carouselGoTo(i) {
    _carouselIdx = i;
    _carouselRender();
}

function _carouselRender() {
    const track = document.getElementById('carouselTrack');
    const dots  = document.querySelectorAll('.carousel-dot');
    const counter = document.querySelector('.carousel-counter');
    if (track) {
        // Áî®ÂÉèÁ¥†ÂÅèÁßªÁ¢∫‰øùÁ≤æÁ¢∫Ôºà‰∏ç‰æùË≥¥ÁôæÂàÜÊØîÁπºÊâøÂïèÈ°åÔºâ
        const slideWidth = track.parentElement ? track.parentElement.offsetWidth : 0;
        if (slideWidth > 0) {
            track.style.transform = `translateX(-${_carouselIdx * slideWidth}px)`;
        } else {
            track.style.transform = `translateX(-${_carouselIdx * 100}%)`;
        }
    }
    dots.forEach((d, i) => d.classList.toggle('active', i === _carouselIdx));
    if (counter) counter.textContent = `${_carouselIdx + 1} / ${_carouselImgs.length}`;
}

function closeSpecModal() {
    document.getElementById('specModal').classList.remove('active');
    currentProduct = null;
    selectedSpec = null;
    selectedFlavor = null;
    currentCategoryProducts = [];
    quantity = 1;
}

function renderSpecOptions() {
    const specs = productSpecs[currentProduct.id];
    const optionsContainer = document.getElementById('specOptions');
    
    const specTitle = `<div class="spec-section-title" style="grid-column: 1 / -1;">üì¶ ÈÅ∏ÊìáË¶èÊ†º (${specs.length} Á®ÆÈÅ∏È†Ö)</div>`;
    
    const specOptions = specs.map((spec, index) => {
        const isOutOfStock = spec.stock === 0;
        
        return `
            <div class="spec-option ${isOutOfStock ? 'out-of-stock' : ''}" 
                 onclick="selectSpec(${index})"
                 id="spec-${index}"
                 title="${spec.specName}${isOutOfStock ? ' - Â∑≤ÂîÆÂÆå' : ''}">
                <div class="spec-name">${spec.specName}${isOutOfStock ? ' ‚ùå' : ''}</div>
            </div>
        `;
    }).join('');
    
    optionsContainer.innerHTML = specTitle + specOptions;
}

function selectSpec(index) {
    const specs = productSpecs[currentProduct.id];
    const spec = specs[index];
    
    if (spec.stock === 0) {
        showToast('Ê≠§Ë¶èÊ†ºÂ∑≤ÂîÆÂÆå', 'error');
        return;
    }

    selectedSpec = spec;
    
    // Êõ¥Êñ∞ÈÅ∏‰∏≠ÁãÄÊÖã
    document.querySelectorAll('.spec-option').forEach((el, i) => {
        el.classList.toggle('selected', i === index);
    });
    
    // Êõ¥Êñ∞ÂúñÁâá
    const imageContainer = null; // Â∞èÂúñÂ∑≤ÁßªÈô§
    let imageUrl = spec.image || currentProduct.image || '';
    
    // Ëá™ÂãïË£ú‰∏ä https://
    if (imageUrl && !imageUrl.startsWith('http://') && !imageUrl.startsWith('https://')) {
        imageUrl = 'https://' + imageUrl;
    }
    if (!imageUrl) {
        imageUrl = '';
    }
    
    // Â∞èÂúñÂ∑≤ÁßªÈô§
    
    // Êõ¥Êñ∞ÂÉπÊ†ºÂíåÂ∫´Â≠òÈ°ØÁ§∫
    renderSpecPrice(spec);
    
    const stockDisplay = document.getElementById('specInfoStock');
    const multiplier = spec.quantityMultiplier || 1;
    const actualStock = spec.stock;
    
    // Â¶ÇÊûúÊúâÂÄçÊï∏ÔºåÈ°ØÁ§∫ÂØ¶ÈöõÊï∏Èáè
    let stockText = '';
    if (multiplier > 1) {
        const availableUnits = Math.floor(actualStock / multiplier);  // ÂèØÂîÆÁµÑÊï∏
        stockText = `Â∫´Â≠òÔºö${actualStock} ÂÄã (ÂèØÂîÆ ${availableUnits} ÁµÑ)`;
    } else {
        stockText = `Â∫´Â≠òÔºö${actualStock} ‰ª∂`;
    }
    
    const isLowStock = actualStock > 0 && actualStock <= 10;
    stockDisplay.textContent = stockText + (isLowStock ? ' ‚ö†Ô∏è Âç≥Â∞áÂîÆÂÆå' : '');
    stockDisplay.style.color = isLowStock ? '#ff9900' : 'var(--accent-green)';
    
    // ÈáçÁΩÆÊï∏Èáè
    quantity = 1;
    updateQuantityDisplay();
    updateAddToCartButton();
}

function changeQuantity(change) {
    if (!selectedSpec) {
        showToast('Ë´ãÂÖàÈÅ∏ÊìáË¶èÊ†º', 'error');
        return;
    }

    const newQty = quantity + change;
    
    if (newQty < 1) {
        showToast('Êï∏Èáè‰∏çÂèØÂ∞èÊñº 1', 'error');
        return;
    }
    
    if (newQty > selectedSpec.stock) {
        showToast('Â∑≤ÈÅîÂ∫´Â≠ò‰∏äÈôê', 'error');
        return;
    }

    quantity = newQty;
    updateQuantityDisplay();
}

function updateQuantityDisplay() {
    document.getElementById('quantityDisplay').textContent = quantity;
}

function updateAddToCartButton() {
    const btn = document.getElementById('addToCartModalBtn');
    btn.disabled = !selectedSpec;
}

function confirmAddToCart() {
    if (!selectedSpec) {
        showToast('Ë´ãÈÅ∏ÊìáË¶èÊ†º', 'error');
        return;
    }

    // ÂèñÂæóÊï∏ÈáèÂÄçÊï∏
    const multiplier = selectedSpec.quantityMultiplier || 1;
    const actualStock = selectedSpec.stock;
    
    // ‰ΩøÁî® selectedSpec ‰∏≠ÁöÑ productId Âíå productNameÔºàÂæû‰∏âÂ±§ÈÅ∏Êìá‰∏≠Ë®≠ÁΩÆÔºâ
    const actualProductId = selectedSpec.productId || (currentProduct ? currentProduct.id : null);
    const actualProductName = selectedSpec.productName || (currentProduct ? currentProduct.name : '');
    
    if (!actualProductId) {
        showToast('ÂïÜÂìÅË≥áË®äÈåØË™§', 'error');
        return;
    }
    
    // Ê™¢Êü•Ë≥ºÁâ©Ëªä‰∏≠ÊòØÂê¶Â∑≤ÊúâÁõ∏ÂêåÂïÜÂìÅ+Ë¶èÊ†º
    const existingIndex = cart.findIndex(item => 
        item.productId === actualProductId && item.specName === selectedSpec.specName
    );

    if (existingIndex !== -1) {
        // Êõ¥Êñ∞Êï∏Èáè
        const newQty = cart[existingIndex].quantity + quantity;
        const totalUnits = newQty * multiplier;  // ÂØ¶Èöõ‰ΩîÁî®Â∫´Â≠ò
        
        if (totalUnits > actualStock) {
            showToast('Â∑≤ÈÅîÂ∫´Â≠ò‰∏äÈôê', 'error');
            return;
        }
        cart[existingIndex].quantity = newQty;
    } else {
        // Ê™¢Êü•Â∫´Â≠ò
        const totalUnits = quantity * multiplier;
        if (totalUnits > actualStock) {
            showToast('Â∫´Â≠ò‰∏çË∂≥', 'error');
            return;
        }
        
        // Êñ∞Â¢ûÈ†ÖÁõÆ
        cart.push({
            productId: actualProductId,
            productName: actualProductName,
            specName: selectedSpec.specName,
            price: selectedSpec.price,
            quantity: quantity,
            quantityMultiplier: multiplier,  // ÂÑ≤Â≠òÂÄçÊï∏
            image: selectedSpec.productImage || selectedSpec.image || (currentProduct ? currentProduct.image : '')
        });
    }
    
    updateCart();
    
    // È°ØÁ§∫ÊèêÁ§∫Ë®äÊÅØÔºàÂ¶ÇÊûúÊúâÂÄçÊï∏ÔºåÈ°ØÁ§∫ÂØ¶ÈöõÊï∏ÈáèÔºâ
    const displayMsg = multiplier > 1 
        ? `‚úÖ Â∑≤Âä†ÂÖ• ${quantity} ÁµÑ„Äå${actualProductName} - ${selectedSpec.specName}„Äç(ÂÖ± ${quantity * multiplier} ÂÄã)Âà∞Ë≥ºÁâ©Ëªä!`
        : `‚úÖ Â∑≤Âä†ÂÖ• ${quantity} ‰ª∂„Äå${actualProductName} - ${selectedSpec.specName}„ÄçÂà∞Ë≥ºÁâ©Ëªä!`;
    showToast(displayMsg);
    
    // ÈáçÁΩÆÈÅ∏ÊìáÁãÄÊÖã,ËÆì‰ΩøÁî®ËÄÖÂèØ‰ª•ÁπºÁ∫åÈÅ∏Ë≥ºÂÖ∂‰ªñË¶èÊ†º
    quantity = 1;
    selectedSpec = null;
    selectedFlavor = null;
    updateQuantityDisplay();
    updateAddToCartButton();
    
    // ÁßªÈô§ÊâÄÊúâË¶èÊ†ºÁöÑÈÅ∏‰∏≠ÁãÄÊÖã
    document.querySelectorAll('.spec-option.selected').forEach(el => {
        el.classList.remove('selected');
    });
    
    const cartIcon = document.querySelector('.cart-float');
    if (cartIcon) {
        cartIcon.classList.add('animate-pulse');
        setTimeout(() => cartIcon.classList.remove('animate-pulse'), 500);
    }
}

// ==========================================
// Ë≥ºÁâ©ËªäÂäüËÉΩ
// ==========================================
function updateCart() {
    const cartItems = document.getElementById('cartItems');
    const cartBadge = document.getElementById('cartBadge');
    const cartTotal = document.getElementById('cartTotal');

    const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
    cartBadge.textContent = totalItems;

    if (cart.length === 0) {
        cartItems.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">Ë≥ºÁâ©ËªäÊòØÁ©∫ÁöÑ</p>';
        cartTotal.textContent = '0';
        return;
    }

    cartItems.innerHTML = cart.map((item, index) => `
        <div class="cart-item">
            <div class="cart-item-name" title="${item.productName} - ${item.specName}">
                ${item.productName}<br>
                <span style="color: var(--primary); font-size: 14px;">üì¶ ${item.specName}</span>
            </div>
            <div class="cart-item-price">$${item.price} √ó ${item.quantity} = <span style="font-size: 20px;">$${item.price * item.quantity}</span></div>
            <div class="cart-item-qty">
                <button class="qty-btn" onclick="updateCartQuantity(${index}, -1)">‚àí</button>
                <span>${item.quantity}</span>
                <button class="qty-btn" onclick="updateCartQuantity(${index}, 1)">+</button>
            </div>
            <button class="remove-item" onclick="removeCartItem(${index})">üóëÔ∏è ÁßªÈô§</button>
        </div>
    `).join('');

    const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    cartTotal.textContent = total;

    // üÜï Ë≥ºÁâ©ËªäÂÑ™ÊÉ†ÊèêÁ§∫
    const cartHintContainer = document.getElementById('cartPromotionHints');
    if (cartHintContainer) {
        const hints = displayPromotionHints(cart);
        if (hints) {
            cartHintContainer.innerHTML = `<div style="padding:10px 16px 4px; font-size:13px; line-height:1.8; color:#FFD700;">${hints}</div>`;
        } else {
            cartHintContainer.innerHTML = '';
        }
    }
}

function updateCartQuantity(index, change) {
    const item = cart[index];
    const newQty = item.quantity + change;

    if (newQty <= 0) {
        removeCartItem(index);
        return;
    }

    // Êü•ÊâæË¶èÊ†ºÔºàÊîØÊåÅ‰∏âÂ±§ÈÅ∏ÊìáÁµêÊßãÔºâ
    let spec = null;
    const specs = productSpecs[item.productId];
    
    if (specs) {
        spec = specs.find(s => s.specName === item.specName);
    }
    
    // Â¶ÇÊûúÊâæ‰∏çÂà∞Ë¶èÊ†ºÔºåÂòóË©¶ÂæûÊâÄÊúâË¶èÊ†º‰∏≠Êü•Êâæ
    if (!spec) {
        for (let productId in productSpecs) {
            const foundSpec = productSpecs[productId].find(s => s.specName === item.specName);
            if (foundSpec) {
                spec = foundSpec;
                break;
            }
        }
    }
    
    if (!spec) {
        showToast('Êâæ‰∏çÂà∞ÂïÜÂìÅË¶èÊ†º', 'error');
        return;
    }
    
    if (newQty > spec.stock) {
        showToast('Â∑≤ÈÅîÂ∫´Â≠ò‰∏äÈôê', 'error');
        return;
    }

    item.quantity = newQty;
    updateCart();
}

function removeCartItem(index) {
    cart.splice(index, 1);
    updateCart();
}

function toggleCart() {
    const cartSidebar = document.getElementById('cartSidebar');
    const isOpening = !cartSidebar.classList.contains('active');
    
    cartSidebar.classList.toggle('active');
    
    if (isOpening) {
        history.pushState({ modal: 'cart' }, '');
        isModalOpen = true;
    } else {
        isModalOpen = false;
    }
}

// ==========================================
// ÁµêÂ∏≥ÊµÅÁ®ã
// ==========================================
function openCheckout() {
    if (cart.length === 0) {
        showToast('Ë≥ºÁâ©ËªäÊòØÁ©∫ÁöÑ', 'error');
        return;
    }
    // Â¶ÇÊûúË®ÇÂñÆË©≥ÊÉÖÈ†ÅÈÇÑÈñãËëóÔºåÂÖàÈóúÊéâ
    const existingDetail = document.getElementById('orderDetailView');
    if (existingDetail) existingDetail.remove();
    
    // Êõ¥Êñ∞ÁµêÂ∏≥È†ÅÈù¢ÁöÑË®ÇÂñÆÊëòË¶Å
    updateCheckoutSummary();
    
    // üÜï Â¶ÇÊûúÂ∑≤ÈÅ∏ÊìáÈñÄÂ∏ÇÔºåÈ°ØÁ§∫ÈñÄÂ∏ÇË≥áË®ä
    displaySelectedStore();
    
    document.getElementById('checkoutModal').classList.add('active');
    
    // üî• Ê∑ªÂä†Ê≠∑Âè≤Ë®òÈåÑ
    history.pushState({ modal: 'checkout' }, '');
    isModalOpen = true;
}

function updateCheckoutSummary() {
    const summaryItems = document.getElementById('checkoutSummary');
    const checkoutTotal = document.getElementById('checkoutTotal');
    
    // Ë®àÁÆóÂïÜÂìÅÂ∞èË®à
    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    
    // üÜï Ë®àÁÆóÂÑ™ÊÉ†
    const promotionResult = calculatePromotions(cart);
    
    // Ê™¢Êü•ÊòØÂê¶ÈÅ∏Êìá 7-11 ÈÖçÈÄÅ
    const shipping = document.querySelector('input[name="shipping"]:checked');
    let shippingFee = (shipping && shipping.value === '711') ? 60 : 0;
    
    // üÜï Â¶ÇÊûúÁ¨¶ÂêàÂÖçÈÅãÂÑ™ÊÉ†ÔºåÈÅãË≤ªË®≠ÁÇ∫ 0
    if (promotionResult.freeShipping) {
        shippingFee = 0;
    }
    
    // ÁîüÊàêÂïÜÂìÅÂàóË°®
    let itemsHtml = cart.map(item => `
        <div class="summary-item">
            <span class="item-name">${item.productName} - ${item.specName} √ó ${item.quantity}</span>
            <span class="item-price">$${item.price * item.quantity}</span>
        </div>
    `).join('');
    
    // È°ØÁ§∫ÂïÜÂìÅÂ∞èË®à
    itemsHtml += `
        <div class="summary-item" style="border-top: 1px solid rgba(255,215,0,0.2); margin-top: 10px; padding-top: 10px;">
            <span class="item-name">ÂïÜÂìÅÂ∞èË®à</span>
            <span class="item-price">$${subtotal}</span>
        </div>
    `;
    
    // üÜï È°ØÁ§∫ÂÑ™ÊÉ†ÊäòÊâ£
    if (promotionResult.appliedPromotions.length > 0) {
        promotionResult.appliedPromotions.forEach(promo => {
            if (promo.type === 'ÊªøÈ°çÂÖçÈÅã') {
                itemsHtml += `
                    <div class="summary-item" style="color: #00FF00;">
                        <span class="item-name">üéÅ ${promo.name}</span>
                        <span class="item-price">ÂÖçÈÅãË≤ª</span>
                    </div>
                `;
            } else if (promo.discount > 0) {
                itemsHtml += `
                    <div class="summary-item" style="color: #00FF00;">
                        <span class="item-name">üéÅ ${promo.name}</span>
                        <span class="item-price">-$${promo.discount}</span>
                    </div>
                `;
            }
        });
    }
    
    // È°ØÁ§∫ÈÅãË≤ª
    if (shipping && shipping.value === '711') {
        const shippingText = promotionResult.freeShipping ? 
            `<span style="text-decoration: line-through; color: #666;">$60</span> <span style="color: #00FF00;">ÂÖçÈÅã</span>` : 
            `$${shippingFee}`;
        
        itemsHtml += `
            <div class="summary-item">
                <span class="item-name">7-11 ÈÅãË≤ª</span>
                <span class="item-price" style="color: var(--primary);">${shippingText}</span>
            </div>
        `;
    }
    
    summaryItems.innerHTML = itemsHtml;
    
    // üÜï Ë®àÁÆóÁ∏ΩÈáëÈ°çÔºàÂïÜÂìÅ - ÂÑ™ÊÉ† + ÈÅãË≤ªÔºâ
    const total = subtotal - promotionResult.totalDiscount + shippingFee;
    checkoutTotal.textContent = `$${total}`;
    
    // üÜï È°ØÁ§∫ÂÑ™ÊÉ†ÊèêÁ§∫
    const hints = displayPromotionHints(cart);
    const hintContainer = document.getElementById('promotionHints');
    if (hintContainer) {
        if (hints) {
            hintContainer.innerHTML = `<div style="background: rgba(255,215,0,0.1); padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 13px; line-height: 1.6;">${hints}</div>`;
        } else {
            hintContainer.innerHTML = '';
        }
    }
}

function closeCheckout() {
    document.getElementById('checkoutModal').classList.remove('active');
    isModalOpen = false;
}

// üÜï ÂàáÊèõÂèñË≤®ÊñπÂºèÔºà7-11 / Ëá™ÂèñÔºâ
function toggleShippingMethod() {
    const shipping = document.querySelector('input[name="shipping"]:checked').value;
    const storeSelector = document.getElementById('storeSelector');
    const pickupPayment = document.getElementById('pickupPaymentMethod');
    const storePayment = document.getElementById('storePaymentMethod');
    
    if (shipping === '711') {
        storeSelector.classList.add('active');
        pickupPayment.classList.remove('active');
        storePayment.style.display = 'none';
        selectedStore = null;
    } else {
        storeSelector.classList.remove('active');
        pickupPayment.classList.add('active');
        storePayment.style.display = 'none';
        selectedStore = null;
        
        const infoElement = document.getElementById('selectedStoreInfo');
        if (infoElement) infoElement.classList.remove('active');
        
        toggleBankInfo();
    }
    
    updateCheckoutSummary();
}

// ÈñÄÂ∏ÇÈÅ∏ÂÆåÂæåÈ°ØÁ§∫‰ªòÊ¨æÊñπÂºè
function showStorePaymentMethod() {
    const storePayment = document.getElementById('storePaymentMethod');
    if (storePayment) {
        storePayment.style.display = 'block';
        updateStoreBankInfo();
        toggleStorePayment();
    }
}

// ÂàáÊèõ 7-11 ‰ªòÊ¨æÊñπÂºè
function toggleStorePayment() {
    const method = document.querySelector('input[name="storePayment"]:checked')?.value;
    const bankInfo = document.getElementById('storeBankInfo');
    const linePayInfo = document.getElementById('storeLinePayInfo');
    if (bankInfo) bankInfo.style.display = (method === 'linepay') ? 'none' : 'block';
    if (linePayInfo) linePayInfo.style.display = (method === 'linepay') ? 'block' : 'none';
}

// Êõ¥Êñ∞ 7-11 ÂåØÊ¨æË≥áË®ä
function updateStoreBankInfo() {
    const el1 = document.getElementById('storeBankName');
    const el2 = document.getElementById('storeBankAccount');
    const el3 = document.getElementById('storeBankHolder');
    const el4 = document.getElementById('linePayAccount');
    if (el1) el1.textContent = systemSettings.bankName || 'Ë´ãËÅØÁπ´ÂÆ¢Êúç';
    if (el2) el2.textContent = systemSettings.bankAccount || 'Ë´ãËÅØÁπ´ÂÆ¢Êúç';
    if (el3) el3.textContent = systemSettings.bankHolder || 'CANDY BOSS';
    if (el4) el4.textContent = systemSettings.linePayAccount || 'Ë´ãËÅØÁπ´ÂÆ¢Êúç';
}

// üÜï ÂàáÊèõÂåØÊ¨æË≥áË®äÈ°ØÁ§∫
function toggleBankInfo() {
    const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value;
    const bankInfo = document.getElementById('bankInfo');
    if (!bankInfo) return;
    if (paymentMethod === 'transfer') {
        bankInfo.classList.add('active');
    } else {
        bankInfo.classList.remove('active');
    }
}

// üÜï ËºâÂÖ•Á≥ªÁµ±Ë®≠ÂÆö
async function loadSystemSettings() {
    try {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Á≥ªÁµ±Ë®≠ÂÆö?key=${API_KEY}`;
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.values && data.values.length > 0) {
            // Ëß£ÊûêË®≠ÂÆöË≥áÊñôÔºàÂÅáË®≠Ê†ºÂºèÔºöË®≠ÂÆöÈ†ÖÁõÆ | Ë®≠ÂÆöÂÄºÔºâ
            data.values.forEach(row => {
                if (row[0] === 'ÂåØÊ¨æÈäÄË°å') systemSettings.bankName = row[1] || '';
                if (row[0] === 'ÂåØÊ¨æÂ∏≥Ëôü') systemSettings.bankAccount = row[1] || '';
                if (row[0] === 'ÂåØÊ¨æÊà∂Âêç') systemSettings.bankHolder = row[1] || '';
                if (row[0] === 'LINE PayÂ∏≥Ëôü') systemSettings.linePayAccount = row[1] || '';
            });
            
            console.log('‚úÖ Á≥ªÁµ±Ë®≠ÂÆöËºâÂÖ•ÊàêÂäü:', systemSettings);
            updateBankInfo();
        }
    } catch (error) {
        console.error('‚ùå ËºâÂÖ•Á≥ªÁµ±Ë®≠ÂÆöÂ§±Êïó:', error);
        // ‰ΩøÁî®È†êË®≠ÂÄº
        systemSettings = {
            bankName: 'Ë´ãËÅØÁπ´ÂÆ¢Êúç',
            bankAccount: 'Ë´ãËÅØÁπ´ÂÆ¢Êúç',
            bankHolder: 'CANDY BOSS'
        };
        updateBankInfo();
    }
}

// üÜï Êõ¥Êñ∞ÂåØÊ¨æË≥áË®äÈ°ØÁ§∫
function updateBankInfo() {
    const bankNameEl = document.getElementById('bankName');
    const bankAccountEl = document.getElementById('bankAccount');
    const bankHolderEl = document.getElementById('bankHolder');
    
    if (bankNameEl) bankNameEl.textContent = systemSettings.bankName;
    if (bankAccountEl) bankAccountEl.textContent = systemSettings.bankAccount;
    if (bankHolderEl) bankHolderEl.textContent = systemSettings.bankHolder;
}

async function submitOrder() {
    // üî• Èò≤ÈáçË§áÈªûÊìäÔºöÊ™¢Êü•ÊòØÂê¶Ê≠£Âú®Êèê‰∫§
    if (window.isSubmittingOrder) {
        showToast('Ë®ÇÂñÆËôïÁêÜ‰∏≠ÔºåË´ãÁ®çÂÄô...', 'error');
        return;
    }
    
    const shipping = document.querySelector('input[name="shipping"]:checked').value;
    const name = document.getElementById('customerName').value.trim();
    const phone = document.getElementById('customerPhone').value.trim();
    let paymentMethod = '';

    // Âü∫Êú¨Ë≥áÊñôÈ©óË≠â
    if (!name || !phone) {
        showToast('Ë´ãÂ°´ÂØ´ÂßìÂêçÂíåÈõªË©±', 'error');
        return;
    }

    // Ëá™Âèñ‰ªòÊ¨æÊñπÂºè
    if (shipping === 'pickup') {
        paymentMethod = document.querySelector('input[name="paymentMethod"]:checked')?.value || '';
    } else if (shipping === '711') {
        if (!selectedStore) {
            showToast('Ë´ãÈÅ∏Êìá 7-11 ÈñÄÂ∏Ç', 'error');
            return;
        }
        const storePaymentVal = document.querySelector('input[name="storePayment"]:checked')?.value || 'transfer';
        if (storePaymentVal === 'linepay') {
            paymentMethod = 'linepay';
            window._linePayName = '';
        } else {
            paymentMethod = 'transfer';
            window._linePayName = '';
        }
    }

    // üî• Ë®≠ÂÆöÊèê‰∫§‰∏≠Ê®ôË®òÔºåÈò≤Ê≠¢ÈáçË§áÈªûÊìä
    window.isSubmittingOrder = true;
    
    // üî• Á¶ÅÁî®Êèê‰∫§ÊåâÈàï‰∏¶È°ØÁ§∫ËºâÂÖ•ÁãÄÊÖã
    const submitBtn = document.querySelector('.submit-order-btn');
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.style.opacity = '0.6';
    submitBtn.style.cursor = 'not-allowed';
    submitBtn.innerHTML = '‚è≥ Ë®ÇÂñÆËôïÁêÜ‰∏≠ÔºåË´ãÁ®çÂÄô...';

    // üÜï Ë®àÁÆóÂÑ™ÊÉ†
    const promotionResult = calculatePromotions(cart);
    
    // üî• Ë®àÁÆóÈÅãË≤ªÂíåÁ∏ΩÈáëÈ°ç
    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    let shippingFee = shipping === '711' ? 60 : 0;
    
    // üÜï Â¶ÇÊûúÁ¨¶ÂêàÂÖçÈÅãÂÑ™ÊÉ†ÔºåÈÅãË≤ªË®≠ÁÇ∫ 0
    if (promotionResult.freeShipping) {
        shippingFee = 0;
    }
    
    // üÜï Ë®àÁÆóÂÑ™ÊÉ†ÂæåÁöÑÁ∏ΩÈáëÈ°ç
    const totalAmount = subtotal - promotionResult.totalDiscount + shippingFee;
    
    // üÜï ÁµÑÂêàÂÑ™ÊÉ†ÊòéÁ¥∞ÊñáÂ≠ó
    const promotionText = promotionResult.appliedPromotions.length > 0 
        ? promotionResult.appliedPromotions.map(p => {
            if (p.type === 'ÊªøÈ°çÂÖçÈÅã') {
                return `${p.name}(ÂÖçÈÅã)`;
            } else {
                return `${p.name}(-$${p.discount})`;
            }
        }).join(', ')
        : '-';

    const orderData = {
        action: 'createOrder',
        Ë®ÇÂñÆÁ∑®Ëôü: 'ORD' + Date.now(),
        Ë®ÇË≥ºÊôÇÈñì: new Date().toISOString(),
        ÂßìÂêç: name,
        ÈõªË©±: phone,
        ÂèñË≤®ÊñπÂºè: shipping === '711' ? '7-11Â∫óÂà∞Â∫ó' : 'Ëá™Âèñ',
        ‰ªòÊ¨æÊñπÂºè: shipping === '711' ? (paymentMethod === 'linepay' ? 'LINE Pay' : 'ÂåØÊ¨æ') : (paymentMethod === 'cash' ? 'ÁèæÂ†¥‰ªòÊ¨æ' : 'ÂåØÊ¨æ'),
        ‰ªòÊ¨æÁãÄÊÖã: 'ÂæÖ‰ªòÊ¨æ', // üÜï ‰ªòÊ¨æÁãÄÊÖã
        ÈñÄÂ∏ÇÂêçÁ®±: shipping === '711' ? selectedStore.name : '-',
        ÈñÄÂ∏Ç‰ª£Á¢º: shipping === '711' ? (selectedStore.id || '') : '-',
        ÈñÄÂ∏ÇÂú∞ÂùÄ: shipping === '711' ? selectedStore.address : '-',
        ÂåØÊ¨æÊú´‰∫îÁ¢º: paymentMethod === 'linepay' ? ('LINE:' + (window._linePayName || '')) : '',
        ÂïÜÂìÅÊòéÁ¥∞: cart.map(item => {
            const multiplier = item.quantityMultiplier || 1;
            const displayQty = multiplier > 1 ? `${item.quantity}ÁµÑ(ÂÖ±${item.quantity * multiplier}ÂÄã)` : `${item.quantity}`;
            return `${item.productName}-${item.specName} x${displayQty}`;
        }).join(', '),
        ÂïÜÂìÅÈáëÈ°ç: subtotal,
        ÂÑ™ÊÉ†ÊäòÊâ£: promotionResult.totalDiscount,  // üÜï ÂÑ™ÊÉ†ÊäòÊâ£
        ÂÑ™ÊÉ†ÊòéÁ¥∞: promotionText,                  // üÜï ÂÑ™ÊÉ†ÊòéÁ¥∞
        ÈÅãË≤ª: shippingFee,
        Á∏ΩÈáëÈ°ç: totalAmount,
        Ë®ÇÂñÆÁãÄÊÖã: 'ÂæÖËôïÁêÜ',
        Áâ©ÊµÅÁ∑®Ëôü: '-',
        ÊúÉÂì°ID: currentMember ? currentMember.lineId : '',
        ÂïÜÂìÅË≥áÊñô: cart.map(item => ({
            productId: item.productId,
            specName: item.specName,
            quantity: (item.quantity * (item.quantityMultiplier || 1))  // ÂÇ≥ÈÄÅÂØ¶ÈöõÊâ£Â∫´Â≠òÊï∏Èáè
        }))
    };

    // üî• ‰øùÂ≠òË≥ºË≤∑Ê∏ÖÂñÆÔºåÁî®ÊñºÂæåÁ∫åÊõ¥Êñ∞Â∫´Â≠ò
    const purchasedItems = cart.map(item => ({
        productId: item.productId,
        specName: item.specName
    }));

    try {
        await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(orderData)
        });
        
        showToast('‚úÖ Ë®ÇÂñÆÂ∑≤ÈÄÅÂá∫ÔºÅ', 'success');
        
        // Ê∏ÖÁ©∫Ë≥ºÁâ©Ëªä
        cart = [];
        updateCart();
        
        // üî• ÈáçÁΩÆÊèê‰∫§ÁãÄÊÖã
        window.isSubmittingOrder = false;
        submitBtn.disabled = false;
        submitBtn.style.opacity = '';
        submitBtn.style.cursor = '';
        submitBtn.innerHTML = originalBtnText;
        
        // ÈóúÈñâÁµêÂ∏≥Ê®°ÊÖãÊ°ÜÔºåÂêåÊôÇÈóúÈñâË≥ºÁâ©Ëªä
        closeCheckout();
        // Âº∑Âà∂ÈóúÈñâË≥ºÁâ©ËªäÔºåÁ¢∫‰øùËøîÂõûÈçµ‰∏çÊúÉÂõûÂà∞Ë≥ºÁâ©ËªäÁãÄÊÖã
        document.getElementById('cartSidebar').classList.remove('active');
        // Áî® replaceState Ê∏ÖÊéâ cart/checkout ÁöÑ historyÔºåËÆìË©≥ÊÉÖÈ†ÅËøîÂõûÁõ¥Êé•ÂõûÈ¶ñÈ†Å
        history.replaceState(null, '', location.href);
        
        // üÜï Áõ¥Êé•Âú®Áï∂ÂâçÈ†ÅÈù¢È°ØÁ§∫Ë®ÇÂñÆË©≥ÊÉÖÔºà‰ΩøÁî®Êñ∞Ë®ÇÂñÆË≥áÊñôÔºâ
        setTimeout(() => {
            showNewOrderDetail(orderData);
        }, 500);
        
    } catch (error) {
        console.log('Ë®ÇÂñÆÂ∑≤ÈÄÅÂá∫(no-cors Ê®°Âºè)');
        showToast('‚úÖ Ë®ÇÂñÆÂ∑≤ÈÄÅÂá∫ÔºÅ', 'success');
        
        // Ê∏ÖÁ©∫Ë≥ºÁâ©Ëªä
        cart = [];
        updateCart();
        
        // üî• ÈáçÁΩÆÊèê‰∫§ÁãÄÊÖã
        window.isSubmittingOrder = false;
        submitBtn.disabled = false;
        submitBtn.style.opacity = '';
        submitBtn.style.cursor = '';
        submitBtn.innerHTML = originalBtnText;
        
        // ÈóúÈñâÁµêÂ∏≥Ê®°ÊÖãÊ°ÜÔºåÂêåÊôÇÈóúÈñâË≥ºÁâ©Ëªä
        closeCheckout();
        // Âº∑Âà∂ÈóúÈñâË≥ºÁâ©ËªäÔºåÁ¢∫‰øùËøîÂõûÈçµ‰∏çÊúÉÂõûÂà∞Ë≥ºÁâ©ËªäÁãÄÊÖã
        document.getElementById('cartSidebar').classList.remove('active');
        // Áî® replaceState Ê∏ÖÊéâ cart/checkout ÁöÑ historyÔºåËÆìË©≥ÊÉÖÈ†ÅËøîÂõûÁõ¥Êé•ÂõûÈ¶ñÈ†Å
        history.replaceState(null, '', location.href);
        
        // È°ØÁ§∫Ë®ÇÂñÆË©≥ÊÉÖ
        setTimeout(() => {
            showNewOrderDetail(orderData);
        }, 500);
        
        // üî• ËºïÈáèÁ¥öÊõ¥Êñ∞ÔºöÂè™Êõ¥Êñ∞Â∑≤Ë≥ºË≤∑ÂïÜÂìÅÁöÑÂ∫´Â≠ò
        setTimeout(() => {
            updatePurchasedProductsStock(purchasedItems);
        }, 1000);
    }
}

// ==========================================
// Ë®ÇÂñÆÊü•Ë©¢
// ==========================================
async function openOrderSearch() {
    // Ê™¢Êü•ÊòØÂê¶Â∑≤ÁôªÂÖ•
    if (!currentMember || !currentMember.lineId) {
        showToast('Ë´ãÂÖàÁôªÂÖ• LINE Â∏≥Ëôü', 'error');
        return;
    }
    
    // È°ØÁ§∫Ê®°ÊÖãÊ°ÜÔºàÈáçÁΩÆ‰ªª‰Ωï style.display Ë¶ÜËìãÔºâ
    const osm = document.getElementById('orderSearchModal');
    osm.style.display = '';
    osm.classList.add('active');
    window._orderDetailFromSearch = false;
    
    // üî• Ê∑ªÂä†Ê≠∑Âè≤Ë®òÈåÑ
    history.pushState({ modal: 'orderSearch' }, '');
    isModalOpen = true;
    
    // È°ØÁ§∫ËºâÂÖ•‰∏≠
    document.getElementById('ordersList').innerHTML = `
        <div style="text-align:center; padding:40px; color:#999;">
            <div style="font-size:40px; margin-bottom:20px;">‚è≥</div>
            <div>ËºâÂÖ•‰∏≠...</div>
        </div>
    `;
    
    // Êü•Ë©¢Ë®ÇÂñÆ
    await loadMemberOrders();
}


function closeOrderSearch() {
    const osm = document.getElementById('orderSearchModal');
    osm.classList.remove('active');
    osm.style.display = '';
    isModalOpen = false;
    window._orderDetailFromSearch = false;
}

// ==========================================
// üÜï È°ØÁ§∫Êñ∞Ë®ÇÂñÆË©≥ÊÉÖÔºàË®ÇÂñÆÈÄÅÂá∫ÂæåÔºâ‚Üí Áµ±‰∏ÄËµ∞Êü•Ë©¢Ë®ÇÂñÆ modal
// ==========================================
function showNewOrderDetail(orderData) {
    // ÂÖàÊ∏ÖÈô§ËàäÁöÑË©≥ÊÉÖÈ†ÅÔºàÈÅøÂÖçÁñäÂä†Ôºâ
    const existingDetail = document.getElementById('orderDetailView');
    if (existingDetail) existingDetail.remove();
    // Áõ¥Êé•È°ØÁ§∫ÂÖ®Ëû¢ÂπïË®ÇÂñÆË©≥ÊÉÖ
    const order = {
        Ë®ÇÂñÆÁ∑®Ëôü: orderData.Ë®ÇÂñÆÁ∑®Ëôü,
        Ë®ÇË≥ºÊôÇÈñì: orderData.Ë®ÇË≥ºÊôÇÈñì,
        ÂßìÂêç: orderData.ÂßìÂêç,
        ÈõªË©±: orderData.ÈõªË©±,
        ÂèñË≤®ÊñπÂºè: orderData.ÂèñË≤®ÊñπÂºè,
        ÈñÄÂ∏ÇÂêçÁ®±: orderData.ÈñÄÂ∏ÇÂêçÁ®± || '-',
        ‰ªòÊ¨æÊñπÂºè: orderData.‰ªòÊ¨æÊñπÂºè || '',   // üî• Ë£ú‰∏ä‰ªòÊ¨æÊñπÂºèÔºåÂê¶Ââá LINE Pay Âà§Êñ∑Â§±Êïó
        ÂïÜÂìÅÊòéÁ¥∞: orderData.ÂïÜÂìÅÊòéÁ¥∞,
        ÂïÜÂìÅÈáëÈ°ç: orderData.ÂïÜÂìÅÈáëÈ°ç,
        ÈÅãË≤ª: orderData.ÈÅãË≤ª,
        Á∏ΩÈáëÈ°ç: orderData.Á∏ΩÈáëÈ°ç,
        Ë®ÇÂñÆÁãÄÊÖã: orderData.Ë®ÇÂñÆÁãÄÊÖã || 'ÂæÖËôïÁêÜ',
        Áâ©ÊµÅÁ∑®Ëôü: '-',
        ÂåØÊ¨æÊú´‰∫îÁ¢º: orderData.ÂåØÊ¨æÊú´‰∫îÁ¢º || '-'
    };
    showOrderDetailByData(order);
}

// ==========================================
// üÜï È°ØÁ§∫Ë®ÇÂñÆË©≥ÊÉÖ
// ==========================================
function showOrderDetail(orderIndex) {
    // üî• Èò≤ÂëÜÔºöÁ¢∫‰øù memberOrders Â≠òÂú®‰∏î index ÊúâÊïà
    if (!window.memberOrders) {
        showToast('Ë®ÇÂñÆË≥áÊñôÂ∞öÊú™ËºâÂÖ•ÔºåË´ãÁ®çÂÄôÂÜçË©¶', 'error');
        return;
    }
    
    let order = window.memberOrders[orderIndex];
    
    // index Âèñ‰∏çÂà∞ÊôÇÔºåÂòóË©¶ÂæûÈªûÊìäÂÖÉÁ¥†ÁöÑ data-order-index Âèñ
    if (!order && typeof event !== 'undefined' && event && event.currentTarget) {
        const idx = parseInt(event.currentTarget.dataset.orderIndex);
        if (!isNaN(idx)) order = window.memberOrders[idx];
    }
    
    if (!order) {
        showToast('Êâæ‰∏çÂà∞Ë®ÇÂñÆË≥áÊñôÔºåË´ãÈáçÊñ∞ÈñãÂïüË®ÇÂñÆÂàóË°®', 'error');
        return;
    }
    
    // üî• ‰∏çÈóúÈñâ orderSearchModalÔºåÂè™ÊòØÊö´ÊôÇÈö±ËóèÔºàËøîÂõûÊôÇÈÇÑËÉΩÂõûÂéªÔºâ
    document.getElementById('orderSearchModal').style.display = 'none';
    // Ê®ôË®òÊòØÂæû orderSearch ÈÄ≤‰æÜÁöÑ
    window._orderDetailFromSearch = true;
    
    showOrderDetailByData(order);
}

// Áµ±‰∏ÄÁöÑË®ÇÂñÆË©≥ÊÉÖÈ°ØÁ§∫ÂáΩÊï∏
function showOrderDetailByData(order) {
    // üî• Èò≤ÂëÜÔºöÁ¢∫‰øù order ÊòØÊúâÊïàÁâ©‰ª∂
    if (!order || typeof order !== 'object') {
        showToast('Ë®ÇÂñÆË≥áÊñôÊ†ºÂºèÈåØË™§', 'error');
        // ÊÅ¢Âæ© orderSearch modal
        const osm = document.getElementById('orderSearchModal');
        if (osm) { osm.style.display = ''; osm.classList.add('active'); }
        return;
    }
    // Á¢∫‰øùÈóúÈçµÊ¨Ñ‰ΩçÊúâÂÄºÔºàÈÅøÂÖç .replace Âú® undefined ‰∏äÁàÜÁÇ∏Ôºâ
    order.Ë®ÇÂñÆÁ∑®Ëôü = order.Ë®ÇÂñÆÁ∑®Ëôü || ('ORD' + Date.now());
    order.Ë®ÇË≥ºÊôÇÈñì = order.Ë®ÇË≥ºÊôÇÈñì || new Date().toISOString();
    order.ÂïÜÂìÅÊòéÁ¥∞ = order.ÂïÜÂìÅÊòéÁ¥∞ || '';
    // üî• ÂåØÊ¨æÊú´‰∫îÁ¢ºÔºöÂº∑Âà∂ËΩâÂ≠ó‰∏≤ÔºàGAS ÂèØËÉΩÂõûÂÇ≥Êï∏Â≠óÔºâÔºånull/undefined Ë£ú '-'
    order.ÂåØÊ¨æÊú´‰∫îÁ¢º = (order.ÂåØÊ¨æÊú´‰∫îÁ¢º !== undefined && order.ÂåØÊ¨æÊú´‰∫îÁ¢º !== null) ? String(order.ÂåØÊ¨æÊú´‰∫îÁ¢º) : '-';
    order.‰ªòÊ¨æÊñπÂºè = order.‰ªòÊ¨æÊñπÂºè || '';
    order.ÂèñË≤®ÊñπÂºè = order.ÂèñË≤®ÊñπÂºè || '';
    order.Ë®ÇÂñÆÁãÄÊÖã = order.Ë®ÇÂñÆÁãÄÊÖã || 'ÂæÖËôïÁêÜ';
    
    let isExpired = false;
    let shouldShowPaymentButton = true;
    
    const isLinePayOrder = order.‰ªòÊ¨æÊñπÂºè === 'LINE Pay';
    const cancelledStatuses = ['ÂèñÊ∂àË®ÇÂñÆ', 'Ë®ÇÂñÆÂèñÊ∂à', 'Â∑≤ÂèñÊ∂à'];
    
    const transferFilled = !isLinePayOrder && order.ÂåØÊ¨æÊú´‰∫îÁ¢º && order.ÂåØÊ¨æÊú´‰∫îÁ¢º !== '-' && order.ÂåØÊ¨æÊú´‰∫îÁ¢º !== '' && !order.ÂåØÊ¨æÊú´‰∫îÁ¢º.startsWith('LINE:');
    const linePayFilled  = isLinePayOrder  && order.ÂåØÊ¨æÊú´‰∫îÁ¢º && order.ÂåØÊ¨æÊú´‰∫îÁ¢º.startsWith('LINE:') && order.ÂåØÊ¨æÊú´‰∫îÁ¢º.replace('LINE:','').trim() !== '';
    const hasPaid = order.Ë®ÇÂñÆÁãÄÊÖã === 'Â∑≤‰ªòÊ¨æÂæÖÂá∫Ë≤®' || transferFilled || linePayFilled;
    
    // Â∑≤ÂèñÊ∂à ‚Üí È°ØÁ§∫ÈÄæÊúü
    if (cancelledStatuses.includes(order.Ë®ÇÂñÆÁãÄÊÖã)) {
        isExpired = true;
        shouldShowPaymentButton = false;
    }
    // üî• Â∑≤‰ªòÊ¨æ ‚Üí ‰∏çÈ°ØÁ§∫Ëº∏ÂÖ•Ê°ÜÔºå‰ΩÜÈÇÑÊòØË¶ÅÈ°ØÁ§∫Â∑≤Â°´ÁöÑÊú´‰∫îÁ¢ºÔºàshowPaymentButton=true ËÆìÂçÄÂ°äÈ°ØÁ§∫Ôºâ
    // shouldShowPaymentButton ‰øùÊåÅ trueÔºåËÆì IIFE Ë£°ÁöÑÈÇèËºØËá™Ë°åÂà§Êñ∑È°ØÁ§∫Â∑≤Â°´ÂÖßÂÆπÊàñËº∏ÂÖ•Ê°Ü
    
    // ÂÄíÊï∏Ë®àÊôÇÔºöÂè™Êúâ 7-11„ÄÅÊú™‰ªòÊ¨æ„ÄÅÊú™ÂèñÊ∂àÊâçÈ°ØÁ§∫
    let countdownHTML = '';
    const orderIdHash = (order.Ë®ÇÂñÆÁ∑®Ëôü || '').replace(/[^a-zA-Z0-9]/g, '') || 'order';
    
    if (order.ÂèñË≤®ÊñπÂºè === '7-11Â∫óÂà∞Â∫ó' && !hasPaid && !isExpired) {
        try {
            const orderTime = new Date(order.Ë®ÇË≥ºÊôÇÈñì);
            const now = new Date();
            const deadline = new Date(orderTime.getTime() + 1 * 60 * 1000); // 1ÂàÜÈêò
            const remaining = deadline - now;
            
            if (remaining > 0) {
                const hours = Math.floor(remaining / (1000 * 60 * 60));
                const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
                countdownHTML = '<div id="countdown-container-' + orderIdHash + '" style="background:linear-gradient(135deg,rgba(255,69,0,0.2),rgba(255,140,0,0.2));border:1.5px solid #ff4500;border-radius:10px;padding:8px 12px;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;gap:10px;">'
                    + '<span style="color:#ff4500;font-size:12px;font-weight:700;white-space:nowrap;">‚è∞ ‰ªòÊ¨æÂÄíÊï∏</span>'
                    + '<div id="countdown-' + orderIdHash + '" style="font-size:20px;font-weight:900;color:#FFD700;font-family:Orbitron,monospace;">'
                    + String(hours).padStart(2,'0') + ':' + String(minutes).padStart(2,'0') + ':' + String(seconds).padStart(2,'0')
                    + '</div>'
                    + '<div style="color:#ff8c00;font-size:15px;font-weight:700;white-space:nowrap;">Ë´ãÁõ°Âø´ÂÆåÊàê‰ªòÊ¨æ</div>'
                    + '</div>';
            }
        } catch (e) {
            console.error('ÂÄíÊï∏Ë®àÊôÇÈåØË™§:', e);
        }
    }
    
    // Âª∫Á´ãË®ÇÂñÆË©≥ÊÉÖ HTMLÔºàÊâãÊ©üÂñÆÈ†ÅÂèØË¶ñÔºâ
    const statusColor = order.Ë®ÇÂñÆÁãÄÊÖã === 'Â∑≤ÂÆåÊàê' ? '#00FF00' : order.Ë®ÇÂñÆÁãÄÊÖã === 'ÂæÖËôïÁêÜ' ? '#ffa500' : order.Ë®ÇÂñÆÁãÄÊÖã === 'ÂèñÊ∂àË®ÇÂñÆ' || order.Ë®ÇÂñÆÁãÄÊÖã === 'Ë®ÇÂñÆÂèñÊ∂à' || order.Ë®ÇÂñÆÁãÄÊÖã === 'Â∑≤ÂèñÊ∂à' ? '#ff4444' : order.Ë®ÇÂñÆÁãÄÊÖã === 'Â∑≤‰ªòÊ¨æÂæÖÂá∫Ë≤®' ? '#00bfff' : '#FFD700';
    const detailHTML = `
        <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:#0d0d0d;z-index:10000;overflow-y:auto;padding:10px 12px;font-family:'Noto Sans TC',sans-serif;">
            <div style="max-width:480px;margin:0 auto;">

                <!-- È†ÇÈÉ®ÔºöËøîÂõû + ÁãÄÊÖã -->
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
                    <button onclick="closeOrderDetail()" style="background:rgba(255,215,0,0.1);border:1.5px solid #FFD700;color:#FFD700;padding:8px 18px;border-radius:20px;font-weight:700;cursor:pointer;font-size:15px;">‚Üê Ë®ÇÂñÆÂàóË°®</button>
                    <div style="background:${statusColor};color:#000;padding:7px 18px;border-radius:20px;font-size:15px;font-weight:900;">${order.Ë®ÇÂñÆÁãÄÊÖã}</div>
                </div>

                ${countdownHTML}

                <!-- Ë®ÇÂñÆË≥áË®äÂç° -->
                <div style="background:rgba(255,255,255,0.05);border:1.5px solid #FFD700;border-radius:12px;padding:14px 16px;margin-bottom:10px;">
                    <div style="color:#FFD700;font-size:15px;font-weight:900;margin-bottom:10px;">üì¶ ${order.Ë®ÇÂñÆÁ∑®Ëôü}</div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:15px;">
                        <div><span style="color:#888;">ÂßìÂêç</span><br><span style="color:#fff;font-weight:700;font-size:16px;">${order.ÂßìÂêç}</span></div>
                        <div><span style="color:#888;">ÈõªË©±</span><br><span style="color:#fff;font-weight:700;font-size:16px;">${order.ÈõªË©±}</span></div>
                        <div><span style="color:#888;">ÂèñË≤®</span><br><span style="color:#FFD700;font-weight:700;font-size:16px;">${order.ÂèñË≤®ÊñπÂºè}</span></div>
                        <div><span style="color:#888;">‰ªòÊ¨æ</span><br><span style="color:#FFD700;font-weight:700;font-size:16px;">${order.‰ªòÊ¨æÊñπÂºè || '-'}</span></div>
                        ${order.ÈñÄÂ∏ÇÂêçÁ®± && order.ÈñÄÂ∏ÇÂêçÁ®± !== '-' ? `<div style="grid-column:1/-1;"><span style="color:#888;">ÈñÄÂ∏Ç</span><br><span style="color:#FFD700;font-weight:700;font-size:16px;">${order.ÈñÄÂ∏ÇÂêçÁ®±}</span></div>` : ''}
                    </div>
                </div>

                <!-- ‰ªòÊ¨æË≥áË®äÔºà7-11ÊâçÈ°ØÁ§∫Ôºâ -->
                ${order.ÂèñË≤®ÊñπÂºè === '7-11Â∫óÂà∞Â∫ó' ? `
                <div style="background:${isLinePayOrder ? 'rgba(6,199,85,0.1)' : 'rgba(255,215,0,0.08)'};border:1.5px solid ${isLinePayOrder ? '#06C755' : '#FFD700'};border-radius:12px;padding:14px 16px;margin-bottom:10px;font-size:15px;">
                    <div style="color:${isLinePayOrder ? '#06C755' : '#FFD700'};font-weight:900;margin-bottom:8px;font-size:16px;">${isLinePayOrder ? 'üíö LINE Pay Ë≥áË®ä' : 'üí≥ ÂåØÊ¨æË≥áË®ä'}</div>
                    ${isLinePayOrder ? `
                        <div style="display:flex;justify-content:space-between;margin-bottom:6px;"><span style="color:#888;">LINE Pay Â∏≥Ëôü</span><span style="color:#06C755;font-weight:700;">${systemSettings.linePayAccount || 'Ë´ãËÅØÁπ´ÂÆ¢Êúç'}</span></div>
                        <div style="display:flex;justify-content:space-between;"><span style="color:#888;">‰ªòÊ¨æÈáëÈ°ç</span><span style="color:#00FF00;font-weight:900;font-size:18px;">$${order.Á∏ΩÈáëÈ°ç}</span></div>
                    ` : `
                        <div style="display:flex;justify-content:space-between;margin-bottom:6px;"><span style="color:#888;">ÈäÄË°å</span><span style="color:#FFD700;font-weight:700;">${systemSettings.bankName || 'Ë´ãËÅØÁπ´ÂÆ¢Êúç'}</span></div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:6px;"><span style="color:#888;">Â∏≥Ëôü</span><span style="color:#FFD700;font-weight:700;">${systemSettings.bankAccount || 'Ë´ãËÅØÁπ´ÂÆ¢Êúç'}</span></div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:6px;"><span style="color:#888;">Ê≥®ÊÑè‰∫ãÈ†Ö</span><span style="color:#FFD700;font-weight:700;">${systemSettings.bankHolder || ''}</span></div>
                        <div style="display:flex;justify-content:space-between;"><span style="color:#888;">ÂåØÊ¨æÈáëÈ°ç</span><span style="color:#00FF00;font-weight:900;font-size:18px;">$${order.Á∏ΩÈáëÈ°ç}</span></div>
                    `}
                </div>
                ` : ''}

                <!-- ÂïÜÂìÅÊòéÁ¥∞ + ÈáëÈ°ç -->
                <div style="background:rgba(255,255,255,0.05);border:1.5px solid rgba(255,215,0,0.3);border-radius:12px;padding:14px 16px;margin-bottom:10px;font-size:15px;">
                    <div style="color:#FFD700;font-weight:900;margin-bottom:8px;font-size:16px;">üõí ÂïÜÂìÅÊòéÁ¥∞</div>
                    <div style="color:#fff;max-height:120px;overflow-y:auto;margin-bottom:10px;line-height:2;">
                        ${order.ÂïÜÂìÅÊòéÁ¥∞.split(',').map(item => `‚Ä¢ ${item.trim()}`).join('<br>')}
                    </div>
                    <div style="border-top:1px solid rgba(255,215,0,0.3);padding-top:8px;display:flex;justify-content:space-between;align-items:center;">
                        ${order.ÈÅãË≤ª && order.ÈÅãË≤ª > 0 ? `<span style="color:#999;font-size:14px;">Âê´ÈÅãË≤ª $${order.ÈÅãË≤ª}</span>` : '<span></span>'}
                        <span style="color:#FFD700;font-weight:900;font-size:20px;">Á∏ΩË®à $${order.Á∏ΩÈáëÈ°ç}</span>
                    </div>
                </div>

                <!-- ‰ªòÊ¨æËº∏ÂÖ• + Á¢∫Ë™çÊåâÈàïÔºàÁî®Â≠ó‰∏≤ÊãºÊé•ÔºåÈÅøÂÖç nested backtick Â¥©ÊΩ∞Ôºâ-->
                ${(function(){
                    if (order.ÂèñË≤®ÊñπÂºè !== '7-11Â∫óÂà∞Â∫ó') return '';
                    if (isExpired) return '<div style="background:rgba(255,0,0,0.15);border:1.5px solid #ff4444;border-radius:12px;padding:14px 16px;text-align:center;font-size:15px;"><div style="color:#ff4444;font-weight:700;margin-bottom:6px;font-size:16px;">‚ùå Ë®ÇÂñÆÂ∑≤ÂèñÊ∂à</div><div style="color:#ff8c00;">Ë´ãËøîÂõûÈáçÊñ∞‰∏ãÂñÆ</div></div>';
                    if (!shouldShowPaymentButton) return '';
                    
                    let inner = '';
                    if (isLinePayOrder) {
                        const lineNameFilled = order.ÂåØÊ¨æÊú´‰∫îÁ¢º && order.ÂåØÊ¨æÊú´‰∫îÁ¢º.startsWith('LINE:') && order.ÂåØÊ¨æÊú´‰∫îÁ¢º.replace('LINE:','').trim() !== '';
                        if (lineNameFilled) {
                            inner = '<div style="color:#00FF00;font-weight:700;font-size:16px;">‚úÖ LINE ÂêçÁ®±Ôºö' + order.ÂåØÊ¨æÊú´‰∫îÁ¢º.replace('LINE:','') + '</div>';
                        } else {
                            inner = '<div style="color:#aaa;font-size:14px;margin-bottom:8px;">üíö Ë´ãËº∏ÂÖ• LINE È°ØÁ§∫ÂêçÁ®±ÂæåÁ¢∫Ë™ç‰ªòÊ¨æ</div>'
                                + '<div style="display:flex;gap:8px;align-items:center;">'
                                + '<input type="text" id="payment-code-input" placeholder="LINE È°ØÁ§∫ÂêçÁ®±" data-payment-type="linepay" style="flex:1;padding:10px;border:1.5px solid #06C755;border-radius:8px;background:rgba(0,0,0,0.5);color:#06C755;font-size:15px;font-weight:700;">'
                                + '<button onclick="submitPaymentCode()" style="background:linear-gradient(135deg,#06C755,#00ff88);color:#000;border:none;padding:10px 18px;border-radius:8px;font-size:15px;font-weight:900;cursor:pointer;white-space:nowrap;">‚úì Á¢∫Ë™ç</button>'
                                + '</div>';
                        }
                    } else {
                        const transferDone = order.ÂåØÊ¨æÊú´‰∫îÁ¢º && order.ÂåØÊ¨æÊú´‰∫îÁ¢º !== '-' && order.ÂåØÊ¨æÊú´‰∫îÁ¢º !== '' && !order.ÂåØÊ¨æÊú´‰∫îÁ¢º.startsWith('LINE:');
                        if (transferDone) {
                            inner = '<div style="color:#00FF00;font-weight:700;font-size:16px;">‚úÖ ÂåØÊ¨æÊú´‰∫îÁ¢ºÔºö' + order.ÂåØÊ¨æÊú´‰∫îÁ¢º + '</div>';
                        } else {
                            inner = '<div style="color:#aaa;font-size:14px;margin-bottom:8px;">üí≥ Ë´ãËº∏ÂÖ•ÂåØÊ¨æÊú´‰∫îÁ¢ºÂæåÁ¢∫Ë™ç‰ªòÊ¨æ</div>'
                                + '<div style="display:flex;gap:8px;align-items:center;">'
                                + '<input type="text" id="payment-code-input" placeholder="Êú´‰∫îÁ¢º" maxlength="5" data-payment-type="transfer" style="flex:1;padding:10px;border:1.5px solid #FFD700;border-radius:8px;background:rgba(0,0,0,0.5);color:#FFD700;font-size:18px;font-weight:700;text-align:center;letter-spacing:3px;">'
                                + '<button onclick="submitPaymentCode()" style="background:linear-gradient(135deg,#00c800,#00ff00);color:#000;border:none;padding:10px 18px;border-radius:8px;font-size:15px;font-weight:900;cursor:pointer;white-space:nowrap;">‚úì Á¢∫Ë™ç</button>'
                                + '</div>';
                        }
                    }
                    return '<div id="payment-code-section" style="background:rgba(255,255,255,0.05);border:1.5px solid rgba(255,215,0,0.3);border-radius:12px;padding:14px 16px;margin-bottom:10px;">' + inner + '</div>';
                })()}

            </div>
        </div>
    `;
    
    // Âª∫Á´ã‰∏¶È°ØÁ§∫Ë©≥ÊÉÖÈ†ÅÈù¢
    const detailDiv = document.createElement('div');
    detailDiv.id = 'orderDetailView';
    detailDiv.innerHTML = detailHTML;
    document.body.appendChild(detailDiv);
    // üî• ÊääË®ÇÂñÆÁ∑®ËôüÂ≠òÂà∞ windowÔºåËÆì submitPaymentCode ‰∏çÈúÄË¶Å‰æùË≥¥ onclick Â≠ó‰∏≤
    window._currentOrderId = order.Ë®ÇÂñÆÁ∑®Ëôü;
    
    // Âä†ÂÖ• historyÔºåËÆìËøîÂõûÈçµÂèØ‰ª•ÈóúÊéâË©≥ÊÉÖÈ†ÅËÄå‰∏çÊòØË∑≥ÂõûÈ¶ñÈ†Å
    history.pushState({ modal: 'orderDetail' }, '');
    isModalOpen = true;
    
    // ÂïüÂãïÂÄíÊï∏Ë®àÊôÇ
    if (order.ÂèñË≤®ÊñπÂºè === '7-11Â∫óÂà∞Â∫ó') {
        if (!hasPaid) startCountdown(order.Ë®ÇÂñÆÁ∑®Ëôü, order.Ë®ÇË≥ºÊôÇÈñì);
    }
}

// ÂÄíÊï∏Ë®àÊôÇÂáΩÊï∏
function startCountdown(orderId, orderTime) {
    const orderIdHash = (orderId || '').replace(/[^a-zA-Z0-9]/g, '') || 'order';
    const countdownEl = document.getElementById(`countdown-${orderIdHash}`);
    if (!countdownEl) return;
    
    const timer = setInterval(() => {
        try {
            const orderDate = new Date(orderTime);
            const now = new Date();
            const deadline = new Date(orderDate.getTime() + 1 * 60 * 1000); // ‰∏ãÂñÆÂæå1ÂàÜÈêò
            const remaining = deadline - now;
            
            if (remaining <= 0) {
                clearInterval(timer);
                
                // Â∑≤‰ªòÊ¨æÔºàpayment-code-section È°ØÁ§∫ ‚úÖÔºâÂ∞±‰∏çÂèñÊ∂à‰πü‰∏çÈ°ØÁ§∫ÈÄæÊúü
                const paidSection = document.getElementById('payment-code-section');
                const alreadyPaid = paidSection && paidSection.textContent.includes('‚úÖ');
                if (alreadyPaid) return;
                
                // Ëá™ÂãïÂèñÊ∂àË®ÇÂñÆ
                cancelExpiredOrder(orderId);
                
                // Êõ¥Êñ∞ÂÄíÊï∏È°ØÁ§∫ÁÇ∫ÈÄæÊúüË®äÊÅØ
                const countdownContainer = document.getElementById(`countdown-container-${orderIdHash}`);
                if (countdownContainer) {
                    countdownContainer.innerHTML = `
                        <span style="color:#ff4444;font-size:13px;font-weight:700;width:100%;text-align:center;">‚ùå ‰ªòÊ¨æÊôÇÈôêÂ∑≤ÈÅéÔºåË®ÇÂñÆÂ∑≤ÂèñÊ∂à</span>
                    `;
                    countdownContainer.style.background = 'rgba(255,0,0,0.15)';
                    countdownContainer.style.border = '1.5px solid #ff4444';
                }
                
                // Èö±Ëóè‰ªòÊ¨æËº∏ÂÖ•ÂçÄ
                const paymentSection = document.getElementById('payment-code-section');
                if (paymentSection) {
                    paymentSection.innerHTML = `
                        <div style="color:#ff4444;font-weight:700;font-size:13px;text-align:center;">‚ùå ‰ªòÊ¨æÊôÇÈôêÂ∑≤ÈÅéÔºåË®ÇÂñÆÂ∑≤Ëá™ÂãïÂèñÊ∂à</div>
                    `;
                }
                
                return;
            }
            
            const hours = Math.floor(remaining / (1000 * 60 * 60));
            const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
            
            countdownEl.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        } catch (e) {
            clearInterval(timer);
        }
    }, 1000);
    
    // ÂÑ≤Â≠òtimer‰ª•‰æøÊ∏ÖÁêÜ
    if (!window.orderTimers) window.orderTimers = {};
    window.orderTimers[orderIdHash] = timer;
}

// ==========================================
// üî• Ëá™ÂãïÂèñÊ∂àÈÄæÊôÇË®ÇÂñÆ
// ==========================================
async function cancelExpiredOrder(orderId) {
    try {
        console.log('üî• Ëá™ÂãïÂèñÊ∂àÈÄæÊôÇË®ÇÂñÆ:', orderId);
        await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({
                action: 'cancelExpiredOrder',
                orderId: orderId
            })
        });
        console.log('‚úÖ ÂèñÊ∂àË´ãÊ±ÇÂ∑≤ÈÄÅÂá∫');
    } catch (error) {
        console.error('‚ùå ÂèñÊ∂àË®ÇÂñÆÂ§±Êïó:', error);
    }
}

// ==========================================
// üÜï Êèê‰∫§ÂåØÊ¨æÊú´‰∫îÁ¢º / LINE Pay ÂêçÁ®±
// ==========================================
async function submitPaymentCode(orderId) {
    // üî• ÂÑ™ÂÖàÁî®ÂÇ≥ÂÖ•ÁöÑ orderIdÔºåËã•ÁÑ°ÂâáÂæû window._currentOrderId Âèñ
    if (!orderId) orderId = window._currentOrderId;
    if (!orderId) { showToast('Êâæ‰∏çÂà∞Ë®ÇÂñÆÁ∑®Ëôü', 'error'); return; }
    const input = document.getElementById('payment-code-input');
    if (!input) { showToast('Êâæ‰∏çÂà∞Ëº∏ÂÖ•Ê¨Ñ‰Ωç', 'error'); return; }
    
    const paymentCode = input.value.trim();
    // üî• ÊîπÁî® data-payment-type Âà§Êñ∑ÔºåÊØî placeholder Êõ¥ÂèØÈù†
    const isLinePay = input.dataset.paymentType === 'linepay';
    let finalCode = paymentCode;
    
    if (!isLinePay) {
        if (!paymentCode) { showToast('Ë´ãËº∏ÂÖ•ÂåØÊ¨æÊú´‰∫îÁ¢º', 'error'); input.focus(); return; }
        if (paymentCode.length !== 5) { showToast('Ë´ãËº∏ÂÖ•ÂÆåÊï¥ÁöÑ5Á¢º', 'error'); input.focus(); return; }
        if (!/^\d{5}$/.test(paymentCode)) { showToast('Ë´ãËº∏ÂÖ•5‰ΩçÊï∏Â≠ó', 'error'); input.focus(); return; }
        if (!confirm(`Á¢∫Ë™çÂåØÊ¨æÊú´‰∫îÁ¢ºÁÇ∫Ôºö${paymentCode}Ôºü\n\nÈÄÅÂá∫ÂæåÂ∞áÊõ¥Êñ∞Ë®ÇÂñÆÁãÄÊÖãÁÇ∫„ÄåÂ∑≤‰ªòÊ¨æ„Äç`)) return;
    } else {
        if (!paymentCode) { showToast('Ë´ãËº∏ÂÖ• LINE È°ØÁ§∫ÂêçÁ®±', 'error'); input.focus(); return; }
        finalCode = 'LINE:' + paymentCode;
        if (!confirm(`Á¢∫Ë™ç LINE È°ØÁ§∫ÂêçÁ®±ÁÇ∫Ôºö${paymentCode}Ôºü\n\nÈÄÅÂá∫ÂæåÂ∞áÊõ¥Êñ∞Ë®ÇÂñÆÁãÄÊÖãÁÇ∫„ÄåÂ∑≤‰ªòÊ¨æ„Äç`)) return;
    }
    
    // btn Âú® try Â§ñÔºåcatch ÊâçËÉΩÁî®
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '‚è≥ ËôïÁêÜ‰∏≠...';
    btn.disabled = true;
    
    try {
        // no-cors Ê®°ÂºèÈÄÅÂá∫Ôºå‰∏çÁ≠âÂõûÂÇ≥
        await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({
                action: 'updatePaymentCode',
                orderId: orderId,
                paymentCode: finalCode
            })
        });
        
        // ÂÅúÊ≠¢ÂÄíÊï∏Ë®àÊôÇÂô®
        const orderIdHash = orderId.replace(/[^a-zA-Z0-9]/g, '');
        if (window.orderTimers && window.orderTimers[orderIdHash]) {
            clearInterval(window.orderTimers[orderIdHash]);
            delete window.orderTimers[orderIdHash];
        }
        
        // Èö±ËóèÂÄíÊï∏ÂçÄÂ°ä
        const countdownEl = document.getElementById('countdown-' + orderIdHash);
        if (countdownEl) {
            let box = countdownEl.parentElement;
            while (box && box !== document.body) {
                if (box.style && box.style.border) { box.style.display = 'none'; break; }
                box = box.parentElement;
            }
        }
        
        // Êõ¥Êñ∞‰ªòÊ¨æÊ¨Ñ‰ΩçÈ°ØÁ§∫
        const section = document.getElementById('payment-code-section');
        if (section) {
            const label = isLinePay ? 'LINE È°ØÁ§∫ÂêçÁ®±' : 'ÂåØÊ¨æÊú´‰∫îÁ¢º';
            section.innerHTML = `
                <div style="color:#999;font-size:12px;margin-bottom:5px;">${label}</div>
                <div style="color:#00FF00;font-weight:700;font-size:14px;">‚úÖ ${paymentCode}</div>
            `;
        }
        
        // ÊääÈÄÅÂá∫ÊåâÈàïÊèõÊàêÊàêÂäüË®äÊÅØÔºå‰øùÊåÅÂú®ÂéüÈ†ÅÈù¢
        btn.parentElement.innerHTML = `
            <div style="background:rgba(0,255,0,0.2);border:2px solid #00c800;padding:20px;
                border-radius:15px;color:#00FF00;font-weight:700;text-align:center;font-size:16px;">
                ‚úÖ ‰ªòÊ¨æÂ∑≤Á¢∫Ë™çÔºåÁ≠âÂæÖÂïÜÂÆ∂ËôïÁêÜ
            </div>
        `;
        
        showToast('‚úÖ ‰ªòÊ¨æÁ¢∫Ë™çÊàêÂäüÔºÅ', 'success');
        
    } catch (error) {
        console.error('Êèê‰∫§‰ªòÊ¨æÁ¢ºÂ§±Êïó:', error);
        showToast('‚ùå Êèê‰∫§Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

function closeOrderDetail() {
    if (window.orderTimers) {
        Object.values(window.orderTimers).forEach(timer => clearInterval(timer));
        window.orderTimers = {};
    }
    const detailView = document.getElementById('orderDetailView');
    if (detailView) detailView.remove();
    isModalOpen = false;
    
    // üî• Ëã•ÊòØÂæûÊü•Ë©¢Ë®ÇÂñÆÈÄ≤‰æÜÁöÑÔºåËøîÂõûÊôÇÈáçÊñ∞È°ØÁ§∫Ë®ÇÂñÆÂàóË°®
    if (window._orderDetailFromSearch) {
        window._orderDetailFromSearch = false;
        const orderSearchModal = document.getElementById('orderSearchModal');
        orderSearchModal.style.display = '';   // ÊÅ¢Âæ© display
        orderSearchModal.classList.add('active');
        isModalOpen = true;
        // Ë£ú‰∏ÄÁ≠Ü history stateÔºåËÆìÂÜçÊåâËøîÂõûÂèØ‰ª•ÈóúÊéâ orderSearch
        history.pushState({ modal: 'orderSearch' }, '');
    }
}

async function loadMemberOrders() {
    if (!currentMember || !currentMember.lineId) {
        document.getElementById('ordersList').innerHTML = `
            <div style="text-align:center; padding:40px; color:#999;">
                <div style="font-size:40px; margin-bottom:20px;">üîê</div>
                <div>Ë´ãÂÖàÁôªÂÖ•</div>
            </div>
        `;
        return;
    }
    
    try {
        const response = await fetch(`${APPS_SCRIPT_URL}?action=getOrdersByLine&lineId=${encodeURIComponent(currentMember.lineId)}`);
        const result = await response.json();
        
        const ordersList = document.getElementById('ordersList');
        
        if (result.success && result.orders && result.orders.length > 0) {
            // üî• ÂÖàÂÑ≤Â≠òË®ÇÂñÆË≥áÊñôÔºåÂÜçÊ∏≤Êüì HTMLÔºàÈÅøÂÖç onclick ÊôÇË≥áÊñôÈÇÑÊ≤íÊ∫ñÂÇôÂ•ΩÔºâ
            window.memberOrders = result.orders;
            
            // È°ØÁ§∫Ë®ÇÂñÆÂàóË°® + Á∏ΩÁ≠ÜÊï∏Ôºå‰∏ÄÊ¨°ÂØ´ÂÖ•ÈÅøÂÖç innerHTML+= Á†¥Â£û‰∫ã‰ª∂
            ordersList.innerHTML = result.orders.map((order, index) => `
                <div class="order-card" data-order-index="${index}" style="
                    background: rgba(255, 255, 255, 0.05);
                    border: 1.5px solid rgba(255, 215, 0, 0.4);
                    border-radius: 14px;
                    padding: 20px 18px;
                    margin-bottom: 16px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                ">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:14px; border-bottom:1px solid rgba(255,215,0,0.2); padding-bottom:12px;">
                        <div>
                            <div style="font-size:20px; font-weight:900; color:var(--primary);">
                                Ë®ÇÂñÆ #${index + 1}
                            </div>
                            <div style="font-size:13px; color:#aaa; margin-top:5px;">
                                ${order.Ë®ÇË≥ºÊôÇÈñì}
                            </div>
                        </div>
                        <div style="
                            background: ${order.Ë®ÇÂñÆÁãÄÊÖã === 'Â∑≤ÂÆåÊàê' ? 'var(--accent-green)' : order.Ë®ÇÂñÆÁãÄÊÖã === 'ÂæÖËôïÁêÜ' ? '#ffa500' : order.Ë®ÇÂñÆÁãÄÊÖã === 'ÂèñÊ∂àË®ÇÂñÆ' || order.Ë®ÇÂñÆÁãÄÊÖã === 'Ë®ÇÂñÆÂèñÊ∂à' ? '#ff4444' : order.Ë®ÇÂñÆÁãÄÊÖã === 'Â∑≤‰ªòÊ¨æÂæÖÂá∫Ë≤®' ? '#00bfff' : 'var(--primary)'};
                            color: var(--secondary);
                            padding: 7px 18px;
                            border-radius: 20px;
                            font-size: 14px;
                            font-weight: 900;
                        ">
                            ${order.Ë®ÇÂñÆÁãÄÊÖã}
                        </div>
                    </div>
                    
                    <div style="line-height:2; font-size:16px;">
                        <div><span style="color:#aaa;">Ë®ÇÂñÆÁ∑®Ëôü</span>„ÄÄ<strong style="color:#fff;">${order.Ë®ÇÂñÆÁ∑®Ëôü}</strong></div>
                        <div><span style="color:#aaa;">Á∏ΩÈáëÈ°ç</span>„ÄÄ<span style="color:var(--primary); font-size:22px; font-weight:900;">$${order.Á∏ΩÈáëÈ°ç}</span></div>
                        <div style="margin-top:8px; color:#bbb; font-size:14px; line-height:1.6;">
                            ${order.ÂïÜÂìÅÊòéÁ¥∞.length > 60 ? order.ÂïÜÂìÅÊòéÁ¥∞.substring(0, 60) + '...' : order.ÂïÜÂìÅÊòéÁ¥∞}
                        </div>
                    </div>
                    
                    <div style="margin-top:14px; padding-top:14px; border-top:1px solid rgba(255,215,0,0.2); text-align:center;">
                        <span style="color:var(--primary); font-size:16px; font-weight:900; letter-spacing:1px;">
                            üëâ ÈªûÊìäÊü•ÁúãË©≥ÊÉÖ
                        </span>
                    </div>
                </div>
            `).join('') + `
                <div style="text-align:center; padding:20px; color:#999; font-size:15px;">
                    ÂÖ± ${result.orders.length} Á≠ÜË®ÇÂñÆ
                </div>
            `;
            // üî• Áî®‰∫ã‰ª∂ÂßîÊ¥æÁ∂ÅÂÆöÈªûÊìäÔºàÈÅøÂÖçÁâπÊÆäÂ≠óÂÖÉÁ†¥Â£û onclick Â≠ó‰∏≤Ôºâ
            ordersList.onclick = function(e) {
                const card = e.target.closest('.order-card');
                if (!card) return;
                const idx = parseInt(card.dataset.orderIndex);
                if (!isNaN(idx)) showOrderDetail(idx);
            };
            
        } else {
            // Ê≤íÊúâË®ÇÂñÆ
            ordersList.innerHTML = `
                <div style="text-align:center; padding:60px 20px; color:#999;">
                    <div style="font-size:60px; margin-bottom:20px;">üì¶</div>
                    <div style="font-size:18px; font-weight:700; margin-bottom:10px;">Â∞öÁÑ°Ë®ÇÂñÆË®òÈåÑ</div>
                    <div style="font-size:14px;">ÈñãÂßãË≥ºÁâ©ÔºåÂª∫Á´ãÊÇ®ÁöÑÁ¨¨‰∏ÄÁ≠ÜË®ÇÂñÆÂêßÔºÅ</div>
                </div>
            `;
        }
    } catch (error) {
        console.error('Êü•Ë©¢Ë®ÇÂñÆÂ§±Êïó:', error);
        document.getElementById('ordersList').innerHTML = `
            <div style="text-align:center; padding:40px; color:#ff4444;">
                <div style="font-size:40px; margin-bottom:20px;">‚ùå</div>
                <div>Êü•Ë©¢Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶</div>
            </div>
        `;
    }
}

// ==========================================
// üî• ËÉåÊôØËá™ÂãïÊéÉÊèèÈÄæÊôÇË®ÇÂñÆÔºà‰∏çÈúÄÈñãË©≥ÊÉÖÈ†ÅÂ∞±ÊúÉËá™ÂãïÂèñÊ∂àÔºâ
// ==========================================
async function autoCheckExpiredOrders() {
    if (!currentMember || !currentMember.lineId) return;
    try {
        const response = await fetch(`${APPS_SCRIPT_URL}?action=getOrdersByLine&lineId=${encodeURIComponent(currentMember.lineId)}`);
        const result = await response.json();
        if (!result.success || !result.orders) return;

        const now = new Date();
        result.orders.forEach(order => {
            // Âè™ËôïÁêÜ 7-11„ÄÅÂæÖËôïÁêÜ„ÄÅÊú™‰ªòÊ¨æÁöÑË®ÇÂñÆ
            if (order.ÂèñË≤®ÊñπÂºè !== '7-11Â∫óÂà∞Â∫ó') return;
            if (['ÂèñÊ∂àË®ÇÂñÆ','Ë®ÇÂñÆÂèñÊ∂à','Â∑≤ÂèñÊ∂à','Â∑≤‰ªòÊ¨æÂæÖÂá∫Ë≤®','Â∑≤ÂÆåÊàê'].includes(order.Ë®ÇÂñÆÁãÄÊÖã)) return;

            // Êú™‰ªòÊ¨æÂà§Êñ∑ÔºöLINE Pay ÁúãË®ÇÂñÆÁãÄÊÖãÔºåÂåØÊ¨æÁúãÊú´‰∫îÁ¢º
            const isLinePay = order.‰ªòÊ¨æÊñπÂºè === 'LINE Pay';
            const hasPaid = isLinePay
                ? order.Ë®ÇÂñÆÁãÄÊÖã === 'Â∑≤‰ªòÊ¨æÂæÖÂá∫Ë≤®'
                : (order.ÂåØÊ¨æÊú´‰∫îÁ¢º && order.ÂåØÊ¨æÊú´‰∫îÁ¢º !== '-' && order.ÂåØÊ¨æÊú´‰∫îÁ¢º !== '' && !order.ÂåØÊ¨æÊú´‰∫îÁ¢º.startsWith('LINE:'));
            if (hasPaid) return;

            const orderTime = new Date(order.Ë®ÇË≥ºÊôÇÈñì);
            if (isNaN(orderTime)) return;
            const deadline = new Date(orderTime.getTime() + 60 * 1000); // 1ÂàÜÈêò
            if (now >= deadline) {
                console.log('üî• ËÉåÊôØÊéÉÊèèÔºöÁôºÁèæÈÄæÊôÇË®ÇÂñÆÔºåËá™ÂãïÂèñÊ∂à', order.Ë®ÇÂñÆÁ∑®Ëôü);
                cancelExpiredOrder(order.Ë®ÇÂñÆÁ∑®Ëôü);
            }
        });
    } catch (e) {
        // ËÉåÊôØÊéÉÊèèÂ§±Êïó‰∏çÂΩ±Èüø‰ΩøÁî®
    }
}


function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = 'toast show ' + (type === 'error' ? 'error' : '');
    setTimeout(() => toast.classList.remove('show'), 3000);
}

// ==========================================
// LINE ÁôªÂÖ•ÂäüËÉΩ
// ==========================================

function lineLogin() {
    const url = `https://access.line.me/oauth2/v2.1/authorize?` +
        `response_type=code` +
        `&client_id=${LINE_CHANNEL_ID}` +
        `&redirect_uri=${encodeURIComponent(LINE_REDIRECT_URI)}` +
        `&state=${LINE_STATE}` +
        `&scope=profile%20openid`;
    
    window.location.href = url;
}

async function checkMemberStatus() {
    const memberData = localStorage.getItem('candyboss_member');
    if (memberData) {
        try {
            currentMember = JSON.parse(memberData);
        } catch (e) {
            console.error('ÊúÉÂì°Ë≥áÊñôËß£ÊûêÈåØË™§:', e);
            localStorage.removeItem('candyboss_member');
            currentMember = null;
            showLoginWall();
            return;
        }
        
        // ÂÖàÁ´ãÂàªÈ°ØÁ§∫ UIÔºàÈÅøÂÖçÁï´Èù¢Âç°ÁôΩÔºâÔºåÂÜçËÉåÊôØÂêåÊ≠•ÂØ©Ê†∏ÁãÄÊÖã
        updateMemberUI();
        
        // ËÉåÊôØÊõ¥Êñ∞ÂØ©Ê†∏ÁãÄÊÖãÔºà‰∏çÈòªÂ°û UIÔºâ
        fetchMemberApprovalStatus().then(() => {
            updateMemberUI();
        }).catch(e => {
            console.warn('ÂØ©Ê†∏ÁãÄÊÖãÂêåÊ≠•Â§±ÊïóÔºà‰∏çÂΩ±ÈüøÁôªÂÖ•Ôºâ:', e);
        });
    } else {
        showLoginWall();
    }
}

async function fetchMemberApprovalStatus() {
    if (!currentMember || !currentMember.lineId) return;
    
    try {
        // Âä†‰∏ä 5 Áßí timeoutÔºåÈÅøÂÖç Apps Script ÊÖ¢ÂõûÊáâËÆìÈ†ÅÈù¢Âç°‰Ωè
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        
        const response = await fetch(
            `${APPS_SCRIPT_URL}?action=getMember&lineId=${encodeURIComponent(currentMember.lineId)}`,
            { signal: controller.signal }
        );
        clearTimeout(timeoutId);
        
        const result = await response.json();
        
        if (result.success && result.member) {
            // Êõ¥Êñ∞ÂØ©Ê†∏ÁãÄÊÖãÂà∞ localStorage
            currentMember.approvalStatus = result.member.approvalStatus || 'ÂæÖÂØ©Ê†∏';
            if (result.member.phone) currentMember.phone = result.member.phone;
            if (result.member.email) currentMember.email = result.member.email;
            localStorage.setItem('candyboss_member', JSON.stringify(currentMember));
        }
    } catch (error) {
        console.warn('ÂèñÂæóÂØ©Ê†∏ÁãÄÊÖãÂ§±ÊïóÔºàÂ∞á‰ΩøÁî®Êú¨Âú∞Âø´ÂèñÔºâ:', error.name === 'AbortError' ? 'Timeout' : error.message);
        // Â¶ÇÊûúÂèñÂæóÂ§±ÊïóÔºåÁ∂≠ÊåÅ localStorage Ë£°Â∑≤ÊúâÁöÑÁãÄÊÖãÔºà‰∏çÊ∏ÖÁ©∫Ôºâ
        currentMember.approvalStatus = currentMember.approvalStatus || 'ÂæÖÂØ©Ê†∏';
    }
}

function showLoginWall() {
    document.getElementById('loginWall').style.display = 'flex';
    document.getElementById('pendingApproval').style.display = 'none';
    document.getElementById('rejectedApproval').style.display = 'none';
    document.getElementById('productsSection').style.display = 'none';
    
    // üî• ‰øÆÊ≠£ÔºöÈ°ØÁ§∫Â∞éËà™ÊåâÈàïÂçÄÂüüÔºå‰∏¶È°ØÁ§∫ LINE ÁôªÂÖ•ÊåâÈàï
    document.getElementById('navButtons').style.display = 'flex';
    document.getElementById('lineLoginBtn').style.display = 'block';
    document.getElementById('memberInfo').style.display = 'none';
}

function updateMemberUI() {
    if (currentMember) {
        // È°ØÁ§∫Â∞éËà™ÊåâÈàïÂçÄ
        document.getElementById('navButtons').style.display = 'flex';
        document.getElementById('lineLoginBtn').style.display = 'none';
        document.getElementById('memberInfo').style.display = 'flex';
        document.getElementById('memberAvatar').src = currentMember.pictureUrl || '';
        // ‰∏çÈ°ØÁ§∫ÂêçÁ®±
        
        // Ê†πÊìöÂØ©Ê†∏ÁãÄÊÖãÈ°ØÁ§∫‰∏çÂêåÂÖßÂÆπ
        const approvalStatus = currentMember.approvalStatus || 'ÂæÖÂØ©Ê†∏';
        
        if (approvalStatus === 'Â∑≤ÈÄöÈÅé') {
            // ÂØ©Ê†∏ÈÄöÈÅéÔºöÈ°ØÁ§∫ÂïÜÂìÅ
            document.getElementById('loginWall').style.display = 'none';
            document.getElementById('pendingApproval').style.display = 'none';
            document.getElementById('rejectedApproval').style.display = 'none';
            document.getElementById('productsSection').style.display = 'block';
            
            // Ëá™ÂãïÂ°´ÂÖ•ÊúÉÂì°Ë≥áÊñôÂà∞ÁµêÂ∏≥Ë°®ÂñÆ
            if (currentMember.phone) {
                const phoneInput = document.getElementById('customerPhone');
                if (phoneInput && phoneInput.value === '') {
                    phoneInput.value = currentMember.phone;
                }
            }
            if (currentMember.displayName) {
                const nameInput = document.getElementById('customerName');
                if (nameInput && nameInput.value === '') {
                    nameInput.value = currentMember.displayName;
                }
            }
        } else if (approvalStatus === 'Â∑≤ÊãíÁµï') {
            // ÂØ©Ê†∏ÊãíÁµï
            document.getElementById('loginWall').style.display = 'none';
            document.getElementById('pendingApproval').style.display = 'none';
            document.getElementById('rejectedApproval').style.display = 'flex';
            document.getElementById('productsSection').style.display = 'none';
        } else {
            // ÂæÖÂØ©Ê†∏
            document.getElementById('loginWall').style.display = 'none';
            document.getElementById('pendingApproval').style.display = 'flex';
            document.getElementById('rejectedApproval').style.display = 'none';
            document.getElementById('productsSection').style.display = 'none';
        }
    } else {
        document.getElementById('lineLoginBtn').style.display = 'block';
        document.getElementById('memberInfo').style.display = 'none';
        showLoginWall();
    }
}

async function checkApprovalStatus() {
    showToast('Ê™¢Êü•‰∏≠...', 'success');
    await fetchMemberApprovalStatus();
    updateMemberUI();
    
    if (currentMember.approvalStatus === 'Â∑≤ÈÄöÈÅé') {
        showToast('ÂØ©Ê†∏Â∑≤ÈÄöÈÅéÔºÅÊ≠°ËøéË≥ºÁâ©ÔºÅ');
    } else if (currentMember.approvalStatus === 'Â∑≤ÊãíÁµï') {
        showToast('ÂØ©Ê†∏Êú™ÈÄöÈÅé', 'error');
    } else {
        showToast('‰ªçÂú®ÂØ©Ê†∏‰∏≠ÔºåË´ãËÄêÂøÉÁ≠âÂÄô', 'error');
    }
}

function logout() {
    if (confirm('Á¢∫ÂÆöË¶ÅÁôªÂá∫ÂóéÔºü')) {
        // Ê∏ÖÈô§ÊúÉÂì°Ë≥áÊñô
        currentMember = null;
        localStorage.removeItem('candyboss_member');
        
        // ÈáçÁΩÆ UI
        document.getElementById('lineLoginBtn').style.display = 'block';
        document.getElementById('memberInfo').style.display = 'none';
        
        // È°ØÁ§∫ÁôªÂÖ•ÁâÜÔºåÈö±ËóèÂÖ∂‰ªñÊâÄÊúâÂÖßÂÆπ
        document.getElementById('loginWall').style.display = 'flex';
        document.getElementById('pendingApproval').style.display = 'none';
        document.getElementById('rejectedApproval').style.display = 'none';
        document.getElementById('productsSection').style.display = 'none';
        
        showToast('Â∑≤ÁôªÂá∫');
        
        // ÁÇ∫‰∫ÜÁ¢∫‰øùÔºå3ÁßíÂæåÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢
        setTimeout(() => {
            window.location.reload();
        }, 1500);
    }
}

// ==========================================
// ÊúÉÂì°Ë≥áÊñôÊü•ÁúãËàáÁ∑®ËºØ
// ==========================================

function openMemberProfileModal() {
    if (!currentMember) {
        showToast('Ë´ãÂÖàÁôªÂÖ•', 'error');
        return;
    }
    
    // Â°´ÂÖ•ÊúÉÂì°Ë≥áÊñô
    document.getElementById('profileAvatar').src = currentMember.pictureUrl || '';
    document.getElementById('profileDisplayName').textContent = currentMember.displayName || 'Êú™Ë®≠ÂÆö';
    document.getElementById('profilePhone').textContent = currentMember.phone || 'Êú™Ë®≠ÂÆö';
    document.getElementById('profileEmail').textContent = currentMember.email || 'Êú™Ë®≠ÂÆö';
    document.getElementById('profileLineId').textContent = currentMember.lineId || '';
    
    // È°ØÁ§∫ÂØ©Ê†∏ÁãÄÊÖã
    const approvalStatus = currentMember.approvalStatus || 'ÂæÖÂØ©Ê†∏';
    const statusElement = document.getElementById('profileApprovalStatus');
    statusElement.textContent = approvalStatus;
    
    // Ê†πÊìöÁãÄÊÖãÊîπËÆäÈ°èËâ≤
    if (approvalStatus === 'Â∑≤ÈÄöÈÅé') {
        statusElement.style.color = 'var(--accent-green)';
    } else if (approvalStatus === 'Â∑≤ÊãíÁµï') {
        statusElement.style.color = '#ff4444';
    } else {
        statusElement.style.color = '#ffa500';
    }
    
    // È°ØÁ§∫ÂΩàÁ™ó
    document.getElementById('memberProfileModal').classList.add('active');
}

function closeMemberProfileModal() {
    document.getElementById('memberProfileModal').classList.remove('active');
}

function openEditProfileModal() {
    // ÈóúÈñâÊü•ÁúãÂΩàÁ™ó
    closeMemberProfileModal();
    
    // Â°´ÂÖ•ÁèæÊúâË≥áÊñô
    document.getElementById('updatePhone').value = currentMember.phone || '';
    document.getElementById('updateEmail').value = currentMember.email || '';
    
    // È°ØÁ§∫Á∑®ËºØÂΩàÁ™ó
    document.getElementById('profileUpdateModal').classList.add('active');
}

function closeProfileUpdateModal() {
    document.getElementById('profileUpdateModal').classList.remove('active');
}

async function submitProfileUpdate() {
    const phone = document.getElementById('updatePhone').value.trim();
    const email = document.getElementById('updateEmail').value.trim();
    
    // È©óË≠âÈõªË©±
    if (!phone) {
        showToast('Ë´ãËº∏ÂÖ•ÈõªË©±ËôüÁ¢º', 'error');
        return;
    }
    
    // È©óË≠âÈõªË©±Ê†ºÂºèÔºàÂè∞ÁÅ£ÊâãÊ©üËôüÁ¢ºÔºâ
    const phonePattern = /^09\d{8}$/;
    if (!phonePattern.test(phone)) {
        showToast('Ë´ãËº∏ÂÖ•Ê≠£Á¢∫ÁöÑÊâãÊ©üËôüÁ¢ºÊ†ºÂºèÔºà‰æãÔºö0912345678Ôºâ', 'error');
        return;
    }
    
    if (!currentMember) {
        showToast('ÊúÉÂì°Ë≥áÊñôÁï∞Â∏∏ÔºåË´ãÈáçÊñ∞ÁôªÂÖ•', 'error');
        return;
    }
    
    try {
        showToast('Êõ¥Êñ∞‰∏≠...', 'success');
        
        // Êõ¥Êñ∞Âà∞ Google Sheets
        await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                action: 'saveMember',
                lineId: currentMember.lineId,
                displayName: currentMember.displayName,
                pictureUrl: currentMember.pictureUrl,
                phone: phone,
                email: email
            })
        });
        
        // Êõ¥Êñ∞Êú¨Âú∞Ë≥áÊñô
        currentMember.phone = phone;
        currentMember.email = email;
        localStorage.setItem('candyboss_member', JSON.stringify(currentMember));
        
        // ÈóúÈñâÂΩàÁ™ó
        closeProfileUpdateModal();
        showToast('Ë≥áÊñôÊõ¥Êñ∞ÊàêÂäüÔºÅ');
        
    } catch (error) {
        console.error('Êõ¥Êñ∞Â§±Êïó:', error);
        showToast('Êõ¥Êñ∞Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
    }
}

// ==========================================
// ÂàùÂßãÂåñ
// ==========================================
window.addEventListener('load', () => {
    console.log('üöÄ È†ÅÈù¢ËºâÂÖ•ÂÆåÊàê');
    
    // üî• Èò≤Ê≠¢ÈõôÊìäÊîæÂ§ßÔºàÂæπÂ∫ïËß£Ê±∫ÊñπÊ°àÔºâ
    let lastTouchEnd = 0;
    document.addEventListener('touchend', (event) => {
        const now = Date.now();
        if (now - lastTouchEnd <= 300) {
            event.preventDefault(); // ÈòªÊ≠¢ÈõôÊìä‰∫ã‰ª∂
        }
        lastTouchEnd = now;
    }, false);
    
    // Ê≠£Â∏∏ÂàùÂßãÂåñ
    loadProductsData();
    loadSystemSettings();
    updateCart();
    checkMemberStatus();
    
    // üî• ÂïüÂãïËá™ÂãïÂà∑Êñ∞Â∫´Â≠òÂäüËÉΩ
    startAutoRefresh(30);

    // üî• ËÉåÊôØÊéÉÊèèÈÄæÊôÇË®ÇÂñÆÔºàÁôªÂÖ•Âæå30ÁßíÈñãÂßãÔºå‰πãÂæåÊØè60ÁßíÊéÉ‰∏ÄÊ¨°Ôºâ
    setTimeout(() => {
        autoCheckExpiredOrders();
        setInterval(autoCheckExpiredOrders, 60 * 1000);
    }, 30000);
});

// Áï∂Áî®Êà∂Èõ¢ÈñãÈ†ÅÈù¢ÊôÇÔºåÂÅúÊ≠¢Ëá™ÂãïÂà∑Êñ∞‰ª•ÁØÄÁúÅË≥áÊ∫ê
window.addEventListener('beforeunload', () => {
    stopAutoRefresh();
});
    </script>
</body>
</html>
