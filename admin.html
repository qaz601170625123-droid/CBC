<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CANDY BOSS å¾Œå°ç®¡ç†</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FFD700;
            --bg-dark: #0a0a0a;
            --bg-card: rgba(255,255,255,0.05);
            --border: rgba(255,215,0,0.3);
            --text: #fff;
            --text-muted: #999;
            --green: #00FF00;
            --red: #ff4444;
            --blue: #00bfff;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            background: var(--bg-dark);
            color: var(--text);
            font-family: 'Noto Sans TC', sans-serif;
            min-height: 100vh;
        }

        /* ===== ç™»å…¥ç•«é¢ ===== */
        #loginScreen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        .login-box {
            background: rgba(255,215,0,0.05);
            border: 2px solid var(--primary);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 400px;
            width: 100%;
        }
        .login-logo {
            font-family: 'Orbitron', monospace;
            font-size: 28px;
            font-weight: 900;
            color: var(--primary);
            margin-bottom: 8px;
        }
        .login-subtitle {
            color: var(--text-muted);
            font-size: 14px;
            margin-bottom: 30px;
        }
        .line-login-btn {
            background: #06C755;
            color: #fff;
            border: none;
            padding: 14px 30px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .line-login-btn:hover { background: #05a847; }
        #loginError {
            display: none;
            margin-top: 20px;
            padding: 12px;
            background: rgba(255,68,68,0.2);
            border: 1px solid var(--red);
            border-radius: 8px;
            color: var(--red);
            font-size: 14px;
        }

        /* ===== ä¸»å¾Œå°ç•«é¢ ===== */
        #adminScreen { display: none; }

        /* é ‚éƒ¨å°è¦½ */
        .admin-header {
            background: rgba(0,0,0,0.9);
            border-bottom: 2px solid var(--primary);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .admin-logo {
            font-family: 'Orbitron', monospace;
            font-size: 18px;
            font-weight: 900;
            color: var(--primary);
        }
        .admin-user {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: var(--text-muted);
        }
        .admin-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid var(--primary);
        }
        .logout-btn {
            background: transparent;
            border: 1px solid #666;
            color: #999;
            padding: 5px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        /* åˆ†é æ¨™ç±¤ */
        .tab-bar {
            display: flex;
            background: rgba(0,0,0,0.5);
            border-bottom: 1px solid var(--border);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .tab-btn {
            flex-shrink: 0;
            padding: 14px 20px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }
        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        /* å…§å®¹å€ */
        .tab-content { display: none; padding: 20px; max-width: 900px; margin: 0 auto; }
        .tab-content.active { display: block; }

        /* é€šç”¨å¡ç‰‡ */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }
        .card-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* è¡¨å–®å…ƒç´  */
        .form-group { margin-bottom: 14px; }
        .form-label { display: block; color: var(--text-muted); font-size: 12px; margin-bottom: 6px; }
        .form-input {
            width: 100%;
            padding: 10px;
            background: rgba(0,0,0,0.5);
            border: 2px solid rgba(255,215,0,0.3);
            border-radius: 8px;
            color: var(--primary);
            font-size: 14px;
            font-family: inherit;
        }
        .form-input:focus { outline: none; border-color: var(--primary); }
        select.form-input { cursor: pointer; }

        /* æŒ‰éˆ• */
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 700;
            cursor: pointer;
            font-size: 14px;
            font-family: inherit;
        }
        .btn-primary { background: var(--primary); color: #000; }
        .btn-primary:hover { background: #FFA500; }
        .btn-danger { background: transparent; border: 1px solid var(--red); color: var(--red); }
        .btn-success { background: transparent; border: 1px solid var(--green); color: var(--green); }
        .btn-sm { padding: 6px 12px; font-size: 12px; }

        /* ç‹€æ…‹æ¨™ç±¤ */
        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
        }
        .badge-pending { background: #ffa500; color: #000; }
        .badge-paid { background: var(--blue); color: #000; }
        .badge-done { background: var(--green); color: #000; }
        .badge-cancel { background: var(--red); color: #fff; }

        /* è¨‚å–®åˆ—è¡¨ */
        .order-row {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 10px;
        }
        .order-row-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .order-id { font-size: 13px; color: var(--text-muted); }
        .order-info { font-size: 14px; line-height: 1.8; }
        .order-actions { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }

        /* å…¬å‘Šåˆ—è¡¨ */
        .announcement-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .announcement-text-preview { flex: 1; font-size: 14px; }
        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            flex-shrink: 0;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider {
            position: absolute;
            inset: 0;
            background: #444;
            border-radius: 24px;
            cursor: pointer;
            transition: 0.3s;
        }
        .toggle-slider:before {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            left: 3px;
            top: 3px;
            background: #fff;
            border-radius: 50%;
            transition: 0.3s;
        }
        .toggle-switch input:checked + .toggle-slider { background: var(--green); }
        .toggle-switch input:checked + .toggle-slider:before { transform: translateX(20px); }

        /* åº«å­˜è¡¨æ ¼ */
        .stock-table { width: 100%; border-collapse: collapse; }
        .stock-table th {
            text-align: left;
            padding: 10px;
            color: var(--primary);
            font-size: 13px;
            border-bottom: 1px solid var(--border);
        }
        .stock-table td {
            padding: 10px;
            font-size: 14px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .stock-input-sm {
            width: 70px;
            padding: 5px 8px;
            background: rgba(0,0,0,0.5);
            border: 1px solid rgba(255,215,0,0.4);
            border-radius: 6px;
            color: var(--primary);
            font-size: 14px;
            text-align: center;
        }

        /* æœƒå“¡åˆ—è¡¨ */
        .member-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .member-avatar-sm {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--border);
            flex-shrink: 0;
        }
        .member-info { flex: 1; }
        .member-name { font-weight: 700; font-size: 14px; }
        .member-detail { font-size: 12px; color: var(--text-muted); }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(0,0,0,0.9);
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: 700;
            font-size: 14px;
            transition: transform 0.3s;
            z-index: 9999;
            white-space: nowrap;
        }
        .toast.show { transform: translateX(-50%) translateY(0); }
        .toast.error { border-color: var(--red); color: var(--red); }

        /* Loading */
        .loading { text-align: center; padding: 40px; color: var(--text-muted); }

        /* ç¯©é¸åˆ— */
        .filter-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        .filter-btn {
            padding: 6px 14px;
            border-radius: 20px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-muted);
            font-size: 13px;
            cursor: pointer;
        }
        .filter-btn.active {
            background: var(--primary);
            color: #000;
            border-color: var(--primary);
            font-weight: 700;
        }
    </style>
</head>
<body>

<!-- ===== ç™»å…¥ç•«é¢ ===== -->
<div id="loginScreen">
    <div class="login-box">
        <div class="login-logo">ğŸ¬ CANDY BOSS</div>
        <div class="login-subtitle">å¾Œå°ç®¡ç†ç³»çµ±</div>
        <button class="line-login-btn" onclick="lineLogin()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                <path d="M19.365 9.863c.349 0 .63.285.63.631 0 .345-.281.63-.63.63H17.61v1.125h1.755c.349 0 .63.283.63.63 0 .344-.281.629-.63.629h-2.386c-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63h2.386c.346 0 .627.285.627.63 0 .349-.281.63-.63.63H17.61v1.125h1.755zm-3.855 3.016c0 .27-.174.51-.432.596-.064.021-.133.031-.199.031-.211 0-.391-.09-.51-.25l-2.443-3.317v2.94c0 .344-.279.629-.631.629-.346 0-.626-.285-.626-.629V8.108c0-.27.173-.51.43-.595.06-.023.136-.033.194-.033.195 0 .375.104.495.254l2.462 3.33V8.108c0-.345.282-.63.63-.63.345 0 .63.285.63.63v4.771zm-5.741 0c0 .344-.282.629-.631.629-.345 0-.627-.285-.627-.629V8.108c0-.345.282-.63.63-.63.346 0 .628.285.628.63v4.771zm-2.466.629H4.917c-.345 0-.63-.285-.63-.629V8.108c0-.345.285-.63.63-.63.348 0 .63.285.63.63v4.141h1.756c.348 0 .629.283.629.63 0 .344-.281.629-.629.629M24 10.314C24 4.943 18.615.572 12 .572S0 4.943 0 10.314c0 4.811 4.27 8.842 10.035 9.608.391.082.923.258 1.058.59.12.301.079.766.038 1.08l-.164 1.02c-.045.301-.24 1.186 1.049.645 1.291-.539 6.916-4.078 9.436-6.975C23.176 14.393 24 12.458 24 10.314"/>
            </svg>
            ä½¿ç”¨ LINE ç™»å…¥
        </button>
        <div id="loginError">âš ï¸ æ‚¨æ²’æœ‰å¾Œå°ç®¡ç†æ¬Šé™</div>
        <div id="loginLoading" style="display:none; margin-top:15px; color:#999; font-size:13px;">â³ é©—è­‰ä¸­...</div>
    </div>
</div>

<!-- ===== å¾Œå°ä¸»ç•«é¢ ===== -->
<div id="adminScreen">
    <!-- é ‚éƒ¨ -->
    <div class="admin-header">
        <div class="admin-logo">âš™ï¸ å¾Œå°ç®¡ç†</div>
        <div class="admin-user">
            <img id="adminAvatar" class="admin-avatar" src="" alt="">
            <span id="adminName"></span>
            <button class="logout-btn" onclick="logout()">ç™»å‡º</button>
        </div>
    </div>

    <!-- åˆ†é æ¨™ç±¤ -->
    <div class="tab-bar">
        <button class="tab-btn active" onclick="switchTab('orders')">ğŸ“¦ è¨‚å–®</button>
        <button class="tab-btn" onclick="switchTab('announcements')">ğŸ“¢ å…¬å‘Š</button>
        <button class="tab-btn" onclick="switchTab('promotions')">ğŸ å„ªæƒ </button>
        <button class="tab-btn" onclick="switchTab('stock')">ğŸ“Š åº«å­˜</button>
        <button class="tab-btn" onclick="switchTab('members')">ğŸ‘¥ æœƒå“¡</button>
    </div>

    <!-- ===== è¨‚å–®ç®¡ç† ===== -->
    <div id="tab-orders" class="tab-content active">
        <div class="card">
            <div class="card-title">
                ğŸ“¦ è¨‚å–®ç®¡ç†
                <button class="btn btn-primary btn-sm" onclick="loadOrders()">ğŸ”„ é‡æ–°è¼‰å…¥</button>
            </div>
            <div class="filter-bar">
                <button class="filter-btn active" onclick="filterOrders('all', this)">å…¨éƒ¨</button>
                <button class="filter-btn" onclick="filterOrders('å¾…è™•ç†', this)">å¾…è™•ç†</button>
                <button class="filter-btn" onclick="filterOrders('å·²ä»˜æ¬¾å¾…å‡ºè²¨', this)">å·²ä»˜æ¬¾å¾…å‡ºè²¨</button>
                <button class="filter-btn" onclick="filterOrders('å·²å®Œæˆ', this)">å·²å®Œæˆ</button>
                <button class="filter-btn" onclick="filterOrders('å–æ¶ˆè¨‚å–®', this)">å·²å–æ¶ˆ</button>
            </div>
            <div id="ordersList"><div class="loading">â³ è¼‰å…¥ä¸­...</div></div>
        </div>
    </div>

    <!-- ===== å…¬å‘Šç®¡ç† ===== -->
    <div id="tab-announcements" class="tab-content">
        <!-- æ–°å¢å…¬å‘Š -->
        <div class="card">
            <div class="card-title">â• æ–°å¢å…¬å‘Š</div>
            <div class="form-group">
                <label class="form-label">å…¬å‘Šå…§å®¹</label>
                <input type="text" class="form-input" id="newAnnouncementText" placeholder="è¼¸å…¥å…¬å‘Šæ–‡å­—...">
            </div>
            <div class="form-group">
                <label class="form-label">é€£çµï¼ˆé¸å¡«ï¼‰</label>
                <input type="text" class="form-input" id="newAnnouncementLink" placeholder="https://...">
            </div>
            <button class="btn btn-primary" onclick="addAnnouncement()">â• æ–°å¢</button>
        </div>

        <!-- å…¬å‘Šåˆ—è¡¨ -->
        <div class="card">
            <div class="card-title">
                ğŸ“‹ å…¬å‘Šåˆ—è¡¨
                <button class="btn btn-primary btn-sm" onclick="loadAnnouncements()">ğŸ”„ é‡æ–°è¼‰å…¥</button>
            </div>
            <div id="announcementsList"><div class="loading">â³ è¼‰å…¥ä¸­...</div></div>
        </div>
    </div>

    <!-- ===== å„ªæƒ ç®¡ç† ===== -->
    <div id="tab-promotions" class="tab-content">
        <!-- æ–°å¢å„ªæƒ  -->
        <div class="card">
            <div class="card-title">â• æ–°å¢å„ªæƒ </div>
            <div class="form-group">
                <label class="form-label">å„ªæƒ åç¨±</label>
                <input type="text" class="form-input" id="newPromoName" placeholder="ä¾‹ï¼šæ»¿20åŒ…å„ªæƒ ">
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                <div class="form-group">
                    <label class="form-label">å„ªæƒ é¡å‹</label>
                    <select class="form-input" id="newPromoType">
                        <option value="æ»¿ä»¶æŠ˜æ‰£">æ»¿ä»¶æŠ˜æ‰£</option>
                        <option value="æ»¿é¡æŠ˜æ‰£">æ»¿é¡æŠ˜æ‰£</option>
                        <option value="æ»¿é¡å…é‹">æ»¿é¡å…é‹</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">å–®ä½</label>
                    <select class="form-input" id="newPromoUnit">
                        <option value="åŒ…">åŒ…</option>
                        <option value="æ¢">æ¢</option>
                        <option value="å…ƒ">å…ƒ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">é–€æª»æ•¸é‡/é‡‘é¡</label>
                    <input type="number" class="form-input" id="newPromoThreshold" placeholder="ä¾‹ï¼š20">
                </div>
                <div class="form-group">
                    <label class="form-label">æŠ˜æ‰£é‡‘é¡ï¼ˆæ¯å–®ä½ï¼‰</label>
                    <input type="number" class="form-input" id="newPromoDiscount" placeholder="ä¾‹ï¼š5">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">èªªæ˜æ–‡å­—ï¼ˆé¸å¡«ï¼‰</label>
                <input type="text" class="form-input" id="newPromoDesc" placeholder="ä¾‹ï¼šè²·20åŒ…æ¯åŒ…æŠ˜5å…ƒ">
            </div>
            <button class="btn btn-primary" onclick="addPromotion()">â• æ–°å¢å„ªæƒ </button>
        </div>

        <!-- å„ªæƒ åˆ—è¡¨ -->
        <div class="card">
            <div class="card-title">
                ğŸ å„ªæƒ åˆ—è¡¨
                <button class="btn btn-primary btn-sm" onclick="loadPromotions()">ğŸ”„ é‡æ–°è¼‰å…¥</button>
            </div>
            <div id="promotionsList"><div class="loading">â³ è¼‰å…¥ä¸­...</div></div>
        </div>
    </div>

    <!-- ===== åº«å­˜ç®¡ç† ===== -->
    <div id="tab-stock" class="tab-content">
        <div class="card">
            <div class="card-title">
                ğŸ“Š åº«å­˜ç®¡ç†
                <div style="display:flex; gap:8px;">
                    <button class="btn btn-primary btn-sm" onclick="saveStockChanges()">ğŸ’¾ å„²å­˜è®Šæ›´</button>
                    <button class="btn btn-sm" style="border:1px solid #666;color:#999;" onclick="loadStock()">ğŸ”„ é‡æ–°è¼‰å…¥</button>
                </div>
            </div>
            <div style="color:#999; font-size:12px; margin-bottom:12px;">ç›´æ¥ä¿®æ”¹æ•¸é‡å¾Œé»ã€Œå„²å­˜è®Šæ›´ã€</div>
            <div id="stockTable"><div class="loading">â³ è¼‰å…¥ä¸­...</div></div>
        </div>
    </div>

    <!-- ===== æœƒå“¡ç®¡ç† ===== -->
    <div id="tab-members" class="tab-content">
        <div class="card">
            <div class="card-title">
                ğŸ‘¥ æœƒå“¡åˆ—è¡¨
                <button class="btn btn-primary btn-sm" onclick="loadMembers()">ğŸ”„ é‡æ–°è¼‰å…¥</button>
            </div>
            <div class="form-group">
                <input type="text" class="form-input" id="memberSearch" placeholder="ğŸ” æœå°‹å§“åæˆ–é›»è©±..." oninput="filterMembers()">
            </div>
            <div id="membersList"><div class="loading">â³ è¼‰å…¥ä¸­...</div></div>
        </div>
    </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ==========================================
// è¨­å®š
// ==========================================
const SHEET_ID = '1v1ecAE2XYAJgCnT3jbUp6Lfz64npIAzdiepzy-PSr_4';
const API_KEY = 'AIzaSyD3zhGgpz3SBgp62_1GhTql2CW5vrzI7NA';
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbywjsDQeIkVbhg9Ah2Z62oWi4fx2WlOeQUhFP-CxtnPYBgOW0_eQ3qdccB4AISV8dIZ/exec';

const LINE_CHANNEL_ID = '2009077580';
const LINE_REDIRECT_URI = 'https://cbc-lake.vercel.app/admin-callback.html';
const LINE_STATE = 'admin_' + Math.random().toString(36).substr(2, 9);

const ADMIN_SHEET = 'ç®¡ç†å“¡';  // ç™½åå–®å·¥ä½œè¡¨

let currentAdmin = null;
let allOrders = [];
let allMembers = [];
let stockData = [];
let stockChanges = {};

// ==========================================
// LINE ç™»å…¥
// ==========================================
function lineLogin() {
    localStorage.setItem('admin_line_state', LINE_STATE);
    const url = `https://access.line.me/oauth2/v2.1/authorize?` +
        `response_type=code` +
        `&client_id=${LINE_CHANNEL_ID}` +
        `&redirect_uri=${encodeURIComponent(LINE_REDIRECT_URI)}` +
        `&state=${LINE_STATE}` +
        `&scope=profile%20openid`;
    window.location.href = url;
}

// å¾ admin-callback å›ä¾†å¾Œçš„è™•ç†
async function handleCallback() {
    const params = new URLSearchParams(window.location.search);
    const adminData = params.get('adminData');
    if (!adminData) return;

    // æ¸…é™¤ URL åƒæ•¸
    window.history.replaceState({}, '', '/admin.html');

    try {
        document.getElementById('loginLoading').style.display = 'block';
        const profile = JSON.parse(decodeURIComponent(adminData));
        await verifyAdmin(profile);
    } catch(e) {
        showLoginError();
    }
}

async function verifyAdmin(profile) {
    try {
        // å¾ Sheets è®€å–ç®¡ç†å“¡ç™½åå–®
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${ADMIN_SHEET}?key=${API_KEY}`;
        const res = await fetch(url);
        const data = await res.json();
        const rows = (data.values || []).slice(1);
        const adminIds = rows.map(r => (r[0] || '').trim()).filter(id => id);

        if (adminIds.includes(profile.userId)) {
            // é©—è­‰é€šé
            currentAdmin = profile;
            localStorage.setItem('admin_session', JSON.stringify(profile));
            showAdminScreen();
        } else {
            showLoginError();
        }
    } catch(e) {
        showLoginError();
    }
}

function showLoginError() {
    document.getElementById('loginLoading').style.display = 'none';
    document.getElementById('loginError').style.display = 'block';
}

function showAdminScreen() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('adminScreen').style.display = 'block';
    document.getElementById('adminAvatar').src = currentAdmin.pictureUrl || '';
    document.getElementById('adminName').textContent = currentAdmin.displayName || '';
    loadOrders();
    loadAnnouncements();
    loadPromotions();
    loadStock();
    loadMembers();
}

function logout() {
    localStorage.removeItem('admin_session');
    currentAdmin = null;
    document.getElementById('adminScreen').style.display = 'none';
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('loginError').style.display = 'none';
}

// ==========================================
// åˆ†é åˆ‡æ›
// ==========================================
function switchTab(tab) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById('tab-' + tab).classList.add('active');
    event.target.classList.add('active');
}

// ==========================================
// è¨‚å–®ç®¡ç†
// ==========================================
async function loadOrders() {
    document.getElementById('ordersList').innerHTML = '<div class="loading">â³ è¼‰å…¥è¨‚å–®ä¸­...</div>';
    try {
        const url = `${APPS_SCRIPT_URL}?action=getAllOrders`;
        const res = await fetch(url);
        const data = await res.json();
        if (data.success && data.orders) {
            allOrders = data.orders;
            renderOrders(allOrders);
        } else {
            document.getElementById('ordersList').innerHTML = '<div class="loading">æ‰¾ä¸åˆ°è¨‚å–®è³‡æ–™</div>';
        }
    } catch(e) {
        document.getElementById('ordersList').innerHTML = '<div class="loading" style="color:var(--red)">âŒ è¼‰å…¥å¤±æ•—</div>';
    }
}

function filterOrders(status, btn) {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    const filtered = status === 'all' ? allOrders : allOrders.filter(o => o.è¨‚å–®ç‹€æ…‹ === status);
    renderOrders(filtered);
}

function renderOrders(orders) {
    const el = document.getElementById('ordersList');
    if (!orders.length) { el.innerHTML = '<div class="loading">æ²’æœ‰è¨‚å–®</div>'; return; }
    el.innerHTML = orders.map(order => {
        const statusClass = order.è¨‚å–®ç‹€æ…‹ === 'å·²å®Œæˆ' ? 'badge-done' :
            order.è¨‚å–®ç‹€æ…‹ === 'å·²ä»˜æ¬¾å¾…å‡ºè²¨' ? 'badge-paid' :
            order.è¨‚å–®ç‹€æ…‹ === 'å–æ¶ˆè¨‚å–®' ? 'badge-cancel' : 'badge-pending';
        return `
        <div class="order-row">
            <div class="order-row-header">
                <div>
                    <div style="font-weight:700; font-size:14px;">${order.è¨‚å–®ç·¨è™Ÿ}</div>
                    <div class="order-id">${order.è¨‚è³¼æ™‚é–“}</div>
                </div>
                <span class="badge ${statusClass}">${order.è¨‚å–®ç‹€æ…‹}</span>
            </div>
            <div class="order-info">
                <div>ğŸ‘¤ ${order.å§“å} ï¼ ğŸ“ ${order.é›»è©±}</div>
                <div>ğŸšš ${order.å–è²¨æ–¹å¼}${order.é–€å¸‚åç¨± && order.é–€å¸‚åç¨± !== '-' ? 'ï¼š' + order.é–€å¸‚åç¨± : ''}</div>
                <div>ğŸ›’ ${order.å•†å“æ˜ç´°}</div>
                <div>ğŸ’° ç¸½é‡‘é¡ï¼š<strong style="color:var(--primary)">$${order.ç¸½é‡‘é¡}</strong>${order.åŒ¯æ¬¾æœ«äº”ç¢¼ && order.åŒ¯æ¬¾æœ«äº”ç¢¼ !== '-' ? ' ï¼ æœ«äº”ç¢¼ï¼š' + order.åŒ¯æ¬¾æœ«äº”ç¢¼ : ''}</div>
            </div>
            <div class="order-actions">
                ${order.è¨‚å–®ç‹€æ…‹ === 'å·²ä»˜æ¬¾å¾…å‡ºè²¨' ? `<button class="btn btn-success btn-sm" onclick="updateOrderStatus('${order.è¨‚å–®ç·¨è™Ÿ}', 'å·²å®Œæˆ')">âœ… æ¨™è¨˜å·²å‡ºè²¨</button>` : ''}
                ${order.è¨‚å–®ç‹€æ…‹ === 'å¾…è™•ç†' ? `<button class="btn btn-success btn-sm" onclick="updateOrderStatus('${order.è¨‚å–®ç·¨è™Ÿ}', 'å·²å®Œæˆ')">âœ… æ¨™è¨˜å®Œæˆ</button>` : ''}
                ${order.è¨‚å–®ç‹€æ…‹ !== 'å–æ¶ˆè¨‚å–®' && order.è¨‚å–®ç‹€æ…‹ !== 'å·²å®Œæˆ' ? `<button class="btn btn-danger btn-sm" onclick="updateOrderStatus('${order.è¨‚å–®ç·¨è™Ÿ}', 'å–æ¶ˆè¨‚å–®')">âŒ å–æ¶ˆè¨‚å–®</button>` : ''}
            </div>
        </div>`;
    }).join('');
}

async function updateOrderStatus(orderId, newStatus) {
    if (!confirm(`ç¢ºå®šå°‡è¨‚å–® ${orderId} ç‹€æ…‹æ”¹ç‚ºã€Œ${newStatus}ã€ï¼Ÿ`)) return;
    try {
        await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({ action: 'updateOrderStatus', orderId, newStatus })
        });
        showToast(`âœ… å·²æ›´æ–°ç‚ºã€Œ${newStatus}ã€`);
        setTimeout(() => loadOrders(), 800);
    } catch(e) {
        showToast('âŒ æ›´æ–°å¤±æ•—', 'error');
    }
}

// ==========================================
// å…¬å‘Šç®¡ç†
// ==========================================
let announcementsData = [];

async function loadAnnouncements() {
    document.getElementById('announcementsList').innerHTML = '<div class="loading">â³ è¼‰å…¥ä¸­...</div>';
    try {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/å…¬å‘Šè¨­å®š?key=${API_KEY}`;
        const res = await fetch(url);
        const data = await res.json();
        const rows = (data.values || []).slice(1);
        announcementsData = rows.map((row, i) => ({
            rowIndex: i + 2,
            text: row[0] || '',
            enabled: (row[1] || '').trim() === 'æ˜¯',
            link: row[2] || ''
        })).filter(r => r.text);
        renderAnnouncements();
    } catch(e) {
        document.getElementById('announcementsList').innerHTML = '<div class="loading" style="color:var(--red)">âŒ è¼‰å…¥å¤±æ•—</div>';
    }
}

function renderAnnouncements() {
    const el = document.getElementById('announcementsList');
    if (!announcementsData.length) { el.innerHTML = '<div class="loading">å°šç„¡å…¬å‘Š</div>'; return; }
    el.innerHTML = announcementsData.map(a => `
        <div class="announcement-row">
            <label class="toggle-switch">
                <input type="checkbox" ${a.enabled ? 'checked' : ''} onchange="toggleAnnouncement(${a.rowIndex}, this.checked)">
                <span class="toggle-slider"></span>
            </label>
            <div class="announcement-text-preview">
                <div>${a.text}</div>
                ${a.link ? `<div style="font-size:11px;color:var(--text-muted)">${a.link}</div>` : ''}
            </div>
            <button class="btn btn-danger btn-sm" onclick="deleteAnnouncement(${a.rowIndex})">ğŸ—‘</button>
        </div>
    `).join('');
}

async function toggleAnnouncement(rowIndex, enabled) {
    try {
        await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({ action: 'updateAnnouncementStatus', rowIndex, enabled: enabled ? 'æ˜¯' : 'å¦' })
        });
        showToast(enabled ? 'âœ… å…¬å‘Šå·²å•Ÿç”¨' : 'å…¬å‘Šå·²åœç”¨');
    } catch(e) { showToast('âŒ æ›´æ–°å¤±æ•—', 'error'); }
}

async function addAnnouncement() {
    const text = document.getElementById('newAnnouncementText').value.trim();
    const link = document.getElementById('newAnnouncementLink').value.trim();
    if (!text) { showToast('è«‹è¼¸å…¥å…¬å‘Šå…§å®¹', 'error'); return; }
    try {
        await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({ action: 'addAnnouncement', text, link })
        });
        document.getElementById('newAnnouncementText').value = '';
        document.getElementById('newAnnouncementLink').value = '';
        showToast('âœ… å…¬å‘Šå·²æ–°å¢');
        setTimeout(() => loadAnnouncements(), 800);
    } catch(e) { showToast('âŒ æ–°å¢å¤±æ•—', 'error'); }
}

async function deleteAnnouncement(rowIndex) {
    if (!confirm('ç¢ºå®šåˆªé™¤é€™å‰‡å…¬å‘Šï¼Ÿ')) return;
    try {
        await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({ action: 'deleteAnnouncement', rowIndex })
        });
        showToast('âœ… å·²åˆªé™¤');
        setTimeout(() => loadAnnouncements(), 800);
    } catch(e) { showToast('âŒ åˆªé™¤å¤±æ•—', 'error'); }
}

// ==========================================
// å„ªæƒ ç®¡ç†
// ==========================================
let promotionsData = [];

async function loadPromotions() {
    document.getElementById('promotionsList').innerHTML = '<div class="loading">â³ è¼‰å…¥ä¸­...</div>';
    try {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/å„ªæƒ è¨­å®š?key=${API_KEY}`;
        const res = await fetch(url);
        const data = await res.json();
        const rows = (data.values || []).slice(1);
        promotionsData = rows.map((row, i) => ({
            rowIndex: i + 2,
            name: row[0] || '',
            type: row[1] || '',
            unit: row[2] || '',
            threshold: row[3] || '',
            discount: row[4] || '',
            enabled: (row[5] || '').trim() === 'æ˜¯',
            desc: row[6] || ''
        })).filter(r => r.name);
        renderPromotions();
    } catch(e) {
        document.getElementById('promotionsList').innerHTML = '<div class="loading" style="color:var(--red)">âŒ è¼‰å…¥å¤±æ•—</div>';
    }
}

function renderPromotions() {
    const el = document.getElementById('promotionsList');
    if (!promotionsData.length) { el.innerHTML = '<div class="loading">å°šç„¡å„ªæƒ </div>'; return; }
    el.innerHTML = promotionsData.map(p => `
        <div class="announcement-row" style="flex-wrap:wrap; gap:8px;">
            <label class="toggle-switch">
                <input type="checkbox" ${p.enabled ? 'checked' : ''} onchange="togglePromotion(${p.rowIndex}, this.checked)">
                <span class="toggle-slider"></span>
            </label>
            <div class="announcement-text-preview">
                <div style="font-weight:700;">${p.name}</div>
                <div style="font-size:12px;color:var(--text-muted)">
                    ${p.type} ï¼ é–€æª»ï¼š${p.threshold}${p.unit} ï¼ æŠ˜æ‰£ï¼š$${p.discount}
                </div>
            </div>
            <button class="btn btn-danger btn-sm" onclick="deletePromotion(${p.rowIndex})">ğŸ—‘</button>
        </div>
    `).join('');
}

async function togglePromotion(rowIndex, enabled) {
    try {
        await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({ action: 'updatePromotionStatus', rowIndex, enabled: enabled ? 'æ˜¯' : 'å¦' })
        });
        showToast(enabled ? 'âœ… å„ªæƒ å·²å•Ÿç”¨' : 'å„ªæƒ å·²åœç”¨');
    } catch(e) { showToast('âŒ æ›´æ–°å¤±æ•—', 'error'); }
}

async function addPromotion() {
    const name = document.getElementById('newPromoName').value.trim();
    const type = document.getElementById('newPromoType').value;
    const unit = document.getElementById('newPromoUnit').value;
    const threshold = document.getElementById('newPromoThreshold').value;
    const discount = document.getElementById('newPromoDiscount').value;
    const desc = document.getElementById('newPromoDesc').value.trim();
    if (!name || !threshold) { showToast('è«‹å¡«å¯«å„ªæƒ åç¨±å’Œé–€æª»', 'error'); return; }
    try {
        await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({ action: 'addPromotion', name, type, unit, threshold, discount, desc })
        });
        showToast('âœ… å„ªæƒ å·²æ–°å¢');
        setTimeout(() => loadPromotions(), 800);
    } catch(e) { showToast('âŒ æ–°å¢å¤±æ•—', 'error'); }
}

async function deletePromotion(rowIndex) {
    if (!confirm('ç¢ºå®šåˆªé™¤é€™å€‹å„ªæƒ ï¼Ÿ')) return;
    try {
        await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({ action: 'deletePromotion', rowIndex })
        });
        showToast('âœ… å·²åˆªé™¤');
        setTimeout(() => loadPromotions(), 800);
    } catch(e) { showToast('âŒ åˆªé™¤å¤±æ•—', 'error'); }
}

// ==========================================
// åº«å­˜ç®¡ç†
// ==========================================
async function loadStock() {
    document.getElementById('stockTable').innerHTML = '<div class="loading">â³ è¼‰å…¥ä¸­...</div>';
    stockChanges = {};
    try {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/å•†å“è¦æ ¼è¡¨?key=${API_KEY}`;
        const res = await fetch(url);
        const data = await res.json();
        const rows = (data.values || []).slice(1);
        stockData = rows.map((row, i) => ({
            rowIndex: i + 2,
            productId: row[0] || '',
            productName: row[1] || '',
            specName: row[2] || '',
            price: row[3] || '',
            stock: parseInt(row[4]) || 0
        })).filter(r => r.productId && r.productName);
        renderStock();
    } catch(e) {
        document.getElementById('stockTable').innerHTML = '<div class="loading" style="color:var(--red)">âŒ è¼‰å…¥å¤±æ•—</div>';
    }
}

function renderStock() {
    const el = document.getElementById('stockTable');
    if (!stockData.length) { el.innerHTML = '<div class="loading">ç„¡åº«å­˜è³‡æ–™</div>'; return; }
    el.innerHTML = `
        <table class="stock-table">
            <thead>
                <tr>
                    <th>å•†å“åç¨±</th>
                    <th>è¦æ ¼</th>
                    <th>å”®åƒ¹</th>
                    <th>ç¾æœ‰åº«å­˜</th>
                    <th>æ–°æ•¸é‡</th>
                </tr>
            </thead>
            <tbody>
                ${stockData.map(s => `
                <tr>
                    <td>${s.productName}</td>
                    <td style="color:var(--text-muted)">${s.specName}</td>
                    <td>$${s.price}</td>
                    <td><strong>${s.stock}</strong></td>
                    <td>
                        <input type="number" min="0" class="stock-input-sm"
                            placeholder="${s.stock}"
                            data-row="${s.rowIndex}"
                            oninput="recordStockChange(this)">
                    </td>
                </tr>`).join('')}
            </tbody>
        </table>
    `;
}

function recordStockChange(input) {
    const row = input.dataset.row;
    const val = parseInt(input.value);
    if (!isNaN(val) && input.value !== '') {
        stockChanges[row] = val;
        input.style.borderColor = '#FFD700';
    } else {
        delete stockChanges[row];
        input.style.borderColor = 'rgba(255,215,0,0.4)';
    }
}

async function saveStockChanges() {
    const keys = Object.keys(stockChanges);
    if (!keys.length) { showToast('æ²’æœ‰è¦è®Šæ›´çš„åº«å­˜', 'error'); return; }
    const updates = keys.map(row => ({ row: parseInt(row), newStock: stockChanges[row] }));
    const preview = updates.map(u => {
        const item = stockData.find(s => s.rowIndex === u.row);
        return item ? `${item.productName} ${item.specName}ï¼š${item.stock} â†’ ${u.newStock}` : '';
    }).filter(Boolean).join('\n');
    if (!confirm(`ç¢ºèªæ›´æ–°ä»¥ä¸‹åº«å­˜ï¼Ÿ\n\n${preview}`)) return;
    try {
        await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({ action: 'updateStock', updates })
        });
        showToast(`âœ… å·²æ›´æ–° ${keys.length} ç­†åº«å­˜`);
        stockChanges = {};
        setTimeout(() => loadStock(), 800);
    } catch(e) { showToast('âŒ å„²å­˜å¤±æ•—', 'error'); }
}

// ==========================================
// æœƒå“¡ç®¡ç†
// ==========================================
async function loadMembers() {
    document.getElementById('membersList').innerHTML = '<div class="loading">â³ è¼‰å…¥ä¸­...</div>';
    try {
        const url = `${APPS_SCRIPT_URL}?action=getAllMembers`;
        const res = await fetch(url);
        const data = await res.json();
        if (data.success && data.members) {
            allMembers = data.members;
            renderMembers(allMembers);
        } else {
            document.getElementById('membersList').innerHTML = '<div class="loading">æ‰¾ä¸åˆ°æœƒå“¡è³‡æ–™</div>';
        }
    } catch(e) {
        document.getElementById('membersList').innerHTML = '<div class="loading" style="color:var(--red)">âŒ è¼‰å…¥å¤±æ•—</div>';
    }
}

function filterMembers() {
    const q = document.getElementById('memberSearch').value.trim().toLowerCase();
    if (!q) { renderMembers(allMembers); return; }
    renderMembers(allMembers.filter(m =>
        (m.displayName || '').toLowerCase().includes(q) ||
        (m.phone || '').includes(q)
    ));
}

function renderMembers(members) {
    const el = document.getElementById('membersList');
    if (!members.length) { el.innerHTML = '<div class="loading">æ‰¾ä¸åˆ°æœƒå“¡</div>'; return; }
    el.innerHTML = members.map(m => `
        <div class="member-row">
            <img class="member-avatar-sm" src="${m.pictureUrl || ''}" onerror="this.src=''" alt="">
            <div class="member-info">
                <div class="member-name">${m.displayName || '-'}</div>
                <div class="member-detail">
                    ğŸ“ ${m.phone || 'æœªå¡«'} ï¼ ğŸ“§ ${m.email || 'æœªå¡«'}
                </div>
                <div class="member-detail" style="color:var(--text-muted); font-size:11px;">
                    ${m.lineId || ''}
                </div>
            </div>
        </div>
    `).join('');
}

// ==========================================
// å·¥å…·å‡½æ•¸
// ==========================================
function showToast(msg, type = 'success') {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.className = 'toast show' + (type === 'error' ? ' error' : '');
    setTimeout(() => el.classList.remove('show'), 3000);
}

// ==========================================
// åˆå§‹åŒ–
// ==========================================
window.addEventListener('load', () => {
    // å…ˆæª¢æŸ¥æ˜¯å¦å¾ callback å›ä¾†
    const params = new URLSearchParams(window.location.search);
    if (params.get('adminData')) {
        handleCallback();
        return;
    }

    // æª¢æŸ¥æœ¬åœ° session
    const session = localStorage.getItem('admin_session');
    if (session) {
        try {
            currentAdmin = JSON.parse(session);
            // é‡æ–°é©—è­‰ç™½åå–®
            verifyAdmin(currentAdmin);
        } catch(e) {
            localStorage.removeItem('admin_session');
        }
    }
});
</script>
</body>
</html>
