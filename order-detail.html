<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨‚å–®è©³æƒ… - CANDY BOSS</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid #FFD700;
            color: #FFD700;
            padding: 12px 24px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 700;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: #FFD700;
            color: #0a0a0a;
        }

        .order-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 2px solid #FFD700;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
        }

        .order-card h1 {
            color: #FFD700;
            font-size: 28px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .order-info {
            display: grid;
            gap: 15px;
        }

        .info-row {
            display: flex;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }

        .info-label {
            color: #999;
            min-width: 120px;
            font-weight: 500;
        }

        .info-value {
            color: #FFD700;
            font-weight: 700;
            flex: 1;
        }

        /* å€’æ•¸è¨ˆæ™‚å¡ç‰‡ */
        .countdown-card {
            background: linear-gradient(135deg, rgba(255, 69, 0, 0.2) 0%, rgba(255, 140, 0, 0.2) 100%);
            border: 2px solid #ff4500;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            text-align: center;
        }

        .countdown-card h3 {
            color: #ff4500;
            font-size: 24px;
            margin-bottom: 20px;
        }

        .countdown-timer {
            font-family: 'Orbitron', monospace;
            font-size: 48px;
            color: #ff4500;
            font-weight: 900;
            margin: 20px 0;
            text-shadow: 0 0 20px rgba(255, 69, 0, 0.5);
        }

        .countdown-hint {
            color: #ffa500;
            font-size: 14px;
            margin-top: 15px;
        }

        .countdown-expired {
            color: #ff4500;
            font-size: 20px;
            font-weight: 700;
        }

        /* åŒ¯æ¬¾è³‡è¨Šå¡ç‰‡ */
        .bank-card {
            background: linear-gradient(135deg, rgba(0, 200, 83, 0.1) 0%, rgba(0, 150, 136, 0.1) 100%);
            border: 2px solid #00c853;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
        }

        .bank-card h3 {
            color: #00c853;
            font-size: 24px;
            margin-bottom: 20px;
        }

        .bank-detail {
            display: flex;
            align-items: center;
            margin: 12px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        .bank-detail .label {
            color: #999;
            min-width: 100px;
            font-weight: 500;
        }

        .bank-detail .value {
            color: #FFD700;
            font-weight: 700;
            font-size: 18px;
            flex: 1;
            letter-spacing: 1px;
        }

        /* ä»˜æ¬¾è¡¨å–® */
        .payment-form {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 2px solid #FFD700;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
        }

        .payment-form h3 {
            color: #FFD700;
            font-size: 24px;
            margin-bottom: 20px;
        }

        .payment-form input {
            width: 100%;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #FFD700;
            border-radius: 10px;
            color: #FFD700;
            font-size: 18px;
            font-weight: 700;
            letter-spacing: 2px;
            text-align: center;
            margin-bottom: 20px;
        }

        .payment-form input::placeholder {
            color: #666;
            letter-spacing: normal;
        }

        .payment-form button {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border: none;
            border-radius: 15px;
            color: #000;
            font-size: 18px;
            font-weight: 900;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .payment-form button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.5);
        }

        .payment-form button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* ç‹€æ…‹æ¨™ç±¤ */
        .status-badge {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 14px;
        }

        .status-pending {
            background: rgba(255, 152, 0, 0.2);
            color: #ffa500;
            border: 2px solid #ffa500;
        }

        .status-paid {
            background: rgba(0, 200, 83, 0.2);
            color: #00c853;
            border: 2px solid #00c853;
        }

        .status-cancelled {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
            border: 2px solid #f44336;
        }

        /* éš±è—é¡åˆ¥ */
        .hidden {
            display: none !important;
        }

        /* è¼‰å…¥å‹•ç•« */
        .loading {
            text-align: center;
            padding: 50px;
            color: #FFD700;
            font-size: 18px;
        }

        .spinner {
            border: 4px solid rgba(255, 215, 0, 0.3);
            border-top: 4px solid #FFD700;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="ecommerce.html" class="back-btn">
            <span>â†</span>
            <span>è¿”å›è³¼ç‰©é é¢</span>
        </a>

        <!-- è¼‰å…¥ä¸­ -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>è¼‰å…¥è¨‚å–®è³‡è¨Šä¸­...</p>
        </div>

        <!-- è¨‚å–®è³‡è¨Š -->
        <div id="orderCard" class="order-card hidden">
            <h1>
                <span>ğŸ“¦</span>
                <span>è¨‚å–®è©³æƒ…</span>
            </h1>
            <div class="order-info" id="orderInfo"></div>
        </div>

        <!-- ä»˜æ¬¾å€’æ•¸ï¼ˆåƒ… 7-11 ä¸”æœªä»˜æ¬¾æ™‚é¡¯ç¤ºï¼‰-->
        <div id="countdownCard" class="countdown-card hidden">
            <h3>â° ä»˜æ¬¾å€’æ•¸</h3>
            <div class="countdown-timer" id="countdownTimer">--:--:--</div>
            <p class="countdown-hint">è«‹åœ¨æ™‚é™å…§å®ŒæˆåŒ¯æ¬¾ä¸¦å¡«å¯«å¸³è™Ÿæœ«äº”ç¢¼</p>
        </div>

        <!-- åŒ¯æ¬¾è³‡è¨Šï¼ˆéœ€è¦åŒ¯æ¬¾æ™‚é¡¯ç¤ºï¼‰-->
        <div id="bankCard" class="bank-card hidden">
            <h3>ğŸ’³ åŒ¯æ¬¾å¸³æˆ¶è³‡è¨Š</h3>
            <div id="bankDetails"></div>
        </div>

        <!-- å¡«å¯«åŒ¯æ¬¾æœ«äº”ç¢¼ -->
        <div id="paymentForm" class="payment-form hidden">
            <h3>âœï¸ ç¢ºèªä»˜æ¬¾</h3>
            <p style="color: #999; margin-bottom: 15px;">è«‹åœ¨å®ŒæˆåŒ¯æ¬¾å¾Œï¼Œå¡«å¯«æ‚¨çš„åŒ¯æ¬¾å¸³è™Ÿæœ«äº”ç¢¼</p>
            <input type="text" id="bankLast5Input" maxlength="5" placeholder="è«‹è¼¸å…¥åŒ¯æ¬¾å¸³è™Ÿæœ«äº”ç¢¼ï¼ˆ5ä½æ•¸å­—ï¼‰">
            <button onclick="submitPayment()">ç¢ºèªä»˜æ¬¾</button>
        </div>
    </div>

    <script>
        // è¨­å®š
        const SHEET_ID = '1v1ecAE2XYAJgCnT3jbUp6Lfz64npIAzdiepzy-PSr_4';
        const API_KEY = 'AIzaSyD3zhGgpz3SBgp62_1GhTql2CW5vrzI7NA';
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbywjsDQeIkVbhg9Ah2Z62oWi4fx2WlOeQUhFP-CxtnPYBgOW0_eQ3qdccB4AISV8dIZ/exec';

        let orderData = null;
        let countdownInterval = null;
        let systemSettings = {
            bankName: '',
            bankAccount: '',
            bankHolder: ''
        };

        // å–å¾—è¨‚å–®ç·¨è™Ÿ
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('orderId');

        if (!orderId) {
            alert('æ‰¾ä¸åˆ°è¨‚å–®ç·¨è™Ÿ');
            window.location.href = 'ecommerce.html';
        }

        // è¼‰å…¥è¨‚å–®è³‡æ–™
        async function loadOrderData() {
            try {
                // å¾ localStorage å–å¾—å‰›å»ºç«‹çš„è¨‚å–®è³‡æ–™
                const cachedOrder = localStorage.getItem('latest_order_' + orderId);
                
                if (cachedOrder) {
                    orderData = JSON.parse(cachedOrder);
                    displayOrderData();
                    localStorage.removeItem('latest_order_' + orderId); // ç”¨å®Œå°±åˆªé™¤
                } else {
                    alert('è¨‚å–®è³‡æ–™å·²å¤±æ•ˆï¼Œè«‹è¿”å›é‡æ–°æŸ¥è©¢');
                    window.location.href = 'ecommerce.html';
                }
            } catch (error) {
                console.error('è¼‰å…¥è¨‚å–®å¤±æ•—:', error);
                alert('è¼‰å…¥è¨‚å–®å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
            }
        }

        // è¼‰å…¥ç³»çµ±è¨­å®šï¼ˆåŒ¯æ¬¾è³‡è¨Šï¼‰
        async function loadSystemSettings() {
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/ç³»çµ±è¨­å®š?key=${API_KEY}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.values && data.values.length > 1) {
                    data.values.slice(1).forEach(row => {
                        if (row[0] === 'åŒ¯æ¬¾éŠ€è¡Œ') systemSettings.bankName = row[1] || '';
                        if (row[0] === 'åŒ¯æ¬¾å¸³è™Ÿ') systemSettings.bankAccount = row[1] || '';
                        if (row[0] === 'åŒ¯æ¬¾æˆ¶å') systemSettings.bankHolder = row[1] || '';
                    });
                }
            } catch (error) {
                console.error('è¼‰å…¥ç³»çµ±è¨­å®šå¤±æ•—:', error);
            }
        }

        // é¡¯ç¤ºè¨‚å–®è³‡æ–™
        function displayOrderData() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('orderCard').classList.remove('hidden');

            const orderInfo = document.getElementById('orderInfo');
            
            // ä»˜æ¬¾ç‹€æ…‹æ¨™ç±¤
            let paymentStatusBadge = '';
            if (orderData.ä»˜æ¬¾ç‹€æ…‹ === 'å·²ä»˜æ¬¾') {
                paymentStatusBadge = '<span class="status-badge status-paid">âœ… å·²ä»˜æ¬¾</span>';
            } else if (orderData.è¨‚å–®ç‹€æ…‹ === 'å–æ¶ˆè¨‚å–®') {
                paymentStatusBadge = '<span class="status-badge status-cancelled">âŒ å·²å–æ¶ˆ</span>';
            } else {
                paymentStatusBadge = '<span class="status-badge status-pending">â° å¾…ä»˜æ¬¾</span>';
            }

            orderInfo.innerHTML = `
                <div class="info-row">
                    <div class="info-label">è¨‚å–®ç·¨è™Ÿ</div>
                    <div class="info-value">${orderData.è¨‚å–®ç·¨è™Ÿ}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">è¨‚è³¼æ™‚é–“</div>
                    <div class="info-value">${orderData.è¨‚è³¼æ™‚é–“}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">å§“å</div>
                    <div class="info-value">${orderData.å§“å}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">é›»è©±</div>
                    <div class="info-value">${orderData.é›»è©±}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">å–è²¨æ–¹å¼</div>
                    <div class="info-value">${orderData.å–è²¨æ–¹å¼}</div>
                </div>
                ${orderData.é–€å¸‚åç¨± && orderData.é–€å¸‚åç¨± !== '-' ? `
                <div class="info-row">
                    <div class="info-label">å–è²¨é–€å¸‚</div>
                    <div class="info-value">${orderData.é–€å¸‚åç¨±}<br><small style="color:#999;">${orderData.é–€å¸‚åœ°å€}</small></div>
                </div>
                ` : ''}
                <div class="info-row">
                    <div class="info-label">ä»˜æ¬¾æ–¹å¼</div>
                    <div class="info-value">${orderData.ä»˜æ¬¾æ–¹å¼}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">ä»˜æ¬¾ç‹€æ…‹</div>
                    <div class="info-value">${paymentStatusBadge}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">å•†å“æ˜ç´°</div>
                    <div class="info-value">${orderData.å•†å“æ˜ç´°.replace(/,/g, '<br>')}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">å•†å“é‡‘é¡</div>
                    <div class="info-value">$${orderData.å•†å“é‡‘é¡}</div>
                </div>
                ${orderData.é‹è²» > 0 ? `
                <div class="info-row">
                    <div class="info-label">é‹è²»</div>
                    <div class="info-value">$${orderData.é‹è²»}</div>
                </div>
                ` : ''}
                <div class="info-row" style="border-top: 2px solid #FFD700; padding-top: 15px;">
                    <div class="info-label" style="font-size: 20px;">ç¸½é‡‘é¡</div>
                    <div class="info-value" style="font-size: 24px;">$${orderData.ç¸½é‡‘é¡}</div>
                </div>
            `;

            // é¡¯ç¤ºå€’æ•¸è¨ˆæ™‚ï¼ˆåƒ… 7-11 ä¸”æœªä»˜æ¬¾ï¼‰
            if (orderData.å–è²¨æ–¹å¼ === '7-11åº—åˆ°åº—' && orderData.ä»˜æ¬¾ç‹€æ…‹ === 'å¾…ä»˜æ¬¾' && orderData.è¨‚å–®ç‹€æ…‹ !== 'å–æ¶ˆè¨‚å–®') {
                document.getElementById('countdownCard').classList.remove('hidden');
                startCountdown();
            }

            // é¡¯ç¤ºåŒ¯æ¬¾è³‡è¨Šï¼ˆéœ€è¦åŒ¯æ¬¾æ™‚ï¼‰
            if ((orderData.ä»˜æ¬¾æ–¹å¼ === 'åŒ¯æ¬¾' || orderData.ä»˜æ¬¾æ–¹å¼ === 'è²¨åˆ°ä»˜æ¬¾') && orderData.ä»˜æ¬¾ç‹€æ…‹ === 'å¾…ä»˜æ¬¾') {
                document.getElementById('bankCard').classList.remove('hidden');
                displayBankInfo();
            }

            // é¡¯ç¤ºä»˜æ¬¾è¡¨å–®ï¼ˆæœªä»˜æ¬¾æ™‚ï¼‰
            if (orderData.ä»˜æ¬¾ç‹€æ…‹ === 'å¾…ä»˜æ¬¾' && orderData.è¨‚å–®ç‹€æ…‹ !== 'å–æ¶ˆè¨‚å–®') {
                document.getElementById('paymentForm').classList.remove('hidden');
            }
        }

        // é¡¯ç¤ºåŒ¯æ¬¾è³‡è¨Š
        function displayBankInfo() {
            const bankDetails = document.getElementById('bankDetails');
            bankDetails.innerHTML = `
                <div class="bank-detail">
                    <span class="label">éŠ€è¡Œï¼š</span>
                    <span class="value">${systemSettings.bankName || 'è¼‰å…¥ä¸­...'}</span>
                </div>
                <div class="bank-detail">
                    <span class="label">å¸³è™Ÿï¼š</span>
                    <span class="value">${systemSettings.bankAccount || 'è¼‰å…¥ä¸­...'}</span>
                </div>
                <div class="bank-detail">
                    <span class="label">æˆ¶åï¼š</span>
                    <span class="value">${systemSettings.bankHolder || 'è¼‰å…¥ä¸­...'}</span>
                </div>
                <div class="bank-detail">
                    <span class="label">é‡‘é¡ï¼š</span>
                    <span class="value" style="color: #ff4500;">$${orderData.ç¸½é‡‘é¡}</span>
                </div>
            `;
        }

        // é–‹å§‹å€’æ•¸è¨ˆæ™‚ï¼ˆ1å°æ™‚ï¼‰
        function startCountdown() {
            const orderTime = new Date(orderData.è¨‚è³¼æ™‚é–“);
            const deadline = new Date(orderTime.getTime() + 60 * 60 * 1000); // 1å°æ™‚å¾Œ

            countdownInterval = setInterval(() => {
                const now = new Date();
                const remaining = deadline - now;

                if (remaining <= 0) {
                    clearInterval(countdownInterval);
                    document.getElementById('countdownTimer').innerHTML = '<span class="countdown-expired">âš ï¸ ä»˜æ¬¾æ™‚é™å·²é</span>';
                    document.getElementById('paymentForm').classList.add('hidden');
                    alert('ä»˜æ¬¾æ™‚é™å·²éï¼Œè¨‚å–®å°‡è¢«å–æ¶ˆ');
                    setTimeout(() => {
                        window.location.href = 'ecommerce.html';
                    }, 3000);
                    return;
                }

                const hours = Math.floor(remaining / (1000 * 60 * 60));
                const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((remaining % (1000 * 60)) / 1000);

                document.getElementById('countdownTimer').textContent = 
                    `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }, 1000);
        }

        // æäº¤ä»˜æ¬¾è³‡è¨Š
        async function submitPayment() {
            const bankLast5 = document.getElementById('bankLast5Input').value.trim();

            if (!bankLast5 || bankLast5.length !== 5) {
                alert('è«‹è¼¸å…¥5ä½æ•¸å­—çš„åŒ¯æ¬¾å¸³è™Ÿæœ«äº”ç¢¼');
                return;
            }

            if (!/^\d{5}$/.test(bankLast5)) {
                alert('åŒ¯æ¬¾æœ«äº”ç¢¼å¿…é ˆæ˜¯5ä½æ•¸å­—');
                return;
            }

            if (!confirm('ç¢ºèªè¦æäº¤ä»˜æ¬¾è³‡è¨Šå—ï¼Ÿ')) {
                return;
            }

            try {
                const paymentData = {
                    action: 'updatePayment',
                    orderId: orderData.è¨‚å–®ç·¨è™Ÿ,
                    bankLast5: bankLast5
                };

                await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(paymentData)
                });

                alert('ä»˜æ¬¾è³‡è¨Šå·²é€å‡ºï¼\n\næˆ‘å€‘æœƒç›¡å¿«ç¢ºèªæ‚¨çš„ä»˜æ¬¾ã€‚');
                window.location.reload();
            } catch (error) {
                console.error('æäº¤ä»˜æ¬¾å¤±æ•—:', error);
                alert('ä»˜æ¬¾è³‡è¨Šå·²é€å‡ºï¼ï¼ˆç³»çµ±è¨˜éŒ„ä¸­ï¼‰');
                window.location.reload();
            }
        }

        // é é¢è¼‰å…¥
        window.addEventListener('load', async () => {
            await loadSystemSettings();
            await loadOrderData();
        });
    </script>
</body>
</html>
